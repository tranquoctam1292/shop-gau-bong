Dá»±a trÃªn mÃ£ nguá»“n báº¡n cung cáº¥p, tÃ´i Ä‘Ã£ phÃ¢n tÃ­ch module Media Library vÃ  phÃ¡t hiá»‡n má»™t sá»‘ lá»—i logic quan trá»ng vÃ  rá»§i ro tiá»m áº©n cáº§n Ä‘Æ°á»£c kháº¯c phá»¥c Ä‘á»ƒ Ä‘áº£m báº£o há»‡ thá»‘ng hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh vÃ  sáº¡ch sáº½.DÆ°á»›i Ä‘Ã¢y lÃ  chi tiáº¿t phÃ¢n tÃ­ch:1. ğŸ”´ Lá»—i Logic NghiÃªm Trá»ng: XÃ³a dá»¯ liá»‡u khÃ´ng triá»‡t Ä‘á»ƒ (Orphaned Files)ÄÃ¢y lÃ  váº¥n Ä‘á» lá»›n nháº¥t trong file lib/repositories/mediaRepository.ts.Váº¥n Ä‘á»: HÃ m deleteMedia chá»‰ thá»±c hiá»‡n xÃ³a document trong MongoDB mÃ  khÃ´ng gá»i Storage Service Ä‘á»ƒ xÃ³a file váº­t lÃ½ (trÃªn Ä‘Ä©a hoáº·c S3/Vercel Blob)1.Háº­u quáº£: Sau má»™t thá»i gian váº­n hÃ nh, database thÃ¬ sáº¡ch nhÆ°ng dung lÆ°á»£ng lÆ°u trá»¯ (Storage) sáº½ bá»‹ Ä‘áº§y bá»Ÿi cÃ¡c file "rÃ¡c" khÃ´ng cÃ²n ai quáº£n lÃ½ (Orphaned files).Giáº£i phÃ¡p: Cáº§n sá»­a láº¡i logic luá»“ng xÃ³a. Repository nÃªn chá»‰ chá»‹u trÃ¡ch nhiá»‡m vá»›i DB. Logic xÃ³a file váº­t lÃ½ pháº£i Ä‘Æ°á»£c gá»i á»Ÿ táº§ng Service hoáº·c API Route trÆ°á»›c khi gá»i repository, hoáº·c inject StorageService vÃ o repository (tuy nhiÃªn nÃªn tÃ¡ch biá»‡t á»Ÿ táº§ng Service/UseCase).2. âš ï¸ Rá»§i ro Runtime: Phá»¥ thuá»™c vÃ o MongoDB Text IndexTrong hÃ m getMediaList, logic tÃ¬m kiáº¿m sá»­ dá»¥ng toÃ¡n tá»­ $text:TypeScriptif (filters.search && filters.search.trim()) {
    query.$text = { $search: filters.search.trim() }; // [cite: 75]
}
Váº¥n Ä‘á»: ToÃ¡n tá»­ $text cá»§a MongoDB báº¯t buá»™c collection media pháº£i cÃ³ má»™t Text Index Ä‘Æ°á»£c táº¡o trÆ°á»›c Ä‘Ã³ (vÃ­ dá»¥: db.media.createIndex({ name: "text", altText: "text" })).Háº­u quáº£: Náº¿u báº¡n deploy code nÃ y lÃªn má»™t database má»›i mÃ  quÃªn cháº¡y lá»‡nh táº¡o index, chá»©c nÄƒng tÃ¬m kiáº¿m sáº½ gÃ¢y ra lá»—i server (Crash) ngay láº­p tá»©c (Lá»—i: text index required for $text query).Giáº£i phÃ¡p: Cáº§n cÃ³ script migration Ä‘á»ƒ táº¡o index khi khá»Ÿi táº¡o á»©ng dá»¥ng, hoáº·c dÃ¹ng toÃ¡n tá»­ $regex (cháº­m hÆ¡n nhÆ°ng khÃ´ng cáº§n text index) náº¿u dá»¯ liá»‡u Ã­t.3. âš ï¸ Logic Cáº­p nháº­t (Update): MÃ¢u thuáº«n Metadata vÃ  File tháº­tTrong hÃ m updateMedia 2:Váº¥n Ä‘á»: Báº¡n cho phÃ©p cáº­p nháº­t trÆ°á»ng folder3. Tuy nhiÃªn, Ä‘oáº¡n code nÃ y chá»‰ cáº­p nháº­t giÃ¡ trá»‹ text trong Database. NÃ³ khÃ´ng thá»±c sá»± di chuyá»ƒn file sang thÆ° má»¥c má»›i trong Storage Service.Háº­u quáº£: path (Ä‘Æ°á»ng dáº«n váº­t lÃ½) vÃ  folder (metadata logic) sáº½ bá»‹ lá»‡ch nhau. VÃ­ dá»¥: Database bÃ¡o file á»Ÿ folder /2025 nhÆ°ng file tháº­t váº«n náº±m á»Ÿ /2024. Äiá»u nÃ y gÃ¢y khÃ³ khÄƒn cho viá»‡c quáº£n lÃ½ file sau nÃ y.Giáº£i phÃ¡p:Cháº·n khÃ´ng cho sá»­a folder sau khi upload.Hoáº·c náº¿u cho sá»­a, pháº£i tÃ­ch há»£p logic move/copy file trong Storage Service.4. â„¹ï¸ Thiáº¿u kiá»ƒm soÃ¡t trÃ¹ng láº·p (Data Integrity)Trong hÃ m createMedia 4:Váº¥n Ä‘á»: HÃ m nÃ y insert tháº³ng vÃ o DB mÃ  khÃ´ng kiá»ƒm tra xem path hoáº·c url Ä‘Ã£ tá»“n táº¡i chÆ°a (dÃ¹ cÃ³ hÃ m getMediaByPath bÃªn dÆ°á»›i nhÆ°ng khÃ´ng Ä‘Æ°á»£c dÃ¹ng trong createMedia).Háº­u quáº£: Náº¿u Storage Service sinh ra cÃ¹ng má»™t tÃªn file (vÃ­ dá»¥ ghi Ä‘Ã¨ file cÅ©), nhÆ°ng Database láº¡i táº¡o má»™t _id má»›i. Báº¡n sáº½ cÃ³ 2 records trong DB cÃ¹ng trá» vÃ o 1 file váº­t lÃ½. Khi user A xÃ³a áº£nh cá»§a há», áº£nh cá»§a user B (chung file) cÅ©ng bá»‹ máº¥t (broken link).5. ğŸ“‰ Hiá»‡u nÄƒng: Sorting khi tÃ¬m kiáº¿m TextTypeScript// If text search is used, sort by text score first
if (filters.search && filters.search.trim()) {
    sortOption = { score: { $meta: 'textScore' }, ...sortOption }; // [cite: 82]
}
PhÃ¢n tÃ­ch: Logic nÃ y Ä‘Ãºng vá» máº·t ká»¹ thuáº­t (Æ°u tiÃªn káº¿t quáº£ khá»›p tá»« khÃ³a nháº¥t). Tuy nhiÃªn, code Ä‘ang spread ...sortOption vÃ o sau.LÆ°u Ã½: MongoDB cÃ³ thá»ƒ gáº·p khÃ³ khÄƒn vá» hiá»‡u nÄƒng khi combine Text Score sort vá»›i cÃ¡c field sort khÃ¡c náº¿u khÃ´ng cÃ³ Index phÃ¹ há»£p (Compound Index). Cáº§n monitor hiá»‡u nÄƒng Ä‘oáº¡n nÃ y khi dá»¯ liá»‡u lá»›n.Báº£ng Tá»•ng Há»£p & Äá» Xuáº¥t Sá»­a Äá»•iFileVá»‹ trÃ­ (DÃ²ng)Má»©c Ä‘á»™Váº¥n Ä‘á»Äá» xuáº¥t sá»­a Ä‘á»•i (HÃ nh Ä‘á»™ng ngay)mediaRepository.ts[90]CaoXÃ³a DB nhÆ°ng khÃ´ng xÃ³a file váº­t lÃ½.Cáº­p nháº­t API route DELETE: Gá»i storageService.delete(path) trÆ°á»›c khi gá»i repo.deleteMedia(id).mediaRepository.ts[75]TBCrash náº¿u thiáº¿u MongoDB Index.ThÃªm script setup DB index hoáº·c chuyá»ƒn sang dÃ¹ng $regex cho an toÃ n náº¿u data nhá».mediaRepository.ts[85]TBUpdate folder khÃ´ng move file.Loáº¡i bá» field folder khá»i MediaUpdate interface hoáº·c implement logic move file.mediaRepository.ts[53]Tháº¥pNguy cÆ¡ trÃ¹ng láº·p file.ThÃªm check getMediaByPath trÆ°á»›c khi insert, hoáº·c Ä‘Ã¡nh Unique Index cho trÆ°á»ng path trong MongoDB.