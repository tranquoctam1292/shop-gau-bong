================================================================================PRODUCT COMPONENTS SOURCE CODEGenerated: 2025-12-16 15:06:47Total Files: 92================================================================================================================================================================FILE: components/admin/products/AttributeCardSelector.tsx================================================================================'use client';

import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Loader2, Palette, Ruler, Image as ImageIcon, Tag } from 'lucide-react';
import type { Attribute } from '@/app/admin/attributes/page';

interface AttributeCardSelectorProps {
  attributes: Attribute[];
  loading: boolean;
  onSelect: (attribute: Attribute) => void;
  selectedAttributeIds?: string[];
}

const typeIcons: Record<Attribute['type'], typeof Palette> = {
  text: Tag,
  color: Palette,
  image: ImageIcon,
  button: Ruler,
};

const typeLabels: Record<Attribute['type'], string> = {
  text: 'Văn bản',
  color: 'Màu sắc',
  image: 'Hình ảnh',
  button: 'Nút bấm',
};

export function AttributeCardSelector({
  attributes,
  loading,
  onSelect,
  selectedAttributeIds = [],
}: AttributeCardSelectorProps) {
  if (loading) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (attributes.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        <p className="text-sm">Chưa có thuộc tính global nào.</p>
        <p className="text-xs mt-1">
          Vào <strong>Sản phẩm &gt; Các thuộc tính</strong> để tạo thuộc tính mới.
        </p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
      {attributes.map((attribute) => {
        const Icon = typeIcons[attribute.type];
        const isSelected = selectedAttributeIds.includes(attribute.id);
        const isDisabled = isSelected;

        return (
          <Card
            key={attribute.id}
            className={`cursor-pointer transition-all hover:shadow-md ${
              isSelected
                ? 'border-primary bg-primary/5'
                : 'hover:border-primary/50'
            } ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            onClick={() => !isDisabled && onSelect(attribute)}
          >
            <CardContent className="p-4">
              <div className="flex items-start gap-3">
                <div
                  className={`p-2 rounded-lg ${
                    attribute.type === 'color'
                      ? 'bg-pink-100 text-pink-700'
                      : attribute.type === 'image'
                      ? 'bg-blue-100 text-blue-700'
                      : attribute.type === 'button'
                      ? 'bg-green-100 text-green-700'
                      : 'bg-gray-100 text-gray-700'
                  }`}
                >
                  <Icon className="w-5 h-5" />
                </div>
                <div className="flex-1 min-w-0">
                  <h4 className="font-semibold text-sm truncate">{attribute.name}</h4>
                  <p className="text-xs text-muted-foreground mt-1">
                    {typeLabels[attribute.type]}
                  </p>
                  {attribute.termsCount !== undefined && (
                    <p className="text-xs text-muted-foreground mt-0.5">
                      {attribute.termsCount} giá trị
                    </p>
                  )}
                </div>
                {isSelected && (
                  <div className="text-primary">
                    <svg
                      className="w-5 h-5"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fillRule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clipRule="evenodd"
                      />
                    </svg>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        );
      })}
    </div>
  );
}
================================================================================FILE: components/admin/products/AttributeLibraryModal.tsx================================================================================'use client';

import { useState, useMemo } from 'react';
import Image from 'next/image';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2, Palette, Ruler, Image as ImageIcon, Tag } from 'lucide-react';
import type { Attribute } from '@/app/admin/attributes/page';
import type { Term } from '@/app/admin/attributes/[id]/terms/page';

interface AttributeLibraryModalProps {
  isOpen: boolean;
  onClose: () => void;
  onApply: (selectedAttributeIds: string[]) => void;
  attributes: Attribute[];
  loading: boolean;
  selectedAttributeIds?: string[];
  // Optional: terms data for preview
  termsMap?: Record<string, Term[]>;
}

const typeIcons: Record<Attribute['type'], typeof Palette> = {
  text: Tag,
  color: Palette,
  image: ImageIcon,
  button: Ruler,
};

const typeLabels: Record<Attribute['type'], string> = {
  text: 'Văn bản',
  color: 'Màu sắc',
  image: 'Hình ảnh',
  button: 'Nút bấm',
};

/**
 * Preview component for attribute values
 */
function AttributePreview({ 
  attribute, 
  terms 
}: { 
  attribute: Attribute; 
  terms?: Term[] 
}) {
  if (!terms || terms.length === 0) {
    return (
      <span className="text-xs text-muted-foreground">Chưa có giá trị</span>
    );
  }

  // Show first 3-5 terms as preview
  const previewTerms = terms.slice(0, 5);

  if (attribute.type === 'color') {
    return (
      <div className="flex items-center gap-1.5 flex-wrap">
        {previewTerms.map((term) => (
          <div
            key={term.id}
            className="w-6 h-6 rounded-full border border-gray-300 shadow-sm"
            style={{
              backgroundColor: term.colorHex || '#ccc',
              backgroundImage: term.colorHex2
                ? `linear-gradient(135deg, ${term.colorHex} 0%, ${term.colorHex2} 100%)`
                : undefined,
            }}
            title={term.name}
          />
        ))}
        {terms.length > 5 && (
          <span className="text-xs text-muted-foreground">+{terms.length - 5}</span>
        )}
      </div>
    );
  }

  if (attribute.type === 'image' || attribute.type === 'button') {
    return (
      <div className="flex items-center gap-1.5 flex-wrap">
        {previewTerms.map((term) => (
          <div
            key={term.id}
            className="w-6 h-6 rounded border border-gray-300 overflow-hidden bg-gray-100"
            title={term.name}
          >
            {term.imageUrl ? (
              <div className="relative w-full h-full">
                <Image
                  src={term.imageUrl}
                  alt={term.name}
                  fill
                  className="object-cover"
                  sizes="(max-width: 768px) 100vw, 150px"
                />
              </div>
            ) : (
              <div className="w-full h-full flex items-center justify-center text-[8px] text-gray-400">
                {term.name.charAt(0).toUpperCase()}
              </div>
            )}
          </div>
        ))}
        {terms.length > 5 && (
          <span className="text-xs text-muted-foreground">+{terms.length - 5}</span>
        )}
      </div>
    );
  }

  // Text type - show names
  return (
    <div className="flex items-center gap-1.5 flex-wrap">
      {previewTerms.map((term, idx) => (
        <span
          key={term.id}
          className="text-xs px-1.5 py-0.5 bg-gray-100 rounded text-gray-700"
        >
          {term.name}
        </span>
      ))}
      {terms.length > 5 && (
        <span className="text-xs text-muted-foreground">+{terms.length - 5}</span>
      )}
    </div>
  );
}

export function AttributeLibraryModal({
  isOpen,
  onClose,
  onApply,
  attributes,
  loading,
  selectedAttributeIds = [],
  termsMap = {},
}: AttributeLibraryModalProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedIds, setSelectedIds] = useState<Set<string>>(
    new Set(selectedAttributeIds)
  );

  // Filter attributes based on search
  const filteredAttributes = useMemo(() => {
    if (!searchQuery.trim()) {
      return attributes;
    }
    const query = searchQuery.toLowerCase();
    return attributes.filter(
      (attr) =>
        attr.name.toLowerCase().includes(query) ||
        typeLabels[attr.type].toLowerCase().includes(query)
    );
  }, [attributes, searchQuery]);

  // Toggle selection
  const toggleSelection = (attributeId: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(attributeId)) {
        next.delete(attributeId);
      } else {
        next.add(attributeId);
      }
      return next;
    });
  };

  // Handle apply
  const handleApply = () => {
    onApply(Array.from(selectedIds));
    onClose();
  };

  // Reset selection when modal closes
  const handleClose = () => {
    setSelectedIds(new Set(selectedAttributeIds));
    setSearchQuery('');
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleClose}>
      <DialogContent className="max-w-4xl max-h-[80vh] flex flex-col">
        <DialogHeader>
          <DialogTitle className="text-xl">Chọn thuộc tính sản phẩm</DialogTitle>
        </DialogHeader>

        {/* Search Bar */}
        <div className="py-4">
          <Input
            type="text"
            placeholder="Tìm kiếm thuộc tính (ví dụ: Màu, Kích thước...)"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full"
          />
        </div>

        {/* Table Body */}
        <div className="flex-1 overflow-auto border rounded-lg">
          {loading ? (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
            </div>
          ) : filteredAttributes.length === 0 ? (
            <div className="text-center py-12 text-muted-foreground">
              <p className="text-sm">
                {searchQuery ? 'Không tìm thấy thuộc tính nào' : 'Chưa có thuộc tính global nào'}
              </p>
              {!searchQuery && (
                <p className="text-xs mt-1">
                  Vào <strong>Sản phẩm &gt; Các thuộc tính</strong> để tạo thuộc tính mới.
                </p>
              )}
            </div>
          ) : (
            <table className="w-full">
              <thead className="bg-muted sticky top-0">
                <tr>
                  <th className="w-12 px-4 py-3 text-left">
                    <input
                      type="checkbox"
                      checked={
                        filteredAttributes.length > 0 &&
                        filteredAttributes.every((attr) => selectedIds.has(attr.id))
                      }
                      onChange={(e) => {
                        if (e.target.checked) {
                          setSelectedIds(
                            new Set([
                              ...selectedIds,
                              ...filteredAttributes.map((attr) => attr.id),
                            ])
                          );
                        } else {
                          setSelectedIds(
                            new Set(
                              Array.from(selectedIds).filter(
                                (id) => !filteredAttributes.some((attr) => attr.id === id)
                              )
                            )
                          );
                        }
                      }}
                      className="w-4 h-4 rounded border-gray-300"
                    />
                  </th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">Tên</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">Loại</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">Preview</th>
                </tr>
              </thead>
              <tbody>
                {filteredAttributes.map((attribute) => {
                  const Icon = typeIcons[attribute.type];
                  const isSelected = selectedIds.has(attribute.id);
                  const terms = termsMap[attribute.id] || [];

                  return (
                    <tr
                      key={attribute.id}
                      className={`border-b hover:bg-muted/50 transition-colors ${
                        isSelected ? 'bg-primary/5' : ''
                      }`}
                    >
                      <td className="px-4 py-3">
                        <input
                          type="checkbox"
                          checked={isSelected}
                          onChange={() => toggleSelection(attribute.id)}
                          className="w-4 h-4 rounded border-gray-300"
                        />
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <div
                            className={`p-1.5 rounded ${
                              attribute.type === 'color'
                                ? 'bg-pink-100 text-pink-700'
                                : attribute.type === 'image'
                                ? 'bg-blue-100 text-blue-700'
                                : attribute.type === 'button'
                                ? 'bg-green-100 text-green-700'
                                : 'bg-gray-100 text-gray-700'
                            }`}
                          >
                            <Icon className="w-4 h-4" />
                          </div>
                          <div>
                            <div className="font-medium text-sm">{attribute.name}</div>
                            {attribute.termsCount !== undefined && (
                              <div className="text-xs text-muted-foreground">
                                {attribute.termsCount} giá trị
                              </div>
                            )}
                          </div>
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        <span className="text-sm text-muted-foreground">
                          {typeLabels[attribute.type]}
                        </span>
                      </td>
                      <td className="px-4 py-3">
                        <AttributePreview attribute={attribute} terms={terms} />
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>

        {/* Footer */}
        <DialogFooter className="flex items-center justify-between pt-4 border-t">
          <div className="text-sm text-muted-foreground">
            Đã chọn: <strong>{selectedIds.size}</strong> thuộc tính
          </div>
          <div className="flex items-center gap-2">
            <Button variant="outline" onClick={handleClose}>
              Hủy
            </Button>
            <Button onClick={handleApply} disabled={selectedIds.size === 0}>
              Áp dụng ({selectedIds.size})
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
================================================================================FILE: components/admin/products/AttributeValueSelectionModal.tsx================================================================================'use client';

import { useState, useEffect, useMemo } from 'react';
import Image from 'next/image';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { Loader2, Check, Plus } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import type { Term } from '@/app/admin/attributes/[id]/terms/page';

/**
 * Parse size value to centimeters for comparison
 * Examples: "25cm" -> 25, "1m" -> 100, "1m5" -> 150, "2m" -> 200
 */
function parseSizeToCm(value: string): number {
  const normalized = value.trim().toLowerCase();
  
  // Match patterns like "25cm", "1m", "1m5", "2m", etc.
  const cmMatch = normalized.match(/^(\d+(?:\.\d+)?)\s*cm$/);
  if (cmMatch) {
    return parseFloat(cmMatch[1]);
  }
  
  const mMatch = normalized.match(/^(\d+(?:\.\d+)?)\s*m(?:\s*(\d+(?:\.\d+)?))?$/);
  if (mMatch) {
    const meters = parseFloat(mMatch[1]);
    const additionalCm = mMatch[2] ? parseFloat(mMatch[2]) : 0;
    return meters * 100 + additionalCm;
  }
  
  // If can't parse, return a large number to push to end
  return Infinity;
}

/**
 * Check if attribute is a size attribute
 */
function isSizeAttribute(attributeName: string, attributeType: string): boolean {
  const nameLower = attributeName.toLowerCase();
  return (
    nameLower.includes('kích thước') ||
    nameLower.includes('size') ||
    nameLower.includes('kích cỡ') ||
    attributeType === 'button' // Button type is often used for sizes
  );
}

interface AttributeValueSelectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onApply: (selectedValues: string[]) => void;
  attributeName: string;
  attributeType: 'text' | 'color' | 'image' | 'button';
  terms: Term[];
  selectedValues: string[]; // Pre-selected values
  loading?: boolean;
  onQuickAdd?: () => void;
}

/**
 * Color Swatch Item Component
 */
function ColorSwatchItem({
  term,
  isSelected,
  onToggle,
}: {
  term: Term;
  isSelected: boolean;
  onToggle: () => void;
}) {
  return (
    <div
      className={cn(
        'relative cursor-pointer rounded-lg border-2 transition-all hover:shadow-md',
        isSelected ? 'border-primary shadow-md scale-105' : 'border-gray-200'
      )}
      onClick={onToggle}
    >
      {/* Color Swatch */}
      <div
        className="w-full aspect-square rounded-t-lg"
        style={{
          background: term.colorHex2
            ? `linear-gradient(135deg, ${term.colorHex} 0%, ${term.colorHex2} 100%)`
            : term.colorHex || '#ccc',
          border: !term.colorHex || term.colorHex === '#FFFFFF' ? '1px solid #ddd' : 'none',
        }}
      >
        {/* Check Icon Overlay */}
        {isSelected && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/20 rounded-t-lg">
            <div className="w-8 h-8 rounded-full bg-primary flex items-center justify-center">
              <Check className="w-5 h-5 text-white" />
            </div>
          </div>
        )}
      </div>
      {/* Label */}
      <div className="p-2 text-center">
        <div className="text-sm font-medium truncate">{term.name}</div>
        {term.description && (
          <div className="text-xs text-muted-foreground truncate mt-0.5">
            {term.description}
          </div>
        )}
      </div>
    </div>
  );
}

/**
 * Visual Table Row Component (for Image/Button types)
 */
function VisualTableRow({
  term,
  isSelected,
  onToggle,
}: {
  term: Term;
  isSelected: boolean;
  onToggle: () => void;
}) {
  return (
    <tr
      className={cn(
        'border-b hover:bg-muted/50 transition-colors cursor-pointer',
        isSelected && 'bg-primary/5'
      )}
      onClick={onToggle}
    >
      <td className="px-4 py-3 w-12">
        <Checkbox checked={isSelected} onCheckedChange={onToggle} />
      </td>
      <td className="px-4 py-3 w-24">
        {term.imageUrl ? (
          <div className="relative w-16 h-16 border rounded overflow-hidden bg-gray-100">
            <Image
              src={term.imageUrl}
              alt={term.name}
              fill
              className="object-cover"
              sizes="64px"
            />
          </div>
        ) : (
          <div className="w-16 h-16 border rounded bg-gray-100 flex items-center justify-center text-xs text-muted-foreground">
            {term.name.charAt(0).toUpperCase()}
          </div>
        )}
      </td>
      <td className="px-4 py-3">
        <div className="font-medium text-sm">{term.name}</div>
        {term.slug && (
          <div className="text-xs text-muted-foreground mt-0.5">{term.slug}</div>
        )}
      </td>
      <td className="px-4 py-3">
        {term.description ? (
          <div className="text-sm text-muted-foreground">{term.description}</div>
        ) : (
          <span className="text-xs text-muted-foreground">—</span>
        )}
      </td>
    </tr>
  );
}

/**
 * Text List Item Component
 */
function TextListItem({
  term,
  isSelected,
  onToggle,
}: {
  term: Term;
  isSelected: boolean;
  onToggle: () => void;
}) {
  return (
    <div
      className={cn(
        'flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors hover:bg-muted',
        isSelected && 'bg-primary/10 border-primary'
      )}
      onClick={onToggle}
    >
      <Checkbox checked={isSelected} onCheckedChange={onToggle} />
      <div className="flex-1 min-w-0">
        <div className="font-medium text-sm">{term.name}</div>
        {term.description && (
          <div className="text-xs text-muted-foreground mt-0.5 truncate">
            {term.description}
          </div>
        )}
      </div>
      {isSelected && <Check className="w-5 h-5 text-primary flex-shrink-0" />}
    </div>
  );
}

export function AttributeValueSelectionModal({
  isOpen,
  onClose,
  onApply,
  attributeName,
  attributeType,
  terms,
  selectedValues,
  loading = false,
  onQuickAdd,
}: AttributeValueSelectionModalProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  // Initialize selectedIds from selectedValues (pre-select)
  useEffect(() => {
    if (isOpen) {
      const initialSelected = new Set<string>();
      terms.forEach((term) => {
        if (selectedValues.includes(term.name)) {
          initialSelected.add(term.id);
        }
      });
      setSelectedIds(initialSelected);
      setSearchQuery(''); // Reset search when modal opens
    }
  }, [isOpen, terms, selectedValues]);

  // Filter and sort terms
  const filteredTerms = useMemo(() => {
    let filtered = terms;
    
    // Filter by search query
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = terms.filter(
        (term) =>
          term.name.toLowerCase().includes(query) ||
          term.slug?.toLowerCase().includes(query) ||
          term.description?.toLowerCase().includes(query)
      );
    }
    
    // Sort by size if this is a size attribute
    if (isSizeAttribute(attributeName, attributeType)) {
      filtered = [...filtered].sort((a, b) => {
        const sizeA = parseSizeToCm(a.name);
        const sizeB = parseSizeToCm(b.name);
        
        // If both are valid sizes, sort by size
        if (sizeA !== Infinity && sizeB !== Infinity) {
          return sizeA - sizeB;
        }
        
        // If only one is valid, put valid one first
        if (sizeA !== Infinity) return -1;
        if (sizeB !== Infinity) return 1;
        
        // If neither is valid, sort alphabetically
        return a.name.localeCompare(b.name);
      });
    }
    
    return filtered;
  }, [terms, searchQuery, attributeName, attributeType]);

  // Toggle selection
  const toggleSelection = (termId: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(termId)) {
        next.delete(termId);
      } else {
        next.add(termId);
      }
      return next;
    });
  };

  // Select All / Deselect All
  const handleSelectAll = () => {
    const allFilteredIds = new Set(filteredTerms.map((term) => term.id));
    setSelectedIds((prev) => new Set([...prev, ...allFilteredIds]));
  };

  const handleDeselectAll = () => {
    const filteredIds = new Set(filteredTerms.map((term) => term.id));
    setSelectedIds((prev) => {
      const next = new Set(prev);
      filteredIds.forEach((id) => next.delete(id));
      return next;
    });
  };

  // Handle Apply
  const handleApply = () => {
    const selectedTermNames = terms
      .filter((term) => selectedIds.has(term.id))
      .map((term) => term.name);
    onApply(selectedTermNames);
    onClose();
  };

  // Handle Close
  const handleClose = () => {
    setSearchQuery('');
    onClose();
  };

  const selectedCount = selectedIds.size;
  const allFilteredSelected = filteredTerms.length > 0 && 
    filteredTerms.every((term) => selectedIds.has(term.id));

  return (
    <Dialog open={isOpen} onOpenChange={handleClose}>
      <DialogContent className="max-w-4xl max-h-[85vh] flex flex-col">
        <DialogHeader>
          <DialogTitle className="text-xl">
            Chọn {attributeName}
          </DialogTitle>
        </DialogHeader>

        {/* Toolbar */}
        <div className="space-y-3 py-4 border-b">
          {/* Search */}
          <div className="flex items-center gap-2">
            <Input
              type="text"
              placeholder={`Tìm kiếm ${attributeName.toLowerCase()}...`}
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="flex-1"
              autoFocus
            />
          </div>

          {/* Actions */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={allFilteredSelected ? handleDeselectAll : handleSelectAll}
              >
                {allFilteredSelected ? 'Bỏ chọn tất cả' : 'Chọn tất cả'}
              </Button>
              {onQuickAdd && (
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={onQuickAdd}
                  className="flex items-center gap-1"
                >
                  <Plus className="w-4 h-4" />
                  Thêm nhanh
                </Button>
              )}
            </div>
            <div className="text-sm text-muted-foreground">
              {filteredTerms.length} giá trị
            </div>
          </div>
        </div>

        {/* Body - Different layouts based on attribute type */}
        <div className="flex-1 overflow-auto">
          {loading ? (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
            </div>
          ) : filteredTerms.length === 0 ? (
            <div className="text-center py-12 text-muted-foreground">
              <p className="text-sm">
                {searchQuery ? 'Không tìm thấy giá trị nào' : 'Chưa có giá trị nào'}
              </p>
              {!searchQuery && onQuickAdd && (
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={onQuickAdd}
                  className="mt-4 flex items-center gap-1"
                >
                  <Plus className="w-4 h-4" />
                  Thêm giá trị đầu tiên
                </Button>
              )}
            </div>
          ) : attributeType === 'color' ? (
            // Color Mode: Grid Layout
            <div className="grid grid-cols-4 sm:grid-cols-5 gap-4 p-4">
              {filteredTerms.map((term) => (
                <ColorSwatchItem
                  key={term.id}
                  term={term}
                  isSelected={selectedIds.has(term.id)}
                  onToggle={() => toggleSelection(term.id)}
                />
              ))}
            </div>
          ) : attributeType === 'image' || attributeType === 'button' ? (
            // Visual Mode: Table Layout
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-muted sticky top-0">
                  <tr>
                    <th className="w-12 px-4 py-3 text-left">
                      <Checkbox
                        checked={allFilteredSelected}
                        onCheckedChange={allFilteredSelected ? handleDeselectAll : handleSelectAll}
                      />
                    </th>
                    <th className="px-4 py-3 text-left text-sm font-semibold">Hình ảnh</th>
                    <th className="px-4 py-3 text-left text-sm font-semibold">Tên</th>
                    <th className="px-4 py-3 text-left text-sm font-semibold">Mô tả</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredTerms.map((term) => (
                    <VisualTableRow
                      key={term.id}
                      term={term}
                      isSelected={selectedIds.has(term.id)}
                      onToggle={() => toggleSelection(term.id)}
                    />
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            // Text Mode: List Layout
            <div className="p-4 space-y-2">
              {filteredTerms.map((term) => (
                <TextListItem
                  key={term.id}
                  term={term}
                  isSelected={selectedIds.has(term.id)}
                  onToggle={() => toggleSelection(term.id)}
                />
              ))}
            </div>
          )}
        </div>

        {/* Footer */}
        <DialogFooter className="flex items-center justify-between pt-4 border-t">
          <div className="text-sm text-muted-foreground">
            Đã chọn: <strong>{selectedCount}</strong> giá trị
          </div>
          <div className="flex items-center gap-2">
            <Button variant="outline" onClick={handleClose}>
              Hủy
            </Button>
            <Button onClick={handleApply} disabled={selectedCount === 0}>
              Áp dụng ({selectedCount})
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
================================================================================FILE: components/admin/products/BulkActionsBar.tsx================================================================================'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Trash2, RotateCcw, FileX, Loader2, DollarSign, Package } from 'lucide-react';
import { BulkUpdatePriceModal } from './BulkUpdatePriceModal';
import { BulkUpdateStockModal } from './BulkUpdateStockModal';
import { useToastContext } from '@/components/providers/ToastProvider';

interface BulkActionsBarProps {
  selectedCount: number;
  isTrashTab?: boolean;
  onBulkDelete?: () => Promise<void>;
  onBulkRestore?: () => Promise<void>;
  onBulkForceDelete?: () => Promise<void>;
  onBulkStatusChange?: (status: 'draft' | 'publish') => Promise<void>;
  onBulkUpdatePrice?: (price: number) => Promise<void>;
  onBulkUpdateStock?: (value: number, operation: 'set' | 'add' | 'subtract') => Promise<void>;
  onClearSelection?: () => void;
}

export function BulkActionsBar({
  selectedCount,
  isTrashTab = false,
  onBulkDelete,
  onBulkRestore,
  onBulkForceDelete,
  onBulkStatusChange,
  onBulkUpdatePrice,
  onBulkUpdateStock,
  onClearSelection,
}: BulkActionsBarProps) {
  const { showToast } = useToastContext();
  const [loading, setLoading] = useState<string | null>(null);
  const [showPriceModal, setShowPriceModal] = useState(false);
  const [showStockModal, setShowStockModal] = useState(false);

  const handleBulkUpdatePrice = async (price: number) => {
    if (!onBulkUpdatePrice) return;

    setLoading('price');
    try {
      await onBulkUpdatePrice(price);
      showToast(`Đã cập nhật giá cho ${selectedCount} sản phẩm`, 'success');
    } catch (error) {
      showToast('Không thể cập nhật giá', 'error');
    } finally {
      setLoading(null);
    }
  };

  const handleBulkUpdateStock = async (value: number, operation: 'set' | 'add' | 'subtract') => {
    if (!onBulkUpdateStock) return;

    setLoading('stock');
    try {
      await onBulkUpdateStock(value, operation);
      showToast(`Đã cập nhật kho cho ${selectedCount} sản phẩm`, 'success');
    } catch (error) {
      showToast('Không thể cập nhật kho', 'error');
    } finally {
      setLoading(null);
    }
  };

  if (selectedCount === 0) return null;

  return (
    <>
      <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
        <span className="text-sm font-medium text-blue-900">
          Đã chọn {selectedCount} sản phẩm
        </span>
        <div className="flex gap-2 flex-wrap">
          {!isTrashTab && (
            <>
              <Button
                variant="outline"
                size="sm"
                onClick={() => onBulkStatusChange?.('publish')}
                disabled={!!loading}
              >
                {loading === 'status' ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : null}
                Xuất bản
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => onBulkStatusChange?.('draft')}
                disabled={!!loading}
              >
                {loading === 'status' ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : null}
                Chuyển thành bản nháp
              </Button>
              {onBulkUpdatePrice && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowPriceModal(true)}
                  disabled={!!loading}
                >
                  <DollarSign className="w-4 h-4 mr-2" />
                  Cập nhật giá
                </Button>
              )}
              {onBulkUpdateStock && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowStockModal(true)}
                  disabled={!!loading}
                >
                  <Package className="w-4 h-4 mr-2" />
                  Cập nhật kho
                </Button>
              )}
              <Button
                variant="destructive"
                size="sm"
                onClick={onBulkDelete}
                disabled={!!loading}
              >
                {loading === 'delete' ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : (
                  <Trash2 className="w-4 h-4 mr-2" />
                )}
                Xóa tạm
              </Button>
            </>
          )}
          {isTrashTab && (
            <>
              <Button
                variant="outline"
                size="sm"
                onClick={onBulkRestore}
                disabled={!!loading}
              >
                {loading === 'restore' ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : (
                  <RotateCcw className="w-4 h-4 mr-2" />
                )}
                Khôi phục
              </Button>
              <Button
                variant="destructive"
                size="sm"
                onClick={onBulkForceDelete}
                disabled={!!loading}
              >
                {loading === 'force-delete' ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : (
                  <FileX className="w-4 h-4 mr-2" />
                )}
                Xóa vĩnh viễn
              </Button>
            </>
          )}
          {onClearSelection && (
            <Button
              variant="outline"
              size="sm"
              onClick={onClearSelection}
              disabled={!!loading}
            >
              Bỏ chọn
            </Button>
          )}
        </div>
      </div>

      {showPriceModal && (
        <BulkUpdatePriceModal
          isOpen={showPriceModal}
          onClose={() => setShowPriceModal(false)}
          onConfirm={handleBulkUpdatePrice}
          selectedCount={selectedCount}
        />
      )}

      {showStockModal && (
        <BulkUpdateStockModal
          isOpen={showStockModal}
          onClose={() => setShowStockModal(false)}
          onConfirm={handleBulkUpdateStock}
          selectedCount={selectedCount}
        />
      )}
    </>
  );
}

================================================================================FILE: components/admin/products/BulkUpdatePriceModal.tsx================================================================================'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToastContext } from '@/components/providers/ToastProvider';

interface BulkUpdatePriceModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (price: number) => Promise<void>;
  selectedCount: number;
}

export function BulkUpdatePriceModal({
  isOpen,
  onClose,
  onConfirm,
  selectedCount,
}: BulkUpdatePriceModalProps) {
  const { showToast } = useToastContext();
  const [price, setPrice] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleConfirm = async () => {
    if (!price || price.trim() === '') {
      setError('Vui lòng nhập giá');
      return;
    }

    const numPrice = parseFloat(price);
    if (isNaN(numPrice) || numPrice < 0) {
      setError('Giá phải là số >= 0');
      return;
    }

    setError(null);
    setLoading(true);
    try {
      await onConfirm(numPrice);
      showToast(`Đã cập nhật giá cho ${selectedCount} sản phẩm thành công`, 'success');
      setPrice('');
      onClose();
    } catch (error: any) {
      console.error('Error bulk updating price:', error);
      showToast(error?.message || 'Có lỗi xảy ra khi cập nhật giá', 'error');
    } finally {
      setLoading(false);
    }
  };

  const formatPrice = (price: number): string => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(price);
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Cập nhật giá hàng loạt</DialogTitle>
          <DialogDescription>
            Cập nhật giá cho {selectedCount} sản phẩm đã chọn
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="bulk-price">Giá mới (VND)</Label>
            <Input
              id="bulk-price"
              type="number"
              placeholder="Nhập giá..."
              value={price}
              onChange={(e) => {
                setPrice(e.target.value);
                setError(null);
              }}
              min="0"
            />
            {error && (
              <p className="text-xs text-red-500">{error}</p>
            )}
            {price && !error && !isNaN(parseFloat(price)) && (
              <p className="text-xs text-gray-500">
                {formatPrice(parseFloat(price))}
              </p>
            )}
          </div>

          <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>{selectedCount}</strong> sản phẩm sẽ được cập nhật với giá mới.
            </p>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={loading}>
            Hủy
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={loading || !price || !!error}
            className="min-h-[44px]"
          >
            {loading ? 'Đang xử lý...' : 'Cập nhật'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

================================================================================FILE: components/admin/products/BulkUpdateStockModal.tsx================================================================================'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useToastContext } from '@/components/providers/ToastProvider';

interface BulkUpdateStockModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (value: number, operation: 'set' | 'add' | 'subtract') => Promise<void>;
  selectedCount: number;
}

export function BulkUpdateStockModal({
  isOpen,
  onClose,
  onConfirm,
  selectedCount,
}: BulkUpdateStockModalProps) {
  const { showToast } = useToastContext();
  const [operation, setOperation] = useState<'set' | 'add' | 'subtract'>('set');
  const [value, setValue] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleConfirm = async () => {
    if (!value || value.trim() === '') {
      setError('Vui lòng nhập số lượng');
      return;
    }

    const numValue = parseInt(value, 10);
    if (isNaN(numValue) || numValue < 0) {
      setError('Số lượng phải là số nguyên >= 0');
      return;
    }

    setError(null);
    setLoading(true);
    try {
      await onConfirm(numValue, operation);
      const operationLabels = {
        set: 'Đặt thành',
        add: 'Thêm vào',
        subtract: 'Trừ đi',
      };
      showToast(
        `Đã cập nhật kho cho ${selectedCount} sản phẩm: ${operationLabels[operation]} ${numValue}`,
        'success'
      );
      setValue('');
      setOperation('set');
      onClose();
    } catch (error: any) {
      console.error('Error bulk updating stock:', error);
      showToast(error?.message || 'Có lỗi xảy ra khi cập nhật kho', 'error');
    } finally {
      setLoading(false);
    }
  };

  const getOperationLabel = () => {
    switch (operation) {
      case 'set':
        return 'Đặt thành';
      case 'add':
        return 'Thêm vào';
      case 'subtract':
        return 'Trừ đi';
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Cập nhật kho hàng loạt</DialogTitle>
          <DialogDescription>
            Cập nhật số lượng kho cho {selectedCount} sản phẩm đã chọn
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="bulk-stock-operation">Thao tác</Label>
            <Select
              value={operation}
              onValueChange={(value) => setOperation(value as 'set' | 'add' | 'subtract')}
            >
              <SelectTrigger id="bulk-stock-operation">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="set">Đặt thành (Set to value)</SelectItem>
                <SelectItem value="add">Thêm vào (Add value)</SelectItem>
                <SelectItem value="subtract">Trừ đi (Subtract value)</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label htmlFor="bulk-stock-value">Số lượng</Label>
            <Input
              id="bulk-stock-value"
              type="number"
              placeholder="Nhập số lượng..."
              value={value}
              onChange={(e) => {
                setValue(e.target.value);
                setError(null);
              }}
              min="0"
            />
            {error && (
              <p className="text-xs text-red-500">{error}</p>
            )}
          </div>

          <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>{selectedCount}</strong> sản phẩm sẽ được cập nhật: <strong>{getOperationLabel()}</strong> {value || '0'} đơn vị.
            </p>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={loading}>
            Hủy
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={loading || !value || !!error}
            className="min-h-[44px]"
          >
            {loading ? 'Đang xử lý...' : 'Cập nhật'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

================================================================================FILE: components/admin/products/CategoryBrandCell.tsx================================================================================'use client';

import Link from 'next/link';
import type { MappedProduct } from '@/lib/utils/productMapper';

interface CategoryBrandCellProps {
  product: MappedProduct;
}

export function CategoryBrandCell({ product }: CategoryBrandCellProps) {
  const category = product.categories?.[0];
  const brand = (product as any).brand; // Brand field may not be in MappedProduct type yet

  return (
    <div className="space-y-1">
      {category && (
        <div>
          <Link
            href={`/admin/categories?search=${category.slug}`}
            className="text-sm text-gray-900 hover:text-blue-600 transition-colors"
          >
            {category.name}
          </Link>
        </div>
      )}
      {brand && (
        <div className="text-xs text-gray-500">
          {brand}
        </div>
      )}
      {!category && !brand && (
        <span className="text-sm text-gray-400">-</span>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/CategoryTreeSelect.tsx================================================================================'use client';

import { useState, useRef } from 'react';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Search, ChevronDown, Check, X } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { useCategories } from '@/lib/hooks/useCategories';
import type { MappedCategory } from '@/lib/utils/productMapper';

interface CategoryTreeSelectProps {
  value: string | null;
  onChange: (value: string | null) => void;
  placeholder?: string;
}

/**
 * Get category display name with hierarchy
 */
function getCategoryDisplayName(category: MappedCategory, allCategories: MappedCategory[]): string {
  if (!category.parentId) {
    return category.name;
  }
  
  const path: string[] = [category.name];
  let currentParentId: string | null = category.parentId;
  
  while (currentParentId) {
    const parent = allCategories.find(cat => cat.id === currentParentId || cat.databaseId.toString() === currentParentId);
    if (!parent) break;
    path.unshift(parent.name);
    currentParentId = parent.parentId;
  }
  
  return path.join(' > ');
}

/**
 * Get indent level for display
 */
function getCategoryLevel(category: MappedCategory, allCategories: MappedCategory[]): number {
  if (!category.parentId) return 0;
  
  let level = 0;
  let currentParentId: string | null = category.parentId;
  
  while (currentParentId) {
    level++;
    const parent = allCategories.find(cat => cat.id === currentParentId || cat.databaseId.toString() === currentParentId);
    if (!parent) break;
    currentParentId = parent.parentId;
  }
  
  return level;
}

export function CategoryTreeSelect({
  value,
  onChange,
  placeholder = 'Chọn danh mục...',
}: CategoryTreeSelectProps) {
  const [open, setOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const inputRef = useRef<HTMLInputElement>(null);
  
  const { categories, isLoading } = useCategories({
    type: 'tree',
    status: 'active',
  });

  // Filter categories by search
  const filteredCategories = categories.filter(cat => {
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      return (
        cat.name.toLowerCase().includes(query) ||
        cat.slug.toLowerCase().includes(query)
      );
    }
    return true;
  });

  // Sort by hierarchy (parents first, then children)
  const sortedCategories = [...filteredCategories].sort((a, b) => {
    const levelA = getCategoryLevel(a, categories);
    const levelB = getCategoryLevel(b, categories);
    if (levelA !== levelB) return levelA - levelB;
    return a.name.localeCompare(b.name);
  });

  // Get selected category
  const selectedCategory = categories.find(
    cat => cat.id === value || cat.databaseId.toString() === value
  );

  const handleSelect = (categoryId: string | null) => {
    onChange(categoryId);
    setOpen(false);
    setSearchQuery('');
  };

  const handleClear = (e: React.MouseEvent) => {
    e.stopPropagation();
    onChange(null);
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          className={cn(
            'w-full justify-between text-left font-normal min-w-[200px]',
            !selectedCategory && 'text-muted-foreground'
          )}
        >
          <span className="truncate">
            {selectedCategory
              ? getCategoryDisplayName(selectedCategory, categories)
              : placeholder}
          </span>
          <div className="flex items-center gap-1">
            {selectedCategory && (
              <X
                className="h-4 w-4 shrink-0 opacity-50 hover:opacity-100"
                onClick={handleClear}
              />
            )}
            <ChevronDown className="h-4 w-4 shrink-0 opacity-50" />
          </div>
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[400px] p-0" align="start">
        <div className="p-2">
          <div className="relative">
            <Search className="absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              ref={inputRef}
              placeholder="Tìm kiếm danh mục..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-8"
            />
          </div>
        </div>
        <div className="max-h-[300px] overflow-y-auto">
          {isLoading ? (
            <div className="p-4 text-center text-sm text-muted-foreground">
              Đang tải...
            </div>
          ) : (
            <>
              <div className="p-2">
                <button
                  type="button"
                  onClick={() => handleSelect(null)}
                  className={cn(
                    'w-full text-left px-2 py-1.5 rounded hover:bg-accent flex items-center gap-2',
                    !value && 'bg-accent'
                  )}
                >
                  {!value && <Check className="h-4 w-4" />}
                  <span className={cn(!value && 'ml-6')}>Tất cả danh mục</span>
                </button>
              </div>
              {sortedCategories.length === 0 ? (
                <div className="p-4 text-center text-sm text-muted-foreground">
                  Không tìm thấy danh mục
                </div>
              ) : (
                <div className="p-2 space-y-1">
                  {sortedCategories.map((category) => {
                    const level = getCategoryLevel(category, categories);
                    const isSelected = category.id === value || category.databaseId.toString() === value;
                    
                    return (
                      <button
                        key={category.id}
                        type="button"
                        onClick={() => handleSelect(category.id)}
                        className={cn(
                          'w-full text-left px-2 py-1.5 rounded hover:bg-accent flex items-center gap-2',
                          isSelected && 'bg-accent'
                        )}
                        style={{ paddingLeft: `${8 + level * 20}px` }}
                      >
                        {isSelected && <Check className="h-4 w-4 shrink-0" />}
                        <span className={cn(!isSelected && level > 0 && 'ml-6')}>
                          {category.name}
                        </span>
                      </button>
                    );
                  })}
                </div>
              )}
            </>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );
}

================================================================================FILE: components/admin/products/ClassicEditor.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Image from '@tiptap/extension-image';
import Link from '@tiptap/extension-link';
// TextAlign and Underline extensions - will be added if needed
// import TextAlign from '@tiptap/extension-text-align';
// import Underline from '@tiptap/extension-underline';
import Placeholder from '@tiptap/extension-placeholder';
import { Iframe, VideoEmbedWrapper } from '@/lib/tiptap/extensions/Iframe';
import { convertVideoUrlToEmbed, isStandaloneVideoUrl } from '@/lib/utils/videoEmbed';
import { useToastContext } from '@/components/providers/ToastProvider';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { MediaLibraryModal } from './MediaLibraryModal';
import { InlineImageToolbar } from './InlineImageToolbar';
import { ImageEditorErrorBoundary } from './ImageEditorErrorBoundary';
import {
  Bold,
  Italic,
  Underline as UnderlineIcon,
  Strikethrough,
  List,
  ListOrdered,
  Quote,
  Minus,
  AlignLeft,
  AlignCenter,
  AlignRight,
  AlignJustify,
  Link as LinkIcon,
  Image as ImageIcon,
  Code,
  Undo,
  Redo,
  Type,
  Palette,
  MoreHorizontal,
  Upload,
  Eye,
  Code2,
} from 'lucide-react';

interface ClassicEditorProps {
  value: string;
  onChange: (html: string) => void;
  placeholder?: string;
}

/**
 * Classic WordPress Editor Component
 * Features:
 * - Visual/Text mode toggle
 * - Add Media button với modal
 * - Full toolbar (2 hàng)
 * - Text mode với QuickTags
 */
export function ClassicEditor({ value, onChange, placeholder = 'Nhập nội dung...' }: ClassicEditorProps) {
  const { showToast } = useToastContext();
  const [mode, setMode] = useState<'visual' | 'text'>('visual');
  const [showToolbarRow2, setShowToolbarRow2] = useState(false);
  const [showMediaModal, setShowMediaModal] = useState(false);
  const [textContent, setTextContent] = useState(value);
  const [isToolbarSticky, setIsToolbarSticky] = useState(false);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const toolbarRef = useRef<HTMLDivElement>(null);
  const editorContainerRef = useRef<HTMLDivElement>(null);

  // Initialize Tiptap editor for Visual mode
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        heading: {
          levels: [1, 2, 3, 4, 5, 6],
        },
      }),
      Image.extend({
        addAttributes() {
          return {
            ...this.parent?.(),
            class: {
              default: null,
              parseHTML: element => element.getAttribute('class'),
              renderHTML: attributes => {
                if (!attributes.class) {
                  return {};
                }
                return {
                  class: attributes.class,
                };
              },
            },
            style: {
              default: null,
              parseHTML: element => element.getAttribute('style'),
              renderHTML: attributes => {
                if (!attributes.style) {
                  return {};
                }
                return {
                  style: attributes.style,
                };
              },
            },
            width: {
              default: null,
              parseHTML: element => element.getAttribute('width'),
              renderHTML: attributes => {
                if (!attributes.width) {
                  return {};
                }
                return {
                  width: attributes.width,
                };
              },
            },
            height: {
              default: null,
              parseHTML: element => element.getAttribute('height'),
              renderHTML: attributes => {
                if (!attributes.height) {
                  return {};
                }
                return {
                  height: attributes.height,
                };
              },
            },
          };
        },
      }).configure({
        inline: true,
        allowBase64: false, // Disable Base64 - force server upload via paste handler
        HTMLAttributes: {
          class: 'max-w-full h-auto',
        },
      }),
      Link.configure({
        openOnClick: false,
        HTMLAttributes: {
          class: 'text-primary underline',
          target: '_blank',
          rel: 'noopener noreferrer',
        },
      }),
      // Video Embed extensions for video embeds
      VideoEmbedWrapper,
      Iframe,
      // TextAlign and Underline will be added when extensions are installed
      // TextAlign.configure({
      //   types: ['heading', 'paragraph'],
      // }),
      // Underline,
      Placeholder.configure({
        placeholder,
      }),
    ],
    content: value || '',
    immediatelyRender: false, // Fix SSR hydration mismatch
    onUpdate: ({ editor }) => {
      const html = editor.getHTML();
      // Only update if different to avoid unnecessary re-renders
      if (html !== textContent) {
        setTextContent(html);
        onChange(html);
      }
    },
    editorProps: {
      attributes: {
        class: 'prose prose-sm max-w-none focus:outline-none min-h-[300px] p-4 border border-input rounded-b',
      },
    },
  });

  // Handle paste events for video embedding and image upload
  useEffect(() => {
    if (!editor) return;

    const handlePaste = async (view: any, event: ClipboardEvent) => {
      const clipboardData = event.clipboardData || (window as any).clipboardData;
      if (!clipboardData) {
        return false;
      }

      // Handle image paste - upload to server instead of Base64
      const items = Array.from(clipboardData.items) as DataTransferItem[];
      const imageItem = items.find((item) => item.type.indexOf('image') !== -1);
      
      if (imageItem) {
        event.preventDefault();
        const file = imageItem.getAsFile();
        if (file) {
          // Upload image to server
          try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('folder', 'products'); // Organize in products folder
            
            const response = await fetch('/api/admin/media/upload', {
              method: 'POST',
              body: formData,
            });

            if (response.ok) {
              const data = await response.json();
              const imageUrl = data.url || data.media?.url;
              
              if (imageUrl) {
                // Insert image with server URL
                editor.chain().focus().setImage({ 
                  src: imageUrl,
                  alt: file.name || 'Product image'
                }).run();
                
                // Update content
                const newHtml = editor.getHTML();
                setTextContent(newHtml);
                onChange(newHtml);
                return true;
              }
            } else {
              const errorData = await response.json().catch(() => ({}));
              showToast(errorData.error || 'Không thể upload ảnh. Vui lòng thử lại.', 'error');
            }
          } catch (error) {
            console.error('Error uploading pasted image:', error);
            showToast('Có lỗi xảy ra khi upload ảnh. Vui lòng thử lại.', 'error');
          }
        }
        return true;
      }

      const pastedText = clipboardData.getData('text/plain');
      if (!pastedText) return false;

      // Check if pasted text is a standalone video URL
      const isStandalone = isStandaloneVideoUrl(pastedText);
      
      if (isStandalone) {
        const embedHtml = convertVideoUrlToEmbed(pastedText.trim());
        
        if (embedHtml) {
          event.preventDefault();
          // Insert video embed using editor commands
          // Parse HTML to extract iframe and create proper node structure
          setTimeout(() => {
            
            // Parse HTML to extract wrapper and iframe for proper node structure
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = embedHtml;
            const wrapper = tempDiv.querySelector('div.video-embed-wrapper');
            const iframe = wrapper?.querySelector('iframe');
            
            if (wrapper && iframe) {
              // Extract attributes
              const wrapperStyle = wrapper.getAttribute('style') || '';
              const wrapperClass = wrapper.getAttribute('class') || 'video-embed-wrapper';
              const iframeAttrs = {
                src: iframe.getAttribute('src') || '',
                frameborder: iframe.getAttribute('frameborder') || '0',
                allowfullscreen: iframe.hasAttribute('allowfullscreen'),
                allow: iframe.getAttribute('allow') || '',
                style: iframe.getAttribute('style') || '',
                class: iframe.getAttribute('class') || '',
                width: iframe.getAttribute('width') || '100%',
                height: iframe.getAttribute('height') || '400px',
              };
              
              // Insert as proper node structure to avoid paragraph wrapping
              editor.chain()
                .focus()
                .insertContent({
                  type: 'videoEmbedWrapper',
                  attrs: {
                    style: wrapperStyle,
                    class: wrapperClass,
                  },
                  content: [
                    {
                      type: 'iframe',
                      attrs: iframeAttrs,
                    },
                  ],
                })
                .run();
            } else {
              // Fallback to raw HTML insert
              editor.commands.insertContent(embedHtml);
            }
          }, 0);
          return true;
        }
      }

      // Check if pasted text contains video URLs on their own lines
      const lines = pastedText.split('\n');
      let hasVideoUrl = false;
      let modifiedText = pastedText;

      for (const line of lines) {
        const trimmedLine = line.trim();
        if (isStandaloneVideoUrl(trimmedLine)) {
          const embedHtml = convertVideoUrlToEmbed(trimmedLine);
          if (embedHtml) {
            hasVideoUrl = true;
            // Replace the line with embed HTML
            modifiedText = modifiedText.replace(trimmedLine, embedHtml);
          }
        }
      }

      if (hasVideoUrl) {
        event.preventDefault();
        setTimeout(() => {
          editor.commands.insertContent(modifiedText);
        }, 0);
        return true;
      }

      return false; // Let default paste handler handle it
    };

    // Register paste handler
    editor.view.dom.addEventListener('paste', (e: ClipboardEvent) => {
      handlePaste(editor.view, e);
    });

    return () => {
      editor.view.dom.removeEventListener('paste', handlePaste as any);
    };
  }, [editor]);

  // Sync content when value prop changes (only if different to avoid loops)
  useEffect(() => {
    if (!editor || value === undefined) return;
    
    const currentHtml = editor.getHTML();
    // Only update if value is actually different and not from our own onChange
    if (value !== currentHtml) {
      editor.commands.setContent(value || '');
      setTextContent(value || '');
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [value]); // Only depend on value, not editor or textContent

  // Sync between Visual and Text mode
  useEffect(() => {
    if (!editor) return;
    
    if (mode === 'text') {
      // When switching to text mode, get HTML from visual editor
      const html = editor.getHTML();
      if (html !== textContent) {
        setTextContent(html);
      }
    } else if (mode === 'visual') {
      // When switching to visual mode, set content from text mode
      const currentHtml = editor.getHTML();
      // Only update if textContent is different to avoid unnecessary updates
      if (textContent && textContent !== currentHtml) {
        editor.commands.setContent(textContent);
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [mode]); // Only trigger on mode change, not editor or textContent

  // Keyboard shortcuts handler
  useEffect(() => {
    if (!editor) return;

    const handleKeyDown = (event: KeyboardEvent) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const ctrlKey = isMac ? event.metaKey : event.ctrlKey;
      const altKey = event.altKey;
      const shiftKey = event.shiftKey;

      // System shortcuts (Ctrl/Cmd + ...)
      if (ctrlKey && !altKey && !shiftKey) {
        switch (event.key.toLowerCase()) {
          case 'z':
            if (!event.shiftKey) {
              event.preventDefault();
              if (mode === 'visual') {
                editor.commands.undo();
              }
            }
            break;
          case 'y':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.redo();
            }
            break;
          case 'a':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.selectAll();
            } else if (textareaRef.current) {
              textareaRef.current.select();
            }
            break;
          case 'b':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.toggleBold();
            } else {
              insertQuickTag('<strong>', '</strong>');
            }
            break;
          case 'i':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.toggleItalic();
            } else {
              insertQuickTag('<em>', '</em>');
            }
            break;
          case 'u':
            event.preventDefault();
            if (mode === 'visual') {
              const { from, to } = editor.state.selection;
              const selectedText = editor.state.doc.textBetween(from, to);
              if (selectedText) {
                editor.chain().focus().deleteSelection().insertContent(`<u>${selectedText}</u>`).run();
              } else {
                editor.chain().focus().insertContent('<u></u>').run();
              }
            } else {
              insertQuickTag('<u>', '</u>');
            }
            break;
          case 'k':
            event.preventDefault();
            addLink();
            break;
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
          case '6':
            event.preventDefault();
            if (mode === 'visual') {
              const level = parseInt(event.key) as 1 | 2 | 3 | 4 | 5 | 6;
              editor.commands.toggleHeading({ level });
            }
            break;
          case '7':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.setParagraph();
            }
            break;
        }
      }

      // Alt + Shift shortcuts
      if (altKey && shiftKey && !ctrlKey) {
        switch (event.key.toLowerCase()) {
          case 'x':
            event.preventDefault();
            if (mode === 'visual') {
              const { from, to } = editor.state.selection;
              const selectedText = editor.state.doc.textBetween(from, to);
              if (selectedText) {
                editor.chain().focus().deleteSelection().insertContent(`<code>${selectedText}</code>`).run();
              } else {
                editor.chain().focus().insertContent('<code></code>').run();
              }
            } else {
              insertQuickTag('<code>', '</code>');
            }
            break;
          case 'd':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.toggleStrike();
            } else {
              insertQuickTag('<del>', '</del>');
            }
            break;
          case 'q':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.toggleBlockquote();
            } else {
              insertQuickTag('<blockquote>', '</blockquote>');
            }
            break;
          case 'u':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.toggleBulletList();
            } else {
              if (textareaRef.current) {
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                if (selectedText) {
                  const lines = selectedText.split('\n').filter(l => l.trim());
                  const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                  const newText = textarea.value.substring(0, start) + `<ul>\n${listItems}\n</ul>` + textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  textarea.value = newText;
                  textarea.focus();
                } else {
                  insertQuickTag('<ul>\n<li>', '</li>\n</ul>');
                }
              }
            }
            break;
          case 'o':
            event.preventDefault();
            if (mode === 'visual') {
              editor.commands.toggleOrderedList();
            } else {
              if (textareaRef.current) {
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                if (selectedText) {
                  const lines = selectedText.split('\n').filter(l => l.trim());
                  const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                  const newText = textarea.value.substring(0, start) + `<ol>\n${listItems}\n</ol>` + textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  textarea.value = newText;
                  textarea.focus();
                } else {
                  insertQuickTag('<ol>\n<li>', '</li>\n</ol>');
                }
              }
            }
            break;
          case 'm':
            event.preventDefault();
            setShowMediaModal(true);
            break;
          case 'l':
            event.preventDefault();
            if (mode === 'visual' && editor) {
              const { from, to } = editor.state.selection;
              const selectedContent = editor.state.doc.textBetween(from, to);
              if (selectedContent) {
                editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: left;">${selectedContent}</p>`).run();
              } else {
                editor.chain().focus().insertContent('<p style="text-align: left;"></p>').run();
              }
            }
            break;
          case 'c':
            event.preventDefault();
            if (mode === 'visual' && editor) {
              const { from, to } = editor.state.selection;
              const selectedContent = editor.state.doc.textBetween(from, to);
              if (selectedContent) {
                editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: center;">${selectedContent}</p>`).run();
              } else {
                editor.chain().focus().insertContent('<p style="text-align: center;"></p>').run();
              }
            }
            break;
          case 'r':
            event.preventDefault();
            if (mode === 'visual' && editor) {
              const { from, to } = editor.state.selection;
              const selectedContent = editor.state.doc.textBetween(from, to);
              if (selectedContent) {
                editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: right;">${selectedContent}</p>`).run();
              } else {
                editor.chain().focus().insertContent('<p style="text-align: right;"></p>').run();
              }
            }
            break;
          case 'j':
            event.preventDefault();
            if (mode === 'visual' && editor) {
              const { from, to } = editor.state.selection;
              const selectedContent = editor.state.doc.textBetween(from, to);
              if (selectedContent) {
                editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: justify;">${selectedContent}</p>`).run();
              } else {
                editor.chain().focus().insertContent('<p style="text-align: justify;"></p>').run();
              }
            }
            break;
          case 'z':
            event.preventDefault();
            setShowToolbarRow2(!showToolbarRow2);
            break;
          case 'w':
            // Distraction-free mode - Toggle fullscreen editor
            event.preventDefault();
            if (editor) {
              const editorElement = editor.view.dom.closest('.border');
              if (editorElement) {
                if (document.fullscreenElement) {
                  document.exitFullscreen();
                } else {
                  editorElement.requestFullscreen().catch(() => {
                    // Fallback: Just hide/show toolbar
                    setShowToolbarRow2(false);
                  });
                }
              }
            }
            break;
        }
      }
    };

    const editorElement = editor.view.dom;
    editorElement.addEventListener('keydown', handleKeyDown);

    return () => {
      editorElement.removeEventListener('keydown', handleKeyDown);
    };
  }, [editor, mode, showToolbarRow2]);

  // Handle sticky toolbar on scroll
  useEffect(() => {
    let timeoutId: NodeJS.Timeout | null = null;
    let cleanup: (() => void) | null = null;

    const setupScrollListener = () => {
      if (!toolbarRef.current || !editorContainerRef.current) {
        // Retry after a short delay
        timeoutId = setTimeout(setupScrollListener, 100);
        return;
      }

      const handleScroll = () => {
        const toolbar = toolbarRef.current;
        const container = editorContainerRef.current;
        if (!toolbar || !container) return;

        const toolbarRect = toolbar.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const scrollY = window.scrollY || window.pageYOffset;
        
        // Admin bar height (32px as per spec)
        const adminBarHeight = 32;
        
        // Check if toolbar is scrolled out of view (above viewport)
        const isToolbarOutOfView = toolbarRect.top < adminBarHeight;
        
        // Check if we're still within the editor container
        // Toolbar should hide when we scroll past the container bottom or before container top
        const containerTop = containerRect.top;
        const containerBottom = containerRect.bottom;
        const isWithinContainer = containerTop < window.innerHeight && containerBottom > adminBarHeight;
        
        // Show sticky toolbar when:
        // 1. Original toolbar is scrolled out of view (above viewport)
        // 2. We're still within the editor container
        // 3. We've scrolled down (not at the top)
        if (isToolbarOutOfView && isWithinContainer && scrollY > 0) {
          setIsToolbarSticky(true);
        } else {
          setIsToolbarSticky(false);
        }
      };

      // Listen to scroll events on window
      window.addEventListener('scroll', handleScroll, { passive: true });
      // Also check on initial load and resize
      handleScroll();
      window.addEventListener('resize', handleScroll, { passive: true });

      // Store cleanup function
      cleanup = () => {
        window.removeEventListener('scroll', handleScroll);
        window.removeEventListener('resize', handleScroll);
      };
    };

    // Start checking for refs
    setupScrollListener();

    // Return cleanup function
    return () => {
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      if (cleanup) {
        cleanup();
      }
    };
  }, []);

  const handleTextChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newContent = e.target.value;
    setTextContent(newContent);
    onChange(newContent);
  };

  const insertQuickTag = (openTag: string, closeTag: string, insertText?: string) => {
    if (!textareaRef.current) return;

    const textarea = textareaRef.current;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const textToWrap = insertText || selectedText;

    let newText: string;
    let newCursorPos: number;

    if (textToWrap) {
      // Wrap text (either selected or provided)
      newText =
        textarea.value.substring(0, start) +
        `${openTag}${textToWrap}${closeTag}` +
        textarea.value.substring(end);
      newCursorPos = start + openTag.length + textToWrap.length + closeTag.length;
    } else {
      // Insert tags at cursor (for empty selection)
      newText =
        textarea.value.substring(0, start) +
        `${openTag}${closeTag}` +
        textarea.value.substring(end);
      newCursorPos = start + openTag.length;
    }

    // Update state and textarea
    setTextContent(newText);
    onChange(newText);
    
    // Use setTimeout to ensure DOM is updated before setting selection
    setTimeout(() => {
      if (textareaRef.current) {
        textareaRef.current.value = newText;
        textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
        textareaRef.current.focus();
      }
    }, 0);
  };

  const addLink = () => {
    const url = prompt('Nhập URL:');
    if (!url) return;

    // Validate URL format
    try {
      new URL(url);
    } catch {
      // If not valid URL, try adding http://
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        const fullUrl = `http://${url}`;
        try {
          new URL(fullUrl);
          // Use fullUrl if valid
        } catch {
          alert('URL không hợp lệ');
          return;
        }
      } else {
        alert('URL không hợp lệ');
        return;
      }
    }

    if (mode === 'visual' && editor) {
      const selectedText = editor.state.doc.textBetween(
        editor.state.selection.from,
        editor.state.selection.to
      );
      if (selectedText) {
        // If text is selected, wrap it in link
        editor.chain().focus().setLink({ href: url }).run();
      } else {
        // If no text selected, insert link with URL as text
        editor.chain().focus().insertContent(`<a href="${url}">${url}</a>`).run();
      }
    } else {
      // Text mode
      if (!textareaRef.current) return;
      const textarea = textareaRef.current;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      
      const linkText = selectedText || prompt('Nhập text hiển thị:', url) || url;
      insertQuickTag(`<a href="${url}">`, '</a>', linkText);
    }
  };

  const addImage = () => {
    const url = prompt('Nhập URL hình ảnh:');
    if (!url) return;

    // Validate URL
    try {
      new URL(url);
    } catch {
      // If not valid URL, try adding http://
      if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('/')) {
        alert('URL không hợp lệ. Vui lòng nhập URL đầy đủ (VD: https://example.com/image.jpg)');
        return;
      }
    }

    const alt = prompt('Nhập Alt Text (tùy chọn):') || '';

    if (mode === 'visual' && editor) {
      editor.chain().focus().setImage({ src: url, alt: alt || undefined }).run();
      // Update textContent for sync
      const newHtml = editor.getHTML();
      setTextContent(newHtml);
      onChange(newHtml);
    } else {
      const imgTag = alt ? `<img src="${url}" alt="${alt}" />` : `<img src="${url}" />`;
      if (textareaRef.current) {
        const textarea = textareaRef.current;
        const start = textarea.selectionStart;
        const newText =
          textarea.value.substring(0, start) + imgTag + textarea.value.substring(start);
        setTextContent(newText);
        onChange(newText);
        
        setTimeout(() => {
          if (textareaRef.current) {
            textareaRef.current.value = newText;
            const newCursorPos = start + imgTag.length;
            textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
            textareaRef.current.focus();
          }
        }, 0);
      }
    }
  };

  const insertReadMore = () => {
    if (mode === 'visual' && editor) {
      editor.chain().focus().insertContent('<!--more-->').run();
      // Update textContent for sync
      const newHtml = editor.getHTML();
      setTextContent(newHtml);
      onChange(newHtml);
    } else {
      if (textareaRef.current) {
        const textarea = textareaRef.current;
        const start = textarea.selectionStart;
        const newText =
          textarea.value.substring(0, start) +
          '<!--more-->' +
          textarea.value.substring(start);
        setTextContent(newText);
        onChange(newText);
        
        setTimeout(() => {
          if (textareaRef.current) {
            textareaRef.current.value = newText;
            const newCursorPos = start + '<!--more-->'.length;
            textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
            textareaRef.current.focus();
          }
        }, 0);
      }
    }
  };

  // Show loading state while editor initializes
  if (!editor) {
    return (
      <div className="border border-input rounded-lg p-8 text-center">
        <div className="text-muted-foreground">Đang tải editor...</div>
      </div>
    );
  }

  return (
    <div ref={editorContainerRef} className="border border-input rounded-lg overflow-hidden">
      {/* Sticky Toolbar (shown when scrolled) */}
      {isToolbarSticky && toolbarRef.current && (() => {
        const toolbar = toolbarRef.current;
        if (!toolbar) return null;
        const toolbarRect = toolbar.getBoundingClientRect();
        const stickyStyle: React.CSSProperties = {
          position: 'fixed',
          top: '32px',
          width: toolbar.offsetWidth + 'px',
          left: toolbarRect.left + 'px',
          zIndex: 9999,
          backgroundColor: 'hsl(var(--muted))',
        };
        return (
          <div 
            className="bg-muted border-b border-input shadow-lg"
            style={stickyStyle}
          >
          {/* Render same toolbar content as original - using same structure */}
          {/* Row 1: Add Media + Core Formatting */}
          <div className="flex items-center gap-1 p-2 border-b border-input">
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => setShowMediaModal(true)}
              className="mr-2"
            >
              <Upload className="h-4 w-4 mr-1" />
              Thêm Media
            </Button>
            <div className="h-6 w-px bg-border mx-1" />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().toggleBold().run();
                } else if (mode === 'text') {
                  insertQuickTag('<strong>', '</strong>');
                }
              }}
              className={mode === 'visual' && editor?.isActive('bold') ? 'bg-background' : ''}
              disabled={mode === 'text' && !textareaRef.current}
              title="In đậm (Ctrl+B)"
            >
              <Bold className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().toggleItalic().run();
                } else if (mode === 'text') {
                  insertQuickTag('<em>', '</em>');
                }
              }}
              className={mode === 'visual' && editor?.isActive('italic') ? 'bg-background' : ''}
              disabled={mode === 'text' && !textareaRef.current}
              title="In nghiêng (Ctrl+I)"
            >
              <Italic className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().toggleStrike().run();
                } else if (mode === 'text') {
                  insertQuickTag('<del>', '</del>');
                }
              }}
              className={mode === 'visual' && editor?.isActive('strike') ? 'bg-background' : ''}
              disabled={mode === 'text' && !textareaRef.current}
              title="Gạch ngang"
            >
              <Strikethrough className="h-4 w-4" />
            </Button>
            <div className="h-6 w-px bg-border mx-1" />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().toggleBulletList().run();
                } else if (mode === 'text' && textareaRef.current) {
                  const textarea = textareaRef.current;
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = textarea.value.substring(start, end);
                  if (selectedText) {
                    const lines = selectedText.split('\n').filter(l => l.trim());
                    const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                    const newText = textarea.value.substring(0, start) + `<ul>\n${listItems}\n</ul>` + textarea.value.substring(end);
                    setTextContent(newText);
                    onChange(newText);
                    textarea.value = newText;
                    textarea.focus();
                  } else {
                    insertQuickTag('<ul>\n<li>', '</li>\n</ul>');
                  }
                }
              }}
              className={mode === 'visual' && editor?.isActive('bulletList') ? 'bg-background' : ''}
              disabled={mode === 'text' && !textareaRef.current}
              title="Danh sách không thứ tự"
            >
              <List className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().toggleOrderedList().run();
                } else if (mode === 'text' && textareaRef.current) {
                  const textarea = textareaRef.current;
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = textarea.value.substring(start, end);
                  if (selectedText) {
                    const lines = selectedText.split('\n').filter(l => l.trim());
                    const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                    const newText = textarea.value.substring(0, start) + `<ol>\n${listItems}\n</ol>` + textarea.value.substring(end);
                    setTextContent(newText);
                    onChange(newText);
                    textarea.value = newText;
                    textarea.focus();
                  } else {
                    insertQuickTag('<ol>\n<li>', '</li>\n</ol>');
                  }
                }
              }}
              className={mode === 'visual' && editor?.isActive('orderedList') ? 'bg-background' : ''}
              disabled={mode === 'text' && !textareaRef.current}
              title="Danh sách có thứ tự"
            >
              <ListOrdered className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().toggleBlockquote().run();
                } else if (mode === 'text') {
                  insertQuickTag('<blockquote>', '</blockquote>');
                }
              }}
              className={mode === 'visual' && editor?.isActive('blockquote') ? 'bg-background' : ''}
              disabled={mode === 'text' && !textareaRef.current}
              title="Trích dẫn"
            >
              <Quote className="h-4 w-4" />
            </Button>
            <div className="h-6 w-px bg-border mx-1" />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().setHorizontalRule().run();
                } else if (mode === 'text' && textareaRef.current) {
                  const textarea = textareaRef.current;
                  const start = textarea.selectionStart;
                  const newText = textarea.value.substring(0, start) + '<hr />' + textarea.value.substring(start);
                  setTextContent(newText);
                  onChange(newText);
                  setTimeout(() => {
                    if (textareaRef.current) {
                      textareaRef.current.value = newText;
                      textareaRef.current.setSelectionRange(start + '<hr />'.length, start + '<hr />'.length);
                      textareaRef.current.focus();
                    }
                  }, 0);
                }
              }}
              disabled={mode === 'text' && !textareaRef.current}
              title="Đường kẻ ngang"
            >
              <Minus className="h-4 w-4" />
            </Button>
            <div className="h-6 w-px bg-border mx-1" />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={addLink}
              title="Chèn/Sửa liên kết"
            >
              <LinkIcon className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={insertReadMore}
              title="Thẻ Đọc tiếp"
            >
              <Type className="h-4 w-4" />
            </Button>
            <div className="flex-1" />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => setShowToolbarRow2(!showToolbarRow2)}
              title="Mở rộng thanh công cụ"
            >
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </div>
          {/* Row 2: Advanced Formatting (Toggle) */}
          {showToolbarRow2 && (
            <div className="flex items-center gap-1 p-2 border-b border-input">
              <Select
                defaultValue="paragraph"
                onValueChange={(value) => {
                  if (mode === 'visual' && editor) {
                    if (value === 'paragraph') {
                      editor.chain().focus().setParagraph().run();
                    } else if (value.startsWith('heading')) {
                      const level = parseInt(value.replace('heading', '')) as 1 | 2 | 3 | 4 | 5 | 6;
                      editor.chain().focus().toggleHeading({ level }).run();
                    }
                  }
                }}
                disabled={mode === 'text'}
              >
                <SelectTrigger className="w-40 h-8 text-xs">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="paragraph">Đoạn văn</SelectItem>
                  <SelectItem value="heading1">Tiêu đề 1</SelectItem>
                  <SelectItem value="heading2">Tiêu đề 2</SelectItem>
                  <SelectItem value="heading3">Tiêu đề 3</SelectItem>
                  <SelectItem value="heading4">Tiêu đề 4</SelectItem>
                  <SelectItem value="heading5">Tiêu đề 5</SelectItem>
                  <SelectItem value="heading6">Tiêu đề 6</SelectItem>
                </SelectContent>
              </Select>
              <div className="h-6 w-px bg-border mx-1" />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => {
                  if (editor) {
                    const { from, to } = editor.state.selection;
                    const selectedText = editor.state.doc.textBetween(from, to);
                    if (selectedText) {
                      editor.chain().focus().deleteSelection().insertContent(`<u>${selectedText}</u>`).run();
                    } else {
                      editor.chain().focus().insertContent('<u></u>').run();
                    }
                  }
                }}
                title="Gạch chân"
              >
                <UnderlineIcon className="h-4 w-4" />
              </Button>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => {
                  if (editor) {
                    const { from, to } = editor.state.selection;
                    const selectedContent = editor.state.doc.textBetween(from, to);
                    if (selectedContent) {
                      editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: justify;">${selectedContent}</p>`).run();
                    } else {
                      const { $from } = editor.state.selection;
                      const paragraph = $from.node(-1);
                      if (paragraph && paragraph.type.name === 'paragraph') {
                        const paraText = paragraph.textContent;
                        const paraStart = $from.start(-1);
                        const paraEnd = $from.end(-1);
                        editor.chain().focus().setTextSelection({ from: paraStart, to: paraEnd }).deleteSelection().insertContent(`<p style="text-align: justify;">${paraText}</p>`).run();
                      } else {
                        editor.chain().focus().insertContent('<p style="text-align: justify;"></p>').run();
                      }
                    }
                  }
                }}
                title="Căn đều 2 bên"
              >
                <AlignJustify className="h-4 w-4" />
              </Button>
              <div className="h-6 w-px bg-border mx-1" />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => {
                  const color = prompt('Nhập mã màu (VD: #FF0000):');
                  if (!color) return;
                  const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                  if (!colorRegex.test(color) && !['red', 'blue', 'green', 'black', 'white'].includes(color.toLowerCase())) {
                    alert('Mã màu không hợp lệ. Sử dụng format #RRGGBB hoặc tên màu.');
                    return;
                  }
                  if (mode === 'visual' && editor) {
                    const { from, to } = editor.state.selection;
                    const selectedText = editor.state.doc.textBetween(from, to);
                    if (selectedText) {
                      editor.chain().focus().deleteSelection().insertContent(`<span style="color: ${color};">${selectedText}</span>`).run();
                    } else {
                      editor.chain().focus().insertContent(`<span style="color: ${color};">text</span>`).run();
                    }
                  } else if (mode === 'text' && textareaRef.current) {
                    const textarea = textareaRef.current;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const selectedText = textarea.value.substring(start, end);
                    const wrappedText = selectedText || 'text';
                    const newText = textarea.value.substring(0, start) + `<span style="color: ${color};">${wrappedText}</span>` + textarea.value.substring(end);
                    setTextContent(newText);
                    onChange(newText);
                    setTimeout(() => {
                      if (textareaRef.current) {
                        textareaRef.current.value = newText;
                        const newCursorPos = start + `<span style="color: ${color};">${wrappedText}</span>`.length;
                        textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
                        textareaRef.current.focus();
                      }
                    }, 0);
                  }
                }}
                disabled={mode === 'text' && !textareaRef.current}
                title="Màu chữ"
              >
                <Palette className="h-4 w-4" />
              </Button>
              <div className="h-6 w-px bg-border mx-1" />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => {
                  if (mode === 'visual' && editor) {
                    editor.chain().focus().unsetBold().unsetItalic().unsetStrike().run();
                  }
                }}
                disabled={mode === 'text' || !editor?.can().unsetBold()}
                title="Tẩy định dạng"
              >
                <Code className="h-4 w-4" />
              </Button>
            </div>
          )}
          </div>
        );
      })()}

      {/* Toolbar */}
      <div ref={toolbarRef} className="bg-muted border-b border-input">
        {/* Row 1: Add Media + Core Formatting */}
        <div className="flex items-center gap-1 p-2 border-b border-input">
          {/* Add Media Button */}
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setShowMediaModal(true)}
            className="mr-2"
          >
            <Upload className="h-4 w-4 mr-1" />
            Thêm Media
          </Button>

          <div className="h-6 w-px bg-border mx-1" />

          {/* Core Formatting */}
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().toggleBold().run();
              } else if (mode === 'text') {
                insertQuickTag('<strong>', '</strong>');
              }
            }}
            className={mode === 'visual' && editor?.isActive('bold') ? 'bg-background' : ''}
            disabled={mode === 'text' && !textareaRef.current}
            title="In đậm (Ctrl+B)"
          >
            <Bold className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().toggleItalic().run();
              } else if (mode === 'text') {
                insertQuickTag('<em>', '</em>');
              }
            }}
            className={mode === 'visual' && editor?.isActive('italic') ? 'bg-background' : ''}
            disabled={mode === 'text' && !textareaRef.current}
            title="In nghiêng (Ctrl+I)"
          >
            <Italic className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().toggleStrike().run();
              } else if (mode === 'text') {
                insertQuickTag('<del>', '</del>');
              }
            }}
            className={mode === 'visual' && editor?.isActive('strike') ? 'bg-background' : ''}
            disabled={mode === 'text' && !textareaRef.current}
            title="Gạch ngang"
          >
            <Strikethrough className="h-4 w-4" />
          </Button>

          <div className="h-6 w-px bg-border mx-1" />

          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().toggleBulletList().run();
              } else if (mode === 'text' && textareaRef.current) {
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                if (selectedText) {
                  const lines = selectedText.split('\n').filter(l => l.trim());
                  const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                  const newText = textarea.value.substring(0, start) + `<ul>\n${listItems}\n</ul>` + textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  textarea.value = newText;
                  textarea.focus();
                } else {
                  insertQuickTag('<ul>\n<li>', '</li>\n</ul>');
                }
              }
            }}
            className={mode === 'visual' && editor?.isActive('bulletList') ? 'bg-background' : ''}
            disabled={mode === 'text' && !textareaRef.current}
            title="Danh sách không thứ tự"
          >
            <List className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().toggleOrderedList().run();
              } else if (mode === 'text' && textareaRef.current) {
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                if (selectedText) {
                  const lines = selectedText.split('\n').filter(l => l.trim());
                  const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                  const newText = textarea.value.substring(0, start) + `<ol>\n${listItems}\n</ol>` + textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  textarea.value = newText;
                  textarea.focus();
                } else {
                  insertQuickTag('<ol>\n<li>', '</li>\n</ol>');
                }
              }
            }}
            className={mode === 'visual' && editor?.isActive('orderedList') ? 'bg-background' : ''}
            disabled={mode === 'text' && !textareaRef.current}
            title="Danh sách có thứ tự"
          >
            <ListOrdered className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().toggleBlockquote().run();
              } else if (mode === 'text') {
                insertQuickTag('<blockquote>', '</blockquote>');
              }
            }}
            className={mode === 'visual' && editor?.isActive('blockquote') ? 'bg-background' : ''}
            disabled={mode === 'text' && !textareaRef.current}
            title="Trích dẫn"
          >
            <Quote className="h-4 w-4" />
          </Button>

          <div className="h-6 w-px bg-border mx-1" />

          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                editor.chain().focus().setHorizontalRule().run();
              } else if (mode === 'text' && textareaRef.current) {
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const newText = textarea.value.substring(0, start) + '<hr />' + textarea.value.substring(start);
                setTextContent(newText);
                onChange(newText);
                setTimeout(() => {
                  if (textareaRef.current) {
                    textareaRef.current.value = newText;
                    textareaRef.current.setSelectionRange(start + '<hr />'.length, start + '<hr />'.length);
                    textareaRef.current.focus();
                  }
                }, 0);
              }
            }}
            disabled={mode === 'text' && !textareaRef.current}
            title="Đường kẻ ngang"
          >
            <Minus className="h-4 w-4" />
          </Button>

          <div className="h-6 w-px bg-border mx-1" />

          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                const { from, to } = editor.state.selection;
                const selectedContent = editor.state.doc.textBetween(from, to);
                if (selectedContent) {
                  editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: left;">${selectedContent}</p>`).run();
                } else {
                  const { $from } = editor.state.selection;
                  const paragraph = $from.node(-1);
                  if (paragraph && paragraph.type.name === 'paragraph') {
                    const paraText = paragraph.textContent;
                    const paraStart = $from.start(-1);
                    const paraEnd = $from.end(-1);
                    editor.chain().focus().setTextSelection({ from: paraStart, to: paraEnd }).deleteSelection().insertContent(`<p style="text-align: left;">${paraText}</p>`).run();
                  } else {
                    editor.chain().focus().insertContent('<p style="text-align: left;"></p>').run();
                  }
                }
              }
              // Alignment buttons don't work well in text mode, so disable them
            }}
            disabled={mode === 'text'}
            title="Căn trái"
          >
            <AlignLeft className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                const { from, to } = editor.state.selection;
                const selectedContent = editor.state.doc.textBetween(from, to);
                if (selectedContent) {
                  editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: center;">${selectedContent}</p>`).run();
                } else {
                  const { $from } = editor.state.selection;
                  const paragraph = $from.node(-1);
                  if (paragraph && paragraph.type.name === 'paragraph') {
                    const paraText = paragraph.textContent;
                    const paraStart = $from.start(-1);
                    const paraEnd = $from.end(-1);
                    editor.chain().focus().setTextSelection({ from: paraStart, to: paraEnd }).deleteSelection().insertContent(`<p style="text-align: center;">${paraText}</p>`).run();
                  } else {
                    editor.chain().focus().insertContent('<p style="text-align: center;"></p>').run();
                  }
                }
              }
            }}
            disabled={mode === 'text'}
            title="Căn giữa"
          >
            <AlignCenter className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => {
              if (mode === 'visual' && editor) {
                const { from, to } = editor.state.selection;
                const selectedContent = editor.state.doc.textBetween(from, to);
                if (selectedContent) {
                  editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: right;">${selectedContent}</p>`).run();
                } else {
                  const { $from } = editor.state.selection;
                  const paragraph = $from.node(-1);
                  if (paragraph && paragraph.type.name === 'paragraph') {
                    const paraText = paragraph.textContent;
                    const paraStart = $from.start(-1);
                    const paraEnd = $from.end(-1);
                    editor.chain().focus().setTextSelection({ from: paraStart, to: paraEnd }).deleteSelection().insertContent(`<p style="text-align: right;">${paraText}</p>`).run();
                  } else {
                    editor.chain().focus().insertContent('<p style="text-align: right;"></p>').run();
                  }
                }
              }
            }}
            disabled={mode === 'text'}
            title="Căn phải"
          >
            <AlignRight className="h-4 w-4" />
          </Button>

          <div className="h-6 w-px bg-border mx-1" />

          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={addLink}
            title="Chèn/Sửa liên kết"
          >
            <LinkIcon className="h-4 w-4" />
          </Button>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={insertReadMore}
            title="Thẻ Đọc tiếp"
          >
            <Type className="h-4 w-4" />
          </Button>

          <div className="flex-1" />

          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => setShowToolbarRow2(!showToolbarRow2)}
            title="Mở rộng thanh công cụ"
          >
            <MoreHorizontal className="h-4 w-4" />
          </Button>
        </div>

        {/* Row 2: Advanced Formatting (Toggle) */}
        {showToolbarRow2 && (
          <div className="flex items-center gap-1 p-2 border-b border-input">
            <Select
              defaultValue="paragraph"
              onValueChange={(value) => {
                if (mode === 'visual' && editor) {
                  if (value === 'paragraph') {
                    editor.chain().focus().setParagraph().run();
                  } else if (value.startsWith('heading')) {
                    const level = parseInt(value.replace('heading', '')) as 1 | 2 | 3 | 4 | 5 | 6;
                    editor.chain().focus().toggleHeading({ level }).run();
                  }
                }
              }}
              disabled={mode === 'text'}
            >
              <SelectTrigger className="w-40 h-8 text-xs">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="paragraph">Đoạn văn</SelectItem>
                <SelectItem value="heading1">Tiêu đề 1</SelectItem>
                <SelectItem value="heading2">Tiêu đề 2</SelectItem>
                <SelectItem value="heading3">Tiêu đề 3</SelectItem>
                <SelectItem value="heading4">Tiêu đề 4</SelectItem>
                <SelectItem value="heading5">Tiêu đề 5</SelectItem>
                <SelectItem value="heading6">Tiêu đề 6</SelectItem>
              </SelectContent>
            </Select>

            <div className="h-6 w-px bg-border mx-1" />

            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                // Underline - wrap selected text in <u> tag
                if (editor) {
                  const { from, to } = editor.state.selection;
                  const selectedText = editor.state.doc.textBetween(from, to);
                  if (selectedText) {
                    // Delete selected text first, then insert wrapped version
                    editor.chain().focus().deleteSelection().insertContent(`<u>${selectedText}</u>`).run();
                  } else {
                    editor.chain().focus().insertContent('<u></u>').run();
                  }
                }
              }}
              title="Gạch chân"
            >
              <UnderlineIcon className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (editor) {
                  const { from, to } = editor.state.selection;
                  const selectedContent = editor.state.doc.textBetween(from, to);
                  if (selectedContent) {
                    editor.chain().focus().deleteSelection().insertContent(`<p style="text-align: justify;">${selectedContent}</p>`).run();
                  } else {
                    const { $from } = editor.state.selection;
                    const paragraph = $from.node(-1);
                    if (paragraph && paragraph.type.name === 'paragraph') {
                      const paraText = paragraph.textContent;
                      const paraStart = $from.start(-1);
                      const paraEnd = $from.end(-1);
                      editor.chain().focus().setTextSelection({ from: paraStart, to: paraEnd }).deleteSelection().insertContent(`<p style="text-align: justify;">${paraText}</p>`).run();
                    } else {
                      editor.chain().focus().insertContent('<p style="text-align: justify;"></p>').run();
                    }
                  }
                }
              }}
              title="Căn đều 2 bên"
            >
              <AlignJustify className="h-4 w-4" />
            </Button>

            <div className="h-6 w-px bg-border mx-1" />

            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                const color = prompt('Nhập mã màu (VD: #FF0000):');
                if (!color) return;
                
                // Validate color format
                const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                if (!colorRegex.test(color) && !['red', 'blue', 'green', 'black', 'white'].includes(color.toLowerCase())) {
                  alert('Mã màu không hợp lệ. Sử dụng format #RRGGBB hoặc tên màu.');
                  return;
                }

                if (mode === 'visual' && editor) {
                  const { from, to } = editor.state.selection;
                  const selectedText = editor.state.doc.textBetween(from, to);
                  if (selectedText) {
                    editor.chain().focus().deleteSelection().insertContent(`<span style="color: ${color};">${selectedText}</span>`).run();
                  } else {
                    editor.chain().focus().insertContent(`<span style="color: ${color};">text</span>`).run();
                  }
                } else if (mode === 'text' && textareaRef.current) {
                  const textarea = textareaRef.current;
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = textarea.value.substring(start, end);
                  const wrappedText = selectedText || 'text';
                  const newText = textarea.value.substring(0, start) + `<span style="color: ${color};">${wrappedText}</span>` + textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  setTimeout(() => {
                    if (textareaRef.current) {
                      textareaRef.current.value = newText;
                      const newCursorPos = start + `<span style="color: ${color};">${wrappedText}</span>`.length;
                      textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
                      textareaRef.current.focus();
                    }
                  }, 0);
                }
              }}
              disabled={mode === 'text' && !textareaRef.current}
              title="Màu chữ"
            >
              <Palette className="h-4 w-4" />
            </Button>

            <div className="h-6 w-px bg-border mx-1" />

            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  // Clear formatting - remove all marks
                  editor.chain().focus().unsetBold().unsetItalic().unsetStrike().run();
                }
                // In text mode, clearing formatting is not straightforward, so disable
              }}
              disabled={mode === 'text' || !editor?.can().unsetBold()}
              title="Tẩy định dạng"
            >
              <Code className="h-4 w-4" />
            </Button>

            <div className="h-6 w-px bg-border mx-1" />

            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().undo().run();
                }
                // Undo/Redo in text mode would need custom implementation
              }}
              disabled={mode === 'text' || !editor?.can().undo()}
              title="Hoàn tác (Ctrl+Z)"
            >
              <Undo className="h-4 w-4" />
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (mode === 'visual' && editor) {
                  editor.chain().focus().redo().run();
                }
              }}
              disabled={mode === 'text' || !editor?.can().redo()}
              title="Làm lại (Ctrl+Y)"
            >
              <Redo className="h-4 w-4" />
            </Button>
          </div>
        )}

        {/* Mode Toggle */}
        <div className="flex items-center justify-between p-2 bg-background">
          <div className="flex gap-1">
            <Button
              type="button"
              variant={mode === 'visual' ? 'default' : 'ghost'}
              size="sm"
              onClick={() => setMode('visual')}
              className="h-7"
            >
              <Eye className="h-3 w-3 mr-1" />
              Trực quan
            </Button>
            <Button
              type="button"
              variant={mode === 'text' ? 'default' : 'ghost'}
              size="sm"
              onClick={() => setMode('text')}
              className="h-7"
            >
              <Code2 className="h-3 w-3 mr-1" />
              Văn bản
            </Button>
          </div>
        </div>
      </div>

      {/* Editor Content */}
      {mode === 'visual' ? (
        <ImageEditorErrorBoundary>
          <div className="relative">
            <EditorContent editor={editor} />
            {editor && <InlineImageToolbar editor={editor} />}
          </div>
        </ImageEditorErrorBoundary>
      ) : (
        <div className="relative">
          {/* QuickTags Toolbar for Text Mode */}
          <div ref={toolbarRef} className="border-b border-input p-2 bg-muted flex gap-1 flex-wrap">
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => insertQuickTag('<strong>', '</strong>')}
              className="h-7 text-xs"
            >
              b
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => insertQuickTag('<em>', '</em>')}
              className="h-7 text-xs"
            >
              i
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => insertQuickTag('<del>', '</del>')}
              className="h-7 text-xs"
            >
              del
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => insertQuickTag('<code>', '</code>')}
              className="h-7 text-xs"
            >
              code
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={addLink}
              className="h-7 text-xs"
            >
              link
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={addImage}
              className="h-7 text-xs"
            >
              img
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (!textareaRef.current) return;
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                
                if (selectedText) {
                  // Wrap each line in <li>
                  const lines = selectedText.split('\n').filter(l => l.trim());
                  const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                  const newText =
                    textarea.value.substring(0, start) +
                    `<ul>\n${listItems}\n</ul>` +
                    textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  textarea.value = newText;
                  textarea.focus();
                } else {
                  insertQuickTag('<ul>\n<li>', '</li>\n</ul>');
                }
              }}
              className="h-7 text-xs"
            >
              ul
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                if (!textareaRef.current) return;
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                
                if (selectedText) {
                  // Wrap each line in <li>
                  const lines = selectedText.split('\n').filter(l => l.trim());
                  const listItems = lines.map(line => `<li>${line}</li>`).join('\n');
                  const newText =
                    textarea.value.substring(0, start) +
                    `<ol>\n${listItems}\n</ol>` +
                    textarea.value.substring(end);
                  setTextContent(newText);
                  onChange(newText);
                  textarea.value = newText;
                  textarea.focus();
                } else {
                  insertQuickTag('<ol>\n<li>', '</li>\n</ol>');
                }
              }}
              className="h-7 text-xs"
            >
              ol
            </Button>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => insertQuickTag('<blockquote>', '</blockquote>')}
              className="h-7 text-xs"
            >
              quote
            </Button>
          </div>
          <Textarea
            ref={textareaRef}
            value={textContent}
            onChange={handleTextChange}
            className="min-h-[300px] font-mono text-sm rounded-none border-0 focus-visible:ring-0"
            placeholder="Nhập HTML hoặc văn bản..."
          />
        </div>
      )}

      {/* Media Library Modal */}
      <MediaLibraryModal
        isOpen={showMediaModal}
        onClose={() => setShowMediaModal(false)}
        onInsert={(html) => {
          if (!html) return;
          if (mode === 'visual' && editor) {
            // Check if we're inserting a video embed wrapper
            if (html.includes('video-embed-wrapper')) {
              // Parse the HTML to extract wrapper and iframe
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = html;
              const wrapper = tempDiv.querySelector('div.video-embed-wrapper');
              const iframe = wrapper?.querySelector('iframe');
              
              if (wrapper && iframe) {
                // Extract attributes
                const wrapperStyle = wrapper.getAttribute('style') || '';
                const wrapperClass = wrapper.getAttribute('class') || 'video-embed-wrapper';
                const iframeAttrs = {
                  src: iframe.getAttribute('src') || '',
                  frameborder: iframe.getAttribute('frameborder') || '0',
                  allowfullscreen: iframe.hasAttribute('allowfullscreen'),
                  allow: iframe.getAttribute('allow') || '',
                  style: iframe.getAttribute('style') || '',
                  class: iframe.getAttribute('class') || '',
                  width: iframe.getAttribute('width') || '100%',
                  height: iframe.getAttribute('height') || '400px',
                };
                
                try {
                  // Insert as proper node structure to avoid paragraph wrapping
                  editor.chain()
                    .focus()
                    .insertContent({
                      type: 'videoEmbedWrapper',
                      attrs: {
                        style: wrapperStyle,
                        class: wrapperClass,
                      },
                      content: [
                        {
                          type: 'iframe',
                          attrs: iframeAttrs,
                        },
                      ],
                    })
                    .run();
                } catch (error) {
                  // Fallback to raw HTML insert
                  editor.chain().focus().insertContent(html).run();
                }
              } else {
                // Fallback to raw HTML insert
                editor.chain().focus().insertContent(html).run();
              }
            } else {
              // Insert HTML into Tiptap editor
              editor.chain().focus().insertContent(html).run();
            }
            
            // Update textContent for sync
            const newHtml = editor.getHTML();
            
            // Check if video embed wrapper exists in DOM
            const editorElement = editor.view.dom;
            setTextContent(newHtml);
            onChange(newHtml);
          } else {
            // Insert into textarea
            if (textareaRef.current) {
              const textarea = textareaRef.current;
              const start = textarea.selectionStart;
              const newText =
                textarea.value.substring(0, start) + html + textarea.value.substring(start);
              setTextContent(newText);
              onChange(newText);
              
              // Update textarea and set cursor position
              setTimeout(() => {
                if (textareaRef.current) {
                  textareaRef.current.value = newText;
                  const newCursorPos = start + html.length;
                  textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
                  textareaRef.current.focus();
                }
              }, 0);
            }
          }
        }}
      />
    </div>
  );
}
================================================================================FILE: components/admin/products/CollectionComboSection.tsx================================================================================'use client';

import { useState } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { RelatedProductsSelector } from './RelatedProductsSelector';
import { ComboProductsBuilder } from './ComboProductsBuilder';
import { Plus, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useToastContext } from '@/components/providers/ToastProvider';

interface CollectionComboData {
  collections?: string[]; // Collection IDs/names
  comboProducts?: string[]; // Product IDs
  bundleProducts?: Array<{
    productId: string;
    quantity: number;
    discount?: number;
  }>;
  relatedProducts?: string[];
  upsellProducts?: string[];
  crossSellProducts?: string[];
}

interface CollectionComboSectionProps {
  data: CollectionComboData;
  onChange: (data: CollectionComboData) => void;
}

export function CollectionComboSection({ data, onChange }: CollectionComboSectionProps) {
  const { showToast } = useToastContext();
  const [collectionInput, setCollectionInput] = useState('');

  const updateField = (field: keyof CollectionComboData, value: any) => {
    onChange({ ...data, [field]: value });
  };

  const addCollection = () => {
    if (!collectionInput.trim()) {
      showToast('Vui lòng nhập tên bộ sưu tập', 'error');
      return;
    }
    if (data.collections?.includes(collectionInput.trim())) {
      showToast('Bộ sưu tập đã tồn tại', 'info');
      return;
    }
    updateField('collections', [...(data.collections || []), collectionInput.trim()]);
    showToast(`Đã thêm bộ sưu tập "${collectionInput.trim()}"`, 'success');
    setCollectionInput('');
  };

  const removeCollection = (collection: string) => {
    updateField('collections', data.collections?.filter((c) => c !== collection) || []);
    showToast(`Đã xóa bộ sưu tập "${collection}"`, 'success');
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Bộ sưu tập & Sản phẩm liên quan</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Collections */}
        <div>
          <Label className="mb-3 block">Bộ sưu tập</Label>
          <div className="flex gap-2 mb-2">
            <Input
              value={collectionInput}
              onChange={(e) => setCollectionInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addCollection())}
              placeholder="Nhập tên bộ sưu tập (ví dụ: Gấu bông lớn, Gấu bông nhỏ)"
            />
            <Button type="button" onClick={addCollection} variant="outline">
              <Plus className="w-4 h-4 mr-2" />
              Thêm
            </Button>
          </div>
          {data.collections && data.collections.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {data.collections.map((collection) => (
                <span
                  key={collection}
                  className="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-sm"
                >
                  {collection}
                  <button
                    type="button"
                    onClick={() => removeCollection(collection)}
                    className="hover:text-red-600"
                  >
                    <X className="w-3 h-3" />
                  </button>
                </span>
              ))}
            </div>
          )}
        </div>

        {/* Related Products */}
        <RelatedProductsSelector
          title="Sản phẩm liên quan"
          selectedProductIds={data.relatedProducts || []}
          onChange={(productIds) => updateField('relatedProducts', productIds)}
          placeholder="Tìm kiếm sản phẩm liên quan..."
        />

        {/* Upsell Products */}
        <RelatedProductsSelector
          title="Sản phẩm Upsell (Nâng cấp)"
          selectedProductIds={data.upsellProducts || []}
          onChange={(productIds) => updateField('upsellProducts', productIds)}
          placeholder="Tìm kiếm sản phẩm upsell..."
        />

        {/* Cross-sell Products */}
        <RelatedProductsSelector
          title="Sản phẩm Cross-sell (Thường mua cùng)"
          selectedProductIds={data.crossSellProducts || []}
          onChange={(productIds) => updateField('crossSellProducts', productIds)}
          placeholder="Tìm kiếm sản phẩm cross-sell..."
        />

        {/* Combo Products */}
        <div>
          <Label className="mb-3 block">Sản phẩm Combo (Sản phẩm đơn giản)</Label>
          <div className="border rounded-lg p-4 bg-gray-50">
            <RelatedProductsSelector
              title=""
              selectedProductIds={data.comboProducts || []}
              onChange={(productIds) => updateField('comboProducts', productIds)}
              placeholder="Tìm kiếm sản phẩm để thêm vào combo..."
            />
          </div>
        </div>

        {/* Bundle Products */}
        <div>
          <Label className="mb-3 block">Sản phẩm Bundle (Combo với số lượng và giảm giá)</Label>
          <div className="border rounded-lg p-4 bg-gray-50">
            <ComboProductsBuilder
              bundleProducts={data.bundleProducts || []}
              onChange={(bundleProducts) => updateField('bundleProducts', bundleProducts)}
            />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/ComboProductsBuilder.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Plus, Trash2, Search, X } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';

interface BundleProduct {
  productId: string;
  productName?: string;
  quantity: number;
  discount?: number; // Percentage discount
}

interface ComboProductsBuilderProps {
  bundleProducts: BundleProduct[];
  onChange: (products: BundleProduct[]) => void;
}

export function ComboProductsBuilder({ bundleProducts, onChange }: ComboProductsBuilderProps) {
  const { showToast } = useToastContext();
  const [search, setSearch] = useState('');
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedProductId, setSelectedProductId] = useState<string>('');

  // Search products
  const handleSearch = async () => {
    if (!search.trim()) return;

    setLoading(true);
    try {
      const response = await fetch(`/api/admin/products?search=${encodeURIComponent(search)}&per_page=20`);
      const data = await response.json();
      setSearchResults(data.products || []);
    } catch (error) {
      console.error('Error searching products:', error);
    } finally {
      setLoading(false);
    }
  };

  // Add product to bundle
  const addProduct = (product: any) => {
    if (!bundleProducts.find((p) => p.productId === product._id)) {
      onChange([
        ...bundleProducts,
        {
          productId: product._id,
          productName: product.name,
          quantity: 1,
          discount: 0,
        },
      ]);
      setSearch('');
      setSearchResults([]);
      setSelectedProductId('');
      showToast(`Đã thêm "${product.name}" vào combo`, 'success');
    } else {
      showToast('Sản phẩm đã có trong combo', 'info');
    }
  };

  // Remove product from bundle
  const removeProduct = (productId: string) => {
    const product = bundleProducts.find((p) => p.productId === productId);
    onChange(bundleProducts.filter((p) => p.productId !== productId));
    if (product?.productName) {
      showToast(`Đã xóa "${product.productName}" khỏi combo`, 'success');
    }
  };

  // Update product in bundle
  const updateProduct = (productId: string, field: keyof BundleProduct, value: any) => {
    onChange(
      bundleProducts.map((p) =>
        p.productId === productId ? { ...p, [field]: value } : p
      )
    );
  };

  // Fetch product names for display
  useEffect(() => {
    async function fetchProductNames() {
      const promises = bundleProducts.map(async (bundle) => {
        if (bundle.productName) return bundle;
        try {
          const response = await fetch(`/api/admin/products/${bundle.productId}`);
          const data = await response.json();
          return {
            ...bundle,
            productName: data.product?.name || 'Unknown Product',
          };
        } catch {
          return bundle;
        }
      });
      const updated = await Promise.all(promises);
      if (JSON.stringify(updated) !== JSON.stringify(bundleProducts)) {
        onChange(updated);
      }
    }
    if (bundleProducts.length > 0) {
      fetchProductNames();
    }
  }, [bundleProducts.length]); // Only run when count changes

  return (
    <div className="space-y-4">
      <Label className="font-medium">Sản phẩm Combo/Bundle</Label>

      {/* Search and Add */}
      <div className="flex gap-2">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
          <Input
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleSearch())}
            placeholder="Tìm kiếm sản phẩm để thêm vào combo..."
            className="pl-10"
          />
        </div>
        <Button type="button" onClick={handleSearch} variant="outline" disabled={loading}>
          {loading ? 'Đang tìm...' : 'Tìm kiếm'}
        </Button>
      </div>

      {/* Search Results */}
      {searchResults.length > 0 && (
        <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
          {searchResults
            .filter((p) => !bundleProducts.find((bp) => bp.productId === p._id))
            .map((product) => (
              <div
                key={product._id}
                className="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer"
                onClick={() => addProduct(product)}
              >
                <div className="flex items-center gap-3 flex-1">
                  {product.image?.sourceUrl && (
                    <div className="relative w-12 h-12 rounded overflow-hidden">
                      <Image
                        src={product.image.sourceUrl}
                        alt={product.name}
                        fill
                        className="object-cover"
                        sizes="48px"
                      />
                    </div>
                  )}
                  <div className="flex-1">
                    <p className="text-sm font-medium">{product.name}</p>
                    {product.price && (
                      <p className="text-xs text-gray-500">{product.price} VNĐ</p>
                    )}
                  </div>
                </div>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={(e) => {
                    e.stopPropagation();
                    addProduct(product);
                  }}
                >
                  <Plus className="w-4 h-4" />
                </Button>
              </div>
            ))}
        </div>
      )}

      {/* Bundle Products List */}
      {bundleProducts.length > 0 && (
        <div className="space-y-3">
          {bundleProducts.map((bundle) => (
            <div key={bundle.productId} className="border rounded-lg p-4 space-y-3">
              <div className="flex justify-between items-start">
                <div className="flex-1">
                  <p className="font-medium">{bundle.productName || 'Loading...'}</p>
                </div>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={() => removeProduct(bundle.productId)}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <Label>Số lượng</Label>
                  <Input
                    type="number"
                    min="1"
                    value={bundle.quantity}
                    onChange={(e) =>
                      updateProduct(bundle.productId, 'quantity', parseInt(e.target.value) || 1)
                    }
                  />
                </div>
                <div>
                  <Label>Giảm giá (%)</Label>
                  <Input
                    type="number"
                    min="0"
                    max="100"
                    value={bundle.discount || 0}
                    onChange={(e) =>
                      updateProduct(bundle.productId, 'discount', parseFloat(e.target.value) || 0)
                    }
                    placeholder="0"
                  />
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {bundleProducts.length === 0 && (
        <p className="text-sm text-gray-500 text-center py-4">
          Chưa có sản phẩm nào trong combo. Tìm kiếm và thêm sản phẩm để bắt đầu.
        </p>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/FocalPointPicker.tsx================================================================================'use client';

import { useState, useRef, useEffect, useCallback, useMemo } from 'react';
import Image from 'next/image';
import { Editor } from '@tiptap/react';
import { Button } from '@/components/ui/button';

interface FocalPointPickerProps {
  editor: Editor | null;
  selectedImage: HTMLElement | null;
  isOpen: boolean;
  onClose: () => void;
}

export function FocalPointPicker({
  editor,
  selectedImage,
  isOpen,
  onClose,
}: FocalPointPickerProps) {
  const [focalPoint, setFocalPoint] = useState<{ x: number; y: number } | null>(null);
  const [isDragging, setIsDragging] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);
  const dotRef = useRef<HTMLDivElement>(null);

  // Load existing focal point
  useEffect(() => {
    if (!selectedImage || !isOpen) return;

    const dataFocalX = selectedImage.getAttribute('data-focal-x');
    const dataFocalY = selectedImage.getAttribute('data-focal-y');

    if (dataFocalX && dataFocalY) {
      setFocalPoint({
        x: parseFloat(dataFocalX),
        y: parseFloat(dataFocalY),
      });
    } else {
      // Default to center
      setFocalPoint({ x: 50, y: 50 });
    }
  }, [selectedImage, isOpen]);

  const updateFocalPoint = useCallback((e: React.MouseEvent | MouseEvent) => {
    if (!containerRef.current || !selectedImage) return;

    const rect = containerRef.current.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    // Clamp values between 0 and 100
    const clampedX = Math.max(0, Math.min(100, x));
    const clampedY = Math.max(0, Math.min(100, y));

    setFocalPoint({ x: clampedX, y: clampedY });
  }, [selectedImage]);

  const handleMouseDown = useCallback((e: React.MouseEvent) => {
    if (!containerRef.current) return;
    setIsDragging(true);
    updateFocalPoint(e);
  }, [updateFocalPoint]);

  const handleMouseMove = useCallback((e: React.MouseEvent) => {
    if (!isDragging || !containerRef.current) return;
    updateFocalPoint(e);
  }, [isDragging, updateFocalPoint]);

  const handleMouseUp = useCallback(() => {
    setIsDragging(false);
  }, []);

  // Handle global mouse events for dragging
  useEffect(() => {
    if (!isDragging) return;

    const handleGlobalMouseMove = (e: MouseEvent) => {
      if (!containerRef.current) return;
      updateFocalPoint(e);
    };

    const handleGlobalMouseUp = () => {
      setIsDragging(false);
    };

    document.addEventListener('mousemove', handleGlobalMouseMove);
    document.addEventListener('mouseup', handleGlobalMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleGlobalMouseMove);
      document.removeEventListener('mouseup', handleGlobalMouseUp);
    };
  }, [isDragging, updateFocalPoint]);

  const handleSave = () => {
    if (!editor || !selectedImage || !focalPoint) return;

    const src = selectedImage.getAttribute('src') || '';
    if (!src) return;

    // Find image node position
    let imagePos: number | null = null;
    editor.state.doc.descendants((node, pos) => {
      if (node.type.name === 'image' && node.attrs.src === src) {
        imagePos = pos;
        return false;
      }
    });

    if (imagePos !== null) {
      const imageNode = editor.state.doc.nodeAt(imagePos);
      if (imageNode && imageNode.type.name === 'image') {
        // Update image with focal point
        // Preserve existing style (like filters) and merge object-position
        const existingStyle = imageNode.attrs.style || '';
        let mergedStyle = existingStyle;
        // Remove existing object-position if any
        mergedStyle = mergedStyle.replace(/object-position:\s*[^;]+;?/g, '');
        // Add new object-position
        mergedStyle = `${mergedStyle} object-position: ${focalPoint.x}% ${focalPoint.y}%;`.trim();
        
        editor
          .chain()
          .focus()
          .setNodeSelection(imagePos)
          .updateAttributes('image', {
            ...imageNode.attrs,
            'data-focal-x': focalPoint.x.toString(),
            'data-focal-y': focalPoint.y.toString(),
            style: mergedStyle || undefined,
          })
          .run();
      }
    }

    onClose();
  };

  if (!isOpen || !selectedImage) return null;

  const imageUrl = selectedImage.getAttribute('src') || '';
  const imageWidth = selectedImage.offsetWidth || 400;
  const imageHeight = selectedImage.offsetHeight || 300;

  return (
    <div className="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4">
      <div className="bg-background rounded-lg shadow-lg max-w-2xl w-full p-6">
        <h3 className="text-lg font-semibold mb-4">Điểm lấy nét thông minh</h3>
        <p className="text-sm text-muted-foreground mb-4">
          Click hoặc kéo điểm đỏ để đặt vị trí quan trọng nhất của ảnh. Điểm này sẽ được căn giữa khi ảnh hiển thị ở kích thước khác.
        </p>

        <div
          ref={containerRef}
          className="relative border-2 border-dashed border-input rounded-lg overflow-hidden bg-muted"
          style={{
            width: '100%',
            maxWidth: '600px',
            aspectRatio: `${imageWidth} / ${imageHeight}`,
            margin: '0 auto',
            cursor: 'crosshair',
          }}
          onMouseDown={handleMouseDown}
          onMouseMove={handleMouseMove}
          onMouseUp={handleMouseUp}
        >
          <div className="relative w-full h-full">
            <Image
              src={imageUrl}
              alt="Preview"
              fill
              className="object-cover"
              style={{
                objectPosition: focalPoint ? `${focalPoint.x}% ${focalPoint.y}%` : 'center',
              }}
              sizes="(max-width: 768px) 100vw, 600px"
              draggable={false}
            />
          </div>

          {/* Focal point dot */}
          {focalPoint && (
            <div
              ref={dotRef}
              className="absolute w-4 h-4 bg-red-500 border-2 border-white rounded-full shadow-lg transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"
              style={{
                left: `${focalPoint.x}%`,
                top: `${focalPoint.y}%`,
              }}
            />
          )}
        </div>

        {/* Coordinates display */}
        {focalPoint && (
          <div className="mt-4 text-center text-sm text-muted-foreground">
            Vị trí: {focalPoint.x.toFixed(1)}%, {focalPoint.y.toFixed(1)}%
          </div>
        )}

        <div className="flex justify-end gap-2 mt-6">
          <Button type="button" variant="outline" onClick={onClose}>
            Hủy
          </Button>
          <Button type="button" onClick={handleSave}>
            Lưu
          </Button>
        </div>
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ForceDeleteModal.tsx================================================================================'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { AlertTriangle } from 'lucide-react';
import type { MappedProduct } from '@/lib/utils/productMapper';

interface ForceDeleteModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => Promise<void>;
  product: MappedProduct | null;
}

export function ForceDeleteModal({
  isOpen,
  onClose,
  onConfirm,
  product,
}: ForceDeleteModalProps) {
  const [loading, setLoading] = useState(false);

  const handleConfirm = async () => {
    setLoading(true);
    try {
      await onConfirm();
      onClose();
    } catch (error) {
      console.error('Error force deleting product:', error);
    } finally {
      setLoading(false);
    }
  };

  if (!product) return null;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md border-red-200">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-red-600">
            <AlertTriangle className="w-5 h-5" />
            Xóa vĩnh viễn sản phẩm
          </DialogTitle>
          <DialogDescription className="text-red-600">
            Hành động này không thể hoàn tác!
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-sm font-medium text-red-900 mb-2">
              ⚠️ Cảnh báo
            </p>
            <p className="text-sm text-red-800">
              Sản phẩm sẽ bị xóa vĩnh viễn khỏi hệ thống và không thể khôi phục.
            </p>
          </div>

          <div className="p-3 bg-gray-50 rounded-lg">
            <p className="text-sm font-medium text-gray-900">{product.name}</p>
            {product.sku && (
              <p className="text-xs text-gray-500 mt-1">SKU: {product.sku}</p>
            )}
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={loading}>
            Hủy
          </Button>
          <Button
            variant="destructive"
            onClick={handleConfirm}
            disabled={loading}
            className="min-h-[44px]"
          >
            {loading ? 'Đang xử lý...' : 'Xóa vĩnh viễn'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

================================================================================FILE: components/admin/products/GiftFeaturesSection.tsx================================================================================'use client';

import { useState } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Plus, X } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';

interface GiftFeaturesData {
  giftWrapping: boolean;
  giftWrappingPrice?: number;
  giftMessageEnabled: boolean;
  giftMessageMaxLength?: number;
  giftCardEnabled: boolean;
  giftCardTypes?: string[]; // e.g., ['birthday', 'anniversary', 'graduation']
  giftDeliveryDateEnabled: boolean;
  giftCategories?: string[]; // Gift categories for this product
  giftSuggestions?: string[]; // Suggested gift messages
}

interface GiftFeaturesSectionProps {
  data: GiftFeaturesData;
  onChange: (data: GiftFeaturesData) => void;
}

export function GiftFeaturesSection({ data, onChange }: GiftFeaturesSectionProps) {
  const { showToast } = useToastContext();
  const [giftCategoryInput, setGiftCategoryInput] = useState('');
  const [giftSuggestionInput, setGiftSuggestionInput] = useState('');

  const updateField = (field: keyof GiftFeaturesData, value: any) => {
    onChange({ ...data, [field]: value });
  };

  const addGiftCategory = () => {
    if (!giftCategoryInput.trim()) {
      showToast('Vui lòng nhập danh mục quà tặng', 'error');
      return;
    }
    if (data.giftCategories?.includes(giftCategoryInput.trim())) {
      showToast('Danh mục đã tồn tại', 'info');
      return;
    }
    updateField('giftCategories', [...(data.giftCategories || []), giftCategoryInput.trim()]);
    showToast(`Đã thêm danh mục "${giftCategoryInput.trim()}"`, 'success');
    setGiftCategoryInput('');
  };

  const removeGiftCategory = (category: string) => {
    updateField('giftCategories', data.giftCategories?.filter((c) => c !== category) || []);
    showToast(`Đã xóa danh mục "${category}"`, 'success');
  };

  const addGiftSuggestion = () => {
    if (!giftSuggestionInput.trim()) {
      showToast('Vui lòng nhập gợi ý tin nhắn', 'error');
      return;
    }
    if (data.giftSuggestions?.includes(giftSuggestionInput.trim())) {
      showToast('Gợi ý đã tồn tại', 'info');
      return;
    }
    updateField('giftSuggestions', [...(data.giftSuggestions || []), giftSuggestionInput.trim()]);
    showToast('Đã thêm gợi ý tin nhắn', 'success');
    setGiftSuggestionInput('');
  };

  const removeGiftSuggestion = (suggestion: string) => {
    updateField('giftSuggestions', data.giftSuggestions?.filter((s) => s !== suggestion) || []);
    showToast('Đã xóa gợi ý tin nhắn', 'success');
  };

  const giftCardTypeOptions = [
    'birthday',
    'anniversary',
    'graduation',
    'wedding',
    'newborn',
    'valentine',
    'christmas',
    'thank-you',
    'congratulations',
    'get-well',
  ];

  const toggleGiftCardType = (type: string) => {
    const currentTypes = data.giftCardTypes || [];
    if (currentTypes.includes(type)) {
      updateField('giftCardTypes', currentTypes.filter((t) => t !== type));
    } else {
      updateField('giftCardTypes', [...currentTypes, type]);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Tính năng quà tặng</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Gift Wrapping */}
        <div className="space-y-3">
          <div className="flex items-center gap-3">
            <input
              type="checkbox"
              id="giftWrapping"
              checked={data.giftWrapping || false}
              onChange={(e) => updateField('giftWrapping', e.target.checked)}
              className="w-4 h-4"
            />
            <Label htmlFor="giftWrapping" className="font-medium">
              Cho phép gói quà
            </Label>
          </div>
          {data.giftWrapping && (
            <div>
              <Label htmlFor="giftWrappingPrice">Giá gói quà (VNĐ)</Label>
              <Input
                id="giftWrappingPrice"
                type="number"
                min="0"
                value={data.giftWrappingPrice || ''}
                onChange={(e) => updateField('giftWrappingPrice', parseFloat(e.target.value) || 0)}
                placeholder="0"
              />
            </div>
          )}
        </div>

        {/* Gift Message */}
        <div className="space-y-3">
          <div className="flex items-center gap-3">
            <input
              type="checkbox"
              id="giftMessageEnabled"
              checked={data.giftMessageEnabled || false}
              onChange={(e) => updateField('giftMessageEnabled', e.target.checked)}
              className="w-4 h-4"
            />
            <Label htmlFor="giftMessageEnabled" className="font-medium">
              Cho phép tin nhắn quà tặng
            </Label>
          </div>
          {data.giftMessageEnabled && (
            <div>
              <Label htmlFor="giftMessageMaxLength">Độ dài tối đa tin nhắn (ký tự)</Label>
              <Input
                id="giftMessageMaxLength"
                type="number"
                min="0"
                max="500"
                value={data.giftMessageMaxLength || ''}
                onChange={(e) => updateField('giftMessageMaxLength', parseInt(e.target.value) || 200)}
                placeholder="200"
              />
            </div>
          )}
        </div>

        {/* Gift Card */}
        <div className="space-y-3">
          <div className="flex items-center gap-3">
            <input
              type="checkbox"
              id="giftCardEnabled"
              checked={data.giftCardEnabled || false}
              onChange={(e) => updateField('giftCardEnabled', e.target.checked)}
              className="w-4 h-4"
            />
            <Label htmlFor="giftCardEnabled" className="font-medium">
              Hỗ trợ thẻ quà tặng
            </Label>
          </div>
          {data.giftCardEnabled && (
            <div>
              <Label className="mb-2 block">Loại thẻ quà tặng</Label>
              <div className="flex flex-wrap gap-2">
                {giftCardTypeOptions.map((type) => (
                  <button
                    key={type}
                    type="button"
                    onClick={() => toggleGiftCardType(type)}
                    className={`px-3 py-1 rounded-full text-sm border ${
                      data.giftCardTypes?.includes(type)
                        ? 'bg-blue-100 border-blue-500 text-blue-700'
                        : 'bg-gray-50 border-gray-300 text-gray-700'
                    }`}
                  >
                    {type}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Gift Delivery Date */}
        <div className="flex items-center gap-3">
          <input
            type="checkbox"
            id="giftDeliveryDateEnabled"
            checked={data.giftDeliveryDateEnabled || false}
            onChange={(e) => updateField('giftDeliveryDateEnabled', e.target.checked)}
            className="w-4 h-4"
          />
          <Label htmlFor="giftDeliveryDateEnabled" className="font-medium">
            Cho phép chọn ngày giao quà
          </Label>
        </div>

        {/* Gift Categories */}
        <div>
          <Label>Danh mục quà tặng</Label>
          <div className="flex gap-2 mb-2">
            <Input
              value={giftCategoryInput}
              onChange={(e) => setGiftCategoryInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addGiftCategory())}
              placeholder="Nhập danh mục quà tặng (ví dụ: Sinh nhật, Kỷ niệm)"
            />
            <Button type="button" onClick={addGiftCategory} variant="outline">
              <Plus className="w-4 h-4 mr-2" />
              Thêm
            </Button>
          </div>
          {data.giftCategories && data.giftCategories.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {data.giftCategories.map((category) => (
                <span
                  key={category}
                  className="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-sm"
                >
                  {category}
                  <button
                    type="button"
                    onClick={() => removeGiftCategory(category)}
                    className="hover:text-red-600"
                  >
                    <X className="w-3 h-3" />
                  </button>
                </span>
              ))}
            </div>
          )}
        </div>

        {/* Gift Suggestions */}
        <div>
          <Label>Gợi ý tin nhắn quà tặng</Label>
          <div className="flex gap-2 mb-2">
            <Textarea
              value={giftSuggestionInput}
              onChange={(e) => setGiftSuggestionInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addGiftSuggestion())}
              placeholder="Nhập gợi ý tin nhắn quà tặng"
              rows={2}
            />
            <Button type="button" onClick={addGiftSuggestion} variant="outline">
              <Plus className="w-4 h-4 mr-2" />
              Thêm
            </Button>
          </div>
          {data.giftSuggestions && data.giftSuggestions.length > 0 && (
            <div className="space-y-2">
              {data.giftSuggestions.map((suggestion, idx) => (
                <div
                  key={idx}
                  className="flex items-start justify-between p-2 bg-gray-50 rounded border"
                >
                  <p className="text-sm flex-1">{suggestion}</p>
                  <button
                    type="button"
                    onClick={() => removeGiftSuggestion(suggestion)}
                    className="hover:text-red-600 ml-2"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/ImageDetailsModal.tsx================================================================================'use client';

import { useState, useEffect, useCallback, useMemo } from 'react';
import { Editor } from '@tiptap/react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { FocalPointPicker } from './FocalPointPicker';
import { Sparkles, Wand2, Camera } from 'lucide-react';

interface ImageDetailsModalProps {
  isOpen: boolean;
  onClose: () => void;
  editor: Editor | null;
  selectedImage: HTMLElement | null;
}

interface ImageData {
  src: string;
  alt: string;
  title: string;
  caption: string;
  width: string;
  height: string;
  displaySize: 'thumbnail' | 'medium' | 'large' | 'full' | 'custom';
  customWidth: string;
  customHeight: string;
  linkTo: 'none' | 'media' | 'custom';
  customUrl: string;
  cssClass: string;
  openInNewTab: boolean;
}

const DISPLAY_SIZES = {
  thumbnail: { width: 150, height: 150, label: 'Thumbnail (150px)' },
  medium: { width: 300, height: 300, label: 'Medium (300px)' },
  large: { width: 1024, height: 1024, label: 'Large (1024px)' },
  full: { width: 0, height: 0, label: 'Full Size (Gốc)' },
  custom: { width: 0, height: 0, label: 'Custom Size' },
};

export function ImageDetailsModal({ 
  isOpen, 
  onClose, 
  editor, 
  selectedImage 
}: ImageDetailsModalProps) {
  const [activeTab, setActiveTab] = useState<'general' | 'advanced'>('general');
  const [formData, setFormData] = useState<ImageData>({
    src: '',
    alt: '',
    title: '',
    caption: '',
    width: '',
    height: '',
    displaySize: 'full',
    customWidth: '',
    customHeight: '',
    linkTo: 'none',
    customUrl: '',
    cssClass: '',
    openInNewTab: false,
  });
  const [aspectRatio, setAspectRatio] = useState<number>(1);
  const [lockAspectRatio, setLockAspectRatio] = useState(true);
  const [altTextError, setAltTextError] = useState(false);
  const [showFocalPointPicker, setShowFocalPointPicker] = useState(false);
  const [selectedFilter, setSelectedFilter] = useState<string>('none');
  const [showWatermark, setShowWatermark] = useState(false);

  // Parse image data from selected image
  useEffect(() => {
    if (!selectedImage || !isOpen) return;

    const src = selectedImage.getAttribute('src') || '';
    const alt = selectedImage.getAttribute('alt') || '';
    const title = selectedImage.getAttribute('title') || '';
    const width = selectedImage.getAttribute('width') || '';
    const height = selectedImage.getAttribute('height') || '';
    const cssClass = selectedImage.getAttribute('class') || '';
    // Remove alignment classes from cssClass for display (they're managed separately)
    const cssClassWithoutAlignment = cssClass
      .split(' ')
      .filter(c => !c.startsWith('align'))
      .join(' ')
      .trim();
    
    // Check if image has caption in data attribute or figure
    const figure = selectedImage.closest('figure');
    let caption = figure?.querySelector('figcaption')?.textContent || '';
    // Also check data attribute
    if (!caption) {
      caption = selectedImage.getAttribute('data-caption') || '';
    }

    // Load filter and watermark settings
    const dataFilter = selectedImage.getAttribute('data-filter') || 'none';
    const dataWatermark = selectedImage.getAttribute('data-watermark') === 'true';

    // Determine display size
    let displaySize: 'thumbnail' | 'medium' | 'large' | 'full' | 'custom' = 'full';
    if (width) {
      const widthNum = parseInt(width);
      if (widthNum <= 150) displaySize = 'thumbnail';
      else if (widthNum <= 300) displaySize = 'medium';
      else if (widthNum <= 1024) displaySize = 'large';
      else displaySize = 'custom';
    }

    // Calculate aspect ratio
    const widthNum = parseInt(width) || selectedImage.offsetWidth;
    const heightNum = parseInt(height) || selectedImage.offsetHeight;
    const ratio = widthNum > 0 && heightNum > 0 ? widthNum / heightNum : 1;
    setAspectRatio(ratio);

    // Check if image has link (from DOM or data attributes)
    const parentLink = selectedImage.closest('a');
    let linkTo: 'none' | 'media' | 'custom' = 'none';
    let customUrl = '';
    let openInNewTab = false;
    
    // Check data attributes first
    const dataLinkTo = selectedImage.getAttribute('data-link-to');
    if (dataLinkTo === 'media' || dataLinkTo === 'custom') {
      linkTo = dataLinkTo;
      customUrl = selectedImage.getAttribute('data-link-url') || '';
      openInNewTab = selectedImage.getAttribute('data-link-target') === '_blank';
    } else if (parentLink) {
      // Fallback to DOM link
      const href = parentLink.getAttribute('href') || '';
      const target = parentLink.getAttribute('target');
      openInNewTab = target === '_blank';
      
      if (href === src) {
        linkTo = 'media';
      } else if (href) {
        linkTo = 'custom';
        customUrl = href;
      }
    }

    setFormData({
      src,
      alt,
      title,
      caption,
      width: width || '',
      height: height || '',
      displaySize: displaySize === 'full' && (width || height) ? 'custom' : displaySize,
      customWidth: width || '',
      customHeight: height || '',
      linkTo,
      customUrl,
      cssClass: cssClassWithoutAlignment,
      openInNewTab,
    });

    // Set filter and watermark states
    setSelectedFilter(dataFilter);
    setShowWatermark(dataWatermark);
  }, [selectedImage, isOpen]);

  const handleInputChange = (field: keyof ImageData, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    
    // Validate alt text
    if (field === 'alt') {
      setAltTextError(value.trim() === '');
    }

    // Handle aspect ratio lock for custom size
    if (lockAspectRatio && aspectRatio > 0) {
      if (field === 'customWidth' && value) {
        const newHeight = Math.round(parseInt(value) / aspectRatio);
        setFormData(prev => ({ ...prev, customHeight: newHeight.toString() }));
      } else if (field === 'customHeight' && value) {
        const newWidth = Math.round(parseInt(value) * aspectRatio);
        setFormData(prev => ({ ...prev, customWidth: newWidth.toString() }));
      }
    }
  };

  const handleDisplaySizeChange = (size: 'thumbnail' | 'medium' | 'large' | 'full' | 'custom') => {
    setFormData(prev => ({ ...prev, displaySize: size }));
    
    if (size !== 'custom' && size !== 'full') {
      const sizeData = DISPLAY_SIZES[size];
      const newWidth = Math.round(sizeData.width);
      const newHeight = lockAspectRatio && aspectRatio > 0 
        ? Math.round(newWidth / aspectRatio)
        : Math.round(sizeData.height);
      
      setFormData(prev => ({
        ...prev,
        customWidth: newWidth.toString(),
        customHeight: newHeight.toString(),
      }));
    }
  };

  const handleSave = () => {
    if (!editor || !selectedImage) return;

    // Validate alt text
    if (!formData.alt.trim()) {
      setAltTextError(true);
      return;
    }

    const src = formData.src;
    if (!src) return;

    // Find image node position
    let imagePos: number | null = null;
    editor.state.doc.descendants((node, pos) => {
      if (node.type.name === 'image' && node.attrs.src === src) {
        imagePos = pos;
        return false;
      }
    });

    if (imagePos === null) return;

    const imageNode = editor.state.doc.nodeAt(imagePos);
    if (!imageNode || imageNode.type.name !== 'image') return;

    // Build attributes
    // Preserve alignment classes from existing class attribute
    const existingClass = imageNode.attrs.class || '';
    const alignmentClasses = existingClass.split(' ').filter((c: string) => c.startsWith('align'));
    const otherClasses = existingClass.split(' ').filter((c: string) => !c.startsWith('align') && c.trim());
    
    // Merge CSS classes
    const allClasses = [
      ...alignmentClasses,
      ...otherClasses,
      formData.cssClass,
    ].filter(Boolean).join(' ').trim();
    
    // Build style string
    let styleString = imageNode.attrs.style || '';
    
    // Add filter style if selected
    if (selectedFilter !== 'none') {
      let filterValue = '';
      switch (selectedFilter) {
        case 'brighten':
          filterValue = 'brightness(1.1)';
          break;
        case 'vivid':
          filterValue = 'saturate(1.3)';
          break;
        case 'vintage':
          filterValue = 'sepia(0.5) contrast(1.1)';
          break;
      }
      if (filterValue) {
        // Remove existing filter if any
        styleString = styleString.replace(/filter:\s*[^;]+;?/g, '');
        styleString = `${styleString} filter: ${filterValue};`.trim();
      }
    } else {
      // Remove filter if none selected
      styleString = styleString.replace(/filter:\s*[^;]+;?/g, '').trim();
    }
    
    const attrs: any = {
      ...imageNode.attrs,
      alt: formData.alt,
      title: formData.title || undefined,
      class: allClasses || undefined,
      style: styleString || undefined,
      'data-filter': selectedFilter !== 'none' ? selectedFilter : undefined,
      'data-watermark': showWatermark ? 'true' : undefined,
    };

    // Handle size
    if (formData.displaySize === 'custom' && formData.customWidth && formData.customHeight) {
      attrs.width = formData.customWidth;
      attrs.height = formData.customHeight;
    } else if (formData.displaySize !== 'full') {
      const sizeData = DISPLAY_SIZES[formData.displaySize];
      attrs.width = sizeData.width.toString();
      attrs.height = lockAspectRatio && aspectRatio > 0
        ? Math.round(sizeData.width / aspectRatio).toString()
        : sizeData.height.toString();
    } else {
      // Full size - remove width/height
      attrs.width = undefined;
      attrs.height = undefined;
    }

    // Handle caption - store in data attribute for now
    // Full figure/figcaption support requires custom extension
    if (formData.caption.trim()) {
      attrs['data-caption'] = formData.caption;
    } else {
      attrs['data-caption'] = undefined;
    }

    // Handle watermark if enabled
    if (showWatermark) {
      // Store watermark flag - actual watermark will be applied on save via API
      attrs['data-watermark'] = 'true';
      attrs['data-watermark-position'] = 'bottom-right';
    } else {
      attrs['data-watermark'] = undefined;
      attrs['data-watermark-position'] = undefined;
    }

    // Handle link - for now, we'll update the image
    // Full link wrapping requires more complex node manipulation
    // The link functionality will be handled at render time or via custom extension
    if (formData.linkTo === 'media') {
      attrs['data-link-to'] = 'media';
      attrs['data-link-url'] = formData.src;
      attrs['data-link-target'] = formData.openInNewTab ? '_blank' : undefined;
    } else if (formData.linkTo === 'custom' && formData.customUrl) {
      attrs['data-link-to'] = 'custom';
      attrs['data-link-url'] = formData.customUrl;
      attrs['data-link-target'] = formData.openInNewTab ? '_blank' : undefined;
    } else {
      attrs['data-link-to'] = undefined;
      attrs['data-link-url'] = undefined;
      attrs['data-link-target'] = undefined;
    }

    // Update image attributes - single update with all attributes
    editor
      .chain()
      .focus()
      .setNodeSelection(imagePos)
      .updateAttributes('image', attrs)
      .run();

    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Chi tiết hình ảnh</DialogTitle>
        </DialogHeader>

        {/* Tabs */}
        <div className="flex border-b mb-4">
          <button
            type="button"
            onClick={() => setActiveTab('general')}
            className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${
              activeTab === 'general'
                ? 'border-primary text-primary'
                : 'border-transparent text-muted-foreground hover:text-foreground'
            }`}
          >
            Cài đặt Chung
          </button>
          <button
            type="button"
            onClick={() => setActiveTab('advanced')}
            className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${
              activeTab === 'advanced'
                ? 'border-primary text-primary'
                : 'border-transparent text-muted-foreground hover:text-foreground'
            }`}
          >
            Nâng cao
          </button>
        </div>

        {/* Tab Content */}
        {activeTab === 'general' && (
          <div className="space-y-4">
            {/* Alt Text */}
            <div>
              <Label htmlFor="alt-text">
                Văn bản thay thế (Alt Text) <span className="text-destructive">*</span>
              </Label>
              <Input
                id="alt-text"
                value={formData.alt}
                onChange={(e) => handleInputChange('alt', e.target.value)}
                className={altTextError ? 'border-destructive' : ''}
                placeholder="Mô tả hình ảnh cho SEO"
              />
              {altTextError && (
                <p className="text-sm text-destructive mt-1">
                  Văn bản thay thế là bắt buộc cho SEO
                </p>
              )}
            </div>

            {/* Caption */}
            <div>
              <Label htmlFor="caption">Chú thích (Caption)</Label>
              <Textarea
                id="caption"
                value={formData.caption}
                onChange={(e) => handleInputChange('caption', e.target.value)}
                placeholder="Chú thích cho hình ảnh (tùy chọn)"
                rows={3}
              />
              <p className="text-xs text-muted-foreground mt-1">
                Chú thích sẽ được hiển thị bên dưới hình ảnh
              </p>
            </div>

            {/* Display Size */}
            <div>
              <Label htmlFor="display-size">Kích thước hiển thị</Label>
              <Select
                value={formData.displaySize}
                onValueChange={(value) => handleDisplaySizeChange(value as any)}
              >
                <SelectTrigger id="display-size">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="thumbnail">Thumbnail (150px)</SelectItem>
                  <SelectItem value="medium">Medium (300px)</SelectItem>
                  <SelectItem value="large">Large (1024px)</SelectItem>
                  <SelectItem value="full">Full Size (Gốc)</SelectItem>
                  <SelectItem value="custom">Custom Size</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Custom Size */}
            {formData.displaySize === 'custom' && (
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="custom-width">Rộng (px)</Label>
                  <Input
                    id="custom-width"
                    type="number"
                    value={formData.customWidth}
                    onChange={(e) => handleInputChange('customWidth', e.target.value)}
                    placeholder="Width"
                  />
                </div>
                <div>
                  <Label htmlFor="custom-height">Cao (px)</Label>
                  <Input
                    id="custom-height"
                    type="number"
                    value={formData.customHeight}
                    onChange={(e) => handleInputChange('customHeight', e.target.value)}
                    placeholder="Height"
                  />
                </div>
              </div>
            )}

            {/* Lock Aspect Ratio */}
            {formData.displaySize === 'custom' && (
              <div className="flex items-center space-x-2">
                <Checkbox
                  id="lock-aspect"
                  checked={lockAspectRatio}
                  onCheckedChange={(checked) => setLockAspectRatio(checked === true)}
                />
                <Label htmlFor="lock-aspect" className="text-sm font-normal cursor-pointer">
                  Khóa tỷ lệ khung hình
                </Label>
              </div>
            )}

            {/* Link To */}
            <div>
              <Label htmlFor="link-to">Liên kết tới</Label>
              <Select
                value={formData.linkTo}
                onValueChange={(value) => handleInputChange('linkTo', value as any)}
              >
                <SelectTrigger id="link-to">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">None (Không link)</SelectItem>
                  <SelectItem value="media">Media File (Link xem ảnh gốc)</SelectItem>
                  <SelectItem value="custom">Custom URL</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Custom URL */}
            {formData.linkTo === 'custom' && (
              <div>
                <Label htmlFor="custom-url">URL tùy chỉnh</Label>
                <Input
                  id="custom-url"
                  type="url"
                  value={formData.customUrl}
                  onChange={(e) => handleInputChange('customUrl', e.target.value)}
                  placeholder="https://example.com"
                />
              </div>
            )}
          </div>
        )}

        {activeTab === 'advanced' && (
          <div className="space-y-4">
            {/* Focal Point Picker */}
            <div>
              <Label>Điểm lấy nét thông minh</Label>
              <p className="text-xs text-muted-foreground mb-2">
                Đặt điểm quan trọng nhất của ảnh để tự động căn giữa khi hiển thị ở kích thước khác
              </p>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => setShowFocalPointPicker(true)}
                className="w-full"
              >
                <Camera className="h-4 w-4 mr-2" />
                Đặt điểm lấy nét
              </Button>
            </div>

            {/* Instant Filters */}
            <div>
              <Label>Bộ lọc màu nhanh</Label>
              <p className="text-xs text-muted-foreground mb-2">
                Áp dụng bộ lọc màu để làm ảnh đẹp hơn (preview bằng CSS)
              </p>
              <div className="grid grid-cols-3 gap-2">
                <Button
                  type="button"
                  variant={selectedFilter === 'brighten' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setSelectedFilter(selectedFilter === 'brighten' ? 'none' : 'brighten')}
                  className="flex flex-col items-center gap-1 h-auto py-2"
                >
                  <Sparkles className="h-4 w-4" />
                  <span className="text-xs">Sáng hơn</span>
                </Button>
                <Button
                  type="button"
                  variant={selectedFilter === 'vivid' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setSelectedFilter(selectedFilter === 'vivid' ? 'none' : 'vivid')}
                  className="flex flex-col items-center gap-1 h-auto py-2"
                >
                  <Wand2 className="h-4 w-4" />
                  <span className="text-xs">Rực rỡ</span>
                </Button>
                <Button
                  type="button"
                  variant={selectedFilter === 'vintage' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setSelectedFilter(selectedFilter === 'vintage' ? 'none' : 'vintage')}
                  className="flex flex-col items-center gap-1 h-auto py-2"
                >
                  <Camera className="h-4 w-4" />
                  <span className="text-xs">Vintage</span>
                </Button>
              </div>
            </div>

            {/* Watermark Toggle */}
            <div className="flex items-center space-x-2">
              <Checkbox
                id="watermark"
                checked={showWatermark}
                onCheckedChange={(checked) => setShowWatermark(checked === true)}
              />
              <Label htmlFor="watermark" className="text-sm font-normal cursor-pointer">
                Đóng dấu logo Shop
              </Label>
              <p className="text-xs text-muted-foreground ml-2">
                (Áp dụng khi lưu)
              </p>
            </div>

            <div className="h-px bg-border my-4" />

            {/* Title Attribute */}
            <div>
              <Label htmlFor="title-attr">Thuộc tính tiêu đề (Title Attribute)</Label>
              <Input
                id="title-attr"
                value={formData.title}
                onChange={(e) => handleInputChange('title', e.target.value)}
                placeholder="Tooltip khi hover vào ảnh"
              />
            </div>

            {/* CSS Class */}
            <div>
              <Label htmlFor="css-class">CSS Class</Label>
              <Input
                id="css-class"
                value={formData.cssClass}
                onChange={(e) => handleInputChange('cssClass', e.target.value)}
                placeholder="shadow-box, rounded-border"
              />
              <p className="text-xs text-muted-foreground mt-1">
                Thêm class tùy biến cho hình ảnh
              </p>
            </div>

            {/* Open in new tab */}
            <div className="flex items-center space-x-2">
              <Checkbox
                id="open-new-tab"
                checked={formData.openInNewTab}
                onCheckedChange={(checked) => handleInputChange('openInNewTab', checked === true)}
              />
              <Label htmlFor="open-new-tab" className="text-sm font-normal cursor-pointer">
                Mở trong tab mới (target=&quot;_blank&quot;)
              </Label>
            </div>
          </div>
        )}

        {/* Focal Point Picker Modal */}
        {showFocalPointPicker && (
          <FocalPointPicker
            editor={editor}
            selectedImage={selectedImage}
            isOpen={showFocalPointPicker}
            onClose={() => setShowFocalPointPicker(false)}
          />
        )}

        <DialogFooter>
          <Button type="button" variant="outline" onClick={onClose}>
            Hủy
          </Button>
          <Button type="button" onClick={handleSave}>
            Cập nhật
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
================================================================================FILE: components/admin/products/ImageEditorErrorBoundary.tsx================================================================================'use client';

import React, { Component, ErrorInfo, ReactNode } from 'react';
import { AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ImageEditorErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
    };
  }

  static getDerivedStateFromError(error: Error): State {
    return {
      hasError: true,
      error,
    };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Image Editor Error:', error, errorInfo);
  }

  handleReset = () => {
    this.setState({
      hasError: false,
      error: null,
    });
  };

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="flex flex-col items-center justify-center p-8 border border-destructive/50 rounded-lg bg-destructive/10">
          <AlertCircle className="h-12 w-12 text-destructive mb-4" />
          <h3 className="text-lg font-semibold text-destructive mb-2">
            Lỗi khi xử lý hình ảnh
          </h3>
          <p className="text-sm text-muted-foreground mb-4 text-center max-w-md">
            {this.state.error?.message || 'Đã xảy ra lỗi không xác định'}
          </p>
          <Button onClick={this.handleReset} variant="outline" size="sm">
            Thử lại
          </Button>
        </div>
      );
    }

    return this.props.children;
  }
}
================================================================================FILE: components/admin/products/ImagePixelEditor.tsx================================================================================'use client';

import { useEffect, useRef, useState, useCallback, useMemo } from 'react';
import Image from 'next/image';
import { Editor } from '@tiptap/react';
import Cropper from 'cropperjs';
import 'cropperjs/dist/cropper.css';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { RotateCw, RotateCcw, FlipVertical, FlipHorizontal, Undo2, Eye } from 'lucide-react';

interface ImagePixelEditorProps {
  isOpen: boolean;
  onClose: () => void;
  editor: Editor | null;
  selectedImage: HTMLElement | null;
  originalImageUrl?: string; // URL của ảnh gốc để restore
}

export function ImagePixelEditor({
  isOpen,
  onClose,
  editor,
  selectedImage,
  originalImageUrl,
}: ImagePixelEditorProps) {
  const imageRef = useRef<HTMLImageElement>(null);
  const cropperRef = useRef<Cropper | null>(null);
  const [aspectRatio, setAspectRatio] = useState<number | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);
  const [showOriginal, setShowOriginal] = useState(false);

  // Initialize Cropper.js
  useEffect(() => {
    if (!isOpen || !imageRef.current || !selectedImage) return;

    const imageUrl = selectedImage.getAttribute('src') || '';
    if (!imageUrl) return;

    // Set image source
    if (imageRef.current) {
      imageRef.current.src = imageUrl;
    }

    // Initialize Cropper
    const cropper = new Cropper(imageRef.current!, {
      aspectRatio: aspectRatio || undefined,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 0.8,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
      scalable: true,
      zoomable: true,
      ready() {
        setHasChanges(false);
      },
      crop() {
        setHasChanges(true);
      },
    });

    cropperRef.current = cropper;

    return () => {
      if (cropperRef.current) {
        cropperRef.current.destroy();
        cropperRef.current = null;
      }
    };
  }, [isOpen, selectedImage, aspectRatio]);

  const handleRotateLeft = () => {
    if (!cropperRef.current) return;
    cropperRef.current.rotate(-90);
    setHasChanges(true);
  };

  const handleRotateRight = () => {
    if (!cropperRef.current) return;
    cropperRef.current.rotate(90);
    setHasChanges(true);
  };

  const handleFlipVertical = () => {
    if (!cropperRef.current) return;
    cropperRef.current.scaleY(-1);
    setHasChanges(true);
  };

  const handleFlipHorizontal = () => {
    if (!cropperRef.current) return;
    cropperRef.current.scaleX(-1);
    setHasChanges(true);
  };

  const handleAspectRatioChange = (ratio: string) => {
    if (!cropperRef.current) return;
    
    if (ratio === 'free') {
      setAspectRatio(null);
      cropperRef.current.setAspectRatio(NaN);
    } else {
      const [width, height] = ratio.split(':').map(Number);
      const aspect = width / height;
      setAspectRatio(aspect);
      cropperRef.current.setAspectRatio(aspect);
    }
    setHasChanges(true);
  };

  const handleRestore = async () => {
    if (!editor || !selectedImage || !originalImageUrl) return;

    const src = selectedImage.getAttribute('src') || '';
    if (!src) return;

    // Find image node position
    let imagePos: number | null = null;
    editor.state.doc.descendants((node, pos) => {
      if (node.type.name === 'image' && node.attrs.src === src) {
        imagePos = pos;
        return false;
      }
    });

    if (imagePos !== null) {
      const imageNode = editor.state.doc.nodeAt(imagePos);
      if (imageNode && imageNode.type.name === 'image') {
        // Restore to original image
        editor
          .chain()
          .focus()
          .setNodeSelection(imagePos)
          .updateAttributes('image', {
            ...imageNode.attrs,
            src: originalImageUrl,
            'data-original-src': undefined,
            'data-edited': undefined,
          })
          .run();
      }
    }

    onClose();
  };

  const handleSave = async () => {
    if (!cropperRef.current || !editor || !selectedImage || isProcessing) return;

    setIsProcessing(true);

    try {
      // Get cropped canvas with options in a single call
      const canvas = cropperRef.current.getCroppedCanvas({
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });

      // Convert canvas to blob
      canvas.toBlob(async (blob) => {
        if (!blob) {
          setIsProcessing(false);
          return;
        }

        // Create FormData for upload
        const formData = new FormData();
        const originalSrc = selectedImage.getAttribute('src') || '';
        const fileName = originalSrc.split('/').pop() || 'image.jpg';
        const nameWithoutExt = fileName.replace(/\.[^/.]+$/, '');
        const ext = fileName.split('.').pop() || 'jpg';
        const timestamp = Date.now();
        const newFileName = `${nameWithoutExt}-edited-${timestamp}.${ext}`;
        
        formData.append('file', blob, newFileName);
        formData.append('originalUrl', originalSrc);

        // Upload to server
        const response = await fetch('/api/admin/images/upload', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          throw new Error('Failed to upload edited image');
        }

        const data = await response.json();
        const newImageUrl = data.url;
        
        if (!newImageUrl) {
          throw new Error('No URL returned from server');
        }

        // Update image in editor
        const src = selectedImage.getAttribute('src') || '';
        if (!src) {
          setIsProcessing(false);
          return;
        }
        
        // Find image node position
        let imagePos: number | null = null;
        editor.state.doc.descendants((node, pos) => {
          if (node.type.name === 'image' && node.attrs.src === src) {
            imagePos = pos;
            return false;
          }
        });

        if (imagePos !== null) {
          const imageNode = editor.state.doc.nodeAt(imagePos);
          if (imageNode && imageNode.type.name === 'image') {
            // Store original URL for restore
            const originalSrc = imageNode.attrs['data-original-src'] || src;
            
            // Update image with new URL
            editor
              .chain()
              .focus()
              .setNodeSelection(imagePos)
              .updateAttributes('image', {
                ...imageNode.attrs,
                src: newImageUrl,
                'data-original-src': originalSrc,
                'data-edited': 'true',
              })
              .run();
          }
        }

        setIsProcessing(false);
        setHasChanges(false);
        onClose();
      }, 'image/jpeg', 0.9);
    } catch (error) {
      console.error('Error saving edited image:', error);
      alert('Có lỗi xảy ra khi lưu ảnh đã chỉnh sửa');
      setIsProcessing(false);
    }
  };

  if (!selectedImage) return null;

  const imageUrl = selectedImage.getAttribute('src') || '';
  const originalSrc = selectedImage.getAttribute('data-original-src') || originalImageUrl || imageUrl;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Chỉnh sửa hình ảnh</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* Toolbar */}
          <div className="flex items-center gap-2 flex-wrap border-b pb-4">
            {/* Rotate buttons */}
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleRotateLeft}
              title="Xoay trái 90°"
            >
              <RotateCcw className="h-4 w-4 mr-2" />
              Xoay trái
            </Button>
            
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleRotateRight}
              title="Xoay phải 90°"
            >
              <RotateCw className="h-4 w-4 mr-2" />
              Xoay phải
            </Button>

            <div className="h-6 w-px bg-border mx-1" />

            {/* Flip buttons */}
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleFlipVertical}
              title="Lật dọc"
            >
              <FlipVertical className="h-4 w-4 mr-2" />
              Lật dọc
            </Button>
            
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleFlipHorizontal}
              title="Lật ngang"
            >
              <FlipHorizontal className="h-4 w-4 mr-2" />
              Lật ngang
            </Button>

            <div className="h-6 w-px bg-border mx-1" />

            {/* Aspect Ratio */}
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium">Tỷ lệ:</label>
              <Select
                defaultValue="free"
                onValueChange={(value) => handleAspectRatioChange(value)}
              >
                <SelectTrigger className="w-32">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="1:1">1:1 (Vuông)</SelectItem>
                  <SelectItem value="16:9">16:9 (Video)</SelectItem>
                  <SelectItem value="4:3">4:3 (Ảnh)</SelectItem>
                  <SelectItem value="free">Tự do</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Restore button */}
            {originalSrc !== imageUrl && (
              <>
                <div className="h-6 w-px bg-border mx-1" />
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={handleRestore}
                  title="Khôi phục ảnh gốc"
                >
                  <Undo2 className="h-4 w-4 mr-2" />
                  Khôi phục
                </Button>
              </>
            )}
          </div>

          {/* Cropper container */}
          <div className="relative w-full" style={{ minHeight: '400px' }}>
            <div className="relative" style={{ minHeight: '400px' }}>
              {/* Compare View - Show original when holding button */}
              {showOriginal && originalSrc !== imageUrl && (
                <div className="absolute inset-0 z-10 border-4 border-primary rounded overflow-hidden">
                  <div className="relative w-full h-full bg-muted">
                    <Image
                      src={originalSrc}
                      alt="Original image"
                      fill
                      className="object-contain"
                      sizes="(max-width: 768px) 100vw, 800px"
                      unoptimized
                    />
                  </div>
                  <div className="absolute top-2 left-2 bg-primary text-primary-foreground px-2 py-1 rounded text-xs font-medium">
                    Ảnh gốc
                  </div>
                </div>
              )}
              
              <img
                ref={imageRef}
                src={imageUrl}
                alt="Image to edit"
                className="max-w-full"
                style={{ display: 'block', maxWidth: '100%' }}
              />
              
              {!showOriginal && originalSrc !== imageUrl && (
                <div className="absolute bottom-2 right-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded text-xs pointer-events-none">
                  Nhấn giữ để xem ảnh gốc
                </div>
              )}
            </div>
          </div>

          {/* Compare View Button */}
          {originalSrc !== imageUrl && (
            <div className="flex justify-center">
              <Button
                type="button"
                variant="outline"
                size="sm"
                onMouseDown={() => setShowOriginal(true)}
                onMouseUp={() => setShowOriginal(false)}
                onMouseLeave={() => setShowOriginal(false)}
                onTouchStart={() => setShowOriginal(true)}
                onTouchEnd={() => setShowOriginal(false)}
                className="w-full"
              >
                {showOriginal ? 'Thả để xem ảnh đã chỉnh sửa' : 'Nhấn giữ để xem ảnh gốc'}
              </Button>
            </div>
          )}

          {/* Instructions */}
          <div className="text-sm text-muted-foreground">
            <p>• Kéo để di chuyển vùng cắt</p>
            <p>• Kéo các góc để thay đổi kích thước</p>
            <p>• Sử dụng các nút xoay và lật để chỉnh sửa</p>
          </div>
        </div>

        <DialogFooter>
          <Button type="button" variant="outline" onClick={onClose} disabled={isProcessing}>
            Hủy
          </Button>
          <Button
            type="button"
            onClick={handleSave}
            disabled={isProcessing || !hasChanges}
          >
            {isProcessing ? 'Đang xử lý...' : 'Lưu ảnh đã chỉnh sửa'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
================================================================================FILE: components/admin/products/ImageResizeHandles.tsx================================================================================'use client';

import { useEffect, useRef, useState, useCallback, useMemo } from 'react';
import { Editor } from '@tiptap/react';

interface ImageResizeHandlesProps {
  editor: Editor | null;
  selectedImage: HTMLElement | null;
  onResize?: (width: number, height: number) => void;
}

interface ResizeState {
  isResizing: boolean;
  handle: 'nw' | 'ne' | 'sw' | 'se' | null;
  startX: number;
  startY: number;
  startWidth: number;
  startHeight: number;
  aspectRatio: number;
}

export function ImageResizeHandles({ 
  editor, 
  selectedImage,
  onResize 
}: ImageResizeHandlesProps) {
  const [resizeState, setResizeState] = useState<ResizeState>({
    isResizing: false,
    handle: null,
    startX: 0,
    startY: 0,
    startWidth: 0,
    startHeight: 0,
    aspectRatio: 1,
  });
  const [currentSize, setCurrentSize] = useState<{ width: number; height: number } | null>(null);
  const handlesRef = useRef<HTMLDivElement>(null);

  // Calculate handle positions
  useEffect(() => {
    if (!selectedImage) {
      setCurrentSize(null);
      return;
    }

    const updatePosition = () => {
      const rect = selectedImage.getBoundingClientRect();
      const editorElement = editor?.view.dom;
      if (!editorElement) return;

      const editorRect = editorElement.getBoundingClientRect();
      
      setCurrentSize({
        width: Math.round(rect.width),
        height: Math.round(rect.height),
      });
    };

    updatePosition();
    
    // Update on scroll/resize
    const handleUpdate = () => updatePosition();
    window.addEventListener('scroll', handleUpdate, true);
    window.addEventListener('resize', handleUpdate);

    return () => {
      window.removeEventListener('scroll', handleUpdate, true);
      window.removeEventListener('resize', handleUpdate);
    };
  }, [selectedImage, editor]);

  // Handle mouse down on resize handle
  const handleMouseDown = (e: React.MouseEvent, handle: 'nw' | 'ne' | 'sw' | 'se') => {
    if (!selectedImage) return;

    e.preventDefault();
    e.stopPropagation();

    const rect = selectedImage.getBoundingClientRect();
    const aspectRatio = rect.width / rect.height;

    setResizeState({
      isResizing: true,
      handle,
      startX: e.clientX,
      startY: e.clientY,
      startWidth: rect.width,
      startHeight: rect.height,
      aspectRatio,
    });
  };

  // Handle mouse move for resizing
  useEffect(() => {
    if (!resizeState.isResizing || !selectedImage || !editor) return;

    const handleMouseMove = (e: MouseEvent) => {
      const deltaX = e.clientX - resizeState.startX;
      const deltaY = e.clientY - resizeState.startY;
      
      let newWidth = resizeState.startWidth;
      let newHeight = resizeState.startHeight;

      // Calculate new dimensions based on handle
      switch (resizeState.handle) {
        case 'nw': // Top-left
          newWidth = resizeState.startWidth - deltaX;
          newHeight = newWidth / resizeState.aspectRatio;
          break;
        case 'ne': // Top-right
          newWidth = resizeState.startWidth + deltaX;
          newHeight = newWidth / resizeState.aspectRatio;
          break;
        case 'sw': // Bottom-left
          newWidth = resizeState.startWidth - deltaX;
          newHeight = newWidth / resizeState.aspectRatio;
          break;
        case 'se': // Bottom-right
          newWidth = resizeState.startWidth + deltaX;
          newHeight = newWidth / resizeState.aspectRatio;
          break;
      }

      // Minimum size constraints
      const minSize = 50;
      newWidth = Math.max(minSize, newWidth);
      newHeight = Math.max(minSize, newHeight);

      // Update image size in DOM (temporary visual update)
      // Always update both style and attributes for consistency
      selectedImage.style.width = `${newWidth}px`;
      selectedImage.style.height = `${newHeight}px`;
      selectedImage.setAttribute('width', `${newWidth}`);
      selectedImage.setAttribute('height', `${newHeight}`);

      // Update size display
      setCurrentSize({
        width: Math.round(newWidth),
        height: Math.round(newHeight),
      });
    };

    const handleMouseUp = () => {
      if (!selectedImage || !editor) return;

      // Get final dimensions from style or attributes
      let finalWidth: number;
      let finalHeight: number;
      
      if (selectedImage.style.width && selectedImage.style.height) {
        finalWidth = Math.round(parseFloat(selectedImage.style.width));
        finalHeight = Math.round(parseFloat(selectedImage.style.height));
      } else {
        finalWidth = Math.round(selectedImage.offsetWidth);
        finalHeight = Math.round(selectedImage.offsetHeight);
      }

      // Update image in editor
      const src = selectedImage.getAttribute('src') || '';
      if (!src) return;
      
      // Find image node position
      let imagePos: number | null = null;
      let foundNodes = 0;
      editor.state.doc.descendants((node, pos) => {
        if (node.type.name === 'image' && node.attrs.src === src) {
          foundNodes++;
          imagePos = pos;
        return false;
      }
    });

    if (imagePos !== null) {
      const imageNode = editor.state.doc.nodeAt(imagePos);
      if (imageNode && imageNode.type.name === 'image') {
        // Update image attributes with width and height
          editor
            .chain()
            .focus()
            .setNodeSelection(imagePos)
            .updateAttributes('image', {
              ...imageNode.attrs,
              width: finalWidth.toString(),
              height: finalHeight.toString(),
            })
            .run();
          
          // Also update style to ensure visual consistency
          selectedImage.setAttribute('width', finalWidth.toString());
          selectedImage.setAttribute('height', finalHeight.toString());
        selectedImage.style.width = `${finalWidth}px`;
        selectedImage.style.height = `${finalHeight}px`;
      }
    }

      // Call onResize callback if provided
      if (onResize) {
        onResize(finalWidth, finalHeight);
      }

      // Reset resize state
      setResizeState({
        isResizing: false,
        handle: null,
        startX: 0,
        startY: 0,
        startWidth: 0,
        startHeight: 0,
        aspectRatio: 1,
      });
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [resizeState, selectedImage, editor, onResize]);

  if (!selectedImage || !currentSize) {
    return null;
  }

  const rect = selectedImage.getBoundingClientRect();
  const editorElement = editor?.view.dom;
  if (!editorElement) return null;

  const editorRect = editorElement.getBoundingClientRect();
  const relativeTop = rect.top - editorRect.top;
  const relativeLeft = rect.left - editorRect.left;

  const handleSize = 8;
  const handleOffset = handleSize / 2;

  return (
    <>
      {/* Resize Handles */}
      <div
        ref={handlesRef}
        className="absolute pointer-events-none"
        style={{
          top: `${relativeTop - handleOffset}px`,
          left: `${relativeLeft - handleOffset}px`,
          width: `${rect.width + handleSize}px`,
          height: `${rect.height + handleSize}px`,
        }}
      >
        {/* Top-left */}
        <div
          className="absolute bg-primary border-2 border-background rounded-sm cursor-nwse-resize pointer-events-auto"
          style={{
            top: 0,
            left: 0,
            width: `${handleSize}px`,
            height: `${handleSize}px`,
          }}
          onMouseDown={(e) => handleMouseDown(e, 'nw')}
        />
        
        {/* Top-right */}
        <div
          className="absolute bg-primary border-2 border-background rounded-sm cursor-nesw-resize pointer-events-auto"
          style={{
            top: 0,
            right: 0,
            width: `${handleSize}px`,
            height: `${handleSize}px`,
          }}
          onMouseDown={(e) => handleMouseDown(e, 'ne')}
        />
        
        {/* Bottom-left */}
        <div
          className="absolute bg-primary border-2 border-background rounded-sm cursor-nesw-resize pointer-events-auto"
          style={{
            bottom: 0,
            left: 0,
            width: `${handleSize}px`,
            height: `${handleSize}px`,
          }}
          onMouseDown={(e) => handleMouseDown(e, 'sw')}
        />
        
        {/* Bottom-right */}
        <div
          className="absolute bg-primary border-2 border-background rounded-sm cursor-nwse-resize pointer-events-auto"
          style={{
            bottom: 0,
            right: 0,
            width: `${handleSize}px`,
            height: `${handleSize}px`,
          }}
          onMouseDown={(e) => handleMouseDown(e, 'se')}
        />
      </div>

      {/* Size Tooltip - shown during resize */}
      {resizeState.isResizing && (
        <div
          className="fixed z-[1001] bg-foreground text-background text-xs px-2 py-1 rounded shadow-lg pointer-events-none"
          style={{
            left: `${resizeState.startX + 10}px`,
            top: `${resizeState.startY + 10}px`,
          }}
        >
          {currentSize.width} × {currentSize.height}px
        </div>
      )}
    </>
  );
}
================================================================================FILE: components/admin/products/InlineImageToolbar.tsx================================================================================'use client';

import { useEffect, useRef, useState } from 'react';
import { Editor } from '@tiptap/react';
import { Button } from '@/components/ui/button';
import {
  AlignLeft,
  AlignCenter,
  AlignRight,
  X,
  Pencil,
  Trash2,
  Crop,
  Sparkles,
} from 'lucide-react';
import { ImageResizeHandles } from './ImageResizeHandles';
import { ImageDetailsModal } from './ImageDetailsModal';
import { ImagePixelEditor } from './ImagePixelEditor';

interface InlineImageToolbarProps {
  editor: Editor | null;
}

interface ImagePosition {
  top: number;
  left: number;
  width: number;
}

export function InlineImageToolbar({ editor }: InlineImageToolbarProps) {
  const [selectedImage, setSelectedImage] = useState<HTMLElement | null>(null);
  const [position, setPosition] = useState<ImagePosition | null>(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showPixelEditor, setShowPixelEditor] = useState(false);
  const [isRemovingBackground, setIsRemovingBackground] = useState(false);
  const toolbarRef = useRef<HTMLDivElement>(null);

  // Use ref to track selectedImage without causing re-renders
  const selectedImageRef = useRef<HTMLElement | null>(null);
  const showEditModalRef = useRef(false);
  const showPixelEditorRef = useRef(false);
  
  useEffect(() => {
    selectedImageRef.current = selectedImage;
  }, [selectedImage]);
  
  useEffect(() => {
    showEditModalRef.current = showEditModal;
  }, [showEditModal]);
  
  useEffect(() => {
    showPixelEditorRef.current = showPixelEditor;
  }, [showPixelEditor]);

  useEffect(() => {
    if (!editor) return;

    const handleImageClick = (event: MouseEvent) => {
      const target = event.target as HTMLElement;
      
      // Check if clicked element is an image or inside an image wrapper
      const img = target.closest('img');
      if (!img) {
        // If clicking outside, hide toolbar
        if (selectedImageRef.current && !toolbarRef.current?.contains(target)) {
          setSelectedImage(null);
          setPosition(null);
        }
        return;
      }

      // Get image position for toolbar placement
      const rect = img.getBoundingClientRect();
      const editorElement = editor.view.dom;
      const editorRect = editorElement.getBoundingClientRect();
      
      setSelectedImage(img);
      setPosition({
        top: rect.top - editorRect.top - 40, // Position above image
        left: rect.left - editorRect.left + rect.width / 2, // Center horizontally
        width: rect.width,
      });
    };

    const handleClickOutside = (event: MouseEvent) => {
      // Use ref to access current selectedImage without dependency
      if (!selectedImageRef.current) return;
      
      const target = event.target as HTMLElement;
      
      // Don't hide toolbar if modals are open
      if (showEditModalRef.current || showPixelEditorRef.current) {
        return;
      }
      
      // Don't hide toolbar if clicking inside modal/dialog (fallback check)
      if (
        target.closest('[role="dialog"]') ||
        target.closest('[data-radix-portal]') ||
        target.closest('[data-radix-dialog-content]') ||
        target.closest('[data-radix-dialog-overlay]')
      ) {
        return;
      }
      
      if (
        !toolbarRef.current?.contains(target) &&
        !target.closest('img') &&
        !target.closest('[data-image-toolbar]')
      ) {
        setSelectedImage(null);
        setPosition(null);
      }
    };

    const editorElement = editor.view.dom;
    editorElement.addEventListener('click', handleImageClick);
    document.addEventListener('click', handleClickOutside);

    return () => {
      editorElement.removeEventListener('click', handleImageClick);
      document.removeEventListener('click', handleClickOutside);
    };
  }, [editor]); // Removed selectedImage from dependencies to prevent re-setup

  // Update toolbar position on scroll/resize
  useEffect(() => {
    if (!selectedImage || !editor) return;

    const updatePosition = () => {
      if (!selectedImage) return;
      
      const rect = selectedImage.getBoundingClientRect();
      const editorElement = editor.view.dom;
      const editorRect = editorElement.getBoundingClientRect();
      
      setPosition({
        top: rect.top - editorRect.top - 40,
        left: rect.left - editorRect.left + rect.width / 2,
        width: rect.width,
      });
    };

    // Update on scroll/resize
    window.addEventListener('scroll', updatePosition, true);
    window.addEventListener('resize', updatePosition);

    return () => {
      window.removeEventListener('scroll', updatePosition, true);
      window.removeEventListener('resize', updatePosition);
    };
  }, [selectedImage, editor]); // Removed position from dependencies to prevent re-setup

  if (!selectedImage || !position || !editor) {
    return null;
  }

  const updateImageAlignment = (alignment: 'left' | 'center' | 'right' | 'none') => {
    if (!selectedImage || !editor) return;
    
    const src = selectedImage.getAttribute('src') || '';
    const alt = selectedImage.getAttribute('alt') || '';
    
    // Find image node position in editor
    let imagePos: number | null = null;
    let foundNodes = 0;
    editor.state.doc.descendants((node, pos) => {
      if (node.type.name === 'image' && node.attrs.src === src) {
        imagePos = pos;
        return false;
      }
    });
    
    if (imagePos === null) {
      return;
    }
    
    // Get current image node
    const imageNode = editor.state.doc.nodeAt(imagePos);
    if (!imageNode || imageNode.type.name !== 'image') return;
    
    // Build new attributes based on alignment
    let newClass = '';
    let newStyle = '';
    
    switch (alignment) {
      case 'left':
        newClass = 'alignleft';
        newStyle = 'float: left; margin-right: 1rem;';
        break;
      case 'center':
        newClass = 'aligncenter';
        newStyle = 'display: block; margin: 0 auto;';
        break;
      case 'right':
        newClass = 'alignright';
        newStyle = 'float: right; margin-left: 1rem;';
        break;
      case 'none':
        newClass = '';
        newStyle = '';
        break;
    }
    
    // Update image node with new attributes
    const currentAttrs = imageNode.attrs;
    const currentClass = currentAttrs.class || '';
    const currentStyle = currentAttrs.style || '';
    
    // Remove old alignment classes
    const cleanedClass = currentClass
      .split(' ')
      .filter((c: string) => !c.startsWith('align'))
      .join(' ')
      .trim();
    
    const finalClass = cleanedClass ? `${cleanedClass} ${newClass}`.trim() : newClass;
    
    // Update image
    editor
      .chain()
      .focus()
      .setNodeSelection(imagePos)
      .updateAttributes('image', {
        ...currentAttrs,
        class: finalClass || undefined,
        style: newStyle || undefined,
      })
      .run();
    
    // Wait for Tiptap to update DOM, then sync DOM element
    // Use requestAnimationFrame to ensure DOM is updated after Tiptap's internal update cycle
    requestAnimationFrame(() => {
      // Find the updated image element using Tiptap's nodeDOM API (most reliable)
      if (imagePos === null) return;
      const domNode = editor.view.nodeDOM(imagePos);
      let updatedImg: HTMLElement | null = null;
      
      if (domNode && domNode.nodeType === Node.ELEMENT_NODE) {
        const element = domNode as HTMLElement;
        if (element.tagName === 'IMG') {
          updatedImg = element;
        } else {
          // If it's a wrapper element, find the img inside
          updatedImg = element.querySelector('img');
        }
      }
      
      // Fallback: use selectedImage if nodeDOM lookup fails
      if (!updatedImg && selectedImage) {
        updatedImg = selectedImage;
      }
      
      if (updatedImg) {
        // Get current DOM classes to preserve Tiptap-added classes (like max-w-full, h-auto)
        const currentDomClass = updatedImg.getAttribute('class') || '';
        const domClasses = currentDomClass.split(' ').filter(c => c.trim());
        
        // Preserve Tiptap system classes that shouldn't be removed
        const systemClasses = ['max-w-full', 'h-auto'];
        const preservedClasses = domClasses.filter(c => systemClasses.includes(c));
        
        // Merge preserved classes with our alignment classes
        const mergedClasses = [
          ...preservedClasses,
          ...(finalClass ? finalClass.split(' ').filter(c => c.trim()) : [])
        ].filter((v, i, a) => a.indexOf(v) === i); // Remove duplicates
        
        // Sync DOM attributes with Tiptap state, preserving system classes
        if (mergedClasses.length > 0) {
          updatedImg.setAttribute('class', mergedClasses.join(' '));
        } else {
          updatedImg.removeAttribute('class');
        }
        
        if (newStyle) {
          updatedImg.setAttribute('style', newStyle);
        } else {
          updatedImg.removeAttribute('style');
        }
        
        // Update selectedImage reference to the newly rendered element
        if (updatedImg !== selectedImage) {
          setSelectedImage(updatedImg);
        }
      }
    });
  };

  const handleAlignLeft = () => updateImageAlignment('left');
  const handleAlignCenter = () => updateImageAlignment('center');
  const handleAlignRight = () => updateImageAlignment('right');
  const handleNoAlignment = () => updateImageAlignment('none');

  const handleEdit = () => {
    setShowEditModal(true);
  };

  const handleEditPixel = () => {
    setShowPixelEditor(true);
  };

  const handleRemoveBackground = async () => {
    if (!editor || !selectedImage || isRemovingBackground) return;

    const src = selectedImage.getAttribute('src') || '';
    if (!src) return;

    setIsRemovingBackground(true);

    try {
      // Call API to remove background
      const response = await fetch('/api/admin/images/remove-background', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          imageUrl: src,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to remove background');
      }

      const data = await response.json();
      const newImageUrl = data.url;

      if (!newImageUrl) {
        throw new Error('No URL returned from server');
      }

      // Update image in editor
      let imagePos: number | null = null;
      editor.state.doc.descendants((node, pos) => {
        if (node.type.name === 'image' && node.attrs.src === src) {
          imagePos = pos;
          return false;
        }
      });

      if (imagePos !== null) {
        const imageNode = editor.state.doc.nodeAt(imagePos);
        if (imageNode && imageNode.type.name === 'image') {
          // Store original URL for restore
          const originalSrc = imageNode.attrs['data-original-src'] || src;
          
          editor
            .chain()
            .focus()
            .setNodeSelection(imagePos)
            .updateAttributes('image', {
              ...imageNode.attrs,
              src: newImageUrl,
              'data-original-src': originalSrc,
              'data-background-removed': 'true',
            })
            .run();
        }
      }

      // Update selected image reference
      selectedImage.setAttribute('src', newImageUrl);
    } catch (error) {
      console.error('Error removing background:', error);
      alert('Có lỗi xảy ra khi tách nền. Vui lòng thử lại.');
    } finally {
      setIsRemovingBackground(false);
    }
  };

  const handleRemove = () => {
    if (!selectedImage || !editor) return;
    
    const src = selectedImage.getAttribute('src');
    if (!src) return;
    
    // Find image node position in editor
    let imagePos: number | null = null;
    editor.state.doc.descendants((node, pos) => {
      if (node.type.name === 'image' && node.attrs.src === src) {
        imagePos = pos;
        return false;
      }
    });
    
    if (imagePos !== null) {
      // Delete image node
      editor
        .chain()
        .focus()
        .setNodeSelection(imagePos)
        .deleteSelection()
        .run();
    }
    
    setSelectedImage(null);
    setPosition(null);
  };

  return (
    <>
      {/* Image Details Modal */}
      <ImageDetailsModal
        isOpen={showEditModal}
        onClose={() => setShowEditModal(false)}
        editor={editor}
        selectedImage={selectedImage}
      />

      {/* Pixel Editor Modal */}
      {selectedImage && (
        <ImagePixelEditor
          isOpen={showPixelEditor}
          onClose={() => setShowPixelEditor(false)}
          editor={editor}
          selectedImage={selectedImage}
          originalImageUrl={selectedImage.getAttribute('data-original-src') || undefined}
        />
      )}

      {/* Resize Handles */}
      {selectedImage && (
        <ImageResizeHandles 
          editor={editor} 
          selectedImage={selectedImage}
        />
      )}
      
      {/* Toolbar - hidden when modals are open */}
      {!showEditModal && !showPixelEditor && (
        <div
          ref={toolbarRef}
          data-image-toolbar="true"
          className="absolute z-[50] bg-background border border-input rounded-md shadow-lg p-1 flex items-center gap-1"
          style={{
            top: `${position.top}px`,
            left: `${position.left}px`,
            transform: 'translateX(-50%)',
          }}
        >
        {/* Alignment buttons */}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleAlignLeft}
          title="Căn trái"
        >
          <AlignLeft className="h-4 w-4" />
        </Button>
        
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleAlignCenter}
          title="Căn giữa"
        >
          <AlignCenter className="h-4 w-4" />
        </Button>
        
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleAlignRight}
          title="Căn phải"
        >
          <AlignRight className="h-4 w-4" />
        </Button>
        
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleNoAlignment}
          title="Không căn chỉnh"
        >
          <X className="h-4 w-4" />
        </Button>
        
        <div className="h-4 w-px bg-border mx-1" />
        
        {/* Edit button (Image Details) */}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleEdit}
          title="Chi tiết hình ảnh"
        >
          <Pencil className="h-4 w-4" />
        </Button>

        {/* Pixel Editor button (Crop/Rotate) */}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleEditPixel}
          title="Cắt cúp & Xoay"
        >
          <Crop className="h-4 w-4" />
        </Button>

        {/* Remove Background button */}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0"
          onClick={handleRemoveBackground}
          disabled={isRemovingBackground}
          title="Tách nền AI"
        >
          <Sparkles className={`h-4 w-4 ${isRemovingBackground ? 'animate-spin' : ''}`} />
        </Button>
        
        {/* Remove button */}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="h-6 w-6 p-0 text-destructive hover:text-destructive"
          onClick={handleRemove}
          title="Xóa"
        >
          <Trash2 className="h-4 w-4" />
        </Button>
        </div>
      )}
    </>
  );
}
================================================================================FILE: components/admin/products/InlinePriceEditor.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Check, X, Loader2 } from 'lucide-react';
import { useQuickUpdateProduct } from '@/lib/hooks/useQuickUpdateProduct';

interface InlinePriceEditorProps {
  productId: string;
  currentPrice: string | number;
  onSave?: (newPrice: number) => void;
  onCancel?: () => void;
}

export function InlinePriceEditor({
  productId,
  currentPrice,
  onSave,
  onCancel,
}: InlinePriceEditorProps) {
  const [value, setValue] = useState(() => {
    // Convert price to number and remove currency formatting
    const numPrice = typeof currentPrice === 'string' ? parseFloat(currentPrice) : currentPrice;
    return isNaN(numPrice) || numPrice <= 0 ? '' : numPrice.toString();
  });
  const [error, setError] = useState<string | null>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const { quickUpdate, isLoading } = useQuickUpdateProduct({
    onSuccess: (updatedProduct) => {
      const newPrice = parseFloat(updatedProduct.price);
      onSave?.(newPrice);
    },
  });

  // Focus input on mount
  useEffect(() => {
    if (inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const inputValue = e.target.value;
    setValue(inputValue);
    setError(null);

    // Validate: only allow numbers and decimal point
    if (inputValue && !/^\d*\.?\d*$/.test(inputValue)) {
      setError('Vui lòng nhập số hợp lệ');
      return;
    }

    // Validate: price >= 0
    const numValue = parseFloat(inputValue);
    if (inputValue && (isNaN(numValue) || numValue < 0)) {
      setError('Giá phải lớn hơn hoặc bằng 0');
      return;
    }
  };

  const handleSave = async () => {
    if (!value || value.trim() === '') {
      setError('Vui lòng nhập giá');
      return;
    }

    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < 0) {
      setError('Giá phải lớn hơn hoặc bằng 0');
      return;
    }

    // If price hasn't changed, just cancel
    const currentNumPrice = typeof currentPrice === 'string' ? parseFloat(currentPrice) : currentPrice;
    if (numValue === currentNumPrice) {
      onCancel?.();
      return;
    }

    await quickUpdate(productId, { price: numValue });
  };

  const handleCancel = () => {
    setValue(typeof currentPrice === 'string' ? parseFloat(currentPrice).toString() : currentPrice.toString());
    setError(null);
    onCancel?.();
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSave();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      handleCancel();
    }
  };

  // Format display value with VND
  const formatPrice = (price: number): string => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(price);
  };

  return (
    <div className="flex items-center gap-2 min-w-[200px]">
      <div className="flex-1">
        <Input
          ref={inputRef}
          type="text"
          value={value}
          onChange={handleChange}
          onKeyDown={handleKeyDown}
          placeholder="Nhập giá (VND)"
          className={`h-8 text-sm ${error ? 'border-red-500' : ''}`}
          disabled={isLoading}
        />
        {error && (
          <p className="text-xs text-red-500 mt-1">{error}</p>
        )}
        {value && !error && (
          <p className="text-xs text-gray-500 mt-1">
            {formatPrice(parseFloat(value))}
          </p>
        )}
      </div>
      <div className="flex items-center gap-1">
        <Button
          size="sm"
          variant="ghost"
          onClick={handleSave}
          disabled={isLoading || !!error || !value}
          className="h-8 w-8 p-0"
          title="Lưu"
        >
          {isLoading ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <Check className="w-4 h-4 text-green-600" />
          )}
        </Button>
        <Button
          size="sm"
          variant="ghost"
          onClick={handleCancel}
          disabled={isLoading}
          className="h-8 w-8 p-0"
          title="Hủy"
        >
          <X className="w-4 h-4 text-gray-400" />
        </Button>
      </div>
    </div>
  );
}

================================================================================FILE: components/admin/products/InlineStockEditor.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Check, X, Loader2, Plus, Minus } from 'lucide-react';
import { useQuickUpdateProduct } from '@/lib/hooks/useQuickUpdateProduct';

interface InlineStockEditorProps {
  productId: string;
  currentStock: number | null;
  onSave?: (newStock: number) => void;
  onCancel?: () => void;
}

export function InlineStockEditor({
  productId,
  currentStock,
  onSave,
  onCancel,
}: InlineStockEditorProps) {
  const [value, setValue] = useState(() => {
    return currentStock !== null && currentStock !== undefined ? currentStock.toString() : '0';
  });
  const [error, setError] = useState<string | null>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const { quickUpdate, isLoading } = useQuickUpdateProduct({
    onSuccess: (updatedProduct) => {
      const newStock = updatedProduct.stockQuantity ?? 0;
      onSave?.(newStock);
    },
  });

  // Focus input on mount
  useEffect(() => {
    if (inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const inputValue = e.target.value;
    setValue(inputValue);
    setError(null);

    // Validate: only allow integers
    if (inputValue && !/^\d+$/.test(inputValue)) {
      setError('Vui lòng nhập số nguyên hợp lệ');
      return;
    }

    // Validate: stockQuantity >= 0
    const numValue = parseInt(inputValue, 10);
    if (inputValue && (isNaN(numValue) || numValue < 0)) {
      setError('Số lượng phải lớn hơn hoặc bằng 0');
      return;
    }
  };

  const handleIncrement = () => {
    const numValue = parseInt(value, 10) || 0;
    setValue(String(numValue + 1));
    setError(null);
  };

  const handleDecrement = () => {
    const numValue = parseInt(value, 10) || 0;
    if (numValue > 0) {
      setValue(String(numValue - 1));
      setError(null);
    }
  };

  const handleSave = async () => {
    if (!value || value.trim() === '') {
      setError('Vui lòng nhập số lượng');
      return;
    }

    const numValue = parseInt(value, 10);
    if (isNaN(numValue) || numValue < 0) {
      setError('Số lượng phải lớn hơn hoặc bằng 0');
      return;
    }

    // If stock hasn't changed, just cancel
    const currentNumStock = currentStock ?? 0;
    if (numValue === currentNumStock) {
      onCancel?.();
      return;
    }

    await quickUpdate(productId, { stockQuantity: numValue });
  };

  const handleCancel = () => {
    setValue(currentStock !== null && currentStock !== undefined ? currentStock.toString() : '0');
    setError(null);
    onCancel?.();
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSave();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      handleCancel();
    }
  };

  return (
    <div className="flex items-center gap-2 min-w-[200px]">
      <div className="flex-1">
        <div className="flex items-center gap-1">
          <Button
            size="sm"
            variant="ghost"
            onClick={handleDecrement}
            disabled={isLoading || parseInt(value, 10) <= 0}
            className="h-8 w-8 p-0"
            title="Giảm"
          >
            <Minus className="w-4 h-4" />
          </Button>
          <Input
            ref={inputRef}
            type="number"
            value={value}
            onChange={handleChange}
            onKeyDown={handleKeyDown}
            placeholder="Nhập số lượng"
            min="0"
            className={`h-8 text-sm text-center ${error ? 'border-red-500' : ''}`}
            disabled={isLoading}
          />
          <Button
            size="sm"
            variant="ghost"
            onClick={handleIncrement}
            disabled={isLoading}
            className="h-8 w-8 p-0"
            title="Tăng"
          >
            <Plus className="w-4 h-4" />
          </Button>
        </div>
        {error && (
          <p className="text-xs text-red-500 mt-1">{error}</p>
        )}
      </div>
      <div className="flex items-center gap-1">
        <Button
          size="sm"
          variant="ghost"
          onClick={handleSave}
          disabled={isLoading || !!error || !value}
          className="h-8 w-8 p-0"
          title="Lưu"
        >
          {isLoading ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <Check className="w-4 h-4 text-green-600" />
          )}
        </Button>
        <Button
          size="sm"
          variant="ghost"
          onClick={handleCancel}
          disabled={isLoading}
          className="h-8 w-8 p-0"
          title="Hủy"
        >
          <X className="w-4 h-4 text-gray-400" />
        </Button>
      </div>
    </div>
  );
}

================================================================================FILE: components/admin/products/MediaExtendedSection.tsx================================================================================'use client';

import { useState } from 'react';
import Image from 'next/image';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Plus, Trash2, X, Image as ImageIcon, Video, RotateCw } from 'lucide-react';

interface VideoData {
  url: string;
  type: 'youtube' | 'vimeo' | 'upload';
  thumbnail?: string;
}

interface MediaExtendedData {
  videos?: VideoData[];
  view360Images?: string[];
  imageAltTexts?: Record<string, string>; // imageUrl -> altText
}

interface MediaExtendedSectionProps {
  data: MediaExtendedData;
  onChange: (data: MediaExtendedData) => void;
  productImages?: string[]; // Existing product images for alt text management
}

export function MediaExtendedSection({ data, onChange, productImages = [] }: MediaExtendedSectionProps) {
  const [videoInput, setVideoInput] = useState<{ url: string; type: 'youtube' | 'vimeo' | 'upload'; thumbnail: string }>({ url: '', type: 'youtube', thumbnail: '' });
  const [view360Input, setView360Input] = useState('');
  const [altTextInputs, setAltTextInputs] = useState<Record<string, string>>({});

  const updateField = <K extends keyof MediaExtendedData>(field: K, value: MediaExtendedData[K]) => {
    onChange({ ...data, [field]: value });
  };

  const addVideo = () => {
    if (videoInput.url.trim()) {
      const videos = data.videos || [];
      // Check if URL is YouTube or Vimeo
      let videoType: 'youtube' | 'vimeo' | 'upload' = 'upload';
      if (videoInput.url.includes('youtube.com') || videoInput.url.includes('youtu.be')) {
        videoType = 'youtube';
      } else if (videoInput.url.includes('vimeo.com')) {
        videoType = 'vimeo';
      }

      updateField('videos', [
        ...videos,
        {
          url: videoInput.url.trim(),
          type: videoType,
          thumbnail: videoInput.thumbnail.trim() || undefined,
        },
      ]);
      setVideoInput({ url: '', type: 'youtube', thumbnail: '' });
    }
  };

  const removeVideo = (index: number) => {
    const videos = data.videos || [];
    updateField('videos', videos.filter((_, i) => i !== index));
  };

  const addView360Image = () => {
    if (view360Input.trim()) {
      const images = data.view360Images || [];
      if (!images.includes(view360Input.trim())) {
        updateField('view360Images', [...images, view360Input.trim()]);
        setView360Input('');
      }
    }
  };

  const removeView360Image = (imageUrl: string) => {
    const images = data.view360Images || [];
    updateField('view360Images', images.filter((img) => img !== imageUrl));
  };

  const updateAltText = (imageUrl: string, altText: string) => {
    const altTexts = data.imageAltTexts || {};
    updateField('imageAltTexts', { ...altTexts, [imageUrl]: altText });
  };

  const getVideoThumbnail = (video: VideoData) => {
    if (video.thumbnail) return video.thumbnail;
    if (video.type === 'youtube') {
      const videoId = video.url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/)?.[1];
      return videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : '';
    }
    return '';
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Media mở rộng</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Videos */}
        <div>
          <Label className="mb-3 block flex items-center gap-2">
            <Video className="w-4 h-4" />
            Video sản phẩm
          </Label>
          <div className="space-y-3">
            <div className="flex gap-2">
              <select
                value={videoInput.type}
                onChange={(e) => setVideoInput({ ...videoInput, type: e.target.value as 'youtube' | 'vimeo' | 'upload' })}
                className="border rounded px-3 py-2"
              >
                <option value="youtube">YouTube</option>
                <option value="vimeo">Vimeo</option>
                <option value="upload">Upload (URL)</option>
              </select>
              <Input
                value={videoInput.url}
                onChange={(e) => setVideoInput({ ...videoInput, url: e.target.value })}
                placeholder="URL video (YouTube, Vimeo hoặc direct URL)"
                className="flex-1"
              />
              <Button type="button" onClick={addVideo} variant="outline">
                <Plus className="w-4 h-4 mr-2" />
                Thêm
              </Button>
            </div>
            {videoInput.type !== 'upload' && (
              <div>
                <Label htmlFor="videoThumbnail">Thumbnail (tùy chọn)</Label>
                <Input
                  id="videoThumbnail"
                  type="url"
                  value={videoInput.thumbnail}
                  onChange={(e) => setVideoInput({ ...videoInput, thumbnail: e.target.value })}
                  placeholder="URL thumbnail image"
                />
              </div>
            )}
            {data.videos && data.videos.length > 0 && (
              <div className="space-y-2">
                {data.videos.map((video, idx) => (
                  <div key={idx} className="flex items-center gap-3 p-3 border rounded-lg">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <Video className="w-4 h-4 text-gray-500" />
                        <span className="text-sm font-medium">{video.type.toUpperCase()}</span>
                      </div>
                      <p className="text-sm text-gray-600 truncate">{video.url}</p>
                      {getVideoThumbnail(video) && (
                        <div className="relative w-24 h-16 rounded mt-2 overflow-hidden">
                          <Image
                            src={getVideoThumbnail(video)!}
                            alt="Video thumbnail"
                            fill
                            className="object-cover"
                            sizes="96px"
                          />
                        </div>
                      )}
                    </div>
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => removeVideo(idx)}
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* 360° View Images */}
        <div>
          <Label className="mb-3 block flex items-center gap-2">
            <RotateCw className="w-4 h-4" />
            Ảnh xoay 360 độ
          </Label>
          <div className="space-y-3">
            <div className="flex gap-2">
              <Input
                value={view360Input}
                onChange={(e) => setView360Input(e.target.value)}
                placeholder="URL hình ảnh 360°"
                className="flex-1"
              />
              <Button type="button" onClick={addView360Image} variant="outline">
                <Plus className="w-4 h-4 mr-2" />
                Thêm
              </Button>
            </div>
            {data.view360Images && data.view360Images.length > 0 && (
              <div className="grid grid-cols-4 gap-3">
                {data.view360Images.map((imageUrl, idx) => (
                  <div key={idx} className="relative group">
                    <div className="relative w-full h-24 rounded overflow-hidden">
                      <Image
                        src={imageUrl}
                        alt={`360 view ${idx + 1}`}
                        fill
                        className="object-cover"
                        sizes="(max-width: 768px) 25vw, 150px"
                      />
                    </div>
                    <Button
                      type="button"
                      variant="destructive"
                      size="sm"
                      className="absolute top-1 right-1 opacity-0 group-hover:opacity-100"
                      onClick={() => removeView360Image(imageUrl)}
                    >
                      <X className="w-3 h-3" />
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Image Alt Text Management */}
        {productImages.length > 0 && (
          <div>
            <Label className="mb-3 block flex items-center gap-2">
              <ImageIcon className="w-4 h-4" />
              Alt Text cho hình ảnh
            </Label>
            <div className="space-y-3">
              {productImages.map((imageUrl) => (
                <div key={imageUrl} className="flex gap-3">
                  <div className="relative w-20 h-20 flex-shrink-0 rounded overflow-hidden">
                    <Image
                      src={imageUrl}
                      alt="Product"
                      fill
                      className="object-cover"
                      sizes="80px"
                    />
                  </div>
                  <div className="flex-1">
                    <Input
                      value={data.imageAltTexts?.[imageUrl] || ''}
                      onChange={(e) => updateAltText(imageUrl, e.target.value)}
                      placeholder="Nhập alt text cho hình ảnh này"
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/MediaLibraryModal.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import Image from 'next/image';
import { createPortal } from 'react-dom';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Card, CardContent } from '@/components/ui/card';
import { Upload, X, Image as ImageIcon, Video, File, Loader2, Link as LinkIcon } from 'lucide-react';
import { convertVideoUrlToEmbed, isAllowedVideoDomain } from '@/lib/utils/videoEmbed';

export interface MediaItem {
  id: string;
  url: string;
  thumbnail_url?: string; // Thumbnail URL for images
  type: 'image' | 'video' | 'file';
  alt?: string;
  title?: string;
  caption?: string;
  description?: string;
}

interface MediaLibraryModalProps {
  isOpen: boolean;
  onClose: () => void;
  onInsert?: (html: string) => void; // For editor mode (legacy)
  onSelect?: (items: MediaItem | MediaItem[]) => void; // For image selection mode (new)
  mode?: 'single' | 'multiple'; // Selection mode: single for featured image, multiple for gallery
  selectedIds?: string[]; // Pre-select existing images by IDs (for gallery mode)
  buttonText?: string; // Custom button text (default: "Chèn vào bài viết" or "Thiết lập ảnh sản phẩm")
}

/**
 * Media Library Modal - Giống WordPress Add Media
 * Features:
 * - Upload Files tab với drag & drop
 * - Media Library tab với grid view
 * - Attachment Details sidebar
 * - Display Settings (alignment, link, size)
 */
export function MediaLibraryModal({ 
  isOpen, 
  onClose, 
  onInsert,
  onSelect,
  mode = 'single',
  selectedIds = [],
  buttonText,
}: MediaLibraryModalProps) {
  const [activeTab, setActiveTab] = useState<'upload' | 'library' | 'url'>('upload');
  const [videoUrl, setVideoUrl] = useState('');
  const [videoAltText, setVideoAltText] = useState('');
  const [selectedMedia, setSelectedMedia] = useState<MediaItem | null>(null);
  const [selectedMediaMultiple, setSelectedMediaMultiple] = useState<MediaItem[]>([]); // For multiple selection
  const [mediaItems, setMediaItems] = useState<MediaItem[]>([]);
  const [loadingMedia, setLoadingMedia] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<Record<string, number>>({});
  
  // Attachment Details
  const [altText, setAltText] = useState('');
  const [title, setTitle] = useState('');
  const [caption, setCaption] = useState('');
  const [description, setDescription] = useState('');
  
  // Display Settings
  const [alignment, setAlignment] = useState<'left' | 'center' | 'right' | 'none'>('none');
  const [linkTo, setLinkTo] = useState<'file' | 'attachment' | 'custom' | 'none'>('file');
  const [customUrl, setCustomUrl] = useState('');
  const [size, setSize] = useState<'thumbnail' | 'medium' | 'large' | 'full'>('medium');
  
  const fileInputRef = useRef<HTMLInputElement>(null);
  const dropZoneRef = useRef<HTMLDivElement>(null);

  // Reset state when modal closes
  useEffect(() => {
    if (!isOpen) {
      // Reset all state when modal closes
      setSelectedMedia(null);
      setSelectedMediaMultiple([]);
      setAltText('');
      setTitle('');
      setCaption('');
      setDescription('');
      setAlignment('none');
      setLinkTo('file');
      setCustomUrl('');
      setSize('medium');
      setUploadProgress({});
      setActiveTab('upload');
    }
  }, [isOpen]);

  // Pre-select existing images when modal opens
  useEffect(() => {
    if (isOpen && selectedIds.length > 0 && mediaItems.length > 0) {
      const preSelected = mediaItems.filter(item => selectedIds.includes(item.id));
      if (mode === 'multiple') {
        setSelectedMediaMultiple(preSelected);
      } else if (preSelected.length > 0) {
        setSelectedMedia(preSelected[0]);
      }
    }
  }, [isOpen, selectedIds, mediaItems, mode]);

  // Load media library from API when modal opens and library tab is active
  useEffect(() => {
    if (isOpen && activeTab === 'library') {
      const fetchMedia = async () => {
        setLoadingMedia(true);
        try {
          const response = await fetch('/api/admin/media?page=1&limit=100&sort=newest');
          if (!response.ok) {
            throw new Error('Failed to fetch media');
          }
          const result = await response.json();
          
          if (result.success && result.data) {
            // Map API response to MediaItem format
            const mappedItems: MediaItem[] = result.data.map((item: any) => ({
              id: item._id,
              url: item.url,
              thumbnail_url: item.thumbnail_url || (item.type === 'image' ? item.url : undefined),
              type: item.type === 'image' ? 'image' : item.type === 'video' ? 'video' : 'file',
              alt: item.altText || item.name,
              title: item.name,
              caption: item.caption,
              description: item.description,
            }));
            setMediaItems(mappedItems);
          } else {
            setMediaItems([]);
          }
        } catch (error) {
          console.error('Error fetching media:', error);
          setMediaItems([]);
        } finally {
          setLoadingMedia(false);
        }
      };
      
      fetchMedia();
    } else if (!isOpen) {
      // Reset media items when modal closes
      setMediaItems([]);
    }
  }, [isOpen, activeTab]);

  const handleFileSelect = async (files: FileList | null) => {
    if (!files || files.length === 0) return;

    setUploading(true);
    const newItems: MediaItem[] = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      // Generate unique ID with timestamp and random to avoid collisions
      const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${i}`;

      // Validate file type
      if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
        alert(`File ${file.name} không được hỗ trợ. Chỉ chấp nhận hình ảnh và video.`);
        continue;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert(`File ${file.name} vượt quá 5MB`);
        continue;
      }

      try {
        // Upload to Vercel Blob via API
        setUploadProgress((prev) => ({ ...prev, [fileId]: 0 }));
        
        const uploadFormData = new FormData();
        uploadFormData.append('file', file);

        // Use new Media Library API endpoint
        const uploadResponse = await fetch('/api/admin/media', {
          method: 'POST',
          body: uploadFormData,
        });

        if (!uploadResponse.ok) {
          const errorData = await uploadResponse.json();
          throw new Error(errorData.error || 'Upload failed');
        }

        const uploadResult = await uploadResponse.json();
        setUploadProgress((prev) => ({ ...prev, [fileId]: 100 }));

        // Map new API response format to MediaItem
        const mediaItem: MediaItem = {
          id: uploadResult.data._id || fileId,
          url: uploadResult.data.url,
          thumbnail_url: uploadResult.data.thumbnail_url || (file.type.startsWith('image/') ? uploadResult.data.url : undefined),
          type: uploadResult.data.type === 'image' ? 'image' : uploadResult.data.type === 'video' ? 'video' : 'file',
          title: uploadResult.data.name || file.name.replace(/\.[^/.]+$/, ''),
          alt: uploadResult.data.altText || file.name.replace(/\.[^/.]+$/, ''),
          caption: uploadResult.data.caption,
          description: uploadResult.data.description,
        };

        newItems.push(mediaItem);
      } catch (error) {
        console.error(`Error uploading file ${file.name}:`, error);
        alert(`Không thể upload file ${file.name}: ${error instanceof Error ? error.message : 'Lỗi không xác định'}. Vui lòng thử lại.`);
        setUploadProgress((prev) => {
          const next = { ...prev };
          delete next[fileId];
          return next;
        });
      }
    }

    // Refresh media list from API after upload to ensure sync with main Media Library
    // This ensures modal shows all media including newly uploaded ones
    if (activeTab === 'library') {
      const refreshMedia = async () => {
        try {
          const response = await fetch('/api/admin/media?page=1&limit=100&sort=newest');
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              const mappedItems: MediaItem[] = result.data.map((item: any) => ({
                id: item._id,
                url: item.url,
                thumbnail_url: item.thumbnail_url || (item.type === 'image' ? item.url : undefined),
                type: item.type === 'image' ? 'image' : item.type === 'video' ? 'video' : 'file',
                alt: item.altText || item.name,
                title: item.name,
                caption: item.caption,
                description: item.description,
              }));
              setMediaItems(mappedItems);
            }
          }
        } catch (error) {
          console.error('Error refreshing media:', error);
          // Fallback: add new items to existing list if refresh fails
          setMediaItems((prev) => [...prev, ...newItems]);
        }
      };
      refreshMedia();
    } else {
      // If not on library tab, just add to list
      setMediaItems((prev) => [...prev, ...newItems]);
    }
    setUploading(false);
    setUploadProgress({});

    // Auto-select first uploaded item and switch to library tab to show uploaded images
    if (newItems.length > 0) {
      // Switch to library tab to show uploaded images
      setActiveTab('library');
      
      if (mode === 'multiple') {
        setSelectedMediaMultiple(prev => [...prev, ...newItems]);
      } else {
        setSelectedMedia(newItems[0]);
        setAltText(newItems[0].alt || '');
        setTitle(newItems[0].title || '');
      }
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    const files = e.dataTransfer.files;
    handleFileSelect(files);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
  };

  const handleMediaClick = (item: MediaItem) => {
    if (mode === 'multiple') {
      // Toggle selection in multiple mode
      const isSelected = selectedMediaMultiple.some(m => m.id === item.id);
      if (isSelected) {
        setSelectedMediaMultiple(prev => prev.filter(m => m.id !== item.id));
      } else {
        setSelectedMediaMultiple(prev => [...prev, item]);
      }
    } else {
      // Single selection mode
      setSelectedMedia(item);
      setAltText(item.alt || '');
      setTitle(item.title || '');
      setCaption(item.caption || '');
      setDescription(item.description || '');
    }
  };

  const handleInsert = () => {
    // If onSelect is provided (image selection mode), use it
    if (onSelect) {
      if (mode === 'multiple') {
        if (selectedMediaMultiple.length === 0) {
          alert('Vui lòng chọn ít nhất một ảnh');
          return;
        }
        onSelect(selectedMediaMultiple);
      } else {
        if (!selectedMedia) {
          alert('Vui lòng chọn một ảnh');
          return;
        }
        onSelect(selectedMedia);
      }
      onClose();
      return;
    }

    // Legacy mode: onInsert (for editor)
    if (!selectedMedia) {
      alert('Vui lòng chọn một media item');
      return;
    }

    // Validate custom URL if provided
    if (linkTo === 'custom' && customUrl) {
      try {
        new URL(customUrl);
      } catch {
        alert('URL tùy chỉnh không hợp lệ');
        return;
      }
    }

    let html = '';

    if (selectedMedia.type === 'image') {
      // Build image HTML
      const imgClass = alignment !== 'none' ? `align${alignment}` : '';
      const imgSize = size !== 'full' ? `size-${size}` : '';
      const classes = [imgClass, imgSize].filter(Boolean).join(' ');

      let imgTag = `<img`;
      if (classes) imgTag += ` class="${classes}"`;
      imgTag += ` src="${selectedMedia.url}"`;
      if (altText) imgTag += ` alt="${altText}"`;
      imgTag += ` />`;

      // Wrap with link if needed
      if (linkTo === 'file') {
        html = `<a href="${selectedMedia.url}">${imgTag}</a>`;
      } else if (linkTo === 'attachment') {
        html = `<a href="#attachment-${selectedMedia.id}">${imgTag}</a>`;
      } else if (linkTo === 'custom' && customUrl) {
        html = `<a href="${customUrl}">${imgTag}</a>`;
      } else {
        html = imgTag;
      }

      // Add caption if provided (WordPress-style caption)
      if (caption) {
        const captionId = selectedMedia.id ? `id="attachment_${selectedMedia.id}"` : '';
        const alignClass = alignment !== 'none' ? `align${alignment}` : 'aligncenter';
        html = `[caption ${captionId} align="${alignClass}" width="300"]${imgTag} ${caption}[/caption]`;
      }
    } else if (selectedMedia.type === 'video') {
      // Check if it's an embeddable video URL (YouTube, Vimeo, etc.)
      const embedHtml = convertVideoUrlToEmbed(selectedMedia.url);
      if (embedHtml) {
        html = embedHtml;
      } else {
        // Regular video file
        html = `<video src="${selectedMedia.url}" controls></video>`;
      }
    }

    onInsert?.(html);
    onClose();
  };

  const handleInsertFromUrl = () => {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/b261569c-76a6-4f8c-839c-264dc5457f92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'MediaLibraryModal.tsx:297',message:'handleInsertFromUrl called',data:{videoUrl:videoUrl.substring(0,100)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
    // #endregion
    
    if (!videoUrl.trim()) {
      alert('Vui lòng nhập URL video');
      return;
    }

    // Validate URL
    try {
      new URL(videoUrl);
    } catch {
      alert('URL không hợp lệ');
      return;
    }

    // Check if it's an embeddable video URL
    const embedHtml = convertVideoUrlToEmbed(videoUrl.trim());
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/b261569c-76a6-4f8c-839c-264dc5457f92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'MediaLibraryModal.tsx:312',message:'convertVideoUrlToEmbed result',data:{hasEmbedHtml:!!embedHtml},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
    // #endregion
    
    if (embedHtml) {
      // Insert video embed
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/b261569c-76a6-4f8c-839c-264dc5457f92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'MediaLibraryModal.tsx:315',message:'Calling onInsert with embedHtml',data:{embedHtmlLength:embedHtml.length,hasOnInsert:!!onInsert},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
      // #endregion
      onInsert?.(embedHtml);
      setVideoUrl('');
      setVideoAltText('');
      onClose();
    } else if (isAllowedVideoDomain(videoUrl)) {
      // Direct video file URL
      const altAttr = videoAltText ? ` alt="${videoAltText}"` : '';
      const html = `<video src="${videoUrl.trim()}" controls${altAttr}></video>`;
      onInsert?.(html);
      setVideoUrl('');
      setVideoAltText('');
      onClose();
    } else {
      alert('URL video không được hỗ trợ. Vui lòng sử dụng YouTube, Vimeo, TikTok hoặc URL video trực tiếp (mp4).');
    }
  };

  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    return () => setMounted(false);
  }, []);

  if (!isOpen || !mounted) return null;

  const modalContent = (
    <div 
      className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4" 
      style={{ isolation: 'isolate' }}
      onClick={(e) => {
        // Close on backdrop click
        if (e.target === e.currentTarget) {
          onClose();
        }
      }}
    >
      <div 
        className="bg-background rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col relative z-[10000]" 
        style={{ isolation: 'isolate' }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b">
          <h2 className="text-lg font-semibold">Thêm Media</h2>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={onClose}
          >
            <X className="h-4 w-4" />
          </Button>
        </div>

        {/* Tabs */}
        <div className="flex border-b">
          <button
            type="button"
            onClick={() => setActiveTab('upload')}
            className={`px-4 py-2 text-sm font-medium ${
              activeTab === 'upload'
                ? 'border-b-2 border-primary text-primary'
                : 'text-muted-foreground hover:text-foreground'
            }`}
          >
            Tải tập tin lên
          </button>
          <button
            type="button"
            onClick={() => setActiveTab('library')}
            className={`px-4 py-2 text-sm font-medium ${
              activeTab === 'library'
                ? 'border-b-2 border-primary text-primary'
                : 'text-muted-foreground hover:text-foreground'
            }`}
          >
            Thư viện Media
          </button>
          <button
            type="button"
            onClick={() => setActiveTab('url')}
            className={`px-4 py-2 text-sm font-medium ${
              activeTab === 'url'
                ? 'border-b-2 border-primary text-primary'
                : 'text-muted-foreground hover:text-foreground'
            }`}
          >
            <LinkIcon className="h-4 w-4 inline mr-1" />
            Chèn từ URL
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-hidden flex">
          {/* Main Content Area */}
          <div className="flex-1 overflow-y-auto p-4">
            {activeTab === 'upload' ? (
              <div
                ref={dropZoneRef}
                onDrop={handleDrop}
                onDragOver={handleDragOver}
                className="border-2 border-dashed border-input rounded-lg p-12 text-center"
              >
                <Upload className="h-16 w-16 mx-auto text-muted-foreground mb-4" />
                <p className="text-lg font-medium mb-2">Kéo thả file vào đây</p>
                <p className="text-sm text-muted-foreground mb-4">
                  Hoặc click để chọn file từ máy tính
                </p>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*,video/*"
                  multiple
                  className="hidden"
                  onChange={(e) => handleFileSelect(e.target.files)}
                />
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => fileInputRef.current?.click()}
                  disabled={uploading}
                >
                  {uploading ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Đang upload...
                    </>
                  ) : (
                    <>
                      <Upload className="h-4 w-4 mr-2" />
                      Chọn file
                    </>
                  )}
                </Button>
                {uploading && Object.keys(uploadProgress).length > 0 && (
                  <div className="mt-4 space-y-2">
                    {Object.entries(uploadProgress).map(([fileId, progress]) => (
                      <div key={fileId} className="text-sm text-muted-foreground">
                        Đang upload... {progress}%
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ) : activeTab === 'url' ? (
              <div className="space-y-4 max-w-2xl mx-auto">
                <div>
                  <Label htmlFor="videoUrl">URL Video</Label>
                  <Input
                    id="videoUrl"
                    type="url"
                    value={videoUrl}
                    onChange={(e) => setVideoUrl(e.target.value)}
                    placeholder="https://www.youtube.com/watch?v=... hoặc https://vimeo.com/..."
                    className="mt-2"
                  />
                  <p className="text-xs text-muted-foreground mt-1">
                    Hỗ trợ: YouTube, Vimeo, TikTok, hoặc URL video trực tiếp (mp4)
                  </p>
                </div>
                <div>
                  <Label htmlFor="videoAltText">Alt Text (tùy chọn)</Label>
                  <Input
                    id="videoAltText"
                    type="text"
                    value={videoAltText}
                    onChange={(e) => setVideoAltText(e.target.value)}
                    placeholder="Mô tả video cho người dùng khiếm thị"
                    className="mt-2"
                  />
                </div>
                <div className="flex justify-end gap-2">
                  <Button
                    type="button"
                    variant="outline"
                    onClick={onClose}
                  >
                    Hủy
                  </Button>
                  <Button
                    type="button"
                    onClick={handleInsertFromUrl}
                    disabled={!videoUrl.trim()}
                  >
                    Chèn video
                  </Button>
                </div>
              </div>
            ) : (
              <div>
                {loadingMedia ? (
                  <div className="text-center py-12">
                    <Loader2 className="h-16 w-16 mx-auto text-muted-foreground mb-4 animate-spin" />
                    <p className="text-muted-foreground">Đang tải media...</p>
                  </div>
                ) : mediaItems.length === 0 ? (
                  <div className="text-center py-12">
                    <ImageIcon className="h-16 w-16 mx-auto text-muted-foreground mb-4" />
                    <p className="text-muted-foreground">Chưa có media nào</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-4 gap-4">
                    {mediaItems.map((item) => {
                      const isSelected = mode === 'multiple' 
                        ? selectedMediaMultiple.some(m => m.id === item.id)
                        : selectedMedia?.id === item.id;
                      
                      return (
                        <div
                          key={item.id}
                          onClick={() => handleMediaClick(item)}
                          className={`cursor-pointer border-2 rounded-lg overflow-hidden transition-all ${
                            isSelected
                              ? 'border-primary ring-2 ring-primary'
                              : 'border-input hover:border-primary/50'
                          }`}
                        >
                          {item.type === 'image' ? (
                            <div className="relative w-full h-32">
                              <Image
                                src={item.url}
                                alt={item.alt || ''}
                                fill
                                className="object-cover"
                                sizes="(max-width: 768px) 100vw, 200px"
                              />
                            </div>
                          ) : (
                            <div className="w-full h-32 bg-muted flex items-center justify-center">
                              <Video className="h-8 w-8 text-muted-foreground" />
                            </div>
                          )}
                          <div className="p-2 text-xs truncate">{item.title}</div>
                          {isSelected && mode === 'multiple' && (
                            <div className="absolute top-2 right-2 bg-primary text-primary-foreground rounded-full w-6 h-6 flex items-center justify-center text-xs">
                              {selectedMediaMultiple.findIndex(m => m.id === item.id) + 1}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Attachment Details Sidebar */}
          {(selectedMedia || (mode === 'multiple' && selectedMediaMultiple.length > 0)) && (
            <div className="w-80 border-l p-4 overflow-y-auto">
              <h3 className="font-semibold mb-4">
                {mode === 'multiple' 
                  ? `Đã chọn ${selectedMediaMultiple.length} ảnh`
                  : 'Chi tiết đính kèm'}
              </h3>

              {/* Preview - Only show in single mode or first selected in multiple mode */}
              {mode === 'single' && selectedMedia && (
                <>
                  <div className="mb-4">
                    {selectedMedia.type === 'image' ? (
                      <div className="relative w-full aspect-video rounded-lg overflow-hidden">
                        <Image
                          src={selectedMedia.url}
                          alt={selectedMedia.alt || ''}
                          fill
                          className="object-contain"
                          sizes="(max-width: 768px) 100vw, 512px"
                        />
                      </div>
                    ) : (
                      <div className="w-full aspect-video bg-muted rounded-lg flex items-center justify-center">
                        <Video className="h-12 w-12 text-muted-foreground" />
                      </div>
                    )}
                  </div>

                  {/* Metadata Fields - Only in single mode */}
                  <div className="space-y-4">
                <div>
                  <Label htmlFor="media-alt">Văn bản thay thế (Alt Text)</Label>
                  <Input
                    id="media-alt"
                    value={altText}
                    onChange={(e) => setAltText(e.target.value)}
                    className="mt-1"
                    placeholder="Mô tả hình ảnh"
                  />
                </div>

                <div>
                  <Label htmlFor="media-title">Tiêu đề</Label>
                  <Input
                    id="media-title"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    className="mt-1"
                  />
                </div>

                <div>
                  <Label htmlFor="media-caption">Chú thích</Label>
                  <Input
                    id="media-caption"
                    value={caption}
                    onChange={(e) => setCaption(e.target.value)}
                    className="mt-1"
                    placeholder="Hiển thị bên dưới hình ảnh"
                  />
                </div>

                <div>
                  <Label htmlFor="media-description">Mô tả</Label>
                  <textarea
                    id="media-description"
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    className="mt-1 w-full min-h-[80px] rounded-md border border-input bg-background px-3 py-2 text-sm"
                    placeholder="Mô tả chi tiết"
                  />
                  </div>
                </div>

                {/* Display Settings - Only in single mode and when onInsert is used */}
                {onInsert && (
                  <div className="mt-6 pt-6 border-t space-y-4">
                    <h3 className="font-semibold mb-4">Thiết lập hiển thị</h3>

                    <div>
                      <Label htmlFor="media-alignment">Căn chỉnh</Label>
                      <Select
                        value={alignment}
                        onValueChange={(value) => setAlignment(value as typeof alignment)}
                      >
                        <SelectTrigger id="media-alignment" className="mt-1">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="none">Không</SelectItem>
                          <SelectItem value="left">Trái</SelectItem>
                          <SelectItem value="center">Giữa</SelectItem>
                          <SelectItem value="right">Phải</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    <div>
                      <Label htmlFor="media-link">Liên kết tới</Label>
                      <Select
                        value={linkTo}
                        onValueChange={(value) => setLinkTo(value as typeof linkTo)}
                      >
                        <SelectTrigger id="media-link" className="mt-1">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="none">Không</SelectItem>
                          <SelectItem value="file">Tập tin đa phương tiện</SelectItem>
                          <SelectItem value="attachment">Trang đính kèm</SelectItem>
                          <SelectItem value="custom">Tùy chỉnh URL</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    {linkTo === 'custom' && (
                      <div>
                        <Label htmlFor="media-custom-url">URL tùy chỉnh</Label>
                        <Input
                          id="media-custom-url"
                          value={customUrl}
                          onChange={(e) => setCustomUrl(e.target.value)}
                          className="mt-1"
                          placeholder="https://..."
                          type="url"
                        />
                        {customUrl && !customUrl.match(/^https?:\/\//) && (
                          <p className="text-xs text-muted-foreground mt-1">
                            URL nên bắt đầu với http:// hoặc https://
                          </p>
                        )}
                      </div>
                    )}

                    {selectedMedia.type === 'image' && (
                      <div>
                        <Label htmlFor="media-size">Kích cỡ</Label>
                        <Select
                          value={size}
                          onValueChange={(value) => setSize(value as typeof size)}
                        >
                          <SelectTrigger id="media-size" className="mt-1">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="thumbnail">Thumbnail (150x150)</SelectItem>
                            <SelectItem value="medium">Medium (300x300)</SelectItem>
                            <SelectItem value="large">Large (1024x1024)</SelectItem>
                            <SelectItem value="full">Full Size</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    )}
                  </div>
                )}
                </>
              )}

              {/* Multiple selection preview */}
              {mode === 'multiple' && selectedMediaMultiple.length > 0 && (
                <div className="grid grid-cols-2 gap-2 mb-4">
                  {selectedMediaMultiple.map((item) => (
                    <div key={item.id} className="relative">
                      {item.type === 'image' ? (
                        <div className="relative w-full aspect-video rounded-lg overflow-hidden">
                          <Image
                            src={item.thumbnail_url || item.url}
                            alt={item.alt || ''}
                            fill
                            className="object-cover"
                            sizes="(max-width: 768px) 50vw, 200px"
                          />
                        </div>
                      ) : (
                        <div className="w-full aspect-square bg-muted rounded-lg flex items-center justify-center">
                          <Video className="h-8 w-8 text-muted-foreground" />
                        </div>
                      )}
                      <button
                        type="button"
                        onClick={() => setSelectedMediaMultiple(prev => prev.filter(m => m.id !== item.id))}
                        className="absolute top-1 right-1 bg-destructive text-destructive-foreground rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-destructive/90"
                      >
                        <X className="h-3 w-3" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t flex justify-end gap-2">
          <Button type="button" variant="outline" onClick={onClose}>
            Hủy
          </Button>
          <Button
            type="button"
            onClick={handleInsert}
            disabled={
              mode === 'multiple' 
                ? selectedMediaMultiple.length === 0
                : !selectedMedia
            }
          >
            {buttonText || (mode === 'single' 
              ? (onSelect ? 'Thiết lập ảnh sản phẩm' : 'Chèn vào bài viết')
              : (onSelect ? 'Thêm vào thư viện' : 'Chèn vào bài viết'))}
          </Button>
        </div>
      </div>
    </div>
  );

  // Render modal using Portal to ensure it's always on top
  return createPortal(modalContent, document.body);
}
================================================================================FILE: components/admin/products/PriceCell.tsx================================================================================'use client';

import { useState } from 'react';
import { Pencil } from 'lucide-react';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { InlinePriceEditor } from './InlinePriceEditor';

interface PriceCellProps {
  product: MappedProduct;
  onUpdate?: (updatedProduct: MappedProduct) => void;
}

export function PriceCell({ product, onUpdate }: PriceCellProps) {
  const [isEditing, setIsEditing] = useState(false);

  const formatPrice = (price: string | number): string => {
    const numPrice = typeof price === 'string' ? parseFloat(price) : price;
    if (isNaN(numPrice) || numPrice <= 0) {
      return 'Liên hệ';
    }
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(numPrice);
  };

  // For variable products, show price range
  const isVariable = product.type === 'variable' || (product.variations && product.variations.length > 0);
  
  let priceDisplay: string;
  if (isVariable) {
    // Get minPrice/maxPrice from product (may be in productDataMetaBox or direct fields)
    const productAny = product as any;
    const minPrice = productAny.minPrice 
      ? parseFloat(String(productAny.minPrice)) 
      : parseFloat(product.price);
    const maxPrice = productAny.maxPrice 
      ? parseFloat(String(productAny.maxPrice)) 
      : parseFloat(product.price);
    
    if (minPrice === maxPrice || isNaN(minPrice) || isNaN(maxPrice)) {
      priceDisplay = formatPrice(product.price);
    } else {
      priceDisplay = `${formatPrice(minPrice)} - ${formatPrice(maxPrice)}`;
    }
  } else {
    priceDisplay = formatPrice(product.price);
  }

  const handleSave = (newPrice: number) => {
    // Update product locally (optimistic update)
    const updatedProduct: MappedProduct = {
      ...product,
      price: newPrice.toString(),
      regularPrice: newPrice.toString(),
    };
    onUpdate?.(updatedProduct);
    setIsEditing(false);
  };

  if (isEditing) {
    return (
      <InlinePriceEditor
        productId={product.id}
        currentPrice={product.price}
        onSave={handleSave}
        onCancel={() => setIsEditing(false)}
      />
    );
  }

  return (
    <div className="flex items-center gap-2">
      <span className="text-sm font-medium text-gray-900">{priceDisplay}</span>
      <button
        onClick={() => setIsEditing(true)}
        className="p-1 hover:bg-gray-100 rounded transition-colors"
        title="Sửa giá"
      >
        <Pencil className="w-3 h-3 text-gray-400 hover:text-gray-600" />
      </button>
    </div>
  );
}

================================================================================FILE: components/admin/products/PriceInput.tsx================================================================================'use client';

import { Input } from '@/components/ui/input';
import { forwardRef, useState, useEffect } from 'react';

interface PriceInputProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'value' | 'onChange'> {
  value?: number;
  onChange?: (value: number | undefined) => void;
  showCurrency?: boolean;
}

/**
 * PriceInput Component
 * Formats number with thousand separators (10.000.000) while typing
 * Stores actual number value (without formatting)
 */
export const PriceInput = forwardRef<HTMLInputElement, PriceInputProps>(
  ({ value, onChange, showCurrency = true, className, ...props }, ref) => {
    const [displayValue, setDisplayValue] = useState<string>('');

    // Update display value when value prop changes
    useEffect(() => {
      if (value === undefined || value === null || isNaN(value)) {
        setDisplayValue('');
      } else {
        // Format with thousand separators
        const formatted = new Intl.NumberFormat('vi-VN').format(value);
        setDisplayValue(formatted);
      }
    }, [value]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const inputValue = e.target.value;
      
      // Remove all non-digit characters (keep only numbers)
      const numericValue = inputValue.replace(/[^\d]/g, '');
      
      // Update display with formatting
      if (numericValue === '') {
        setDisplayValue('');
        onChange?.(undefined);
      } else {
        const num = parseInt(numericValue, 10);
        if (!isNaN(num)) {
          // Format with thousand separators for display
          const formatted = new Intl.NumberFormat('vi-VN').format(num);
          setDisplayValue(formatted);
          // Pass numeric value to onChange
          onChange?.(num);
        }
      }
    };

    const handleBlur = (e: React.FocusEvent<HTMLInputElement>) => {
      // On blur, ensure display value matches the numeric value
      if (value !== undefined && value !== null && !isNaN(value)) {
        const formatted = new Intl.NumberFormat('vi-VN').format(value);
        setDisplayValue(formatted);
      }
    };

    return (
      <div className="relative">
        <Input
          {...props}
          ref={ref}
          type="text"
          inputMode="numeric"
          value={displayValue}
          onChange={handleChange}
          onBlur={handleBlur}
          className={showCurrency ? `${className || ''} pr-20` : className}
        />
        {showCurrency && (
          <span className="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground pointer-events-none">
            đ
          </span>
        )}
      </div>
    );
  }
);

PriceInput.displayName = 'PriceInput';
================================================================================FILE: components/admin/products/PriceRangeFilter.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { X } from 'lucide-react';

interface PriceRangeFilterProps {
  minPrice: number | null;
  maxPrice: number | null;
  onMinPriceChange: (value: number | null) => void;
  onMaxPriceChange: (value: number | null) => void;
  onClear: () => void;
}

export function PriceRangeFilter({
  minPrice,
  maxPrice,
  onMinPriceChange,
  onMaxPriceChange,
  onClear,
}: PriceRangeFilterProps) {
  const [minValue, setMinValue] = useState(minPrice?.toString() || '');
  const [maxValue, setMaxValue] = useState(maxPrice?.toString() || '');
  const [error, setError] = useState<string | null>(null);

  // Sync with props
  useEffect(() => {
    setMinValue(minPrice?.toString() || '');
    setMaxValue(maxPrice?.toString() || '');
  }, [minPrice, maxPrice]);

  const formatPrice = (price: number): string => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      maximumFractionDigits: 0,
    }).format(price);
  };

  const handleMinChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setMinValue(value);
    setError(null);

    if (!value || value.trim() === '') {
      onMinPriceChange(null);
      return;
    }

    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < 0) {
      setError('Giá tối thiểu phải là số >= 0');
      return;
    }

    if (maxPrice !== null && numValue > maxPrice) {
      setError('Giá tối thiểu không được lớn hơn giá tối đa');
      return;
    }

    onMinPriceChange(numValue);
  };

  const handleMaxChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setMaxValue(value);
    setError(null);

    if (!value || value.trim() === '') {
      onMaxPriceChange(null);
      return;
    }

    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < 0) {
      setError('Giá tối đa phải là số >= 0');
      return;
    }

    if (minPrice !== null && numValue < minPrice) {
      setError('Giá tối đa không được nhỏ hơn giá tối thiểu');
      return;
    }

    onMaxPriceChange(numValue);
  };

  const hasValue = minPrice !== null || maxPrice !== null;

  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <Label className="text-sm font-medium">Khoảng giá (VND)</Label>
        {hasValue && (
          <button
            onClick={onClear}
            className="text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1"
          >
            <X className="w-3 h-3" />
            Xóa
          </button>
        )}
      </div>
      <div className="flex items-center gap-2">
        <div className="flex-1">
          <Input
            type="number"
            placeholder="Tối thiểu"
            value={minValue}
            onChange={handleMinChange}
            min="0"
            className="text-sm"
          />
        </div>
        <span className="text-gray-400">-</span>
        <div className="flex-1">
          <Input
            type="number"
            placeholder="Tối đa"
            value={maxValue}
            onChange={handleMaxChange}
            min="0"
            className="text-sm"
          />
        </div>
      </div>
      {error && (
        <p className="text-xs text-red-500">{error}</p>
      )}
      {hasValue && !error && (
        <p className="text-xs text-gray-500">
          {minPrice !== null && maxPrice !== null
            ? `${formatPrice(minPrice)} - ${formatPrice(maxPrice)}`
            : minPrice !== null
            ? `Từ ${formatPrice(minPrice)}`
            : `Đến ${formatPrice(maxPrice!)}`}
        </p>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/ProductActionMenu.tsx================================================================================'use client';

import { useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { MoreHorizontal, Eye, Copy, Trash2, RotateCcw, AlertTriangle, Loader2 } from 'lucide-react';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { useToastContext } from '@/components/providers/ToastProvider';
import { RestoreProductModal } from './RestoreProductModal';
import { ForceDeleteModal } from './ForceDeleteModal';

interface ProductActionMenuProps {
  product: MappedProduct;
  isTrashTab?: boolean;
  isDeleting?: boolean;
  onDelete?: (id: string) => Promise<void>;
  onRestore?: (id: string) => Promise<void>;
  onForceDelete?: (id: string) => Promise<void>;
  onDuplicate?: (id: string) => Promise<void>;
}

export function ProductActionMenu({
  product,
  isTrashTab = false,
  onDelete,
  onRestore,
  onForceDelete,
  onDuplicate,
}: ProductActionMenuProps) {
  const router = useRouter();
  const { showToast } = useToastContext();
  const [isLoading, setIsLoading] = useState(false);
  const [showRestoreModal, setShowRestoreModal] = useState(false);
  const [showForceDeleteModal, setShowForceDeleteModal] = useState(false);

  const handleDelete = async () => {
    if (!onDelete) return;
    
    if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
      return;
    }

    setIsLoading(true);
    try {
      await onDelete(product.id);
      showToast('Đã chuyển vào thùng rác', 'success');
    } catch (error) {
      showToast('Không thể xóa sản phẩm', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const handleRestore = async () => {
    if (!onRestore) return;

    setIsLoading(true);
    try {
      await onRestore(product.id);
      showToast('Đã khôi phục sản phẩm', 'success');
      setShowRestoreModal(false);
    } catch (error) {
      showToast('Không thể khôi phục sản phẩm', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const handleForceDelete = async () => {
    if (!onForceDelete) return;

    setIsLoading(true);
    try {
      await onForceDelete(product.id);
      showToast('Đã xóa vĩnh viễn sản phẩm', 'success');
      setShowForceDeleteModal(false);
    } catch (error) {
      showToast('Không thể xóa sản phẩm', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const handleDuplicate = async () => {
    if (!onDuplicate) return;

    setIsLoading(true);
    try {
      await onDuplicate(product.id);
      showToast('Đã tạo bản sao sản phẩm', 'success');
    } catch (error) {
      showToast('Không thể tạo bản sao', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="sm"
          className="h-8 w-8 p-0"
          disabled={isLoading}
        >
          <MoreHorizontal className="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        {!isTrashTab && (
          <>
            <DropdownMenuItem asChild>
              <Link href={`/admin/products/${product.id}`} className="cursor-pointer">
                <Eye className="mr-2 h-4 w-4" />
                Xem chi tiết
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link href={`/admin/products/${product.id}/edit`} className="cursor-pointer">
                <Eye className="mr-2 h-4 w-4" />
                Chỉnh sửa
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem
              onClick={handleDuplicate}
              disabled={isLoading}
              className="cursor-pointer"
            >
              <Copy className="mr-2 h-4 w-4" />
              Nhân bản
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem
              onClick={handleDelete}
              disabled={isLoading}
              className="cursor-pointer text-red-600"
            >
              {isLoading ? (
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              ) : (
                <Trash2 className="mr-2 h-4 w-4" />
              )}
              {isLoading ? 'Đang xóa...' : 'Xóa tạm'}
            </DropdownMenuItem>
          </>
        )}
        {isTrashTab && (
          <>
            <DropdownMenuItem
              onClick={() => setShowRestoreModal(true)}
              disabled={isLoading}
              className="cursor-pointer"
            >
              {isLoading ? (
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              ) : (
                <RotateCcw className="mr-2 h-4 w-4" />
              )}
              {isLoading ? 'Đang xử lý...' : 'Khôi phục'}
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem
              onClick={() => setShowForceDeleteModal(true)}
              disabled={isLoading}
              className="cursor-pointer text-red-600"
            >
              {isLoading ? (
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              ) : (
                <AlertTriangle className="mr-2 h-4 w-4" />
              )}
              {isLoading ? 'Đang xóa...' : 'Xóa vĩnh viễn'}
            </DropdownMenuItem>
          </>
        )}
      </DropdownMenuContent>

      {/* Modals */}
      <RestoreProductModal
        isOpen={showRestoreModal}
        onClose={() => setShowRestoreModal(false)}
        onConfirm={handleRestore}
        product={product}
      />
      <ForceDeleteModal
        isOpen={showForceDeleteModal}
        onClose={() => setShowForceDeleteModal(false)}
        onConfirm={handleForceDelete}
        product={product}
      />
    </DropdownMenu>
  );
}

================================================================================FILE: components/admin/products/ProductAnalytics.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Eye, MousePointerClick, ShoppingCart, Search, TrendingUp } from 'lucide-react';

interface AnalyticsData {
  productId: string;
  totals: {
    views: number;
    clicks: number;
    conversions: number;
    searches: number;
  };
  conversionRate: number;
  popularVariants: Array<{ variant: string; count: number }>;
  searchKeywords: Array<{ keyword: string; count: number }>;
  dailyData: Array<{
    date: string;
    views: number;
    clicks: number;
    conversions: number;
    searches: number;
  }>;
}

interface ProductAnalyticsProps {
  productId: string;
}

export function ProductAnalytics({ productId }: ProductAnalyticsProps) {
  const [analytics, setAnalytics] = useState<AnalyticsData | null>(null);
  const [loading, setLoading] = useState(true);
  const [startDate, setStartDate] = useState<string>('');
  const [endDate, setEndDate] = useState<string>('');

  useEffect(() => {
    // Set default date range (last 30 days)
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - 30);
    setEndDate(end.toISOString().split('T')[0]);
    setStartDate(start.toISOString().split('T')[0]);
  }, []);

  useEffect(() => {
    if (startDate && endDate) {
      fetchAnalytics();
    }
  }, [productId, startDate, endDate]);

  const fetchAnalytics = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (startDate) {
        params.append('startDate', startDate);
      }
      if (endDate) {
        params.append('endDate', endDate);
      }

      const response = await fetch(`/api/admin/products/${productId}/analytics?${params}`);
      const data = await response.json();
      setAnalytics(data);
    } catch (error) {
      console.error('Error fetching analytics:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <div className="text-center py-8">Đang tải...</div>;
  }

  if (!analytics) {
    return <div className="text-center py-8 text-gray-500">Không có dữ liệu phân tích</div>;
  }

  return (
    <div className="space-y-6">
      {/* Date Range Filter */}
      <Card>
        <CardHeader>
          <CardTitle>Lọc theo thời gian</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex gap-4">
            <div>
              <label className="text-sm font-medium mb-1 block">Từ ngày</label>
              <input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="border rounded px-3 py-2"
              />
            </div>
            <div>
              <label className="text-sm font-medium mb-1 block">Đến ngày</label>
              <input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className="border rounded px-3 py-2"
              />
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Lượt xem</p>
                <p className="text-2xl font-bold">{analytics.totals.views.toLocaleString()}</p>
              </div>
              <Eye className="w-8 h-8 text-blue-500" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Lượt click</p>
                <p className="text-2xl font-bold">{analytics.totals.clicks.toLocaleString()}</p>
              </div>
              <MousePointerClick className="w-8 h-8 text-green-500" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Chuyển đổi</p>
                <p className="text-2xl font-bold">{analytics.totals.conversions.toLocaleString()}</p>
              </div>
              <ShoppingCart className="w-8 h-8 text-purple-500" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Tỷ lệ chuyển đổi</p>
                <p className="text-2xl font-bold">{analytics.conversionRate}%</p>
              </div>
              <TrendingUp className="w-8 h-8 text-orange-500" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Popular Variants */}
      {analytics.popularVariants.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Biến thể phổ biến</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              {analytics.popularVariants.map((item, idx) => (
                <div key={idx} className="flex items-center justify-between p-2 border rounded">
                  <span className="text-sm">{item.variant}</span>
                  <span className="text-sm font-medium">{item.count} lượt</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Search Keywords */}
      {analytics.searchKeywords.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Từ khóa tìm kiếm</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-2">
              {analytics.searchKeywords.map((item, idx) => (
                <div
                  key={idx}
                  className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm flex items-center gap-2"
                >
                  <Search className="w-3 h-3" />
                  <span>{item.keyword}</span>
                  <span className="text-xs">({item.count})</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Daily Data Table */}
      {analytics.dailyData.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Dữ liệu theo ngày</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-2">Ngày</th>
                    <th className="text-right p-2">Lượt xem</th>
                    <th className="text-right p-2">Lượt click</th>
                    <th className="text-right p-2">Chuyển đổi</th>
                    <th className="text-right p-2">Tìm kiếm</th>
                  </tr>
                </thead>
                <tbody>
                  {analytics.dailyData.map((day, idx) => (
                    <tr key={idx} className="border-b">
                      <td className="p-2">
                        {new Date(day.date).toLocaleDateString('vi-VN')}
                      </td>
                      <td className="text-right p-2">{day.views || 0}</td>
                      <td className="text-right p-2">{day.clicks || 0}</td>
                      <td className="text-right p-2">{day.conversions || 0}</td>
                      <td className="text-right p-2">{day.searches || 0}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/ProductCell.tsx================================================================================'use client';

import Link from 'next/link';
import Image from 'next/image';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { stripHtmlTags } from '@/lib/utils/sanitizeHtml';

interface ProductCellProps {
  product: MappedProduct;
}

export function ProductCell({ product }: ProductCellProps) {
  const imageUrl = product.image?.sourceUrl || '/images/teddy-placeholder.png';
  
  // Strip HTML tags from product name (in case it contains HTML)
  const productName = stripHtmlTags(product.name || '');
  const imageAlt = product.image?.altText || productName;
  
  // Truncate description to 3 lines and strip HTML tags
  const rawDescription = product.shortDescription || product.description || '';
  const plainTextDescription = stripHtmlTags(rawDescription);
  const truncatedDescription = plainTextDescription.length > 150
    ? plainTextDescription.substring(0, 150) + '...'
    : plainTextDescription;

  return (
    <div className="flex items-start gap-3 min-w-[300px]">
      {/* Thumbnail */}
      <div className="relative w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-gray-100">
        <Image
          src={imageUrl}
          alt={imageAlt}
          fill
          className="object-cover"
          sizes="64px"
        />
      </div>

      {/* Product Info */}
      <div className="flex-1 min-w-0">
        <Link
          href={`/admin/products/${product.id}/edit`}
          className="font-medium text-gray-900 hover:text-blue-600 transition-colors line-clamp-1"
        >
          {productName}
        </Link>
        {truncatedDescription && (
          <p className="text-sm text-gray-500 mt-1 line-clamp-3">
            {truncatedDescription}
          </p>
        )}
      </div>
    </div>
  );
}

================================================================================FILE: components/admin/products/ProductDataGrid.tsx================================================================================'use client';

import { useMemo, useCallback } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Skeleton } from '@/components/ui/skeleton';
import { EmptyState } from '@/components/ui/empty-state';
import { ErrorState } from '@/components/ui/error-state';
import { Button } from '@/components/ui/button';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { ProductCell } from './ProductCell';
import { CategoryBrandCell } from './CategoryBrandCell';
import { SKUCell } from './SKUCell';
import { PriceCell } from './PriceCell';
import { StockCell } from './StockCell';
import { StatusCell } from './StatusCell';
import { ProductActionMenu } from './ProductActionMenu';
import { Filter } from 'lucide-react';
import { memo } from 'react';

interface ProductDataGridProps {
  products: MappedProduct[];
  loading?: boolean;
  error?: Error | null;
  selectedProducts: string[];
  onSelectProduct: (id: string) => void;
  onSelectAll: () => void;
  isTrashTab?: boolean;
  hasActiveFilters?: boolean;
  onClearFilters?: () => void;
  onDelete?: (id: string) => Promise<void>;
  onRestore?: (id: string) => Promise<void>;
  onForceDelete?: (id: string) => Promise<void>;
  onDuplicate?: (id: string) => Promise<void>;
  onStatusChange?: (id: string, status: 'draft' | 'publish') => Promise<void>;
  onProductUpdate?: (updatedProduct: MappedProduct) => void;
  onRetry?: () => void;
}

// CRITICAL: Memoize StatusCell wrapper để tránh re-render loop
// Component này nhận productId và onStatusChange, tạo callback ổn định
const StatusCellWrapper = memo(({ 
  productId, 
  product, 
  onStatusChange 
}: { 
  productId: string; 
  product: MappedProduct;
  onStatusChange?: (id: string, status: 'draft' | 'publish') => Promise<void>;
}) => {
  // Memoize callback với productId trong closure
  const handleStatusChange = useCallback(
    async (status: 'draft' | 'publish') => {
      if (onStatusChange) {
        await onStatusChange(productId, status);
      }
    },
    [onStatusChange, productId]
  );

  return (
    <StatusCell
      product={product}
      onStatusChange={onStatusChange ? handleStatusChange : undefined}
    />
  );
}, (prevProps, nextProps) => {
  // Custom comparison: chỉ re-render nếu product hoặc onStatusChange thay đổi
  // So sánh các trường quan trọng của product thay vì JSON.stringify (hiệu suất tốt hơn)
  return (
    prevProps.productId === nextProps.productId &&
    prevProps.product.status === nextProps.product.status &&
    prevProps.product.stockStatus === nextProps.product.stockStatus &&
    prevProps.product.isActive === nextProps.product.isActive &&
    prevProps.onStatusChange === nextProps.onStatusChange
  );
});
StatusCellWrapper.displayName = 'StatusCellWrapper';

export function ProductDataGrid({
  products,
  loading = false,
  error = null,
  selectedProducts,
  onSelectProduct,
  onSelectAll,
  isTrashTab = false,
  hasActiveFilters = false,
  onClearFilters,
  onDelete,
  onRestore,
  onForceDelete,
  onDuplicate,
  onStatusChange,
  onProductUpdate,
  onRetry,
}: ProductDataGridProps) {
  const allSelected = products.length > 0 && selectedProducts.length === products.length;
  const someSelected = selectedProducts.length > 0 && selectedProducts.length < products.length;

  // Error state
  if (error) {
    return (
      <ErrorState
        title="Không thể tải danh sách sản phẩm"
        message={error.message || 'Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại sau.'}
        action={
          onRetry
            ? {
                label: 'Thử lại',
                onClick: onRetry,
              }
            : undefined
        }
        variant="destructive"
      />
    );
  }

  // Loading state with improved skeleton
  if (loading) {
    return (
      <div className="space-y-4">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex items-center gap-4 p-4 border rounded-lg">
            <Skeleton className="h-16 w-16 rounded-lg" />
            <div className="flex-1 space-y-2">
              <Skeleton className="h-5 w-64" />
              <Skeleton className="h-4 w-48" />
              <div className="flex gap-4 mt-2">
                <Skeleton className="h-4 w-24" />
                <Skeleton className="h-4 w-24" />
                <Skeleton className="h-4 w-24" />
              </div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  // Empty state with improved UI
  if (products.length === 0) {
    if (isTrashTab) {
      return (
        <EmptyState
          title="Thùng rác sạch sẽ"
          description="Không có sản phẩm nào trong thùng rác. Sản phẩm đã xóa sẽ tự động bị xóa vĩnh viễn sau 30 ngày."
          icon="🗑️"
        />
      );
    }

    if (hasActiveFilters) {
      return (
        <div className="text-center py-12">
          <div className="space-y-4">
            <div className="text-6xl mb-4">🔍</div>
            <h3 className="text-lg font-medium text-gray-900">Không tìm thấy sản phẩm</h3>
            <p className="text-sm text-gray-500">
              Không có sản phẩm nào phù hợp với bộ lọc hiện tại. Hãy thử thay đổi bộ lọc hoặc tìm kiếm với từ khóa khác.
            </p>
            {onClearFilters && (
              <Button
                variant="outline"
                onClick={onClearFilters}
                className="mt-4"
              >
                <Filter className="w-4 h-4 mr-2" />
                Xóa bộ lọc
              </Button>
            )}
          </div>
        </div>
      );
    }

    return (
      <EmptyState
        title="Chưa có sản phẩm nào"
        description="Bắt đầu bằng cách thêm sản phẩm đầu tiên vào cửa hàng của bạn."
        icon="📦"
        action={{
          label: 'Thêm sản phẩm',
          href: '/admin/products/new',
        }}
      />
    );
  }

  return (
    <div className="overflow-x-auto">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-12">
              <input
                type="checkbox"
                checked={allSelected}
                ref={(input) => {
                  if (input) input.indeterminate = someSelected;
                }}
                onChange={onSelectAll}
                className="w-4 h-4"
              />
            </TableHead>
            <TableHead className="min-w-[300px]">Sản phẩm</TableHead>
            <TableHead className="hidden md:table-cell">Phân loại</TableHead>
            <TableHead className="hidden lg:table-cell">SKU</TableHead>
            <TableHead>Giá bán</TableHead>
            <TableHead className="hidden md:table-cell">Tồn kho</TableHead>
            <TableHead className="hidden lg:table-cell">Trạng thái</TableHead>
            <TableHead className="w-12">Hành động</TableHead>
          </TableRow>
        </TableHeader>
      <TableBody>
        {products.map((product) => (
          <TableRow key={product.id}>
            <TableCell>
              <input
                type="checkbox"
                checked={selectedProducts.includes(product.id)}
                onChange={() => onSelectProduct(product.id)}
                className="w-4 h-4"
              />
            </TableCell>
            <TableCell>
              <ProductCell product={product} />
            </TableCell>
            <TableCell className="hidden md:table-cell">
              <CategoryBrandCell product={product} />
            </TableCell>
            <TableCell className="hidden lg:table-cell">
              <SKUCell sku={product.sku} />
            </TableCell>
            <TableCell>
              <PriceCell
                product={product}
                onUpdate={onProductUpdate}
              />
            </TableCell>
            <TableCell className="hidden md:table-cell">
              <StockCell
                product={product}
                onUpdate={onProductUpdate}
              />
            </TableCell>
            <TableCell className="hidden lg:table-cell">
              <StatusCellWrapper
                productId={product.id}
                product={product}
                onStatusChange={onStatusChange}
              />
            </TableCell>
            <TableCell>
              <ProductActionMenu
                product={product}
                isTrashTab={isTrashTab}
                onDelete={onDelete}
                onRestore={onRestore}
                onForceDelete={onForceDelete}
                onDuplicate={onDuplicate}
              />
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
    </div>
  );
}

================================================================================FILE: components/admin/products/ProductDataMetaBox/AdvancedTab.tsx================================================================================'use client';

import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { Info } from 'lucide-react';
import type { ProductDataMetaBoxState } from './ProductDataMetaBox';

interface AdvancedTabProps {
  state: ProductDataMetaBoxState;
  onUpdate: (updates: Partial<ProductDataMetaBoxState>) => void;
}

/**
 * Advanced Tab - Purchase Note, Menu Order, Reviews
 * Features:
 * - Purchase Note textarea
 * - Menu Order number input
 * - Enable Reviews checkbox
 */
export function AdvancedTab({ state, onUpdate }: AdvancedTabProps) {
  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-4">Nâng cao</h3>

        {/* Purchase Note */}
        <div className="space-y-2 mb-6">
          <Label htmlFor="purchaseNote" className="text-sm font-medium">
            Ghi chú mua hàng
          </Label>
          <Textarea
            id="purchaseNote"
            placeholder="Gửi cho khách sau khi mua xong (trong email)"
            value={state.purchaseNote || ''}
            onChange={(e) => onUpdate({ purchaseNote: e.target.value || undefined })}
            rows={4}
            className="resize-none"
          />
          <p className="text-xs text-muted-foreground">
            Ghi chú này sẽ được gửi cho khách hàng trong email xác nhận đơn hàng
          </p>
        </div>

        {/* Menu Order */}
        <div className="space-y-2 mb-6">
          <Label htmlFor="menuOrder" className="text-sm font-medium">
            Thứ tự sắp xếp
          </Label>
          <Input
            id="menuOrder"
            type="number"
            value={state.menuOrder || 0}
            onChange={(e) => {
              const value = parseInt(e.target.value, 10);
              onUpdate({ menuOrder: isNaN(value) ? 0 : value });
            }}
            min={0}
            step={1}
            className="w-32"
          />
          <div className="flex items-start gap-2 text-xs text-muted-foreground">
            <Info className="h-4 w-4 mt-0.5 flex-shrink-0" />
            <p>Dùng để sắp xếp vị trí hiển thị sản phẩm. Số nhỏ hơn sẽ hiển thị trước.</p>
          </div>
        </div>

        {/* Enable Reviews */}
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <Checkbox
              id="enableReviews"
              checked={state.enableReviews ?? true}
              onCheckedChange={(checked) => onUpdate({ enableReviews: checked as boolean })}
            />
            <Label htmlFor="enableReviews" className="text-sm font-medium cursor-pointer">
              Bật đánh giá và bình luận
            </Label>
          </div>
          <div className="flex items-start gap-2 text-xs text-muted-foreground ml-6">
            <Info className="h-4 w-4 mt-0.5 flex-shrink-0" />
            <p>Bật/tắt tính năng đánh giá và bình luận cho sản phẩm này</p>
          </div>
        </div>
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/AttributeItem.tsx================================================================================'use client';

import { useState, useEffect, useRef } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { X, Plus, Palette } from 'lucide-react';
import { SmartValueInput } from '../SmartValueInput';
import type { Attribute as GlobalAttribute } from '@/app/admin/attributes/page';
import type { Term } from '@/app/admin/attributes/[id]/terms/page';

export interface Attribute {
  id: string;
  name: string;
  isGlobal: boolean;
  globalAttributeId?: string; // Reference to global attribute ID
  values: string[];
  usedForVariations: boolean;
  colorCodes?: Record<string, string>; // For color attributes: value -> hex code
}

interface AttributeItemProps {
  attribute: Attribute;
  onUpdate: (updated: Attribute) => void;
  onRemove: () => void;
  existingValues?: string[]; // For auto-suggest
  // New props for global attributes
  isGlobalAttribute?: boolean;
  globalAttributeType?: GlobalAttribute['type'];
  globalTerms?: Term[]; // Terms from API
  loadingTerms?: boolean;
  onLoadTerms?: () => void;
  onQuickAddTerm?: () => void;
}

/**
 * Attribute Item Component
 * Features:
 * - Name field (read-only if global, editable if custom)
 * - Values input với Tags/Chips UI
 * - Auto-suggest từ existing values
 * - Color Picker cho color attributes
 * - Used for variations checkbox
 */
export function AttributeItem({
  attribute,
  onUpdate,
  onRemove,
  existingValues = [],
  isGlobalAttribute = false,
  globalAttributeType,
  globalTerms = [],
  loadingTerms = false,
  onLoadTerms,
  onQuickAddTerm,
}: AttributeItemProps) {
  const [inputValue, setInputValue] = useState('');
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [suggestions, setSuggestions] = useState<string[]>([]);
  const inputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  const isColorAttribute = attribute.name.toLowerCase() === 'màu sắc' || 
                          attribute.name.toLowerCase() === 'color' ||
                          attribute.name.toLowerCase() === 'màu';

  // Load terms when global attribute is first rendered
  useEffect(() => {
    if (isGlobalAttribute && onLoadTerms && globalTerms.length === 0 && !loadingTerms) {
      onLoadTerms();
    }
  }, [isGlobalAttribute, onLoadTerms, globalTerms.length, loadingTerms]);

  // Filter suggestions based on input
  useEffect(() => {
    if (inputValue.trim() && existingValues.length > 0) {
      const filtered = existingValues
        .filter((val) => 
          val.toLowerCase().includes(inputValue.toLowerCase()) &&
          !attribute.values.includes(val)
        )
        .slice(0, 5);
      setSuggestions(filtered);
      setShowSuggestions(filtered.length > 0);
    } else {
      setSuggestions([]);
      setShowSuggestions(false);
    }
  }, [inputValue, existingValues, attribute.values]);

  // Close suggestions when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setShowSuggestions(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleAddValue = (value: string, colorCode?: string) => {
    if (!value.trim() || attribute.values.includes(value.trim())) return;

    const newValues = [...attribute.values, value.trim()];
    const newColorCodes = colorCode
      ? { ...attribute.colorCodes, [value.trim()]: colorCode }
      : attribute.colorCodes;

    onUpdate({
      ...attribute,
      values: newValues,
      colorCodes: newColorCodes,
    });

    setInputValue('');
    setShowSuggestions(false);
  };

  const handleRemoveValue = (value: string) => {
    const newValues = attribute.values.filter((v) => v !== value);
    const newColorCodes = { ...attribute.colorCodes };
    delete newColorCodes[value];

    onUpdate({
      ...attribute,
      values: newValues,
      colorCodes: Object.keys(newColorCodes).length > 0 ? newColorCodes : undefined,
    });
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && inputValue.trim()) {
      e.preventDefault();
      handleAddValue(inputValue);
    } else if (e.key === 'Escape') {
      setShowSuggestions(false);
    } else if (e.key === 'ArrowDown' && suggestions.length > 0) {
      e.preventDefault();
      // Could implement keyboard navigation here
    }
  };

  const handleColorChange = (value: string, colorCode: string) => {
    handleAddValue(value, colorCode);
  };

  return (
    <div className="p-4 border border-input rounded-lg bg-background space-y-4">
      <div className="flex items-start justify-between gap-4">
        {/* Attribute Name */}
        <div className="flex-1 space-y-2">
          <Label className="text-sm font-medium">Tên thuộc tính</Label>
          {attribute.isGlobal ? (
            <div className="px-3 py-2 bg-muted rounded border border-input text-sm">
              {attribute.name}
              <span className="ml-2 text-xs text-muted-foreground">(Global)</span>
            </div>
          ) : (
            <Input
              type="text"
              value={attribute.name}
              onChange={(e) => onUpdate({ ...attribute, name: e.target.value })}
              placeholder="VD: Kích thước, Màu sắc..."
              className="text-sm"
            />
          )}
        </div>

        {/* Remove Button */}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={onRemove}
          className="text-destructive hover:text-destructive hover:bg-destructive/10 mt-6"
        >
          <X className="h-4 w-4" />
        </Button>
      </div>

      {/* Values Input */}
      <div className="space-y-2" ref={containerRef}>
        <Label className="text-sm font-medium">Giá trị</Label>
        
        {/* Smart Value Input for Global Attributes */}
        {isGlobalAttribute && globalAttributeType ? (
          <SmartValueInput
            terms={globalTerms.map((term): Term => ({
              id: term.id,
              attributeId: term.attributeId,
              name: term.name,
              slug: term.slug,
              colorHex: term.colorHex,
              colorHex2: term.colorHex2,
              imageUrl: term.imageUrl,
              imageId: term.imageId,
              description: term.description,
            }))}
            selectedValues={attribute.values}
            onValuesChange={(values: string[]) => {
              // Update values and colorCodes from selected terms
              const selectedTerms = globalTerms.filter((term) =>
                values.includes(term.name)
              );
              const colorCodes: Record<string, string> = {};
              selectedTerms.forEach((term) => {
                if (term.colorHex) {
                  colorCodes[term.name] = term.colorHex;
                }
              });

              onUpdate({
                ...attribute,
                values,
                colorCodes: Object.keys(colorCodes).length > 0 ? colorCodes : undefined,
              });
            }}
            attributeType={globalAttributeType}
            loading={loadingTerms}
            onQuickAdd={onQuickAddTerm}
            placeholder="Chọn giá trị từ danh sách global..."
            attributeName={attribute.name}
          />
        ) : isColorAttribute ? (
          // Color Picker Mode
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Tên màu (VD: Đỏ, Xanh lá...)"
                className="flex-1 text-sm"
              />
              <Input
                type="color"
                onChange={(e) => {
                  const colorName = inputValue.trim() || `Màu ${e.target.value}`;
                  handleColorChange(colorName, e.target.value);
                }}
                className="w-16 h-10 cursor-pointer"
                title="Chọn màu"
              />
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => {
                  if (inputValue.trim()) {
                    // Use a default color if no color picker value
                    handleAddValue(inputValue);
                  }
                }}
                className="flex items-center gap-1"
              >
                <Plus className="h-4 w-4" />
                Thêm
              </Button>
            </div>
          </div>
        ) : (
          // Text Input Mode
          <div className="relative">
            <Input
              ref={inputRef}
              type="text"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyDown={handleKeyDown}
              onFocus={() => {
                if (suggestions.length > 0) setShowSuggestions(true);
              }}
              placeholder="Nhập giá trị và nhấn Enter..."
              className="text-sm"
            />
            {/* Suggestions Dropdown */}
            {showSuggestions && suggestions.length > 0 && (
              <div className="absolute z-50 w-full mt-1 bg-background border border-input rounded-lg shadow-lg max-h-40 overflow-y-auto">
                {suggestions.map((suggestion) => (
                  <button
                    key={suggestion}
                    type="button"
                    onClick={() => handleAddValue(suggestion)}
                    className="w-full text-left px-3 py-2 hover:bg-muted transition-colors text-sm"
                  >
                    {suggestion}
                  </button>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Values Display (Tags/Chips) */}
        {attribute.values.length > 0 && (
          <div className="flex flex-wrap gap-2 pt-2">
            {attribute.values.map((value) => (
              <div
                key={value}
                className="flex items-center gap-2 px-3 py-1.5 bg-muted rounded-full text-sm"
              >
                {isColorAttribute && attribute.colorCodes?.[value] && (
                  <div
                    className="w-4 h-4 rounded border border-input"
                    style={{ backgroundColor: attribute.colorCodes[value] }}
                    title={attribute.colorCodes[value]}
                  />
                )}
                <span>{value}</span>
                <button
                  type="button"
                  onClick={() => handleRemoveValue(value)}
                  className="ml-1 hover:text-destructive transition-colors"
                  aria-label="Xóa"
                >
                  <X className="h-3 w-3" />
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Used for Variations Checkbox */}
      <label className="flex items-center gap-2 cursor-pointer group pt-2 border-t border-input">
        <Checkbox
          checked={attribute.usedForVariations}
          onCheckedChange={(checked) =>
            onUpdate({ ...attribute, usedForVariations: checked === true })
          }
        />
        <span className="text-sm text-foreground group-hover:text-primary transition-colors">
          Dùng cho nhiều biến thể
        </span>
        {attribute.usedForVariations && (
          <span className="ml-2 px-2 py-0.5 bg-primary/10 text-primary text-xs rounded">
            ✓
          </span>
        )}
      </label>
      {attribute.usedForVariations && (
        <p className="text-xs text-muted-foreground ml-6">
          Thuộc tính này sẽ được sử dụng để tạo các biến thể sản phẩm
        </p>
      )}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/AttributesTab.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Plus, Loader2 } from 'lucide-react';
import type { ProductDataMetaBoxState } from './ProductDataMetaBox';
import { AttributeItem, type Attribute } from './AttributeItem';
import { AttributeLibraryModal } from '../AttributeLibraryModal';
import type { Attribute as GlobalAttribute } from '@/app/admin/attributes/page';
import type { Term } from '@/app/admin/attributes/[id]/terms/page';
import { SmartValueInput } from '../SmartValueInput';
import { QuickAddTermModal } from '../QuickAddTermModal';

interface AttributesTabProps {
  state: ProductDataMetaBoxState;
  onUpdate: (updates: Partial<ProductDataMetaBoxState>) => void;
}

/**
 * Attributes Tab - Product Attributes
 * Features:
 * - Add Attribute section (Global vs Custom)
 * - Attribute Item component với Tags/Chips UI
 * - Color Picker integration
 * - Used for variations checkbox logic
 */
export function AttributesTab({ state, onUpdate }: AttributesTabProps) {
  const [globalAttributes, setGlobalAttributes] = useState<GlobalAttribute[]>([]);
  const [loadingAttributes, setLoadingAttributes] = useState(false);
  const [customAttributeName, setCustomAttributeName] = useState('');
  const [quickAddModalOpen, setQuickAddModalOpen] = useState(false);
  const [quickAddAttribute, setQuickAddAttribute] = useState<GlobalAttribute | null>(null);
  const [globalTermsMap, setGlobalTermsMap] = useState<Record<string, Term[]>>({});
  const [loadingTerms, setLoadingTerms] = useState<Record<string, boolean>>({});
  const [pendingFetches, setPendingFetches] = useState<Set<string>>(new Set());
  const [isLibraryModalOpen, setIsLibraryModalOpen] = useState(false);

  // Fetch global attributes
  useEffect(() => {
    const fetchGlobalAttributes = async () => {
      setLoadingAttributes(true);
      try {
        const response = await fetch('/api/admin/attributes');
        if (response.ok) {
          const data = await response.json();
          setGlobalAttributes(data.attributes || []);
        }
      } catch (error) {
        console.error('Error fetching global attributes:', error);
      } finally {
        setLoadingAttributes(false);
      }
    };

    fetchGlobalAttributes();
  }, []);

  // Fetch terms for a global attribute (with race condition protection)
  const fetchTermsForAttribute = async (attributeId: string) => {
    // Check if already loaded or currently loading
    if (globalTermsMap[attributeId] || pendingFetches.has(attributeId)) {
      return; // Already loaded or loading
    }

    // Mark as pending
    setPendingFetches((prev) => new Set(prev).add(attributeId));
    setLoadingTerms((prev) => ({ ...prev, [attributeId]: true }));
    
    try {
      const response = await fetch(`/api/admin/attributes/${attributeId}/terms`);
      if (response.ok) {
        const data = await response.json();
        setGlobalTermsMap((prev) => ({
          ...prev,
          [attributeId]: data.terms || [],
        }));
      }
    } catch (error) {
      console.error('Error fetching terms:', error);
    } finally {
      setLoadingTerms((prev) => ({ ...prev, [attributeId]: false }));
      // Remove from pending set
      setPendingFetches((prev) => {
        const next = new Set(prev);
        next.delete(attributeId);
        return next;
      });
    }
  };

  // Pre-fetch terms for all attributes when modal opens (for preview)
  useEffect(() => {
    if (isLibraryModalOpen && globalAttributes.length > 0) {
      globalAttributes.forEach((attr) => {
        if (!globalTermsMap[attr.id] && !pendingFetches.has(attr.id)) {
          fetchTermsForAttribute(attr.id);
        }
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isLibraryModalOpen]);

  // Get all existing values from all attributes for auto-suggest
  const getAllExistingValues = (): string[] => {
    const allValues: string[] = [];
    state.attributes.forEach((attr) => {
      allValues.push(...attr.values);
    });
    return [...new Set(allValues)]; // Remove duplicates
  };

  const handleSelectGlobalAttribute = (globalAttr: GlobalAttribute) => {
    // Check if attribute already exists
    if (state.attributes.some((a) => a.name === globalAttr.name)) {
      alert('Thuộc tính này đã được thêm');
      return;
    }

    // Fetch terms for this attribute
    fetchTermsForAttribute(globalAttr.id);

    // Create new attribute with empty values (will be populated from terms)
    const newAttribute: Attribute = {
      id: `attr-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      name: globalAttr.name,
      isGlobal: true,
      globalAttributeId: globalAttr.id, // Store reference to global attribute
      values: [], // Will be populated from terms
      usedForVariations: false,
    };

    onUpdate({
      attributes: [...state.attributes, newAttribute],
    });
  };

  // Handle bulk selection from modal
  const handleBulkSelectAttributes = (selectedAttributeIds: string[]) => {
    const newAttributes: Attribute[] = [];
    
    selectedAttributeIds.forEach((attributeId) => {
      const globalAttr = globalAttributes.find((a) => a.id === attributeId);
      if (!globalAttr) return;

      // Check if attribute already exists
      if (state.attributes.some((a) => a.globalAttributeId === attributeId)) {
        return; // Skip if already added
      }

      // Fetch terms for this attribute
      fetchTermsForAttribute(attributeId);

      // Create new attribute
      const newAttribute: Attribute = {
        id: `attr-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        name: globalAttr.name,
        isGlobal: true,
        globalAttributeId: globalAttr.id,
        values: [],
        usedForVariations: false,
      };

      newAttributes.push(newAttribute);
    });

    if (newAttributes.length > 0) {
      onUpdate({
        attributes: [...state.attributes, ...newAttributes],
      });
    }
  };

  const handleQuickAddTerm = (attribute: GlobalAttribute) => {
    setQuickAddAttribute(attribute);
    setQuickAddModalOpen(true);
  };

  const handleQuickAddSuccess = (termName: string) => {
    if (!quickAddAttribute) return;

    // Refresh terms for this attribute
    setGlobalTermsMap((prev) => {
      const currentTerms = prev[quickAddAttribute.id] || [];
      // The new term will be fetched on next render, but we can optimistically add it
      return prev;
    });

    // Reload terms
    fetchTermsForAttribute(quickAddAttribute.id);

    // Auto-select the new term in the corresponding attribute
    const attribute = state.attributes.find(
      (a) => a.globalAttributeId === quickAddAttribute.id
    );
    if (attribute) {
      handleUpdateAttribute({
        ...attribute,
        values: [...attribute.values, termName],
      });
    }

    setQuickAddModalOpen(false);
    setQuickAddAttribute(null);
  };

  const handleAddCustomAttribute = () => {
    if (!customAttributeName.trim()) return;

    // Check if attribute already exists
    if (state.attributes.some((a) => a.name.toLowerCase() === customAttributeName.trim().toLowerCase())) {
      alert('Thuộc tính này đã được thêm');
      return;
    }

    const newAttribute: Attribute = {
      id: `attr-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      name: customAttributeName.trim(),
      isGlobal: false,
      values: [],
      usedForVariations: false,
    };

    onUpdate({
      attributes: [...state.attributes, newAttribute],
    });

    setCustomAttributeName('');
  };

  const handleUpdateAttribute = (updated: Attribute) => {
    onUpdate({
      attributes: state.attributes.map((a) => (a.id === updated.id ? updated : a)),
    });
  };

  const handleRemoveAttribute = (id: string) => {
    onUpdate({
      attributes: state.attributes.filter((a) => a.id !== id),
    });
  };

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-1">Thuộc tính sản phẩm</h3>
        <p className="text-sm text-muted-foreground mb-6">
          Thêm các thuộc tính như màu sắc, kích thước để tạo biến thể sản phẩm
        </p>
      </div>

      {/* Add Attribute Section */}
      <div className="p-4 border border-input rounded-lg bg-muted/30 space-y-4">
        <Label className="text-sm font-semibold">Thêm thuộc tính</Label>

        {/* Global Attributes - Modal Button */}
        <div className="space-y-2">
          <Label className="text-xs text-muted-foreground">Thuộc tính Global</Label>
          <Button
            type="button"
            variant="outline"
            onClick={() => setIsLibraryModalOpen(true)}
            className="w-full justify-start h-auto py-3 px-4 text-left"
          >
            <Plus className="h-5 w-5 mr-2" />
            <div className="flex-1">
              <div className="font-medium">Thêm thuộc tính từ thư viện</div>
              <div className="text-xs text-muted-foreground mt-0.5">
                Chọn nhiều thuộc tính cùng lúc từ danh sách
              </div>
            </div>
          </Button>
        </div>

        <div className="h-px bg-border" />

        {/* Custom Attribute */}
        <div className="space-y-2">
          <Label className="text-xs text-muted-foreground">Thuộc tính tùy chỉnh</Label>
          <div className="flex items-center gap-2">
            <Input
              type="text"
              value={customAttributeName}
              onChange={(e) => setCustomAttributeName(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  handleAddCustomAttribute();
                }
              }}
              placeholder="VD: Kích thước, Màu sắc, Chất liệu..."
              className="flex-1"
            />
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleAddCustomAttribute}
              disabled={!customAttributeName.trim()}
              className="flex items-center gap-1"
            >
              <Plus className="h-4 w-4" />
              Thêm
            </Button>
          </div>
        </div>
      </div>

      {/* Attributes List */}
      {state.attributes.length === 0 ? (
        <div className="text-center py-12 border-2 border-dashed border-input rounded-lg">
          <p className="text-sm text-muted-foreground">Chưa có thuộc tính nào</p>
          <p className="text-xs text-muted-foreground mt-1">
            Thêm thuộc tính để bắt đầu
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {state.attributes.map((attribute) => {
            // Find global attribute info if it's a global attribute
            const globalAttr = attribute.globalAttributeId
              ? globalAttributes.find((a) => a.id === attribute.globalAttributeId)
              : null;
            const terms = attribute.globalAttributeId
              ? globalTermsMap[attribute.globalAttributeId] || []
              : [];
            const isLoadingTerms = attribute.globalAttributeId
              ? loadingTerms[attribute.globalAttributeId] || false
              : false;

            return (
              <AttributeItem
                key={attribute.id}
                attribute={attribute}
                onUpdate={handleUpdateAttribute}
                onRemove={() => handleRemoveAttribute(attribute.id)}
                existingValues={getAllExistingValues()}
                // New props for global attributes
                isGlobalAttribute={!!attribute.globalAttributeId}
                globalAttributeType={globalAttr?.type}
                globalTerms={terms}
                loadingTerms={isLoadingTerms}
                onLoadTerms={() => {
                  if (attribute.globalAttributeId) {
                    fetchTermsForAttribute(attribute.globalAttributeId);
                  }
                }}
                onQuickAddTerm={() => {
                  if (globalAttr) {
                    handleQuickAddTerm(globalAttr);
                  }
                }}
              />
            );
          })}
        </div>
      )}

      {/* Attribute Library Modal */}
      <AttributeLibraryModal
        isOpen={isLibraryModalOpen}
        onClose={() => setIsLibraryModalOpen(false)}
        onApply={handleBulkSelectAttributes}
        attributes={globalAttributes}
        loading={loadingAttributes}
        selectedAttributeIds={state.attributes
          .filter((a) => a.isGlobal && a.globalAttributeId)
          .map((a) => a.globalAttributeId!)
          .filter(Boolean)}
        termsMap={globalTermsMap}
      />

      {/* Quick Add Term Modal */}
      {quickAddAttribute && (
        <QuickAddTermModal
          isOpen={quickAddModalOpen}
          onClose={() => {
            setQuickAddModalOpen(false);
            setQuickAddAttribute(null);
          }}
          attribute={quickAddAttribute}
          onSuccess={handleQuickAddSuccess}
        />
      )}

      {/* Info Box */}
      {state.attributes.some((a) => a.usedForVariations) && (
        <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
          <p className="text-sm text-green-900 dark:text-green-200">
            <strong>✓ Sẵn sàng tạo biến thể:</strong> Bạn có thể chuyển sang tab &quot;Biến thể&quot; để tạo các biến thể từ các thuộc tính đã chọn.
          </p>
        </div>
      )}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/DownloadableFilesSection.tsx================================================================================'use client';

import { useState } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Plus, X, Upload, File } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';

export interface DownloadableFile {
  id: string;
  name: string;
  url: string;
  downloadLimit?: number;
  downloadExpiry?: string;
}

interface DownloadableFilesSectionProps {
  files: DownloadableFile[];
  onFilesChange: (files: DownloadableFile[]) => void;
}

/**
 * Downloadable Files Section
 * Features:
 * - Add/Remove files
 * - File upload (Data URL for PoC)
 * - Download limit và expiry date
 * - Table/list view
 */
export function DownloadableFilesSection({
  files,
  onFilesChange,
}: DownloadableFilesSectionProps) {
  const { showToast } = useToastContext();

  const handleAddFile = () => {
    const newFile: DownloadableFile = {
      id: `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      name: '',
      url: '',
    };
    onFilesChange([...files, newFile]);
  };

  const handleRemoveFile = (id: string) => {
    onFilesChange(files.filter((f) => f.id !== id));
  };

  const handleFileChange = (id: string, field: keyof DownloadableFile, value: string | number | undefined) => {
    onFilesChange(
      files.map((f) => (f.id === id ? { ...f, [field]: value } : f))
    );
  };

  const handleFileUpload = async (id: string, file: File) => {
    try {
      // Convert to data URL (in production, upload to server)
      const dataUrl = await new Promise<string>((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const result = e.target?.result;
          if (typeof result === 'string') {
            resolve(result);
          } else {
            reject(new Error('Failed to read file'));
          }
        };
        reader.onerror = () => reject(new Error('FileReader error'));
        reader.readAsDataURL(file);
      });

      handleFileChange(id, 'url', dataUrl);
      if (!files.find((f) => f.id === id)?.name) {
        handleFileChange(id, 'name', file.name);
      }
      showToast('Đã tải file thành công', 'success');
    } catch (error) {
      console.error('Error uploading file:', error);
      showToast('Không thể đọc file. Vui lòng thử lại.', 'error');
    }
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h4 className="text-base font-semibold flex items-center gap-2">
            <File className="h-4 w-4" />
            Tệp tin tải xuống
          </h4>
          <p className="text-sm text-muted-foreground mt-1">
            Thêm các file mà khách hàng có thể tải xuống sau khi mua sản phẩm
          </p>
        </div>
        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={handleAddFile}
          className="flex items-center gap-2"
        >
          <Plus className="h-4 w-4" />
          Thêm file
        </Button>
      </div>

      {files.length === 0 ? (
        <div className="text-center py-8 border-2 border-dashed border-input rounded-lg">
          <File className="h-12 w-12 mx-auto text-muted-foreground mb-2" />
          <p className="text-sm text-muted-foreground">Chưa có file nào</p>
          <p className="text-xs text-muted-foreground mt-1">
            Click &quot;Thêm file&quot; để bắt đầu
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {files.map((file) => (
            <div
              key={file.id}
              className="p-4 border border-input rounded-lg bg-background space-y-3"
            >
              <div className="flex items-start justify-between gap-4">
                <div className="flex-1 space-y-3">
                  {/* File Name */}
                  <div className="space-y-1">
                    <Label htmlFor={`file-name-${file.id}`} className="text-xs">
                      Tên file
                    </Label>
                    <Input
                      id={`file-name-${file.id}`}
                      type="text"
                      placeholder="VD: Hướng dẫn sử dụng.pdf"
                      value={file.name}
                      onChange={(e) => handleFileChange(file.id, 'name', e.target.value)}
                      className="text-sm"
                    />
                  </div>

                  {/* File Upload */}
                  <div className="space-y-1">
                    <Label htmlFor={`file-upload-${file.id}`} className="text-xs">
                      File
                    </Label>
                    <div className="flex items-center gap-2">
                      <input
                        type="file"
                        className="hidden"
                        onChange={(e) => {
                          const selectedFile = e.target.files?.[0];
                          if (selectedFile) {
                            handleFileUpload(file.id, selectedFile);
                          }
                          // Reset input để có thể chọn lại file cùng tên
                          e.target.value = '';
                        }}
                        id={`file-upload-${file.id}`}
                      />
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          const input = document.getElementById(`file-upload-${file.id}`) as HTMLInputElement;
                          input?.click();
                        }}
                        className="flex items-center gap-2"
                      >
                        <Upload className="h-4 w-4" />
                        {file.url ? 'Thay đổi file' : 'Chọn file'}
                      </Button>
                      {file.url && (
                        <span className="text-xs text-muted-foreground flex items-center gap-1">
                          <File className="h-3 w-3" />
                          Đã chọn
                        </span>
                      )}
                    </div>
                  </div>

                  {/* Download Limit & Expiry */}
                  <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-1">
                      <Label htmlFor={`file-limit-${file.id}`} className="text-xs">
                        Giới hạn tải (lượt)
                      </Label>
                      <Input
                        id={`file-limit-${file.id}`}
                        type="number"
                        min="0"
                        placeholder="Không giới hạn"
                        value={file.downloadLimit || ''}
                        onChange={(e) =>
                          handleFileChange(
                            file.id,
                            'downloadLimit',
                            e.target.value ? parseInt(e.target.value) : undefined
                          )
                        }
                        className="text-sm"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label htmlFor={`file-expiry-${file.id}`} className="text-xs">
                        Hết hạn tải
                      </Label>
                      <Input
                        id={`file-expiry-${file.id}`}
                        type="datetime-local"
                        value={file.downloadExpiry || ''}
                        onChange={(e) =>
                          handleFileChange(file.id, 'downloadExpiry', e.target.value || undefined)
                        }
                        className="text-sm"
                      />
                    </div>
                  </div>
                </div>

                {/* Remove Button */}
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemoveFile(file.id)}
                  className="text-destructive hover:text-destructive hover:bg-destructive/10"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/GeneralTab.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { DollarSign, TrendingUp, Percent, Calendar, Upload, X, File } from 'lucide-react';
import type { ProductDataMetaBoxState } from './ProductDataMetaBox';
import { DownloadableFilesSection } from './DownloadableFilesSection';
import { PriceInput } from '../PriceInput';

interface GeneralTabProps {
  state: ProductDataMetaBoxState;
  onUpdate: (updates: Partial<ProductDataMetaBoxState>) => void;
}

/**
 * General Tab - Pricing and Downloadable Files
 * Features:
 * - Cost Price (optional, admin only)
 * - Regular Price với real-time profit calculation
 * - Sale Price với schedule dates và discount %
 * - Downloadable Files section (conditional)
 */
export function GeneralTab({ state, onUpdate }: GeneralTabProps) {
  const [showSchedule, setShowSchedule] = useState(
    !!(state.salePriceStartDate || state.salePriceEndDate)
  );

  // Validate salePrice < regularPrice on mount/update
  useEffect(() => {
    if (state.salePrice !== undefined && state.regularPrice !== undefined && state.salePrice >= state.regularPrice) {
      // Auto-fix: clear invalid salePrice
      onUpdate({ salePrice: undefined });
    }
  }, [state.salePrice, state.regularPrice, onUpdate]);

  // Calculate profit in real-time
  const profit = useMemo(() => {
    if (!state.regularPrice || !state.costPrice) return null;
    const profitAmount = state.regularPrice - state.costPrice;
    const profitPercent = state.costPrice > 0 
      ? ((profitAmount / state.costPrice) * 100).toFixed(1)
      : '0';
    return { amount: profitAmount, percent: profitPercent };
  }, [state.regularPrice, state.costPrice]);

  // Calculate discount percentage
  const discountPercent = useMemo(() => {
    if (!state.salePrice || !state.regularPrice) return null;
    const discount = ((state.regularPrice - state.salePrice) / state.regularPrice) * 100;
    return discount.toFixed(1);
  }, [state.salePrice, state.regularPrice]);

  // Check if sale price should be active (date range check)
  const isSaleActive = useMemo(() => {
    if (!state.salePrice || !showSchedule) return true; // Always active if no schedule
    const now = new Date();
    const start = state.salePriceStartDate ? new Date(state.salePriceStartDate) : null;
    const end = state.salePriceEndDate ? new Date(state.salePriceEndDate) : null;
    
    if (start && now < start) return false;
    if (end && now > end) return false;
    return true;
  }, [state.salePrice, state.salePriceStartDate, state.salePriceEndDate, showSchedule]);

  // Format currency
  const formatCurrency = (value: number | undefined) => {
    if (value === undefined || value === null) return '';
    return new Intl.NumberFormat('vi-VN').format(value);
  };


  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-1">Giá sản phẩm</h3>
        <p className="text-sm text-muted-foreground mb-6">
          Thiết lập giá vốn, giá bán và giá khuyến mãi cho sản phẩm
        </p>
      </div>

      {/* Cost Price */}
      <div className="space-y-2">
        <Label htmlFor="cost-price" className="text-sm font-medium flex items-center gap-2">
          <DollarSign className="h-4 w-4 text-muted-foreground" />
          Giá vốn
          <span className="text-xs text-muted-foreground font-normal">(Tùy chọn)</span>
        </Label>
        <PriceInput
          id="cost-price"
          placeholder="0"
          value={state.costPrice}
          onChange={(value) => onUpdate({ costPrice: value })}
        />
        <p className="text-xs text-muted-foreground">
          Giá vốn dùng để tính toán lợi nhuận. Chỉ hiển thị cho admin.
        </p>
      </div>

      {/* Regular Price */}
      <div className="space-y-2">
        <Label htmlFor="regular-price" className="text-sm font-medium flex items-center gap-2">
          <DollarSign className="h-4 w-4 text-muted-foreground" />
          Giá bán thường
          {state.productType === 'variable' ? (
            <span className="text-xs text-muted-foreground font-normal">(Không áp dụng cho sản phẩm có biến thể)</span>
          ) : (
            <span className="text-red-500">*</span>
          )}
        </Label>
        <PriceInput
          id="regular-price"
          placeholder="0"
          required={state.productType !== 'variable'}
          value={state.regularPrice}
          onChange={(value) => onUpdate({ regularPrice: value })}
          disabled={state.productType === 'variable'}
        />
        {state.productType === 'variable' && (
          <p className="text-xs text-muted-foreground">
            Với sản phẩm có biến thể, giá được quản lý tại tab &quot;Biến thể&quot;. Trường này sẽ bị vô hiệu hóa.
          </p>
        )}
        {/* Real-time Profit Calculation */}
        {profit && state.costPrice && (
          <div className="flex items-center gap-2 text-sm">
            <TrendingUp className="h-4 w-4 text-green-600" />
            <span className="text-green-600 font-medium">
              Lãi: {formatCurrency(profit.amount)}đ ({profit.percent}%)
            </span>
          </div>
        )}
      </div>

      {/* Sale Price */}
      <div className="space-y-3 p-4 border border-input rounded-lg bg-muted/30">
        <div className="space-y-2">
          <Label htmlFor="sale-price" className="text-sm font-medium flex items-center gap-2">
            <Percent className="h-4 w-4 text-muted-foreground" />
            Giá khuyến mãi
            <span className="text-xs text-muted-foreground font-normal">(Tùy chọn)</span>
          </Label>
          <PriceInput
            id="sale-price"
            placeholder="0"
            value={state.salePrice}
            onChange={(value) => {
              // Validate: salePrice must be less than regularPrice
              if (value !== undefined && state.regularPrice && value >= state.regularPrice) {
                return; // Don't update if invalid
              }
              onUpdate({ salePrice: value });
            }}
            disabled={!state.regularPrice}
          />
          {state.salePrice && state.regularPrice && discountPercent && (
            <div className="flex items-center gap-2 text-sm">
              <Percent className="h-4 w-4 text-orange-600" />
              <span className="text-orange-600 font-medium">
                Đang giảm {discountPercent}%
              </span>
            </div>
          )}
          {state.salePrice && state.regularPrice && state.salePrice >= state.regularPrice && (
            <p className="text-xs text-red-500">
              Giá khuyến mãi phải nhỏ hơn giá bán thường
            </p>
          )}
        </div>

        {/* Schedule Checkbox */}
        <label className="flex items-center gap-2 cursor-pointer group">
          <Checkbox
            id="schedule-sale"
            checked={showSchedule}
            onCheckedChange={(checked) => {
              setShowSchedule(checked === true);
              if (!checked) {
                onUpdate({ salePriceStartDate: undefined, salePriceEndDate: undefined });
              }
            }}
          />
          <span className="text-sm text-foreground group-hover:text-primary transition-colors flex items-center gap-2">
            <Calendar className="h-4 w-4" />
            Lên lịch khuyến mãi
          </span>
        </label>

        {/* Schedule Date Pickers */}
        {showSchedule && (
          <div className="grid grid-cols-2 gap-4 pt-2 border-t border-input">
            <div className="space-y-2">
              <Label htmlFor="sale-start-date" className="text-xs">
                Ngày bắt đầu
              </Label>
              <Input
                id="sale-start-date"
                type="datetime-local"
                value={state.salePriceStartDate || ''}
                onChange={(e) => onUpdate({ salePriceStartDate: e.target.value || undefined })}
                className="text-sm"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="sale-end-date" className="text-xs">
                Ngày kết thúc
              </Label>
              <Input
                id="sale-end-date"
                type="datetime-local"
                value={state.salePriceEndDate || ''}
                onChange={(e) => onUpdate({ salePriceEndDate: e.target.value || undefined })}
                className="text-sm"
              />
            </div>
            {!isSaleActive && state.salePrice && (
              <div className="col-span-2 text-xs text-muted-foreground bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded">
                ⚠️ Giá khuyến mãi hiện không hoạt động (ngoài khoảng thời gian đã lên lịch)
              </div>
            )}
          </div>
        )}
      </div>

      {/* Downloadable Files Section */}
      {state.isDownloadable && (
        <div className="pt-6 border-t border-input">
          <DownloadableFilesSection
            files={state.downloadableFiles || []}
            onFilesChange={(files) => onUpdate({ downloadableFiles: files })}
          />
        </div>
      )}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/index.ts================================================================================export { ProductDataMetaBox } from './ProductDataMetaBox';
export type { ProductDataMetaBoxState, ProductType } from './ProductDataMetaBox';
export { StickyActionBar } from './StickyActionBar';
================================================================================FILE: components/admin/products/ProductDataMetaBox/InventoryTab.tsx================================================================================'use client';

import { useState, useEffect, useMemo } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Package, AlertCircle, CheckCircle2, Info, Loader2 } from 'lucide-react';
import type { ProductDataMetaBoxState } from './ProductDataMetaBox';
import { SkuAutoGenerateButton } from '@/components/admin/products/SkuAutoGenerateButton';

interface InventoryTabProps {
  state: ProductDataMetaBoxState;
  onUpdate: (updates: Partial<ProductDataMetaBoxState>) => void;
  productId?: string; // For SKU validation (exclude current product)
  productName?: string; // For SKU auto-generation
  categoryId?: string; // For SKU auto-generation
}

/**
 * Inventory Tab - Stock Management
 * Features:
 * - SKU với real-time unique validation
 * - Manage Stock checkbox với conditional fields
 * - Stock Quantity & Low Stock Threshold
 * - Allow Backorders dropdown
 * - Sold Individually checkbox
 */
export function InventoryTab({ state, onUpdate, productId, productName, categoryId }: InventoryTabProps) {
  const [skuValue, setSkuValue] = useState(state.sku || '');
  const [skuValidating, setSkuValidating] = useState(false);
  const [skuError, setSkuError] = useState<string | null>(null);
  const [skuValid, setSkuValid] = useState<boolean | null>(null);

  // Sync local SKU value with parent state
  useEffect(() => {
    const stateSku = state.sku || '';
    if (stateSku !== skuValue) {
      setSkuValue(stateSku);
      // Only reset validation if SKU actually changed (not just empty to empty)
      if (stateSku !== '' || skuValue !== '') {
        setSkuValid(null);
        setSkuError(null);
      }
    }
  }, [state.sku]); // Remove skuValue from deps to prevent loop

  // Debounce SKU validation
  useEffect(() => {
    if (!skuValue.trim()) {
      setSkuError(null);
      setSkuValid(null);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setSkuValidating(true);
      setSkuError(null);
      
      try {
        // Call API to validate SKU uniqueness
        const response = await fetch(
          `/api/admin/products/validate-sku?sku=${encodeURIComponent(skuValue)}${productId ? `&excludeId=${productId}` : ''}`,
          { 
            method: 'POST',
            credentials: 'include', // Include credentials for authentication
          }
        );
        
        const data = await response.json();
        
        if (response.ok && data.available) {
          setSkuValid(true);
          setSkuError(null);
        } else {
          setSkuValid(false);
          // Handle authentication errors with user-friendly message
          if (response.status === 401) {
            setSkuError('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
          } else {
            setSkuError(data.error || 'SKU đã tồn tại trong hệ thống');
          }
        }
      } catch (error) {
        console.error('Error validating SKU:', error);
        // Don't show error on network failure, just mark as unknown
        setSkuValid(null);
      } finally {
        setSkuValidating(false);
      }
    }, 500); // 500ms debounce

    return () => clearTimeout(timeoutId);
  }, [skuValue, productId]);

  // Auto-update stock status when quantity changes
  useEffect(() => {
    if (state.manageStock && state.stockQuantity !== undefined) {
      if (state.stockQuantity === 0) {
        onUpdate({ stockStatus: 'outofstock' });
      } else if (state.stockQuantity > 0 && state.stockStatus === 'outofstock') {
        onUpdate({ stockStatus: 'instock' });
      }
    }
  }, [state.stockQuantity, state.manageStock, state.stockStatus, onUpdate]);

  // Stock status options
  const stockStatusOptions = [
    { value: 'instock', label: 'Còn hàng', icon: CheckCircle2, color: 'text-green-600' },
    { value: 'outofstock', label: 'Hết hàng', icon: AlertCircle, color: 'text-red-600' },
    { value: 'onbackorder', label: 'Đặt hàng trước', icon: Package, color: 'text-orange-600' },
  ];

  const currentStatusOption = stockStatusOptions.find((opt) => opt.value === state.stockStatus);

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-1">Kiểm kê kho hàng</h3>
        <p className="text-sm text-muted-foreground mb-6">
          Quản lý mã SKU, số lượng tồn kho và các thiết lập liên quan
        </p>
      </div>

      {/* SKU Field */}
      <div className="space-y-2">
        <Label htmlFor="sku" className="text-sm font-medium flex items-center gap-2">
          <Package className="h-4 w-4 text-muted-foreground" />
          Mã sản phẩm (SKU)
          <span className="text-xs text-muted-foreground font-normal">(Tùy chọn)</span>
        </Label>
        <div className="flex gap-2">
          <div className="relative flex-1">
            <Input
              id="sku"
              type="text"
              placeholder="VD: PROD-001"
              value={skuValue}
              onChange={(e) => {
                const newValue = e.target.value;
                setSkuValue(newValue);
                onUpdate({ sku: newValue || undefined });
              }}
              className={`pr-10 ${skuError ? 'border-red-500' : skuValid ? 'border-green-500' : ''}`}
            />
            {skuValidating && (
              <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground" />
            )}
            {!skuValidating && skuValid && (
              <CheckCircle2 className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-green-600" />
            )}
            {!skuValidating && skuError && (
              <AlertCircle className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-red-600" />
            )}
          </div>
          {productName && (
            <SkuAutoGenerateButton
              productName={productName}
              categoryId={categoryId}
              onSkuGenerated={(sku) => {
                setSkuValue(sku);
                onUpdate({ sku });
              }}
              excludeProductId={productId}
            />
          )}
        </div>
        {skuError && (
          <p className="text-xs text-red-500 flex items-center gap-1">
            <AlertCircle className="h-3 w-3" />
            {skuError}
          </p>
        )}
        {skuValid && !skuError && (
          <p className="text-xs text-green-600 flex items-center gap-1">
            <CheckCircle2 className="h-3 w-3" />
            SKU có thể sử dụng
          </p>
        )}
        <p className="text-xs text-muted-foreground">
          Mã SKU phải là duy nhất trong toàn bộ hệ thống
        </p>
      </div>

      {/* Manage Stock Checkbox */}
      <div className="space-y-3 p-4 border border-input rounded-lg bg-muted/30">
        <label className="flex items-center gap-2 cursor-pointer group">
          <Checkbox
            id="manage-stock"
            checked={state.manageStock}
            onCheckedChange={(checked) => {
              // Batch updates to prevent multiple onChange calls
              const updates: Partial<ProductDataMetaBoxState> = {
                manageStock: checked === true,
              };
              // Reset stock quantity if unchecking
              if (!checked) {
                updates.stockQuantity = undefined;
                updates.lowStockThreshold = undefined;
              }
              onUpdate(updates);
            }}
          />
          <span className="text-sm font-medium text-foreground group-hover:text-primary transition-colors">
            Quản lý kho hàng
          </span>
        </label>
        <p className="text-xs text-muted-foreground ml-6">
          Bật tính năng này để theo dõi số lượng tồn kho chi tiết
        </p>

        {/* Stock Status - Always visible */}
        <div className="space-y-2 ml-6 pt-2 border-t border-input">
          <Label htmlFor="stock-status" className="text-sm font-medium">
            Trạng thái tồn kho
          </Label>
          <Select
            value={state.stockStatus}
            onValueChange={(value) =>
              onUpdate({ stockStatus: value as ProductDataMetaBoxState['stockStatus'] })
            }
          >
            <SelectTrigger id="stock-status" className="w-full">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              {stockStatusOptions.map((option) => {
                const Icon = option.icon;
                return (
                  <SelectItem key={option.value} value={option.value}>
                    <div className="flex items-center gap-2">
                      <Icon className="h-4 w-4" />
                      {option.label}
                    </div>
                  </SelectItem>
                );
              })}
            </SelectContent>
          </Select>
          {currentStatusOption && (
            <div className="flex items-center gap-2 text-sm">
              <currentStatusOption.icon className={`h-4 w-4 ${currentStatusOption.color}`} />
              <span className={currentStatusOption.color}>
                {currentStatusOption.label}
              </span>
            </div>
          )}
        </div>

        {/* Stock Quantity & Threshold - Only visible when Manage Stock is checked */}
        {state.manageStock && (
          <div className="ml-6 pt-2 border-t border-input space-y-4">
            <div className="grid grid-cols-2 gap-4">
              {/* Stock Quantity */}
              <div className="space-y-2">
                <Label htmlFor="stock-quantity" className="text-sm font-medium">
                  Số lượng trong kho
                </Label>
                {state.productType === 'variable' && state.variations.length > 0 ? (
                  // For variable products, show calculated sum from variations (read-only)
                  <div>
                    <Input
                      id="stock-quantity"
                      type="number"
                      min="0"
                      step="1"
                      placeholder="0"
                      value={state.variations.reduce((sum, v) => sum + (v.stockQuantity || 0), 0) || ''}
                      readOnly
                      className="bg-muted cursor-not-allowed"
                    />
                    <p className="text-xs text-muted-foreground">
                      Tổng số lượng từ các biến thể (tự động tính). Quản lý tồn kho tại tab &quot;Biến thể&quot;
                    </p>
                  </div>
                ) : (
                  // For simple products, allow editing
                  <>
                    <Input
                      id="stock-quantity"
                      type="number"
                      min="0"
                      step="1"
                      placeholder="0"
                      value={state.stockQuantity || ''}
                      onChange={(e) => {
                        const value = e.target.value === '' ? undefined : parseInt(e.target.value);
                        onUpdate({ stockQuantity: value });
                      }}
                    />
                    <p className="text-xs text-muted-foreground">
                      Số lượng sẽ tự động giảm khi có đơn hàng
                    </p>
                  </>
                )}
              </div>

              {/* Low Stock Threshold */}
              <div className="space-y-2">
                <Label htmlFor="low-stock-threshold" className="text-sm font-medium">
                  Ngưỡng sắp hết hàng
                </Label>
                <Input
                  id="low-stock-threshold"
                  type="number"
                  min="0"
                  step="1"
                  placeholder="0"
                  value={state.lowStockThreshold || ''}
                  onChange={(e) => {
                    const value = e.target.value === '' ? undefined : parseInt(e.target.value);
                    onUpdate({ lowStockThreshold: value });
                  }}
                />
                <p className="text-xs text-muted-foreground">
                  Cảnh báo khi số lượng còn lại &lt;= ngưỡng này
                </p>
              </div>
            </div>

            {/* Low Stock Warning */}
            {state.stockQuantity !== undefined &&
              state.lowStockThreshold !== undefined &&
              state.stockQuantity <= state.lowStockThreshold &&
              state.stockQuantity > 0 && (
                <div className="flex items-center gap-2 text-sm text-orange-600 bg-orange-50 dark:bg-orange-900/20 p-2 rounded">
                  <AlertCircle className="h-4 w-4" />
                  <span>Sắp hết hàng! Số lượng còn lại: {state.stockQuantity}</span>
                </div>
              )}
          </div>
        )}
      </div>

      {/* Allow Backorders */}
      <div className="space-y-2">
        <Label htmlFor="backorders" className="text-sm font-medium flex items-center gap-2">
          <Info className="h-4 w-4 text-muted-foreground" />
          Cho phép đặt hàng trước
        </Label>
        <Select
          value={state.backorders}
          onValueChange={(value) =>
            onUpdate({ backorders: value as ProductDataMetaBoxState['backorders'] })
          }
        >
          <SelectTrigger id="backorders" className="w-full">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="no">Không cho phép</SelectItem>
            <SelectItem value="notify">Cho phép nhưng thông báo khách</SelectItem>
            <SelectItem value="yes">Cho phép</SelectItem>
          </SelectContent>
        </Select>
        <div className="text-xs text-muted-foreground space-y-1">
          <p>
            <strong>Không cho phép:</strong> Khách không thể mua khi hết hàng
          </p>
          <p>
            <strong>Cho phép nhưng thông báo:</strong> Khách có thể mua nhưng sẽ thấy cảnh báo
          </p>
          <p>
            <strong>Cho phép:</strong> Khách có thể mua bình thường ngay cả khi hết hàng
          </p>
        </div>
      </div>

      {/* Sold Individually */}
      <div className="space-y-2 p-4 border border-input rounded-lg bg-muted/30">
        <label className="flex items-center gap-2 cursor-pointer group">
          <Checkbox
            id="sold-individually"
            checked={state.soldIndividually}
            onCheckedChange={(checked) => onUpdate({ soldIndividually: checked === true })}
          />
          <span className="text-sm font-medium text-foreground group-hover:text-primary transition-colors">
            Bán riêng lẻ
          </span>
        </label>
        <p className="text-xs text-muted-foreground ml-6">
          Chỉ cho phép khách hàng mua tối đa 1 sản phẩm này trong 1 đơn hàng
        </p>
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/ProductDataMetaBox.tsx================================================================================'use client';

import { useState, useEffect, useRef } from 'react';
import { Card } from '@/components/ui/card';
import { TopControlBar } from './TopControlBar';
import { TabNavigation } from './TabNavigation';
import { GeneralTab } from './GeneralTab';
import { InventoryTab } from './InventoryTab';
import { ShippingTab } from './ShippingTab';
import { AttributesTab } from './AttributesTab';
import { VariationsTab } from './VariationsTab';
import { AdvancedTab } from './AdvancedTab';

export type ProductType = 'simple' | 'variable' | 'grouped' | 'external';

export interface ProductDataMetaBoxState {
  // Product Type & Options
  productType: ProductType;
  isVirtual: boolean;
  isDownloadable: boolean;

  // General Tab
  costPrice?: number;
  regularPrice?: number;
  salePrice?: number;
  salePriceStartDate?: string;
  salePriceEndDate?: string;
  downloadableFiles?: Array<{
    id: string;
    name: string;
    url: string;
    downloadLimit?: number;
    downloadExpiry?: string;
  }>;

  // Inventory Tab
  sku?: string;
  manageStock: boolean;
  stockQuantity?: number;
  stockStatus: 'instock' | 'outofstock' | 'onbackorder';
  lowStockThreshold?: number;
  backorders: 'no' | 'notify' | 'yes';
  soldIndividually: boolean;

  // Shipping Tab
  weight?: number;
  length?: number;
  width?: number;
  height?: number;
  shippingClass?: string;

  // Attributes
  attributes: Array<{
    id: string;
    name: string;
    isGlobal: boolean;
    globalAttributeId?: string; // Reference to global attribute ID
    values: string[];
    usedForVariations: boolean;
    colorCodes?: Record<string, string>; // For color attributes
  }>;

  // Variations
  variations: Array<{
    id: string;
    name: string;
    sku?: string;
    costPrice?: number;
    regularPrice?: number;
    salePrice?: number;
    stockQuantity?: number;
    image?: string;
    attributes: Record<string, string>; // attribute name -> value
  }>;

  // Advanced
  purchaseNote?: string;
  menuOrder: number;
  enableReviews: boolean;
}

interface ProductDataMetaBoxProps {
  data?: Partial<ProductDataMetaBoxState>;
  onChange?: (data: ProductDataMetaBoxState) => void;
  productId?: string; // For SKU validation
  productName?: string; // For SKU auto-generation
  categoryId?: string; // For SKU auto-generation
}

/**
 * Product Data Meta Box - Main component
 * Features:
 * - Vertical tabs layout
 * - Top control bar (Product Type, Virtual, Downloadable)
 * - Tab-based content organization
 * - Responsive design
 */
export function ProductDataMetaBox({ data, onChange, productId, productName, categoryId }: ProductDataMetaBoxProps) {
  const [activeTab, setActiveTab] = useState<string>('general');
  const [state, setState] = useState<ProductDataMetaBoxState>({
    productType: 'simple',
    isVirtual: false,
    isDownloadable: false,
    manageStock: false,
    stockStatus: 'instock',
    backorders: 'no',
    soldIndividually: false,
    attributes: [],
    variations: [],
    menuOrder: 0,
    enableReviews: true,
    ...data,
  });

  // Sync state with data prop changes
  // Use useRef to track if we're updating from internal state to prevent cycles
  const isInternalUpdateRef = useRef(false);
  const prevDataRef = useRef(data);
  const dataStringRef = useRef<string>('');
  
  useEffect(() => {
    // Serialize data for comparison (avoid reference comparison issues)
    const currentDataString = JSON.stringify(data);
    
    // Only sync if data prop actually changed and not from internal update
    if (data && currentDataString !== dataStringRef.current && !isInternalUpdateRef.current) {
      dataStringRef.current = currentDataString;
      prevDataRef.current = data;
      
      setState((prevState) => {
        // Only update if data actually changed (prevent infinite loops)
        const hasChanges = Object.keys(data).some(
          (key) => prevState[key as keyof ProductDataMetaBoxState] !== data[key as keyof ProductDataMetaBoxState]
        );
        if (!hasChanges) {
          return prevState;
        }
        
        return {
          ...prevState,
          ...data,
        };
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [data]);

  // Update parent when state changes
  const updateState = (updates: Partial<ProductDataMetaBoxState>) => {
    // Check if updates actually change anything (use JSON.stringify for arrays/objects)
    const hasActualChanges = Object.keys(updates).some((key) => {
      const currentValue = state[key as keyof ProductDataMetaBoxState];
      const newValue = updates[key as keyof ProductDataMetaBoxState];
      
      // For arrays/objects, use JSON.stringify comparison
      if (Array.isArray(currentValue) || Array.isArray(newValue) || 
          (typeof currentValue === 'object' && currentValue !== null) ||
          (typeof newValue === 'object' && newValue !== null)) {
        return JSON.stringify(currentValue) !== JSON.stringify(newValue);
      }
      
      // For primitives, use !==
      return currentValue !== newValue;
    });
    
    if (!hasActualChanges) {
      return; // Skip if no actual changes
    }
    
    // Mark as internal update to prevent sync cycle
    isInternalUpdateRef.current = true;
    
    // Calculate new state
    const newState = { ...state, ...updates };
    
    setState(newState);
    
    // Call onChange with calculated newState (outside setState to avoid duplicate calls in React batches)
    onChange?.(newState);
    
    // Reset flag after a short delay to allow sync to complete
    // Use requestAnimationFrame to defer to next render cycle
    requestAnimationFrame(() => {
      isInternalUpdateRef.current = false;
    });
  };

  // Determine which tabs should be visible
  const visibleTabs = [
    { id: 'general', label: 'Tổng quan', icon: '📊' },
    { id: 'inventory', label: 'Kiểm kê kho hàng', icon: '📦' },
    ...(state.isVirtual ? [] : [{ id: 'shipping', label: 'Giao hàng', icon: '🚚' }]),
    { id: 'attributes', label: 'Thuộc tính', icon: '🏷️' },
    ...(state.productType === 'variable' && state.attributes.some((a) => a.usedForVariations)
      ? [{ id: 'variations', label: 'Biến thể', icon: '🔄' }]
      : []),
    { id: 'advanced', label: 'Nâng cao', icon: '⚙️' },
  ];

  // Render active tab content
  const renderTabContent = () => {
    switch (activeTab) {
      case 'general':
        return (
          <GeneralTab
            state={state}
            onUpdate={updateState}
          />
        );
      case 'inventory':
        return (
          <InventoryTab
            state={state}
            onUpdate={updateState}
            productId={productId}
            productName={productName}
            categoryId={categoryId}
          />
        );
      case 'shipping':
        return (
          <ShippingTab
            state={state}
            onUpdate={updateState}
          />
        );
      case 'attributes':
        return (
          <AttributesTab
            state={state}
            onUpdate={updateState}
          />
        );
      case 'variations':
        return (
          <VariationsTab
            state={state}
            onUpdate={updateState}
            productName={productName}
            categoryId={categoryId}
          />
        );
      case 'advanced':
        return (
          <AdvancedTab
            state={state}
            onUpdate={updateState}
          />
        );
      default:
        return null;
    }
  };

  return (
    <Card className="overflow-hidden">
      {/* Top Control Bar */}
      <TopControlBar
        productType={state.productType}
        isVirtual={state.isVirtual}
        isDownloadable={state.isDownloadable}
        onProductTypeChange={(type) => {
          // Clear regularPrice when switching to variable product
          if (type === 'variable') {
            updateState({ productType: type, regularPrice: undefined });
          } else {
            updateState({ productType: type });
          }
        }}
        onVirtualChange={(isVirtual) => {
          updateState({ isVirtual });
          // If virtual, switch away from shipping tab
          if (isVirtual && activeTab === 'shipping') {
            setActiveTab('general');
          }
        }}
        onDownloadableChange={(isDownloadable) => updateState({ isDownloadable })}
      />

      <div className="flex flex-col md:flex-row min-h-[600px]">
        {/* Tab Navigation - Vertical on desktop, horizontal on mobile */}
        <div className="md:w-[200px] md:border-r border-input bg-muted/30">
          <TabNavigation
            tabs={visibleTabs}
            activeTab={activeTab}
            onTabChange={setActiveTab}
          />
        </div>

        {/* Tab Content */}
        <div className="flex-1 p-6 overflow-y-auto">
          {renderTabContent()}
        </div>
      </div>
    </Card>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/ProductSearchInput.tsx================================================================================'use client';

import { useState, useEffect, useRef } from 'react';
import Image from 'next/image';
import { Input } from '@/components/ui/input';
import { Loader2, Search, X, Image as ImageIcon } from 'lucide-react';
import { cn } from '@/lib/utils/cn';

export interface ProductSearchResult {
  id: string;
  name: string;
  price?: number;
  image?: string;
  sku?: string;
}

interface ProductSearchInputProps {
  value: string[];
  onChange: (productIds: string[]) => void;
  placeholder?: string;
  excludeIds?: string[]; // Exclude current product and already selected products
}

/**
 * Product Search Input - Reusable component
 * Features:
 * - Debounced search
 * - Loading state
 * - Product suggestion list với image, name, price
 * - Add to selection on click
 * - Remove selected products
 */
export function ProductSearchInput({
  value,
  onChange,
  placeholder = 'Tìm kiếm sản phẩm...',
  excludeIds = [],
}: ProductSearchInputProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [results, setResults] = useState<ProductSearchResult[]>([]);
  const [loading, setLoading] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const [selectedProducts, setSelectedProducts] = useState<ProductSearchResult[]>([]);
  const searchRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Fetch selected products details
  useEffect(() => {
    const fetchSelectedProducts = async () => {
      if (value.length === 0) {
        setSelectedProducts([]);
        return;
      }

      try {
        const productPromises = value.map(async (id) => {
          try {
            const response = await fetch(`/api/admin/products/${id}`);
            if (response.ok) {
              const data = await response.json();
              const product = data.product || data;
              return {
                id: product.id || product._id?.toString(),
                name: product.name,
                price: typeof product.price === 'string' ? parseFloat(product.price) : product.price,
                image: product.image?.sourceUrl || product.images?.[0]?.sourceUrl || product.images?.[0],
                sku: product.sku,
              };
            }
          } catch (err) {
            console.error(`Error fetching product ${id}:`, err);
          }
          return null;
        });

        const products = (await Promise.all(productPromises)).filter(Boolean) as ProductSearchResult[];
        setSelectedProducts(products);
      } catch (error) {
        console.error('Error fetching selected products:', error);
      }
    };

    fetchSelectedProducts();
  }, [value]);

  // Debounced search
  useEffect(() => {
    if (!searchQuery.trim()) {
      setResults([]);
      setShowResults(false);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setLoading(true);
      try {
        const response = await fetch(
          `/api/admin/products?search=${encodeURIComponent(searchQuery)}&per_page=10&status=publish`
        );
        
        if (response.ok) {
          const data = await response.json();
          const allExcludeIds = [...excludeIds, ...value];
          
          // Handle different response formats
          type ProductResponse = { id?: string; _id?: { toString: () => string } | string; name?: string; image?: { sourceUrl?: string } | string; sku?: string; price?: string | number };
          let productsList: ProductResponse[] = [];
          if (Array.isArray(data)) {
            productsList = data;
          } else if (data.products && Array.isArray(data.products)) {
            productsList = data.products;
          } else if (data.data && Array.isArray(data.data)) {
            productsList = data.data;
          }
          
          const products: ProductSearchResult[] = productsList
            .map((product: ProductResponse) => {
              const productId = product.id || product._id?.toString();
              if (!productId) return null;
              
              // Handle image: can be string or object with sourceUrl
              let imageUrl: string | undefined;
              if (typeof product.image === 'string') {
                imageUrl = product.image;
              } else if (product.image && typeof product.image === 'object' && 'sourceUrl' in product.image) {
                imageUrl = product.image.sourceUrl;
              }
              
              return {
                id: productId,
                name: product.name || '',
                price: typeof product.price === 'string' ? parseFloat(product.price) : product.price,
                image: imageUrl,
                sku: product.sku || '',
              };
            })
            .filter((p) => 
              p !== null && !allExcludeIds.includes(p.id)
            ) as ProductSearchResult[];
          
          setResults(products);
          setShowResults(true);
        }
      } catch (error) {
        console.error('Error searching products:', error);
        setResults([]);
      } finally {
        setLoading(false);
      }
    }, 300); // 300ms debounce

    return () => clearTimeout(timeoutId);
  }, [searchQuery, excludeIds, value]);

  // Close results when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (searchRef.current && !searchRef.current.contains(event.target as Node)) {
        setShowResults(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleSelectProduct = (product: ProductSearchResult) => {
    if (!value.includes(product.id)) {
      onChange([...value, product.id]);
    }
    setSearchQuery('');
    setShowResults(false);
    inputRef.current?.focus();
  };

  const handleRemoveProduct = (productId: string) => {
    onChange(value.filter((id) => id !== productId));
  };

  const formatPrice = (price?: number) => {
    if (!price) return '';
    return new Intl.NumberFormat('vi-VN').format(price) + 'đ';
  };

  return (
    <div ref={searchRef} className="relative w-full">
      {/* Search Input */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
        <Input
          ref={inputRef}
          type="text"
          placeholder={placeholder}
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          onFocus={() => {
            if (results.length > 0) setShowResults(true);
          }}
          className="pl-9 pr-9"
        />
        {loading && (
          <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground" />
        )}
      </div>

      {/* Search Results Dropdown */}
      {showResults && results.length > 0 && (
        <div className="absolute z-50 w-full mt-1 bg-background border border-input rounded-lg shadow-lg max-h-64 overflow-y-auto">
          {results.map((product) => (
            <button
              key={product.id}
              type="button"
              onClick={() => handleSelectProduct(product)}
              className="w-full flex items-center gap-3 p-3 hover:bg-muted transition-colors text-left border-b border-input last:border-b-0"
            >
              {product.image ? (
                <div className="relative w-12 h-12 rounded overflow-hidden">
                  <Image
                    src={product.image}
                    alt={product.name}
                    fill
                    className="object-cover"
                    sizes="48px"
                  />
                </div>
              ) : (
                <div className="w-12 h-12 bg-muted rounded flex items-center justify-center">
                  <ImageIcon className="h-6 w-6 text-muted-foreground" />
                </div>
              )}
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate">{product.name}</p>
                <div className="flex items-center gap-2 text-xs text-muted-foreground">
                  {product.sku && <span>SKU: {product.sku}</span>}
                  {product.price && <span>• {formatPrice(product.price)}</span>}
                </div>
              </div>
            </button>
          ))}
        </div>
      )}

      {/* Selected Products (Chips) */}
      {selectedProducts.length > 0 && (
        <div className="mt-3 flex flex-wrap gap-2">
          {selectedProducts.map((product) => (
            <div
              key={product.id}
              className="flex items-center gap-2 px-3 py-1.5 bg-muted rounded-full text-sm"
            >
              {product.image ? (
                <div className="relative w-5 h-5 rounded overflow-hidden">
                  <Image
                    src={product.image}
                    alt={product.name}
                    fill
                    className="object-cover"
                    sizes="20px"
                  />
                </div>
              ) : (
                <ImageIcon className="h-4 w-4 text-muted-foreground" />
              )}
              <span className="max-w-[200px] truncate">{product.name}</span>
              <button
                type="button"
                onClick={() => handleRemoveProduct(product.id)}
                className="ml-1 hover:text-destructive transition-colors"
                aria-label="Xóa"
              >
                <X className="h-3 w-3" />
              </button>
            </div>
          ))}
        </div>
      )}

      {/* Empty State */}
      {searchQuery && !loading && results.length === 0 && showResults && (
        <div className="absolute z-50 w-full mt-1 bg-background border border-input rounded-lg shadow-lg p-4 text-center text-sm text-muted-foreground">
          Không tìm thấy sản phẩm nào
        </div>
      )}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/ShippingTab.tsx================================================================================'use client';

import { useState } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Package, Ruler, Truck } from 'lucide-react';
import type { ProductDataMetaBoxState } from './ProductDataMetaBox';

interface ShippingTabProps {
  state: ProductDataMetaBoxState;
  onUpdate: (updates: Partial<ProductDataMetaBoxState>) => void;
}

/**
 * Shipping Tab - Weight, Dimensions, Shipping Class
 * Features:
 * - Weight field với unit selector (kg/g)
 * - Dimensions fields (Length, Width, Height) với unit selector (cm/m)
 * - Shipping Class dropdown
 * Note: Tab này sẽ tự động ẩn khi isVirtual = true
 */
export function ShippingTab({ state, onUpdate }: ShippingTabProps) {
  const [weightUnit, setWeightUnit] = useState<'kg' | 'g'>('kg');
  const [dimensionUnit, setDimensionUnit] = useState<'cm' | 'm'>('cm');

  // Shipping class options
  // Note: Cannot use empty string for SelectItem value (Radix UI restriction)
  // Use '__none__' as special value for "no shipping class"
  const shippingClasses = [
    { value: '__none__', label: 'Không có' },
    { value: 'standard', label: 'Hàng thường' },
    { value: 'fragile', label: 'Hàng dễ vỡ' },
    { value: 'bulky', label: 'Hàng cồng kềnh' },
    { value: 'express', label: 'Giao hàng nhanh' },
  ];

  // Handle weight change with unit conversion
  const handleWeightChange = (value: string) => {
    const numValue = value === '' ? undefined : parseFloat(value);
    if (numValue !== undefined && numValue < 0) return;
    onUpdate({ weight: numValue });
  };

  // Handle dimension change
  const handleDimensionChange = (field: 'length' | 'width' | 'height', value: string) => {
    const numValue = value === '' ? undefined : parseFloat(value);
    if (numValue !== undefined && numValue < 0) return;
    onUpdate({ [field]: numValue });
  };

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-1">Giao hàng</h3>
        <p className="text-sm text-muted-foreground mb-6">
          Thiết lập thông tin vận chuyển để tính phí giao hàng chính xác
        </p>
      </div>

      {/* Weight Field */}
      <div className="space-y-2">
        <Label htmlFor="weight" className="text-sm font-medium flex items-center gap-2">
          <Package className="h-4 w-4 text-muted-foreground" />
          Trọng lượng
        </Label>
        <div className="flex items-center gap-2">
          <div className="relative flex-1">
            <Input
              id="weight"
              type="number"
              step="0.1"
              min="0"
              placeholder="0"
              value={state.weight || ''}
              onChange={(e) => handleWeightChange(e.target.value)}
              className="pr-16"
            />
            <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1">
              <Select
                value={weightUnit}
                onValueChange={(value) => setWeightUnit(value as 'kg' | 'g')}
              >
                <SelectTrigger className="w-12 h-6 text-xs border-0 bg-transparent p-0 focus:ring-0">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="kg">kg</SelectItem>
                  <SelectItem value="g">g</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </div>
        <p className="text-xs text-muted-foreground">
          Trọng lượng sản phẩm dùng để tính phí vận chuyển
        </p>
      </div>

      {/* Dimensions Fields */}
      <div className="space-y-3 p-4 border border-input rounded-lg bg-muted/30">
        <Label className="text-sm font-semibold flex items-center gap-2">
          <Ruler className="h-4 w-4 text-muted-foreground" />
          Kích thước
        </Label>
        <div className="flex items-center gap-2 mb-3">
          <span className="text-xs text-muted-foreground">Đơn vị:</span>
          <Select
            value={dimensionUnit}
            onValueChange={(value) => setDimensionUnit(value as 'cm' | 'm')}
          >
            <SelectTrigger className="w-20 h-8 text-xs">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="cm">cm</SelectItem>
              <SelectItem value="m">m</SelectItem>
            </SelectContent>
          </Select>
        </div>
        <div className="grid grid-cols-3 gap-3">
          {/* Length */}
          <div className="space-y-2">
            <Label htmlFor="length" className="text-xs font-medium">
              Dài ({dimensionUnit})
            </Label>
            <Input
              id="length"
              type="number"
              step="0.1"
              min="0"
              placeholder="0"
              value={state.length || ''}
              onChange={(e) => handleDimensionChange('length', e.target.value)}
              className="text-sm"
            />
          </div>

          {/* Width */}
          <div className="space-y-2">
            <Label htmlFor="width" className="text-xs font-medium">
              Rộng ({dimensionUnit})
            </Label>
            <Input
              id="width"
              type="number"
              step="0.1"
              min="0"
              placeholder="0"
              value={state.width || ''}
              onChange={(e) => handleDimensionChange('width', e.target.value)}
              className="text-sm"
            />
          </div>

          {/* Height */}
          <div className="space-y-2">
            <Label htmlFor="height" className="text-xs font-medium">
              Cao ({dimensionUnit})
            </Label>
            <Input
              id="height"
              type="number"
              step="0.1"
              min="0"
              placeholder="0"
              value={state.height || ''}
              onChange={(e) => handleDimensionChange('height', e.target.value)}
              className="text-sm"
            />
          </div>
        </div>
        <p className="text-xs text-muted-foreground">
          Kích thước sản phẩm (Dài x Rộng x Cao) dùng để tính phí vận chuyển
        </p>
      </div>

      {/* Shipping Class */}
      <div className="space-y-2">
        <Label htmlFor="shipping-class" className="text-sm font-medium flex items-center gap-2">
          <Truck className="h-4 w-4 text-muted-foreground" />
          Lớp giao hàng
        </Label>
        <Select
          value={state.shippingClass || '__none__'}
          onValueChange={(value) => {
            // Convert '__none__' to undefined when saving
            onUpdate({ shippingClass: value === '__none__' ? undefined : value });
          }}
        >
          <SelectTrigger id="shipping-class" className="w-full">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {shippingClasses.map((option) => (
              <SelectItem key={option.value} value={option.value}>
                {option.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
        <p className="text-xs text-muted-foreground">
          Chọn lớp giao hàng phù hợp để tính phí vận chuyển chính xác. Ví dụ: Hàng dễ vỡ có thể có phí bảo hiểm cao hơn.
        </p>
      </div>

      {/* Info Box */}
      <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
        <p className="text-sm text-blue-900 dark:text-blue-200">
          <strong>Lưu ý:</strong> Thông tin trọng lượng và kích thước sẽ được sử dụng để tính phí vận chuyển tự động thông qua các API vận chuyển (Giao Hàng Nhanh, Viettel Post, v.v.)
        </p>
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/StickyActionBar.tsx================================================================================'use client';

import { Button } from '@/components/ui/button';
import { Save, Eye, Loader2 } from 'lucide-react';

interface StickyActionBarProps {
  onSave: () => void | Promise<void>;
  onPreview?: () => void;
  loading?: boolean;
  productId?: string;
  productSlug?: string;
  disabled?: boolean;
}

/**
 * Sticky Action Bar - Fixed bottom bar với Save và Preview buttons
 * Features:
 * - Fixed position ở bottom của viewport
 * - Save button (primary)
 * - Preview button (optional)
 * - Loading states
 * - Shadow/elevation để tách biệt với content
 */
export function StickyActionBar({
  onSave,
  onPreview,
  loading = false,
  productId,
  productSlug,
  disabled = false,
}: StickyActionBarProps) {
  const handlePreview = () => {
    if (onPreview) {
      onPreview();
    } else if (productId && productSlug) {
      // Open preview in new tab
      const previewUrl = `/products/${productSlug}`;
      window.open(previewUrl, '_blank');
    }
  };

  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 bg-background border-t border-border shadow-lg">
      <div className="container mx-auto px-4 py-3">
        <div className="flex items-center justify-between">
          {/* Left side - Info or empty */}
          <div className="flex-1">
            {/* Optional: Add unsaved changes indicator here */}
          </div>

          {/* Right side - Action Buttons */}
          <div className="flex items-center gap-3">
            {/* Preview Button */}
            {onPreview || (productId && productSlug) ? (
              <Button
                type="button"
                variant="outline"
                onClick={handlePreview}
                disabled={loading || disabled || !productId || !productSlug}
                className="gap-2"
              >
                <Eye className="h-4 w-4" />
                Xem trước
              </Button>
            ) : null}

            {/* Save Button */}
            <Button
              type="button"
              onClick={onSave}
              disabled={loading || disabled}
              className="gap-2 min-w-[120px]"
            >
              {loading ? (
                <>
                  <Loader2 className="h-4 w-4 animate-spin" />
                  Đang lưu...
                </>
              ) : (
                <>
                  <Save className="h-4 w-4" />
                  Lưu thay đổi
                </>
              )}
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/TabNavigation.tsx================================================================================'use client';

interface Tab {
  id: string;
  label: string;
  icon: string;
}

interface TabNavigationProps {
  tabs: Tab[];
  activeTab: string;
  onTabChange: (tabId: string) => void;
}

/**
 * Tab Navigation - Vertical tabs on desktop, horizontal on mobile
 * Features:
 * - Active tab indicator (border-left on desktop, underline on mobile)
 * - Smooth transitions
 * - Responsive design
 */
export function TabNavigation({ tabs, activeTab, onTabChange }: TabNavigationProps) {
  return (
    <div className="flex md:flex-col overflow-x-auto md:overflow-x-visible">
      {tabs.map((tab) => {
        const isActive = activeTab === tab.id;
        return (
          <button
            key={tab.id}
            type="button"
            onClick={() => onTabChange(tab.id)}
            className={`
              flex items-center gap-2 px-4 py-3 text-sm font-medium transition-all
              md:border-l-3 md:border-l-transparent
              border-b-2 md:border-b-0 border-b-transparent
              whitespace-nowrap
              ${
                isActive
                  ? 'md:border-l-primary bg-background text-primary font-semibold'
                  : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'
              }
              ${isActive ? 'md:border-l-primary border-b-primary' : ''}
            `}
            aria-selected={isActive}
            role="tab"
          >
            <span className="text-base">{tab.icon}</span>
            <span>{tab.label}</span>
          </button>
        );
      })}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/TopControlBar.tsx================================================================================'use client';

import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import type { ProductType } from './ProductDataMetaBox';

interface TopControlBarProps {
  productType: ProductType;
  isVirtual: boolean;
  isDownloadable: boolean;
  onProductTypeChange: (type: ProductType) => void;
  onVirtualChange: (isVirtual: boolean) => void;
  onDownloadableChange: (isDownloadable: boolean) => void;
}

/**
 * Top Control Bar - Product Type and Options
 * Features:
 * - Product Type dropdown
 * - Virtual Product checkbox
 * - Downloadable Product checkbox
 */
export function TopControlBar({
  productType,
  isVirtual,
  isDownloadable,
  onProductTypeChange,
  onVirtualChange,
  onDownloadableChange,
}: TopControlBarProps) {
  return (
    <div className="h-[60px] px-4 border-b border-input bg-muted/50 flex items-center gap-6 flex-wrap">
      {/* Product Type */}
      <div className="flex items-center gap-3">
        <Label htmlFor="product-type" className="text-sm font-semibold whitespace-nowrap">
          Loại sản phẩm:
        </Label>
        <Select
          value={productType}
          onValueChange={(value) => onProductTypeChange(value as ProductType)}
        >
          <SelectTrigger id="product-type" className="w-[220px] h-9 text-sm">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="simple">Sản phẩm đơn giản</SelectItem>
            <SelectItem value="variable">Sản phẩm có biến thể</SelectItem>
            <SelectItem value="grouped">Sản phẩm nhóm</SelectItem>
            <SelectItem value="external">Sản phẩm bên ngoài/Liên kết</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Checkbox Options */}
      <div className="flex items-center gap-4">
        <label className="flex items-center gap-2 cursor-pointer group">
          <Checkbox
            id="virtual-product"
            checked={isVirtual}
            onCheckedChange={(checked) => onVirtualChange(checked === true)}
          />
          <span className="text-sm text-foreground group-hover:text-primary transition-colors">
            Sản phẩm ảo
          </span>
        </label>

        <label className="flex items-center gap-2 cursor-pointer group">
          <Checkbox
            id="downloadable-product"
            checked={isDownloadable}
            onCheckedChange={(checked) => onDownloadableChange(checked === true)}
          />
          <span className="text-sm text-foreground group-hover:text-primary transition-colors">
            Có thể tải xuống
          </span>
        </label>
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/VariationImageMapper.tsx================================================================================'use client';

import { useState, useMemo } from 'react';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Card, CardContent } from '@/components/ui/card';
import { Upload, Image as ImageIcon, X, Loader2 } from 'lucide-react';
import { MediaLibraryModal, type MediaItem } from '../MediaLibraryModal';
import type { Variation } from './VariationTable';
import type { Attribute } from './AttributeItem';

interface VariationImageMapperProps {
  variations: Variation[];
  attributes: Attribute[];
  onMapImages: (mappings: Array<{ attributeName: string; attributeValue: string; imageId: string; imageUrl: string }>) => void;
}

export function VariationImageMapper({
  variations,
  attributes,
  onMapImages,
}: VariationImageMapperProps) {
  const [mappings, setMappings] = useState<
    Record<string, { imageId: string; imageUrl: string }>
  >({});
  const [showMediaLibrary, setShowMediaLibrary] = useState<string | null>(null);
  const [isApplying, setIsApplying] = useState(false);

  // Get attribute values that can be mapped (only attributes used for variations)
  const mappableAttributes = useMemo(() => {
    return attributes.filter((attr) => attr.usedForVariations && attr.values.length > 0);
  }, [attributes]);

  // Group by attribute name - MUST be called before any early returns (React Hooks rules)
  const groupedByAttribute = useMemo(() => {
    const grouped: Record<string, string[]> = {};
    mappableAttributes.forEach((attr) => {
      grouped[attr.name] = attr.values;
    });
    return grouped;
  }, [mappableAttributes]);

  // Calculate how many variations will be affected by each mapping
  const getAffectedCount = (attributeName: string, attributeValue: string): number => {
    return variations.filter(
      (variation) => variation.attributes[attributeName] === attributeValue
    ).length;
  };

  const handleImageSelect = (attributeName: string, attributeValue: string) => {
    return (item: MediaItem | MediaItem[]) => {
      const image = Array.isArray(item) ? item[0] : item;
      const key = `${attributeName}:${attributeValue}`;
      setMappings((prev) => ({
        ...prev,
        [key]: {
          imageId: image.id,
          imageUrl: image.url,
        },
      }));
      setShowMediaLibrary(null);
    };
  };

  const handleRemoveMapping = (key: string) => {
    setMappings((prev) => {
      const newMappings = { ...prev };
      delete newMappings[key];
      return newMappings;
    });
  };

  const handleApply = async () => {
    if (Object.keys(mappings).length === 0) {
      alert('Vui lòng chọn ít nhất một ảnh để gán');
      return;
    }

    setIsApplying(true);
    try {
      const mappingArray = Object.entries(mappings).map(([key, image]) => {
        const [attributeName, attributeValue] = key.split(':');
        return {
          attributeName,
          attributeValue,
          imageId: image.imageId,
          imageUrl: image.imageUrl,
        };
      });

      onMapImages(mappingArray);
      
      // Clear mappings after successful apply
      setMappings({});
    } finally {
      setIsApplying(false);
    }
  };

  if (mappableAttributes.length === 0) {
    return (
      <div className="p-4 border border-input rounded-lg bg-muted/30">
        <p className="text-sm text-muted-foreground text-center">
          Chưa có thuộc tính nào được dùng cho biến thể. Vui lòng thêm thuộc tính trong tab &quot;Thuộc tính&quot;.
        </p>
      </div>
    );
  }

  return (
    <>
      <div className="p-4 border border-input rounded-lg bg-muted/30 space-y-4">
        <div>
          <Label className="text-sm font-semibold">Gán ảnh thông minh theo Thuộc tính</Label>
          <p className="text-xs text-muted-foreground mt-1">
            Gán ảnh cho tất cả biến thể có cùng giá trị thuộc tính. Ví dụ: Gán ảnh &quot;Gấu Nâu&quot; cho tất cả biến thể có màu Nâu (Nâu-1m, Nâu-1m5, Nâu-2m).
          </p>
        </div>

        {/* Mapping Table */}
        <div className="space-y-4">
          {Object.entries(groupedByAttribute).map(([attributeName, values]) => (
            <div key={attributeName} className="space-y-2">
              <Label className="text-xs font-medium text-muted-foreground">
                {attributeName}
              </Label>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                {values.map((value) => {
                  const key = `${attributeName}:${value}`;
                  const mapping = mappings[key];
                  const affectedCount = getAffectedCount(attributeName, value);

                  return (
                    <Card
                      key={value}
                      className={`overflow-hidden ${
                        mapping ? 'border-primary' : ''
                      }`}
                    >
                      <CardContent className="p-3 space-y-2">
                        <div className="flex items-center justify-between">
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium truncate">{value}</p>
                            <p className="text-xs text-muted-foreground">
                              {affectedCount} biến thể
                            </p>
                          </div>
                        </div>

                        {mapping ? (
                          <div className="space-y-2">
                            <div className="relative w-full h-20 border rounded overflow-hidden">
                              <Image
                                src={mapping.imageUrl}
                                alt={value}
                                fill
                                className="object-cover"
                                sizes="(max-width: 768px) 100vw, 200px"
                              />
                            </div>
                            <Button
                              type="button"
                              variant="ghost"
                              size="sm"
                              onClick={() => handleRemoveMapping(key)}
                              className="w-full text-red-600 hover:text-red-700 hover:bg-red-50"
                            >
                              <X className="w-4 h-4 mr-1" />
                              Xóa ảnh
                            </Button>
                          </div>
                        ) : (
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => setShowMediaLibrary(key)}
                            className="w-full"
                          >
                            <Upload className="w-4 h-4 mr-2" />
                            Chọn ảnh
                          </Button>
                        )}
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            </div>
          ))}
        </div>

        {/* Apply Button */}
        {Object.keys(mappings).length > 0 && (
          <div className="pt-4 border-t">
            <div className="flex items-center justify-between mb-3">
              <div>
                <p className="text-sm font-medium">
                  Đã chọn {Object.keys(mappings).length} ảnh
                </p>
                <p className="text-xs text-muted-foreground">
                  Sẽ gán ảnh cho{' '}
                  {Object.keys(mappings).reduce((total, key) => {
                    const [attrName, attrValue] = key.split(':');
                    return total + getAffectedCount(attrName, attrValue);
                  }, 0)}{' '}
                  biến thể
                </p>
              </div>
            </div>
            <Button
              type="button"
              onClick={handleApply}
              disabled={isApplying}
              className="w-full"
            >
              {isApplying ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Đang áp dụng...
                </>
              ) : (
                <>
                  <ImageIcon className="w-4 h-4 mr-2" />
                  Áp dụng ảnh cho biến thể
                </>
              )}
            </Button>
          </div>
        )}
      </div>

      {/* Media Library Modal */}
      {showMediaLibrary && (
        <MediaLibraryModal
          isOpen={!!showMediaLibrary}
          onClose={() => setShowMediaLibrary(null)}
          onSelect={(item) => {
            const [attributeName, attributeValue] = showMediaLibrary.split(':');
            handleImageSelect(attributeName, attributeValue)(item);
          }}
          mode="single"
        />
      )}
    </>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/VariationsBulkEditToolbar.tsx================================================================================'use client';

import { useState, useMemo } from 'react';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { DollarSign, TrendingUp, TrendingDown, Package, Loader2 } from 'lucide-react';
import type { Variation } from './VariationTable';
import type { Attribute } from './AttributeItem';
import { useToastContext } from '@/components/providers/ToastProvider';

interface VariationsBulkEditToolbarProps {
  variations: Variation[];
  attributes: Attribute[];
  onBulkUpdate: (updates: Partial<Variation>, filter: FilterOptions) => void;
  onVariationsChange?: (variations: Variation[]) => void;
}

interface FilterOptions {
  attributeName?: string;
  attributeValue?: string;
  applyToAll?: boolean;
}

export function VariationsBulkEditToolbar({
  variations,
  attributes,
  onBulkUpdate,
  onVariationsChange,
}: VariationsBulkEditToolbarProps) {
  const { showToast } = useToastContext();
  const [filter, setFilter] = useState<FilterOptions>({ applyToAll: true });
  const [showPriceModal, setShowPriceModal] = useState(false);
  const [showPercentModal, setShowPercentModal] = useState(false);
  const [showStockModal, setShowStockModal] = useState(false);
  const [priceValue, setPriceValue] = useState('');
  const [percentValue, setPercentValue] = useState('');
  const [stockStatus, setStockStatus] = useState<'instock' | 'outofstock'>('instock');
  const [isApplying, setIsApplying] = useState(false);

  // Get unique attribute values for filter dropdown
  const filterOptions = useMemo(() => {
    const options: Array<{ attributeName: string; value: string }> = [];
    
    attributes.forEach((attr) => {
      attr.values.forEach((value) => {
        options.push({ attributeName: attr.name, value });
      });
    });

    return options;
  }, [attributes]);

  // Get filtered variations count
  const filteredCount = useMemo(() => {
    if (filter.applyToAll) {
      return variations.length;
    }
    if (!filter.attributeName || !filter.attributeValue) {
      return variations.length;
    }

    return variations.filter((variation) => {
      return variation.attributes[filter.attributeName!] === filter.attributeValue;
    }).length;
  }, [variations, filter]);

  const handleSetPrice = async () => {
    if (!priceValue || isNaN(parseFloat(priceValue))) {
      showToast('Vui lòng nhập giá hợp lệ', 'error');
      return;
    }

    const price = parseFloat(priceValue);
    if (!isFinite(price) || price < 0) {
      showToast('Giá phải là số hợp lệ và không âm', 'error');
      return;
    }

    setIsApplying(true);
    try {
      
      // Update via onVariationsChange if available for better performance
      if (onVariationsChange) {
        const updatedVariations = variations.map((variation) => {
          const matchesFilter = filter.applyToAll
            ? true
            : filter.attributeName && filter.attributeValue
            ? variation.attributes[filter.attributeName] === filter.attributeValue
            : true;

          if (matchesFilter) {
            return { ...variation, regularPrice: price };
          }
          return variation;
        });
        onVariationsChange(updatedVariations);
      } else {
        onBulkUpdate({ regularPrice: price }, filter);
      }
      
      showToast(`Đã thiết lập giá cho ${filteredCount} biến thể`, 'success');
      setShowPriceModal(false);
      setPriceValue('');
    } catch (error: any) {
      console.error('Error setting price:', error);
      showToast('Có lỗi xảy ra khi thiết lập giá', 'error');
    } finally {
      setIsApplying(false);
    }
  };

  const handleAdjustPrice = async () => {
    if (!percentValue || isNaN(parseFloat(percentValue))) {
      showToast('Vui lòng nhập phần trăm hợp lệ', 'error');
      return;
    }

    const percent = parseFloat(percentValue);
    if (percent === 0 || !isFinite(percent)) {
      showToast('Phần trăm phải khác 0 và là số hợp lệ', 'error');
      return;
    }

    setIsApplying(true);
    try {
      // Get filtered variations and calculate new prices
      const updatedVariations = variations.map((variation) => {
        // Check if variation matches filter
        const matchesFilter = filter.applyToAll
          ? true
          : filter.attributeName && filter.attributeValue
          ? variation.attributes[filter.attributeName] === filter.attributeValue
          : true;

        // Validate regularPrice before calculation
        if (
          matchesFilter &&
          variation.regularPrice !== undefined &&
          variation.regularPrice !== null &&
          isFinite(variation.regularPrice) &&
          variation.regularPrice >= 0
        ) {
          const newPrice = variation.regularPrice * (1 + percent / 100);
          // Ensure new price is valid
          if (isFinite(newPrice) && newPrice >= 0) {
            return {
              ...variation,
              regularPrice: newPrice,
            };
          }
        }
        return variation;
      });

      // Update via onVariationsChange if available
      if (onVariationsChange) {
        onVariationsChange(updatedVariations);
      } else {
        // Fallback: use onBulkUpdate for each variation
        updatedVariations.forEach((variation) => {
          const original = variations.find((v) => v.id === variation.id);
          if (original && original.regularPrice !== variation.regularPrice) {
            // This will be handled by parent component
            onBulkUpdate(
              { regularPrice: variation.regularPrice },
              { applyToAll: false, attributeName: undefined, attributeValue: variation.id }
            );
          }
        });
      }

      const percentLabel = percent > 0 ? `tăng ${percent}%` : `giảm ${Math.abs(percent)}%`;
      showToast(`Đã ${percentLabel} giá cho ${filteredCount} biến thể`, 'success');
      setShowPercentModal(false);
      setPercentValue('');
    } catch (error: any) {
      console.error('Error adjusting price:', error);
      showToast('Có lỗi xảy ra khi điều chỉnh giá', 'error');
    } finally {
      setIsApplying(false);
    }
  };

  const handleSetStockStatus = async () => {
    setIsApplying(true);
    try {
      const stockQty = stockStatus === 'instock' ? 1 : 0;
      
      // Update via onVariationsChange if available for better performance
      if (onVariationsChange) {
        const updatedVariations = variations.map((variation) => {
          const matchesFilter = filter.applyToAll
            ? true
            : filter.attributeName && filter.attributeValue
            ? variation.attributes[filter.attributeName] === filter.attributeValue
            : true;

          if (matchesFilter) {
            return { ...variation, stockQuantity: stockQty };
          }
          return variation;
        });
        onVariationsChange(updatedVariations);
      } else {
        onBulkUpdate({ stockQuantity: stockQty }, filter);
      }
      
      const statusLabel = stockStatus === 'instock' ? 'Còn hàng' : 'Hết hàng';
      showToast(`Đã đặt trạng thái kho "${statusLabel}" cho ${filteredCount} biến thể`, 'success');
      setShowStockModal(false);
    } catch (error: any) {
      console.error('Error setting stock status:', error);
      showToast('Có lỗi xảy ra khi cập nhật trạng thái kho', 'error');
    } finally {
      setIsApplying(false);
    }
  };

  return (
    <>
      <div className="p-4 border border-input rounded-lg bg-muted/30 space-y-4">
        <div className="flex items-center justify-between">
          <div>
            <Label className="text-sm font-semibold">Xử lý hàng loạt</Label>
            <p className="text-xs text-muted-foreground mt-1">
              Áp dụng cho: <span className="font-medium">{filteredCount}</span> biến thể
            </p>
          </div>
        </div>

        {/* Filter */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div className="space-y-2">
            <Label className="text-xs">Áp dụng cho</Label>
            <Select
              value={filter.applyToAll ? 'all' : 'filtered'}
              onValueChange={(value) => {
                if (value === 'all') {
                  setFilter({ applyToAll: true });
                } else {
                  setFilter({ applyToAll: false });
                }
              }}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Tất cả biến thể</SelectItem>
                <SelectItem value="filtered">Lọc theo thuộc tính</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {!filter.applyToAll && (
            <>
              <div className="space-y-2">
                <Label className="text-xs">Thuộc tính</Label>
                <Select
                  value={filter.attributeName || ''}
                  onValueChange={(value) => {
                    setFilter({
                      applyToAll: false,
                      attributeName: value,
                      attributeValue: undefined,
                    });
                  }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Chọn thuộc tính..." />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="__none__">Chọn thuộc tính...</SelectItem>
                    {attributes.map((attr) => (
                      <SelectItem key={attr.id} value={attr.name}>
                        {attr.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {filter.attributeName && (
                <div className="space-y-2">
                  <Label className="text-xs">Giá trị</Label>
                  <Select
                    value={filter.attributeValue || '__none__'}
                    onValueChange={(value) => {
                      setFilter({
                        applyToAll: false,
                        attributeName: filter.attributeName,
                        attributeValue: value === '__none__' ? undefined : value,
                      });
                    }}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Chọn giá trị..." />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="__none__">Chọn giá trị...</SelectItem>
                      {filterOptions
                        .filter((opt) => opt.attributeName === filter.attributeName)
                        .map((opt, idx) => (
                          <SelectItem key={idx} value={opt.value}>
                            {opt.value}
                          </SelectItem>
                        ))}
                    </SelectContent>
                  </Select>
                </div>
              )}
            </>
          )}
        </div>

        {/* Action Buttons */}
        <div className="flex flex-wrap gap-2 pt-2 border-t">
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setShowPriceModal(true)}
            disabled={filteredCount === 0}
            className="flex items-center gap-2"
          >
            <DollarSign className="w-4 h-4" />
            Thiết lập giá thường
          </Button>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setShowPercentModal(true)}
            disabled={filteredCount === 0}
            className="flex items-center gap-2"
          >
            <TrendingUp className="w-4 h-4" />
            Tăng/Giảm giá (%)
          </Button>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setShowStockModal(true)}
            disabled={filteredCount === 0}
            className="flex items-center gap-2"
          >
            <Package className="w-4 h-4" />
            Quản lý kho
          </Button>
        </div>
      </div>

      {/* Set Price Modal */}
      <Dialog open={showPriceModal} onOpenChange={setShowPriceModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Thiết lập giá thường</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Giá (VNĐ)</Label>
              <Input
                type="number"
                value={priceValue}
                onChange={(e) => setPriceValue(e.target.value)}
                placeholder="0"
                min="0"
                step="1000"
              />
            </div>
            <p className="text-sm text-muted-foreground">
              Sẽ áp dụng cho <strong>{filteredCount}</strong> biến thể đã lọc.
            </p>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowPriceModal(false)}>
              Hủy
            </Button>
            <Button onClick={handleSetPrice} disabled={isApplying}>
              {isApplying ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Đang áp dụng...
                </>
              ) : (
                'Áp dụng'
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Adjust Price Modal */}
      <Dialog open={showPercentModal} onOpenChange={setShowPercentModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Tăng/Giảm giá theo %</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Phần trăm (%)</Label>
              <Input
                type="number"
                value={percentValue}
                onChange={(e) => setPercentValue(e.target.value)}
                placeholder="10 (tăng 10%) hoặc -10 (giảm 10%)"
                step="1"
              />
              <p className="text-xs text-muted-foreground">
                Nhập số dương để tăng, số âm để giảm (ví dụ: 10 = tăng 10%, -10 = giảm 10%)
              </p>
            </div>
            <p className="text-sm text-muted-foreground">
              Sẽ áp dụng cho <strong>{filteredCount}</strong> biến thể đã lọc.
            </p>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowPercentModal(false)}>
              Hủy
            </Button>
            <Button onClick={handleAdjustPrice} disabled={isApplying}>
              {isApplying ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Đang áp dụng...
                </>
              ) : (
                'Áp dụng'
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Stock Status Modal */}
      <Dialog open={showStockModal} onOpenChange={setShowStockModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Quản lý kho</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Trạng thái kho</Label>
              <Select
                value={stockStatus}
                onValueChange={(value) => setStockStatus(value as 'instock' | 'outofstock')}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="instock">Còn hàng</SelectItem>
                  <SelectItem value="outofstock">Hết hàng</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <p className="text-sm text-muted-foreground">
              Sẽ áp dụng cho <strong>{filteredCount}</strong> biến thể đã lọc.
            </p>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowStockModal(false)}>
              Hủy
            </Button>
            <Button onClick={handleSetStockStatus} disabled={isApplying}>
              {isApplying ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Đang áp dụng...
                </>
              ) : (
                'Áp dụng'
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/VariationsTab.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { AlertCircle, RefreshCw, Plus, AlertTriangle } from 'lucide-react';
import type { ProductDataMetaBoxState } from './ProductDataMetaBox';
import { VariationTable } from './VariationTable';
import { VariationsBulkEditToolbar } from './VariationsBulkEditToolbar';
import { VariationImageMapper } from './VariationImageMapper';
import { VariantSkuGenerator } from '@/components/admin/products/VariantSkuGenerator';
import { validateVariantUniqueness } from '@/lib/utils/skuValidator';
import { useToastContext } from '@/components/providers/ToastProvider';
import type { Variation } from './VariationTable';

interface VariationsTabProps {
  state: ProductDataMetaBoxState;
  onUpdate: (updates: Partial<ProductDataMetaBoxState>) => void;
  productName?: string; // For SKU auto-generation
  categoryId?: string; // For SKU auto-generation
}

/**
 * Variations Tab - Product Variations
 * Features:
 * - Generate Variations button với Cartesian Product algorithm
 * - Variations Table View với inline editing
 * - Variation Image Upload
 * - Performance optimization
 */
export function VariationsTab({ state, onUpdate, productName, categoryId }: VariationsTabProps) {
  const { showToast } = useToastContext();
  const [isGenerating, setIsGenerating] = useState(false);
  const [autoGenerateSku, setAutoGenerateSku] = useState(false);
  const [previewSkus, setPreviewSkus] = useState<Record<string, string>>({});
  const [hasIncrementToken, setHasIncrementToken] = useState(false);
  const [variantValidationErrors, setVariantValidationErrors] = useState<string[]>([]);

  // Get attributes that are used for variations
  const variationAttributes = useMemo(() => {
    return state.attributes.filter((attr) => attr.usedForVariations && attr.values.length > 0);
  }, [state.attributes]);

  // Check if we can generate variations
  const canGenerateVariations = variationAttributes.length > 0;

  // Calculate total possible variations (Cartesian product)
  const totalPossibleVariations = useMemo(() => {
    if (variationAttributes.length === 0) return 0;
    return variationAttributes.reduce((total, attr) => total * attr.values.length, 1);
  }, [variationAttributes]);

  /**
   * Generate all possible variations using Cartesian Product
   * Example: Color [Red, Blue] x Size [S, M] = 4 variations
   */
  const generateVariations = () => {
    if (!canGenerateVariations) return;

    // Confirmation if there are existing variations
    if (state.variations.length > 0) {
      const confirmed = window.confirm(
        `Bạn đã có ${state.variations.length} biến thể. Tạo mới sẽ xóa tất cả biến thể hiện tại. Bạn có muốn tiếp tục?`
      );
      if (!confirmed) return;
    }

    setIsGenerating(true);

    try {
      // Cartesian Product algorithm
      const generateCombinations = (attributes: typeof variationAttributes): Array<Record<string, string>> => {
        if (attributes.length === 0) return [{}];
        if (attributes.length === 1) {
          return attributes[0].values.map((value) => ({
            [attributes[0].name]: value,
          }));
        }

        // Recursive: combine first attribute with all combinations of the rest
        const first = attributes[0];
        const rest = attributes.slice(1);
        const restCombinations = generateCombinations(rest);

        const combinations: Array<Record<string, string>> = [];
        for (const value of first.values) {
          for (const restCombo of restCombinations) {
            combinations.push({
              [first.name]: value,
              ...restCombo,
            });
          }
        }
        return combinations;
      };

      const combinations = generateCombinations(variationAttributes);

      // Create variation objects
      const newVariations = combinations.map((attributes, index) => {
        // Generate variation name from attributes
        const nameParts = Object.entries(attributes)
          .map(([attrName, value]) => `${attrName}: ${value}`)
          .join(', ');
        const name = nameParts || `Variation ${index + 1}`;

        // Only copy prices if they exist
        const variationData: any = {
          id: `var-${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${index}`,
          name,
          sku: '',
          image: undefined,
          attributes,
        };
        
        // Only include prices if they are defined
        if (state.costPrice !== undefined) variationData.costPrice = state.costPrice;
        if (state.regularPrice !== undefined) variationData.regularPrice = state.regularPrice;
        if (state.salePrice !== undefined && state.regularPrice !== undefined && state.salePrice < state.regularPrice) {
          variationData.salePrice = state.salePrice;
        }
        if (state.stockQuantity !== undefined) variationData.stockQuantity = state.stockQuantity;
        
        return variationData;
      });

      // Validate variant uniqueness before updating
      const validation = validateVariantUniqueness(newVariations);
      if (!validation.isValid) {
        setVariantValidationErrors(validation.errors);
        showToast('Có biến thể trùng lặp. Vui lòng kiểm tra lại.', 'error');
        return;
      }
      
      setVariantValidationErrors([]);
      onUpdate({ variations: newVariations });
    } catch (error) {
      console.error('Error generating variations:', error);
      showToast('Có lỗi xảy ra khi tạo biến thể. Vui lòng thử lại.', 'error');
    } finally {
      setIsGenerating(false);
    }
  };

  // Validate variants whenever they change
  useEffect(() => {
    if (state.variations.length === 0) {
      setVariantValidationErrors([]);
      return;
    }

    const validation = validateVariantUniqueness(
      state.variations.map((v) => ({
        attributes: v.attributes,
        size: v.attributes?.Size || v.attributes?.size,
        color: v.attributes?.Color || v.attributes?.color,
      }))
    );

    setVariantValidationErrors(validation.errors);
  }, [state.variations]);

  // Empty state
  if (!canGenerateVariations) {
    return (
      <div className="space-y-6">
        <div>
          <h3 className="text-lg font-semibold mb-4">Biến thể</h3>
          <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
            <div className="flex items-start gap-3">
              <AlertCircle className="h-5 w-5 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0" />
              <div className="flex-1">
                <p className="text-sm font-medium text-yellow-800 dark:text-yellow-200 mb-1">
                  Chưa có thuộc tính để tạo biến thể
                </p>
                <p className="text-xs text-yellow-700 dark:text-yellow-300">
                  Vui lòng thêm thuộc tính trong tab &quot;Thuộc tính&quot; và đánh dấu &quot;Dùng cho biến thể&quot; để có thể tạo biến thể.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-4">Biến thể</h3>

        {/* Generate Variations Section */}
        <div className="bg-muted/50 rounded-lg p-4 mb-6">
          <div className="flex items-center justify-between mb-3">
            <div>
              <p className="text-sm font-medium mb-1">Tạo biến thể tự động</p>
              <p className="text-xs text-muted-foreground">
                Sẽ tạo {totalPossibleVariations} biến thể từ {variationAttributes.length} thuộc tính
              </p>
            </div>
            <Button
              onClick={generateVariations}
              disabled={isGenerating || !canGenerateVariations}
              className="gap-2"
            >
              {isGenerating ? (
                <>
                  <RefreshCw className="h-4 w-4 animate-spin" />
                  Đang tạo...
                </>
              ) : (
                <>
                  <Plus className="h-4 w-4" />
                  Tạo biến thể
                </>
              )}
            </Button>
          </div>

          {/* Variation Attributes Info */}
          <div className="mt-3 pt-3 border-t border-border">
            <p className="text-xs text-muted-foreground mb-2">Thuộc tính được sử dụng:</p>
            <div className="flex flex-wrap gap-2">
              {variationAttributes.map((attr) => (
                <div
                  key={attr.id}
                  className="inline-flex items-center gap-1.5 px-2 py-1 bg-background rounded border border-border text-xs"
                >
                  <span className="font-medium">{attr.name}:</span>
                  <span className="text-muted-foreground">{attr.values.length} giá trị</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Variations Table */}
        {state.variations.length > 0 ? (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <p className="text-sm font-medium">
                {state.variations.length} biến thể
              </p>
              {totalPossibleVariations > 50 && (
                <div className="flex items-center gap-2 text-xs text-amber-600 dark:text-amber-400">
                  <AlertTriangle className="h-4 w-4" />
                  <span>Nhiều biến thể có thể làm chậm hiệu suất</span>
                </div>
              )}
            </div>

            {/* Bulk Edit Toolbar */}
            <VariationsBulkEditToolbar
              variations={state.variations}
              attributes={variationAttributes}
              onBulkUpdate={(updates, filter) => {
                const updatedVariations = state.variations.map((variation) => {
                  // Check if variation matches filter
                  if (filter.applyToAll) {
                    return { ...variation, ...updates };
                  }
                  if (filter.attributeName && filter.attributeValue) {
                    if (variation.attributes[filter.attributeName] === filter.attributeValue) {
                      return { ...variation, ...updates };
                    }
                  }
                  return variation;
                });
                onUpdate({ variations: updatedVariations });
              }}
              onVariationsChange={(variations) => {
                onUpdate({ variations });
              }}
            />

            {/* Image Mapper */}
            <VariationImageMapper
              variations={state.variations}
              attributes={variationAttributes}
              onMapImages={(mappings) => {
                const updatedVariations = state.variations.map((variation) => {
                  // Find matching mapping
                  const mapping = mappings.find(
                    (m) =>
                      variation.attributes[m.attributeName] === m.attributeValue
                  );
                  if (mapping) {
                    return {
                      ...variation,
                      image: mapping.imageUrl,
                    };
                  }
                  return variation;
                });
                onUpdate({ variations: updatedVariations });
              }}
            />

            {/* Variant Validation Errors */}
            {variantValidationErrors.length > 0 && (
              <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <AlertCircle className="h-5 w-5 text-red-600 dark:text-red-400 mt-0.5 flex-shrink-0" />
                  <div className="flex-1">
                    <p className="text-sm font-medium text-red-800 dark:text-red-200 mb-2">
                      Có biến thể trùng lặp
                    </p>
                    <ul className="text-xs text-red-700 dark:text-red-300 space-y-1">
                      {variantValidationErrors.map((error, idx) => (
                        <li key={idx}>• {error}</li>
                      ))}
                    </ul>
                    <p className="text-xs text-red-600 dark:text-red-400 mt-2">
                      Không thể tạo 2 biến thể có cùng thuộc tính (Size, Màu, ...)
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* Variant SKU Generator */}
            {productName && (
              <VariantSkuGenerator
                variations={state.variations}
                productName={productName}
                categoryId={categoryId}
                onVariationsChange={(variations) => {
                  // Validate before updating
                  const validation = validateVariantUniqueness(
                    variations.map((v) => ({
                      attributes: v.attributes,
                      size: v.attributes?.Size || v.attributes?.size,
                      color: v.attributes?.Color || v.attributes?.color,
                    }))
                  );
                  
                  if (!validation.isValid) {
                    setVariantValidationErrors(validation.errors);
                    showToast('Có biến thể trùng lặp. Vui lòng kiểm tra lại.', 'error');
                    return;
                  }
                  
                  setVariantValidationErrors([]);
                  onUpdate({ variations });
                }}
                autoGenerateEnabled={autoGenerateSku}
                onAutoGenerateChange={setAutoGenerateSku}
                onPreviewSkusChange={setPreviewSkus}
                onHasIncrementTokenChange={setHasIncrementToken}
              />
            )}

            {/* Variations Table */}
            <VariationTable
              variations={state.variations}
              onVariationsChange={(variations) => {
                // Validate before updating
                const validation = validateVariantUniqueness(
                  variations.map((v) => ({
                    attributes: v.attributes,
                    size: v.attributes?.Size || v.attributes?.size,
                    color: v.attributes?.Color || v.attributes?.color,
                  }))
                );
                
                if (!validation.isValid) {
                  setVariantValidationErrors(validation.errors);
                  showToast('Có biến thể trùng lặp. Vui lòng kiểm tra lại.', 'error');
                  return;
                }
                
                setVariantValidationErrors([]);
                onUpdate({ variations });
              }}
              productName={productName}
              categoryId={categoryId}
              autoGenerateSku={autoGenerateSku}
              previewSkus={previewSkus}
              hasIncrementToken={hasIncrementToken}
            />
          </div>
        ) : (
          <div className="text-center py-12 border-2 border-dashed border-muted rounded-lg">
            <p className="text-sm text-muted-foreground mb-4">
              Chưa có biến thể nào. Nhấn &quot;Tạo biến thể&quot; để tạo tự động.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDataMetaBox/VariationTable.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { ImageIcon, Trash2, Copy, Upload, X } from 'lucide-react';
import Image from 'next/image';

export interface Variation {
  id: string;
  name: string;
  sku?: string;
  costPrice?: number;
  regularPrice?: number;
  salePrice?: number;
  stockQuantity?: number;
  image?: string;
  attributes: Record<string, string>;
}

interface VariationTableProps {
  variations: Variation[];
  onVariationsChange: (variations: Variation[]) => void;
  productName?: string; // For SKU auto-generation
  categoryId?: string; // For SKU auto-generation
  autoGenerateSku?: boolean; // Auto-generate SKU enabled
  previewSkus?: Record<string, string>; // Preview SKUs for live preview
  hasIncrementToken?: boolean; // Pattern has {INCREMENT} token
}

/**
 * Variation Table - Spreadsheet-like table với inline editing
 * Features:
 * - Inline editing (click cell to edit)
 * - Tab key để move to next cell
 * - Enter để save, Escape để cancel
 * - Row selection với checkbox
 * - Bulk actions (Delete selected)
 * - Image upload per variation
 */
export function VariationTable({
  variations,
  onVariationsChange,
  productName,
  categoryId,
  autoGenerateSku = false,
  previewSkus = {},
  hasIncrementToken = false,
}: VariationTableProps) {
  const [selectedRows, setSelectedRows] = useState<Set<string>>(new Set());
  const [editingCell, setEditingCell] = useState<{ rowId: string; field: string } | null>(null);
  const [editValue, setEditValue] = useState<string>('');
  const inputRef = useRef<HTMLInputElement>(null);

  // Focus input when editing starts
  useEffect(() => {
    if (editingCell && inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, [editingCell]);

  // Handle cell click to start editing
  const handleCellClick = (rowId: string, field: string, currentValue: string | number | undefined) => {
    setEditingCell({ rowId, field });
    setEditValue(currentValue?.toString() || '');
  };

  // Handle input change
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setEditValue(e.target.value);
  };

  // Handle save (Enter key or blur)
  const handleSave = () => {
    if (!editingCell) return;

    const { rowId, field } = editingCell;
    const updatedVariations = variations.map((variation) => {
      if (variation.id !== rowId) return variation;

      const updated = { ...variation };
      const numValue = parseFloat(editValue);

      switch (field) {
        case 'sku':
          updated.sku = editValue.trim() || undefined;
          break;
        case 'costPrice':
          updated.costPrice = editValue.trim() ? (isNaN(numValue) ? undefined : numValue) : undefined;
          break;
        case 'regularPrice':
          updated.regularPrice = editValue.trim() ? (isNaN(numValue) ? undefined : numValue) : undefined;
          break;
        case 'salePrice':
          updated.salePrice = editValue.trim() ? (isNaN(numValue) ? undefined : numValue) : undefined;
          break;
        case 'stockQuantity':
          updated.stockQuantity = editValue.trim() ? (isNaN(numValue) ? undefined : Math.floor(numValue)) : undefined;
          break;
        default:
          return variation;
      }

      return updated;
    });

    onVariationsChange(updatedVariations);
    setEditingCell(null);
    setEditValue('');
  };

  // Handle cancel (Escape key)
  const handleCancel = () => {
    setEditingCell(null);
    setEditValue('');
  };

  // Handle key down
  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSave();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      handleCancel();
    } else if (e.key === 'Tab') {
      // Tab navigation will be handled by browser, but we save current edit first
      if (editingCell) {
        handleSave();
      }
    }
  };

  // Handle image upload
  const handleImageUpload = (variationId: string, file: File) => {
    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Vui lòng chọn file hình ảnh');
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Kích thước file không được vượt quá 5MB');
      return;
    }

    // Convert to data URL (in production, upload to server)
    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      const updatedVariations = variations.map((variation) =>
        variation.id === variationId ? { ...variation, image: dataUrl } : variation
      );
      onVariationsChange(updatedVariations);
    };
    reader.onerror = () => {
      alert('Có lỗi xảy ra khi đọc file');
    };
    reader.readAsDataURL(file);
  };

  // Handle image remove
  const handleImageRemove = (variationId: string) => {
    const updatedVariations = variations.map((variation) =>
      variation.id === variationId ? { ...variation, image: undefined } : variation
    );
    onVariationsChange(updatedVariations);
  };

  // Handle row selection
  const handleRowSelect = (variationId: string, checked: boolean) => {
    const newSelected = new Set(selectedRows);
    if (checked) {
      newSelected.add(variationId);
    } else {
      newSelected.delete(variationId);
    }
    setSelectedRows(newSelected);
  };

  // Handle select all
  const handleSelectAll = (checked: boolean) => {
    if (checked) {
      setSelectedRows(new Set(variations.map((v) => v.id)));
    } else {
      setSelectedRows(new Set());
    }
  };

  // Handle delete selected
  const handleDeleteSelected = () => {
    if (selectedRows.size === 0) return;
    const confirmed = window.confirm(
      `Bạn có chắc chắn muốn xóa ${selectedRows.size} biến thể đã chọn?`
    );
    if (!confirmed) return;

    const updatedVariations = variations.filter((v) => !selectedRows.has(v.id));
    onVariationsChange(updatedVariations);
    setSelectedRows(new Set());
  };

  // Handle duplicate variation
  const handleDuplicate = (variationId: string) => {
    const variation = variations.find((v) => v.id === variationId);
    if (!variation) return;

    const duplicated: Variation = {
      ...variation,
      id: `var-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      name: `${variation.name} (Copy)`,
      sku: undefined, // Clear SKU for duplicate
    };

    const index = variations.findIndex((v) => v.id === variationId);
    const updatedVariations = [
      ...variations.slice(0, index + 1),
      duplicated,
      ...variations.slice(index + 1),
    ];
    onVariationsChange(updatedVariations);
  };

  // Handle delete single variation
  const handleDelete = (variationId: string) => {
    const confirmed = window.confirm('Bạn có chắc chắn muốn xóa biến thể này?');
    if (!confirmed) return;

    const updatedVariations = variations.filter((v) => v.id !== variationId);
    onVariationsChange(updatedVariations);
  };

  const isEditing = (rowId: string, field: string) => {
    return editingCell?.rowId === rowId && editingCell?.field === field;
  };

  const getCellValue = (variation: Variation, field: string): string => {
    switch (field) {
      case 'sku':
        return variation.sku || '';
      case 'costPrice':
        return variation.costPrice?.toString() || '';
      case 'regularPrice':
        return variation.regularPrice?.toString() || '';
      case 'salePrice':
        return variation.salePrice?.toString() || '';
      case 'stockQuantity':
        return variation.stockQuantity?.toString() || '';
      default:
        return '';
    }
  };

  return (
    <div className="space-y-4">
      {/* Bulk Actions */}
      {selectedRows.size > 0 && (
        <div className="flex items-center justify-between p-3 bg-muted/50 rounded-lg">
          <p className="text-sm font-medium">
            Đã chọn {selectedRows.size} biến thể
          </p>
          <Button
            variant="destructive"
            size="sm"
            onClick={handleDeleteSelected}
            className="gap-2"
          >
            <Trash2 className="h-4 w-4" />
            Xóa đã chọn
          </Button>
        </div>
      )}

      {/* Table */}
      <div className="border rounded-lg overflow-hidden">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-12">
                <Checkbox
                  checked={selectedRows.size === variations.length && variations.length > 0}
                  onCheckedChange={handleSelectAll}
                />
              </TableHead>
              <TableHead className="w-20">Hình ảnh</TableHead>
              <TableHead>Tên</TableHead>
              <TableHead className="w-32">SKU</TableHead>
              <TableHead className="w-32">Giá vốn</TableHead>
              <TableHead className="w-32">Giá bán</TableHead>
              <TableHead className="w-32">Giá KM</TableHead>
              <TableHead className="w-32">Tồn kho</TableHead>
              <TableHead className="w-32">Thao tác</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {variations.map((variation) => (
              <TableRow key={variation.id}>
                {/* Checkbox */}
                <TableCell>
                  <Checkbox
                    checked={selectedRows.has(variation.id)}
                    onCheckedChange={(checked) => handleRowSelect(variation.id, checked as boolean)}
                  />
                </TableCell>

                {/* Image */}
                <TableCell>
                  <div className="relative w-16 h-16 rounded border border-border overflow-hidden bg-muted/50">
                    {variation.image ? (
                      <>
                        <Image
                          src={variation.image}
                          alt={variation.name}
                          fill
                          className="object-cover"
                          unoptimized={variation.image.startsWith('data:')}
                        />
                        <button
                          onClick={() => handleImageRemove(variation.id)}
                          className="absolute top-0 right-0 p-1 bg-red-500 text-white rounded-bl opacity-0 hover:opacity-100 transition-opacity"
                          title="Xóa hình ảnh"
                        >
                          <X className="h-3 w-3" />
                        </button>
                      </>
                    ) : (
                      <label className="w-full h-full flex items-center justify-center cursor-pointer hover:bg-muted transition-colors">
                        <input
                          type="file"
                          accept="image/*"
                          className="hidden"
                          onChange={(e) => {
                            const file = e.target.files?.[0];
                            if (file) handleImageUpload(variation.id, file);
                            e.target.value = ''; // Reset to allow re-uploading same file
                          }}
                        />
                        <ImageIcon className="h-6 w-6 text-muted-foreground" />
                      </label>
                    )}
                  </div>
                </TableCell>

                {/* Name (read-only) */}
                <TableCell>
                  <div className="text-sm font-medium">{variation.name}</div>
                </TableCell>

                {/* SKU */}
                <TableCell>
                  {isEditing(variation.id, 'sku') ? (
                    <Input
                      ref={inputRef}
                      value={editValue}
                      onChange={handleInputChange}
                      onBlur={handleSave}
                      onKeyDown={handleKeyDown}
                      className="h-8 text-xs"
                    />
                  ) : (
                    <div className="space-y-1">
                      <div
                        onClick={() => handleCellClick(variation.id, 'sku', variation.sku)}
                        className="px-2 py-1.5 text-sm rounded border border-transparent hover:border-border cursor-text min-h-[32px] flex items-center"
                      >
                        {variation.sku || <span className="text-muted-foreground">Click để nhập</span>}
                      </div>
                      {/* Live Preview */}
                      {autoGenerateSku && !variation.sku && previewSkus[variation.id] && (
                        <div className="text-xs text-muted-foreground italic px-2">
                          {hasIncrementToken && previewSkus[variation.id].includes('###') ? (
                            <span title="Số thứ tự thực tế sẽ được gán khi lưu sản phẩm">
                              {previewSkus[variation.id]}
                            </span>
                          ) : (
                            <span>Preview: {previewSkus[variation.id]}</span>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </TableCell>

                {/* Cost Price */}
                <TableCell>
                  {isEditing(variation.id, 'costPrice') ? (
                    <Input
                      ref={inputRef}
                      type="number"
                      step="0.01"
                      value={editValue}
                      onChange={handleInputChange}
                      onBlur={handleSave}
                      onKeyDown={handleKeyDown}
                      className="h-8 text-xs"
                    />
                  ) : (
                    <div
                      onClick={() => handleCellClick(variation.id, 'costPrice', variation.costPrice)}
                      className="px-2 py-1.5 text-sm rounded border border-transparent hover:border-border cursor-text min-h-[32px] flex items-center"
                    >
                      {variation.costPrice ? `${variation.costPrice.toLocaleString('vi-VN')}đ` : <span className="text-muted-foreground">Click để nhập</span>}
                    </div>
                  )}
                </TableCell>

                {/* Regular Price */}
                <TableCell>
                  {isEditing(variation.id, 'regularPrice') ? (
                    <Input
                      ref={inputRef}
                      type="number"
                      step="0.01"
                      value={editValue}
                      onChange={handleInputChange}
                      onBlur={handleSave}
                      onKeyDown={handleKeyDown}
                      className="h-8 text-xs"
                    />
                  ) : (
                    <div
                      onClick={() => handleCellClick(variation.id, 'regularPrice', variation.regularPrice)}
                      className="px-2 py-1.5 text-sm rounded border border-transparent hover:border-border cursor-text min-h-[32px] flex items-center"
                    >
                      {variation.regularPrice ? `${variation.regularPrice.toLocaleString('vi-VN')}đ` : <span className="text-muted-foreground">Click để nhập</span>}
                    </div>
                  )}
                </TableCell>

                {/* Sale Price */}
                <TableCell>
                  {isEditing(variation.id, 'salePrice') ? (
                    <Input
                      ref={inputRef}
                      type="number"
                      step="0.01"
                      value={editValue}
                      onChange={handleInputChange}
                      onBlur={handleSave}
                      onKeyDown={handleKeyDown}
                      className="h-8 text-xs"
                    />
                  ) : (
                    <div
                      onClick={() => handleCellClick(variation.id, 'salePrice', variation.salePrice)}
                      className="px-2 py-1.5 text-sm rounded border border-transparent hover:border-border cursor-text min-h-[32px] flex items-center"
                    >
                      {variation.salePrice ? `${variation.salePrice.toLocaleString('vi-VN')}đ` : <span className="text-muted-foreground">Click để nhập</span>}
                    </div>
                  )}
                </TableCell>

                {/* Stock Quantity */}
                <TableCell>
                  {isEditing(variation.id, 'stockQuantity') ? (
                    <Input
                      ref={inputRef}
                      type="number"
                      step="1"
                      value={editValue}
                      onChange={handleInputChange}
                      onBlur={handleSave}
                      onKeyDown={handleKeyDown}
                      className="h-8 text-xs"
                    />
                  ) : (
                    <div
                      onClick={() => handleCellClick(variation.id, 'stockQuantity', variation.stockQuantity)}
                      className="px-2 py-1.5 text-sm rounded border border-transparent hover:border-border cursor-text min-h-[32px] flex items-center"
                    >
                      {variation.stockQuantity !== undefined ? variation.stockQuantity : <span className="text-muted-foreground">Click để nhập</span>}
                    </div>
                  )}
                </TableCell>

                {/* Actions */}
                <TableCell>
                  <div className="flex items-center gap-1">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleDuplicate(variation.id)}
                      className="h-7 w-7 p-0"
                      title="Nhân đôi"
                    >
                      <Copy className="h-3.5 w-3.5" />
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleDelete(variation.id)}
                      className="h-7 w-7 p-0 text-destructive hover:text-destructive"
                      title="Xóa"
                    >
                      <Trash2 className="h-3.5 w-3.5" />
                    </Button>
                  </div>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>

      {variations.length === 0 && (
        <div className="text-center py-8 text-sm text-muted-foreground">
          Chưa có biến thể nào
        </div>
      )}
    </div>
  );
}
================================================================================FILE: components/admin/products/ProductDetailsSection.tsx================================================================================'use client';

import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

interface ProductDetailsData {
  ageRecommendation?: string;
  careInstructions?: string;
  safetyInformation?: string;
  productSpecifications?: string;
  sizeGuide?: string;
  materialDetails?: string;
  warrantyInformation?: string;
}

interface ProductDetailsSectionProps {
  data: ProductDetailsData;
  onChange: (data: ProductDetailsData) => void;
}

export function ProductDetailsSection({ data, onChange }: ProductDetailsSectionProps) {
  const updateField = (field: keyof ProductDetailsData, value: string) => {
    onChange({ ...data, [field]: value });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Thông tin chi tiết sản phẩm</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <Label htmlFor="ageRecommendation">Độ tuổi phù hợp</Label>
          <Input
            id="ageRecommendation"
            value={data.ageRecommendation || ''}
            onChange={(e) => updateField('ageRecommendation', e.target.value)}
            placeholder="Ví dụ: 3-12 tuổi"
          />
        </div>

        <div>
          <Label htmlFor="careInstructions">Hướng dẫn bảo quản</Label>
          <Textarea
            id="careInstructions"
            value={data.careInstructions || ''}
            onChange={(e) => updateField('careInstructions', e.target.value)}
            rows={4}
            placeholder="Hướng dẫn cách bảo quản sản phẩm..."
          />
        </div>

        <div>
          <Label htmlFor="safetyInformation">Thông tin an toàn</Label>
          <Textarea
            id="safetyInformation"
            value={data.safetyInformation || ''}
            onChange={(e) => updateField('safetyInformation', e.target.value)}
            rows={3}
            placeholder="Thông tin về độ an toàn của sản phẩm..."
          />
        </div>

        <div>
          <Label htmlFor="productSpecifications">Thông số kỹ thuật chi tiết</Label>
          <Textarea
            id="productSpecifications"
            value={data.productSpecifications || ''}
            onChange={(e) => updateField('productSpecifications', e.target.value)}
            rows={5}
            placeholder="Các thông số kỹ thuật chi tiết của sản phẩm..."
          />
        </div>

        <div>
          <Label htmlFor="sizeGuide">Hướng dẫn chọn size</Label>
          <Textarea
            id="sizeGuide"
            value={data.sizeGuide || ''}
            onChange={(e) => updateField('sizeGuide', e.target.value)}
            rows={4}
            placeholder="Hướng dẫn khách hàng chọn size phù hợp..."
          />
        </div>

        <div>
          <Label htmlFor="materialDetails">Chi tiết chất liệu</Label>
          <Textarea
            id="materialDetails"
            value={data.materialDetails || ''}
            onChange={(e) => updateField('materialDetails', e.target.value)}
            rows={3}
            placeholder="Chi tiết về chất liệu sản phẩm..."
          />
        </div>

        <div>
          <Label htmlFor="warrantyInformation">Thông tin bảo hành</Label>
          <Textarea
            id="warrantyInformation"
            value={data.warrantyInformation || ''}
            onChange={(e) => updateField('warrantyInformation', e.target.value)}
            rows={3}
            placeholder="Thông tin về chế độ bảo hành sản phẩm..."
          />
        </div>
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/ProductFilters.tsx================================================================================'use client';

import { useState } from 'react';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Filter, X } from 'lucide-react';
import { CategoryTreeSelect } from './CategoryTreeSelect';
import { PriceRangeFilter } from './PriceRangeFilter';
import type { ProductFilters } from '@/lib/hooks/useProductFilters';

interface ProductFiltersProps {
  filters: ProductFilters;
  onFilterChange: (key: keyof ProductFilters, value: any) => void;
  onClearFilters: () => void;
  hasActiveFilters: boolean;
}

export function ProductFilters({
  filters,
  onFilterChange,
  onClearFilters,
  hasActiveFilters,
}: ProductFiltersProps) {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="flex items-center gap-2">
      <Popover open={isOpen} onOpenChange={setIsOpen}>
        <PopoverTrigger asChild>
          <Button variant="outline" className="relative">
            <Filter className="w-4 h-4 mr-2" />
            Bộ lọc
            {hasActiveFilters && (
              <span className="ml-2 h-5 w-5 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center">
                {[
                  filters.category,
                  filters.brand,
                  filters.priceMin !== null,
                  filters.priceMax !== null,
                  filters.stockStatus,
                ].filter(Boolean).length}
              </span>
            )}
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-80 p-4" align="start">
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="font-semibold">Bộ lọc sản phẩm</h3>
              {hasActiveFilters && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={onClearFilters}
                  className="text-xs"
                >
                  <X className="w-3 h-3 mr-1" />
                  Xóa tất cả
                </Button>
              )}
            </div>

            {/* Category Filter */}
            <div>
              <CategoryTreeSelect
                value={filters.category || null}
                onChange={(value) => onFilterChange('category', value)}
                placeholder="Tất cả danh mục"
              />
            </div>

            {/* Brand Filter - Placeholder for future */}
            {/* <div>
              <Select
                value={filters.brand || ''}
                onValueChange={(value) => onFilterChange('brand', value || null)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Tất cả thương hiệu" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Tất cả thương hiệu</SelectItem>
                  <SelectItem value="brand1">Thương hiệu 1</SelectItem>
                  <SelectItem value="brand2">Thương hiệu 2</SelectItem>
                </SelectContent>
              </Select>
            </div> */}

            {/* Price Range Filter */}
            <div>
              <PriceRangeFilter
                minPrice={filters.priceMin ?? null}
                maxPrice={filters.priceMax ?? null}
                onMinPriceChange={(value) => onFilterChange('priceMin', value)}
                onMaxPriceChange={(value) => onFilterChange('priceMax', value)}
                onClear={() => {
                  onFilterChange('priceMin', null);
                  onFilterChange('priceMax', null);
                }}
              />
            </div>

            {/* Stock Status Filter */}
            <div>
              <label className="text-sm font-medium mb-2 block">Trạng thái kho</label>
              <Select
                value={filters.stockStatus || 'all'}
                onValueChange={(value) => onFilterChange('stockStatus', value === 'all' ? null : value)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Tất cả trạng thái" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Tất cả trạng thái</SelectItem>
                  <SelectItem value="instock">Còn hàng</SelectItem>
                  <SelectItem value="outofstock">Hết hàng</SelectItem>
                  <SelectItem value="onbackorder">Đặt hàng trước</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </PopoverContent>
      </Popover>

      {/* Active Filters Display */}
      {hasActiveFilters && (
        <div className="flex items-center gap-2 flex-wrap">
          {filters.category && (
            <span className="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">
              Danh mục: {filters.category}
              <button
                onClick={() => onFilterChange('category', null)}
                className="hover:bg-blue-100 rounded"
              >
                <X className="w-3 h-3" />
              </button>
            </span>
          )}
          {filters.priceMin !== null && filters.priceMin !== undefined && (
            <span className="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">
              Giá từ: {filters.priceMin.toLocaleString('vi-VN')} VND
              <button
                onClick={() => onFilterChange('priceMin', null)}
                className="hover:bg-blue-100 rounded"
              >
                <X className="w-3 h-3" />
              </button>
            </span>
          )}
          {filters.priceMax !== null && filters.priceMax !== undefined && (
            <span className="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">
              Giá đến: {filters.priceMax.toLocaleString('vi-VN')} VND
              <button
                onClick={() => onFilterChange('priceMax', null)}
                className="hover:bg-blue-100 rounded"
              >
                <X className="w-3 h-3" />
              </button>
            </span>
          )}
          {filters.stockStatus && (
            <span className="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">
              Kho: {filters.stockStatus === 'instock' ? 'Còn hàng' : filters.stockStatus === 'outofstock' ? 'Hết hàng' : 'Đặt hàng trước'}
              <button
                onClick={() => onFilterChange('stockStatus', null)}
                className="hover:bg-blue-100 rounded"
              >
                <X className="w-3 h-3" />
              </button>
            </span>
          )}
        </div>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/ProductFormLayout.tsx================================================================================'use client';

import { ReactNode } from 'react';

interface ProductFormLayoutProps {
  children: ReactNode;
  sidebar: ReactNode;
  header?: ReactNode;
}

/**
 * Product Form Layout với 2 cột (giống WordPress)
 * - Cột trái: Form chính (70%)
 * - Cột phải: Sidebar với các chức năng nhanh (30%)
 * - Responsive: Sidebar chuyển xuống dưới trên mobile
 */
export function ProductFormLayout({ children, sidebar, header }: ProductFormLayoutProps) {
  return (
    <div className="space-y-6">
      {/* Header (optional) */}
      {header && (
        <div className="border-b pb-4">
          {header}
        </div>
      )}

      {/* Main Layout: 2 columns on desktop, stacked on mobile */}
      <div className="grid grid-cols-1 lg:grid-cols-[1fr_350px] gap-6">
        {/* Main Form (Left Column - 70% on desktop) */}
        <div className="space-y-6 min-w-0 pb-8">
          {children}
        </div>

        {/* Sidebar (Right Column - 30% on desktop) */}
        <div className="space-y-6">
          {/* Sticky sidebar on desktop */}
          <div className="lg:sticky lg:top-6 lg:max-h-[calc(100vh-3rem-2rem)] lg:overflow-y-auto lg:pb-8 lg:pr-2">
            <div className="space-y-6">
              {sidebar}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}



================================================================================FILE: components/admin/products/ProductListTabs.tsx================================================================================'use client';

import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';

export type ProductListTab = 'all' | 'active' | 'outofstock' | 'trash';

interface ProductListTabsProps {
  activeTab: ProductListTab;
  onTabChange: (tab: ProductListTab) => void;
  trashCount?: number;
}

export function ProductListTabs({
  activeTab,
  onTabChange,
  trashCount = 0,
}: ProductListTabsProps) {
  return (
    <Tabs value={activeTab} onValueChange={(value) => onTabChange(value as ProductListTab)}>
      <TabsList className="grid w-full grid-cols-4">
        <TabsTrigger value="all">Tất cả</TabsTrigger>
        <TabsTrigger value="active">Đang bán</TabsTrigger>
        <TabsTrigger value="outofstock">Hết hàng</TabsTrigger>
        <TabsTrigger value="trash">
          Thùng rác {trashCount > 0 && `(${trashCount})`}
        </TabsTrigger>
      </TabsList>
    </Tabs>
  );
}

================================================================================FILE: components/admin/products/ProductReviews.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { useToastContext } from '@/components/providers/ToastProvider';
import { Star, Check, X, Trash2, ThumbsUp } from 'lucide-react';

interface Review {
  _id: string;
  rating: number;
  title?: string;
  content: string;
  authorName: string;
  authorEmail: string;
  status: 'pending' | 'approved' | 'rejected';
  photos?: string[];
  helpfulCount: number;
  createdAt: string;
}

interface ProductReviewsProps {
  productId: string;
}

export function ProductReviews({ productId }: ProductReviewsProps) {
  const { showToast } = useToastContext();
  const [reviews, setReviews] = useState<Review[]>([]);
  const [loading, setLoading] = useState(true);
  const [statusFilter, setStatusFilter] = useState<string>('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);

  useEffect(() => {
    fetchReviews();
  }, [productId, statusFilter, page]);

  const fetchReviews = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: '20',
      });
      if (statusFilter) {
        params.append('status', statusFilter);
      }

      const response = await fetch(`/api/admin/products/${productId}/reviews?${params}`);
      const data = await response.json();
      setReviews(data.reviews || []);
      setTotalPages(data.pagination?.totalPages || 1);
    } catch (error) {
      console.error('Error fetching reviews:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleStatusChange = async (reviewId: string, newStatus: 'approved' | 'rejected') => {
    try {
      const response = await fetch(`/api/admin/products/${productId}/reviews/${reviewId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      if (response.ok) {
        showToast(
          newStatus === 'approved' ? 'Đã duyệt đánh giá' : 'Đã từ chối đánh giá',
          'success'
        );
        fetchReviews();
      } else {
        showToast('Có lỗi xảy ra khi cập nhật trạng thái', 'error');
      }
    } catch (error) {
      console.error('Error updating review status:', error);
      showToast('Có lỗi xảy ra khi cập nhật trạng thái', 'error');
    }
  };

  const handleDelete = async (reviewId: string) => {
    if (!confirm('Bạn có chắc muốn xóa đánh giá này?')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/products/${productId}/reviews/${reviewId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        showToast('Đã xóa đánh giá thành công', 'success');
        fetchReviews();
      } else {
        showToast('Có lỗi xảy ra khi xóa đánh giá', 'error');
      }
    } catch (error) {
      console.error('Error deleting review:', error);
      showToast('Có lỗi xảy ra khi xóa đánh giá', 'error');
    }
  };

  const renderStars = (rating: number) => {
    return Array.from({ length: 5 }).map((_, i) => (
      <Star
        key={i}
        className={`w-4 h-4 ${
          i < rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'
        }`}
      />
    ));
  };

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { label: string; className: string }> = {
      pending: { label: 'Chờ duyệt', className: 'bg-yellow-100 text-yellow-800' },
      approved: { label: 'Đã duyệt', className: 'bg-green-100 text-green-800' },
      rejected: { label: 'Đã từ chối', className: 'bg-red-100 text-red-800' },
    };

    const variant = variants[status] || variants.pending;
    return (
      <Badge className={variant.className}>{variant.label}</Badge>
    );
  };

  if (loading) {
    return <div className="text-center py-8">Đang tải...</div>;
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between items-center">
          <CardTitle>Đánh giá sản phẩm</CardTitle>
          <div className="flex gap-2">
            <select
              value={statusFilter}
              onChange={(e) => {
                setStatusFilter(e.target.value);
                setPage(1);
              }}
              className="border rounded px-3 py-2 text-sm"
            >
              <option value="">Tất cả trạng thái</option>
              <option value="pending">Chờ duyệt</option>
              <option value="approved">Đã duyệt</option>
              <option value="rejected">Đã từ chối</option>
            </select>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        {reviews.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            Chưa có đánh giá nào
          </div>
        ) : (
          <div className="space-y-4">
            {reviews.map((review) => (
              <div
                key={review._id}
                className="border rounded-lg p-4 space-y-3"
              >
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      {renderStars(review.rating)}
                      {review.title && (
                        <span className="font-medium">{review.title}</span>
                      )}
                      {getStatusBadge(review.status)}
                    </div>
                    <p className="text-sm text-gray-700 mb-2">{review.content}</p>
                    <div className="flex items-center gap-4 text-xs text-gray-500">
                      <span>{review.authorName}</span>
                      <span>{review.authorEmail}</span>
                      <span>
                        {new Date(review.createdAt).toLocaleDateString('vi-VN')}
                      </span>
                      {review.helpfulCount > 0 && (
                        <span className="flex items-center gap-1">
                          <ThumbsUp className="w-3 h-3" />
                          {review.helpfulCount} hữu ích
                        </span>
                      )}
                    </div>
                    {review.photos && review.photos.length > 0 && (
                      <div className="flex gap-2 mt-2">
                        {review.photos.map((photo, idx) => (
                          <div key={idx} className="relative w-20 h-20 rounded overflow-hidden">
                            <Image
                              src={photo}
                              alt={`Review photo ${idx + 1}`}
                              fill
                              className="object-cover"
                              sizes="80px"
                            />
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2">
                    {review.status === 'pending' && (
                      <>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleStatusChange(review._id, 'approved')}
                          className="text-green-600"
                        >
                          <Check className="w-4 h-4" />
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleStatusChange(review._id, 'rejected')}
                          className="text-red-600"
                        >
                          <X className="w-4 h-4" />
                        </Button>
                      </>
                    )}
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleDelete(review._id)}
                      className="text-red-600"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </div>
            ))}
            
            {/* Pagination */}
            {totalPages > 1 && (
              <div className="flex justify-center gap-2 mt-4">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                  disabled={page === 1}
                >
                  Trước
                </Button>
                <span className="px-4 py-2 text-sm">
                  Trang {page} / {totalPages}
                </span>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                  disabled={page === totalPages}
                >
                  Sau
                </Button>
              </div>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/QuickAddTermModal.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Loader2 } from 'lucide-react';
import { generateSlug } from '@/lib/utils/slug';
import type { Attribute } from '@/app/admin/attributes/page';
import { MediaLibraryModal, type MediaItem } from '@/components/admin/products/MediaLibraryModal';

interface QuickAddTermModalProps {
  isOpen: boolean;
  onClose: () => void;
  attribute: Attribute;
  onSuccess: (termName: string) => void;
}

/**
 * Color Picker Component
 */
function ColorPicker({
  label,
  value,
  onChange,
  required = false,
}: {
  label: string;
  value: string;
  onChange: (value: string) => void;
  required?: boolean;
}) {
  return (
    <div className="space-y-2">
      <Label>
        {label} {required && <span className="text-red-500">*</span>}
      </Label>
      <div className="flex items-center gap-3">
        <Input
          type="color"
          value={value || '#000000'}
          onChange={(e) => onChange(e.target.value)}
          className="w-20 h-12 cursor-pointer"
        />
        <Input
          type="text"
          value={value || ''}
          onChange={(e) => {
            const hex = e.target.value.startsWith('#') ? e.target.value : `#${e.target.value}`;
            if (/^#[0-9A-Fa-f]{6}$/.test(hex) || hex === '#') {
              onChange(hex);
            }
          }}
          placeholder="#000000"
          pattern="^#[0-9A-Fa-f]{6}$"
          className="flex-1 font-mono"
        />
        {value && (
          <div
            className="w-12 h-12 rounded-lg border-2 border-gray-300"
            style={{ backgroundColor: value }}
            title={value}
          />
        )}
      </div>
    </div>
  );
}

export function QuickAddTermModal({
  isOpen,
  onClose,
  attribute,
  onSuccess,
}: QuickAddTermModalProps) {
  const [name, setName] = useState('');
  const [slug, setSlug] = useState('');
  const [description, setDescription] = useState('');
  const [colorHex, setColorHex] = useState('');
  const [colorHex2, setColorHex2] = useState('');
  const [hasGradient, setHasGradient] = useState(false);
  const [imageUrl, setImageUrl] = useState('');
  const [imageId, setImageId] = useState('');
  const [showMediaLibrary, setShowMediaLibrary] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [autoGenerateSlug, setAutoGenerateSlug] = useState(true);

  // Reset form when modal opens/closes
  useEffect(() => {
    if (isOpen) {
      setName('');
      setSlug('');
      setDescription('');
      setColorHex('');
      setColorHex2('');
      setHasGradient(false);
      setImageUrl('');
      setImageId('');
      setAutoGenerateSlug(true);
      setError(null);
    }
  }, [isOpen]);

  // Auto-generate slug from name
  useEffect(() => {
    if (autoGenerateSlug && name) {
      setSlug(generateSlug(name));
    }
  }, [name, autoGenerateSlug]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    if (!name.trim()) {
      setError('Tên giá trị không được để trống');
      return;
    }

    // Validate color type
    if (attribute.type === 'color' && !colorHex) {
      setError('Vui lòng chọn màu');
      return;
    }

    // Validate image/button type
    if (
      (attribute.type === 'image' || attribute.type === 'button') &&
      !imageUrl &&
      !imageId
    ) {
      setError('Vui lòng upload ảnh');
      return;
    }

    setIsSubmitting(true);

    try {
      const termData: any = {
        name: name.trim(),
        slug: slug.trim() || generateSlug(name.trim()),
        description: description.trim() || undefined,
      };

      // Add type-specific fields
      if (attribute.type === 'color') {
        termData.colorHex = colorHex;
        if (hasGradient && colorHex2) {
          termData.colorHex2 = colorHex2;
        }
      } else if (attribute.type === 'image' || attribute.type === 'button') {
        if (imageId) {
          termData.imageId = imageId;
        }
        if (imageUrl) {
          termData.imageUrl = imageUrl;
        }
      }

      const response = await fetch(`/api/admin/attributes/${attribute.id}/terms`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(termData),
      });

      if (response.ok) {
        const data = await response.json();
        onSuccess(data.term.name);
        onClose();
      } else {
        const errorData = await response.json();
        setError(errorData.error || 'Có lỗi xảy ra khi tạo giá trị');
      }
    } catch (err: any) {
      setError(err.message || 'Có lỗi xảy ra');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleImageSelect = (item: MediaItem | MediaItem[]) => {
    const image = Array.isArray(item) ? item[0] : item;
    setImageId(image.id);
    setImageUrl(image.url);
    setShowMediaLibrary(false);
  };

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent className="max-w-md max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Tạo giá trị mới cho &quot;{attribute.name}&quot;</DialogTitle>
          </DialogHeader>

          <form onSubmit={handleSubmit} className="space-y-4">
            {error && (
              <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm">
                {error}
              </div>
            )}

            {/* Tên */}
            <div className="space-y-2">
              <Label htmlFor="quick-name">
                Tên <span className="text-red-500">*</span>
              </Label>
              <Input
                id="quick-name"
                value={name}
                onChange={(e) => {
                  setName(e.target.value);
                  setAutoGenerateSlug(true);
                }}
                placeholder="Nhập tên giá trị"
                required
                autoFocus
              />
            </div>

            {/* Slug (only for text and color types) */}
            {(attribute.type === 'text' || attribute.type === 'color') && (
              <div className="space-y-2">
                <Label htmlFor="quick-slug">Slug</Label>
                <Input
                  id="quick-slug"
                  value={slug}
                  onChange={(e) => {
                    setSlug(e.target.value);
                    setAutoGenerateSlug(false);
                  }}
                  placeholder="Tự động sinh từ tên"
                />
              </div>
            )}

            {/* Mô tả */}
            {(attribute.type === 'button' ||
              attribute.type === 'text' ||
              attribute.type === 'color') && (
              <div className="space-y-2">
                <Label htmlFor="quick-description">Mô tả</Label>
                <Textarea
                  id="quick-description"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  rows={2}
                />
              </div>
            )}

            {/* Color Picker (for color type) */}
            {attribute.type === 'color' && (
              <>
                <ColorPicker
                  label="Mã màu"
                  value={colorHex}
                  onChange={setColorHex}
                  required
                />
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      id="quick-gradient"
                      checked={hasGradient}
                      onChange={(e) => {
                        setHasGradient(e.target.checked);
                        if (!e.target.checked) {
                          setColorHex2('');
                        }
                      }}
                      className="w-4 h-4"
                    />
                    <Label htmlFor="quick-gradient" className="cursor-pointer text-sm">
                      Phối màu (Gradient)
                    </Label>
                  </div>
                  {hasGradient && (
                    <ColorPicker
                      label="Mã màu thứ 2"
                      value={colorHex2}
                      onChange={setColorHex2}
                    />
                  )}
                </div>
              </>
            )}

            {/* Image Upload (for image and button types) */}
            {(attribute.type === 'image' || attribute.type === 'button') && (
              <div className="space-y-2">
                <Label>
                  {attribute.type === 'button'
                    ? 'Ảnh minh họa'
                    : 'Upload Ảnh Swatch'}
                  <span className="text-red-500">*</span>
                </Label>
                <div className="space-y-2">
                  {imageUrl && (
                    <div className="relative w-full h-24 border rounded-lg overflow-hidden">
                      <Image
                        src={imageUrl}
                        alt={name || 'Preview'}
                        fill
                        className="object-contain"
                        sizes="(max-width: 768px) 100vw, 200px"
                      />
                    </div>
                  )}
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setShowMediaLibrary(true)}
                    className="w-full"
                  >
                    {imageUrl ? 'Thay đổi ảnh' : 'Chọn ảnh từ thư viện'}
                  </Button>
                </div>
              </div>
            )}

            <DialogFooter>
              <Button type="button" variant="outline" onClick={onClose}>
                Hủy
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Đang tạo...
                  </>
                ) : (
                  'Tạo giá trị'
                )}
              </Button>
            </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>

      {/* Media Library Modal */}
      {showMediaLibrary && (
        <MediaLibraryModal
          isOpen={showMediaLibrary}
          onClose={() => setShowMediaLibrary(false)}
          onSelect={handleImageSelect}
          mode="single"
        />
      )}
    </>
  );
}
================================================================================FILE: components/admin/products/RelatedProductsSelector.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Search, X, Plus } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';

interface Product {
  _id: string;
  name: string;
  slug: string;
  price?: string;
  image?: { sourceUrl?: string };
}

interface RelatedProductsSelectorProps {
  title: string;
  selectedProductIds: string[];
  onChange: (productIds: string[]) => void;
  placeholder?: string;
}

export function RelatedProductsSelector({
  title,
  selectedProductIds,
  onChange,
  placeholder = 'Tìm kiếm sản phẩm...',
}: RelatedProductsSelectorProps) {
  const { showToast } = useToastContext();
  const [search, setSearch] = useState('');
  const [products, setProducts] = useState<Product[]>([]);
  const [selectedProducts, setSelectedProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(false);

  // Fetch selected products
  useEffect(() => {
    if (selectedProductIds.length > 0) {
      async function fetchSelectedProducts() {
        try {
          const promises = selectedProductIds.map((id) =>
            fetch(`/api/admin/products/${id}`)
              .then((res) => res.json())
              .then((data) => data.product)
              .catch(() => null)
          );
          const results = await Promise.all(promises);
          setSelectedProducts(results.filter(Boolean));
        } catch (error) {
          console.error('Error fetching selected products:', error);
        }
      }
      fetchSelectedProducts();
    } else {
      setSelectedProducts([]);
    }
  }, [selectedProductIds]);

  // Search products
  const handleSearch = async () => {
    if (!search.trim()) return;

    setLoading(true);
    try {
      const response = await fetch(`/api/admin/products?search=${encodeURIComponent(search)}&per_page=20`);
      const data = await response.json();
      setProducts(data.products || []);
    } catch (error) {
      console.error('Error searching products:', error);
    } finally {
      setLoading(false);
    }
  };

  const addProduct = (product: Product) => {
    if (!selectedProductIds.includes(product._id)) {
      onChange([...selectedProductIds, product._id]);
      setSearch('');
      setProducts([]);
      showToast(`Đã thêm "${product.name}"`, 'success');
    } else {
      showToast('Sản phẩm đã được thêm rồi', 'info');
    }
  };

  const removeProduct = (productId: string) => {
    const product = selectedProducts.find((p) => p._id === productId);
    onChange(selectedProductIds.filter((id) => id !== productId));
    if (product) {
      showToast(`Đã xóa "${product.name}"`, 'success');
    }
  };

  return (
    <div className="space-y-3">
      <Label className="font-medium">{title}</Label>
      
      {/* Search */}
      <div className="flex gap-2">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
          <Input
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleSearch())}
            placeholder={placeholder}
            className="pl-10"
          />
        </div>
        <Button type="button" onClick={handleSearch} variant="outline" disabled={loading}>
          {loading ? 'Đang tìm...' : 'Tìm kiếm'}
        </Button>
      </div>

      {/* Search Results */}
      {products.length > 0 && (
        <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
          {products
            .filter((p) => !selectedProductIds.includes(p._id))
            .map((product) => (
              <div
                key={product._id}
                className="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer"
                onClick={() => addProduct(product)}
              >
                <div className="flex items-center gap-3 flex-1">
                  {product.image?.sourceUrl && (
                    <div className="relative w-12 h-12 rounded overflow-hidden">
                      <Image
                        src={product.image.sourceUrl}
                        alt={product.name}
                        fill
                        className="object-cover"
                        sizes="48px"
                      />
                    </div>
                  )}
                  <div className="flex-1">
                    <p className="text-sm font-medium">{product.name}</p>
                    {product.price && (
                      <p className="text-xs text-gray-500">{product.price} VNĐ</p>
                    )}
                  </div>
                </div>
                <Button type="button" variant="outline" size="sm" onClick={(e) => {
                  e.stopPropagation();
                  addProduct(product);
                }}>
                  <Plus className="w-4 h-4" />
                </Button>
              </div>
            ))}
        </div>
      )}

      {/* Selected Products */}
      {selectedProducts.length > 0 && (
        <div className="space-y-2">
          {selectedProducts.map((product) => (
            <div
              key={product._id}
              className="flex items-center justify-between p-2 border rounded-lg"
            >
              <div className="flex items-center gap-3 flex-1">
                {product.image?.sourceUrl && (
                  <img
                    src={product.image.sourceUrl}
                    alt={product.name}
                    className="w-12 h-12 object-cover rounded"
                  />
                )}
                <div className="flex-1">
                  <p className="text-sm font-medium">{product.name}</p>
                  {product.price && (
                    <p className="text-xs text-gray-500">{product.price} VNĐ</p>
                  )}
                </div>
              </div>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => removeProduct(product._id)}
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          ))}
        </div>
      )}

      {selectedProducts.length === 0 && (
        <p className="text-sm text-gray-500 text-center py-4">
          Chưa có sản phẩm nào được chọn
        </p>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/RestoreProductModal.tsx================================================================================'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { RotateCcw } from 'lucide-react';
import type { MappedProduct } from '@/lib/utils/productMapper';

interface RestoreProductModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => Promise<void>;
  product: MappedProduct | null;
}

export function RestoreProductModal({
  isOpen,
  onClose,
  onConfirm,
  product,
}: RestoreProductModalProps) {
  const [loading, setLoading] = useState(false);

  const handleConfirm = async () => {
    setLoading(true);
    try {
      await onConfirm();
      onClose();
    } catch (error) {
      console.error('Error restoring product:', error);
    } finally {
      setLoading(false);
    }
  };

  if (!product) return null;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <RotateCcw className="w-5 h-5 text-blue-600" />
            Khôi phục sản phẩm
          </DialogTitle>
          <DialogDescription>
            Bạn có chắc chắn muốn khôi phục sản phẩm này?
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="p-3 bg-gray-50 rounded-lg">
            <p className="text-sm font-medium text-gray-900">{product.name}</p>
            {product.sku && (
              <p className="text-xs text-gray-500 mt-1">SKU: {product.sku}</p>
            )}
          </div>
          <p className="text-sm text-gray-600">
            Sản phẩm sẽ được khôi phục và chuyển về trạng thái <strong>Bản nháp</strong>.
          </p>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={loading}>
            Hủy
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={loading}
            className="min-h-[44px]"
          >
            {loading ? 'Đang xử lý...' : 'Khôi phục'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

================================================================================FILE: components/admin/products/SEOMetaBox.tsx================================================================================'use client';

import { useState, useEffect, useMemo } from 'react';
import Image from 'next/image';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { CheckCircle2, AlertCircle, XCircle, Star, Package, Image as ImageIcon, Link, FileText, Code, Copy } from 'lucide-react';
import { MediaLibraryModal, type MediaItem } from './MediaLibraryModal';
import { generateProductSchema } from '@/lib/utils/schema';

export interface SEOMetaBoxData {
  focusKeyword?: string;
  seoTitle?: string;
  seoDescription?: string;
  slug?: string;
  canonicalUrl?: string;
  robotsMeta?: string;
  ogImage?: string;
  ogImageId?: string;
  socialDescription?: string;
}

interface SEOMetaBoxProps {
  data: SEOMetaBoxData;
  onChange: (data: SEOMetaBoxData) => void;
  // Product data for auto-fill and templates
  productName?: string;
  productPrice?: number;
  productSalePrice?: number;
  productSku?: string;
  productCategory?: string;
  productBrand?: string;
  productShortDescription?: string;
  productDescription?: string;
  productImage?: string;
  productStockStatus?: 'instock' | 'outofstock' | 'onbackorder';
  productStockQuantity?: number;
  productRating?: number;
  productSlug?: string;
  siteName?: string;
  // For internal links check
  hasRelatedProducts?: boolean; // Check if product has upsell/cross-sell
}

/**
 * Calculate pixel width of text (approximate)
 */
function getTextWidth(text: string): number {
  // Approximate: average character width ~6.5px for most fonts
  return text.length * 6.5;
}

/**
 * Get progress bar color based on length
 */
function getProgressColor(type: 'title' | 'description', length: number): string {
  if (type === 'title') {
    const width = getTextWidth(length.toString());
    if (width < 200) return 'bg-gray-400'; // Too short
    if (width < 400) return 'bg-orange-400'; // Good
    if (width < 580) return 'bg-green-500'; // Perfect
    return 'bg-red-500'; // Too long
  } else {
    // Description: 155-160 chars is perfect
    if (length < 100) return 'bg-gray-400'; // Too short
    if (length < 130) return 'bg-orange-400'; // Good
    if (length <= 160) return 'bg-green-500'; // Perfect
    return 'bg-red-500'; // Too long
  }
}

/**
 * Replace template variables in SEO title
 */
function replaceTemplateVariables(template: string, props: SEOMetaBoxProps): string {
  const price = props.productSalePrice || props.productPrice || 0;
  const priceFormatted = price > 0 ? `${(price / 1000).toFixed(0)}k` : '';
  
  return template
    .replace(/%title%/g, props.productName || '')
    .replace(/%price%/g, priceFormatted)
    .replace(/%sku%/g, props.productSku || '')
    .replace(/%category%/g, props.productCategory || '')
    .replace(/%brand%/g, props.productBrand || '')
    .replace(/%sitename%/g, props.siteName || 'Shop Gấu Bông');
}

/**
 * SEO Meta Box Component
 * Features:
 * - Product Snippet Preview (Google Rich Result)
 * - Focus Keyword with auto-suggest
 * - SEO Title with template variables
 * - Meta Description with fallback
 * - SEO Analysis Checklist
 * - Advanced Tab (Canonical, Robots)
 * - Social Sharing Tab (OG Image, Price)
 */
export function SEOMetaBox({
  data,
  onChange,
  productName = '',
  productPrice = 0,
  productSalePrice,
  productSku = '',
  productCategory = '',
  productBrand = '',
  productShortDescription = '',
  productDescription = '',
  productImage = '',
  productStockStatus = 'instock',
  productStockQuantity = 0,
  productRating = 5.0,
  productSlug = '',
  siteName = 'Shop Gấu Bông',
  hasRelatedProducts = false,
}: SEOMetaBoxProps) {
  const [activeTab, setActiveTab] = useState<'general' | 'advanced' | 'social' | 'schema'>('general');
  const [showMediaModal, setShowMediaModal] = useState(false);
  const [seoTitleTemplate, setSeoTitleTemplate] = useState('');
  const [slugValidation, setSlugValidation] = useState<{ isValid: boolean; message?: string } | null>(null);
  const [slugDebounceTimer, setSlugDebounceTimer] = useState<NodeJS.Timeout | null>(null);

  // Auto-suggest focus keyword from product name
  const suggestedKeyword = useMemo(() => {
    if (productName) {
      // Extract key words from product name (remove common words)
      const words = productName
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .split(/\s+/)
        .filter(w => w.length > 2 && !['the', 'and', 'or', 'for', 'with'].includes(w));
      return words.slice(0, 3).join(' ');
    }
    return '';
  }, [productName]);

  // Auto-generate SEO title from template (only when template changes)
  useEffect(() => {
    if (seoTitleTemplate && seoTitleTemplate.trim()) {
      const generated = replaceTemplateVariables(seoTitleTemplate, {
        data,
        onChange,
        productName,
        productPrice,
        productSalePrice,
        productSku,
        productCategory,
        productBrand,
        productShortDescription,
        productDescription,
        productImage,
        productStockStatus,
        productStockQuantity,
        productRating,
        productSlug,
        siteName,
      });
      if (generated && generated !== data.seoTitle) {
        onChange({ ...data, seoTitle: generated });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [seoTitleTemplate]);

  // Auto-fill meta description from short description or description (only once on mount)
  useEffect(() => {
    if (!data.seoDescription) {
      let fallback = '';
      if (productShortDescription) {
        fallback = productShortDescription.substring(0, 160);
      } else if (productDescription) {
        fallback = productDescription.substring(0, 160).replace(/<[^>]*>/g, ''); // Strip HTML
      }
      if (fallback) {
        onChange({ ...data, seoDescription: fallback });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Only run once on mount

  // Auto-generate slug from product name (only if slug is empty and productSlug is also empty)
  useEffect(() => {
    if (!data.slug && !productSlug && productName) {
      const slug = productName
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      onChange({ ...data, slug });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [productName]); // Only when productName changes

  // Validate slug real-time (debounced)
  useEffect(() => {
    if (slugDebounceTimer) {
      clearTimeout(slugDebounceTimer);
    }

    if (!data.slug || data.slug === productSlug) {
      setSlugValidation(null);
      return;
    }

    const timer = setTimeout(async () => {
      try {
        // Only validate if slug is different from current productSlug
        if (data.slug && data.slug !== productSlug) {
          const response = await fetch(
            `/api/admin/products/validate-slug?slug=${encodeURIComponent(data.slug)}&excludeId=${productSlug || ''}`,
            { credentials: 'include' } // Include credentials for authentication
          );
          
          if (!response.ok) {
            // Authentication error or other error - skip validation silently
            setSlugValidation(null);
            return;
          }
          
          const result = await response.json();
          if (result.exists) {
            setSlugValidation({ isValid: false, message: 'Slug này đã tồn tại' });
          } else {
            setSlugValidation({ isValid: true });
          }
        } else {
          setSlugValidation(null);
        }
      } catch (error) {
        console.error('Error validating slug:', error);
        setSlugValidation(null);
      }
    }, 500); // Debounce 500ms

    setSlugDebounceTimer(timer);

    return () => {
      if (slugDebounceTimer) {
        clearTimeout(slugDebounceTimer);
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [data.slug, productSlug]);

  const updateField = (field: keyof SEOMetaBoxData, value: string | undefined) => {
    onChange({ ...data, [field]: value });
  };

  // SEO Analysis Checklist
  const seoChecks = useMemo(() => {
    const checks = {
      sku: {
        status: productSku ? 'good' : 'bad',
        label: 'SKU',
        message: productSku ? 'Đã có mã SKU' : 'Chưa có mã SKU',
      },
      price: {
        status: (productPrice > 0 || productSalePrice) ? 'good' : 'bad',
        label: 'Giá bán',
        message: (productPrice > 0 || productSalePrice) ? 'Đã nhập giá' : 'Chưa nhập giá',
      },
      image: {
        status: productImage ? 'good' : 'bad',
        label: 'Ảnh đại diện',
        message: productImage ? 'Đã có ảnh' : 'Chưa có ảnh',
      },
      content: {
        status: (() => {
          const hasContent = productDescription || productShortDescription;
          if (!hasContent) return 'bad';
          // Check if content contains focus keyword
          if (data.focusKeyword) {
            const keyword = data.focusKeyword.toLowerCase();
            const desc = (productDescription || productShortDescription || '').toLowerCase();
            return desc.includes(keyword) ? 'good' : 'warning';
          }
          return hasContent ? 'good' : 'warning';
        })(),
        label: 'Nội dung',
        message: (() => {
          const hasContent = productDescription || productShortDescription;
          if (!hasContent) return 'Thiếu mô tả sản phẩm';
          if (data.focusKeyword) {
            const keyword = data.focusKeyword.toLowerCase();
            const desc = (productDescription || productShortDescription || '').toLowerCase();
            return desc.includes(keyword) 
              ? 'Mô tả có chứa từ khóa' 
              : 'Mô tả chưa chứa từ khóa chính';
          }
          return 'Đã có mô tả';
        })(),
      },
      keyword: {
        status: data.focusKeyword ? 'good' : 'warning',
        label: 'Từ khóa chính',
        message: data.focusKeyword ? 'Đã nhập từ khóa' : 'Chưa nhập từ khóa',
      },
      seoTitle: {
        status: data.seoTitle ? 'good' : 'warning',
        label: 'SEO Title',
        message: data.seoTitle ? 'Đã có tiêu đề SEO' : 'Chưa có tiêu đề SEO',
      },
      seoDescription: {
        status: data.seoDescription ? 'good' : 'warning',
        label: 'Meta Description',
        message: data.seoDescription ? 'Đã có mô tả' : 'Chưa có mô tả',
      },
      internalLinks: {
        status: hasRelatedProducts ? 'good' : 'warning',
        label: 'Internal Links',
        message: hasRelatedProducts 
          ? 'Có sản phẩm liên quan' 
          : 'Chưa có sản phẩm liên quan',
      },
    };
    return checks;
  }, [productSku, productPrice, productSalePrice, productImage, productDescription, productShortDescription, data.focusKeyword, data.seoTitle, data.seoDescription]);

  // Get current price for display
  const displayPrice = productSalePrice || productPrice || 0;
  const priceFormatted = displayPrice > 0 
    ? `${displayPrice.toLocaleString('vi-VN')}₫` 
    : 'Liên hệ';

  // Get stock status text
  const stockStatusText = productStockStatus === 'instock' 
    ? 'Còn hàng' 
    : productStockStatus === 'outofstock' 
    ? 'Hết hàng' 
    : 'Đặt hàng trước';

  // SEO Title length (pixel width)
  const seoTitleLength = data.seoTitle ? getTextWidth(data.seoTitle) : 0;
  const seoDescriptionLength = data.seoDescription?.length || 0;

  // Breadcrumb from category
  const breadcrumb = productCategory ? `Shop Gấu Bông > ${productCategory}` : 'Shop Gấu Bông';

  // Generate Product Schema (JSON-LD) for preview
  const productSchema = useMemo(() => {
    const price = productSalePrice || productPrice || 0;
    const stockStatus = productStockStatus || (productStockQuantity > 0 ? 'instock' : 'outofstock');
    const availability = stockStatus === 'instock' ? 'InStock' : 
                        stockStatus === 'outofstock' ? 'OutOfStock' : 'PreOrder';
    
    const siteUrl = typeof window !== 'undefined' 
      ? window.location.origin 
      : 'https://shop-gaubong.com';
    const productUrl = `${siteUrl}/products/${data.slug || productSlug || 'product-slug'}`;
    
    // Extract size from variations if available (from ProductDataMetaBox)
    // Note: This is a preview, actual schema is generated in backend with full variation data
    const additionalProperties: Array<{ name: string; value: string }> = [];
    
    return generateProductSchema({
      name: productName || 'Sản phẩm',
      description: data.seoDescription || productShortDescription || productDescription || null,
      image: productImage || null,
      price: price > 0 ? String(price) : null,
      currency: 'VND',
      sku: productSku || null,
      availability,
      brand: productBrand || 'Shop Gấu Bông',
      category: productCategory || 'Gấu bông',
      url: productUrl,
      additionalProperties: additionalProperties.length > 0 ? additionalProperties : undefined,
    });
  }, [
    productName,
    productSalePrice,
    productPrice,
    productStockStatus,
    productStockQuantity,
    productImage,
    productSku,
    productBrand,
    productCategory,
    data.seoDescription,
    productShortDescription,
    productDescription,
    data.slug,
    productSlug,
  ]);

  // Format JSON for display
  const schemaJson = JSON.stringify(productSchema, null, 2);

  // Copy schema to clipboard
  const handleCopySchema = async () => {
    try {
      await navigator.clipboard.writeText(schemaJson);
      alert('Đã sao chép Schema JSON-LD vào clipboard!');
    } catch (error) {
      console.error('Failed to copy schema:', error);
      alert('Không thể sao chép. Vui lòng copy thủ công.');
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Tối ưu hóa Tìm kiếm (SEO)</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* 1. Product Snippet Preview */}
        <div className="border rounded-lg p-4 bg-gray-50">
          <h3 className="text-sm font-semibold mb-3">Xem trước kết quả tìm kiếm Google</h3>
          <div className="bg-white border rounded p-4 space-y-2">
            {/* Breadcrumb */}
            <div className="text-xs text-gray-600 flex items-center gap-1">
              <span className="w-4 h-4 bg-blue-500 rounded"></span>
              {breadcrumb}
            </div>
            
            {/* Title */}
            <div>
              <a href="#" className="text-blue-600 text-lg hover:underline">
                {data.seoTitle || productName || 'Tiêu đề sản phẩm'}
              </a>
            </div>
            
            {/* Rich Data */}
            <div className="text-sm text-gray-600 space-y-1">
              <div className="flex items-center gap-4">
                <span className="flex items-center gap-1">
                  <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                  {productRating.toFixed(1)}
                </span>
                <span>Giá: <strong>{priceFormatted}</strong></span>
                <span>Tình trạng: {stockStatusText}</span>
              </div>
            </div>
            
            {/* Description */}
            <p className="text-sm text-gray-700">
              {data.seoDescription || productShortDescription || 'Mô tả sản phẩm...'}
            </p>
          </div>
        </div>

        {/* 2. Length Progress Bars */}
        <div className="space-y-3">
          <div>
            <div className="flex justify-between text-xs mb-1">
              <span>SEO Title</span>
              <span className={seoTitleLength > 580 ? 'text-red-600' : ''}>
                ~{Math.round(seoTitleLength)}px / 580px (tối ưu)
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className={`h-2 rounded-full transition-all ${getProgressColor('title', seoTitleLength)}`}
                style={{ width: `${Math.min((seoTitleLength / 580) * 100, 100)}%` }}
              />
            </div>
          </div>
          
          <div>
            <div className="flex justify-between text-xs mb-1">
              <span>Meta Description</span>
              <span className={seoDescriptionLength > 160 ? 'text-red-600' : ''}>
                {seoDescriptionLength} / 160 ký tự
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className={`h-2 rounded-full transition-all ${getProgressColor('description', seoDescriptionLength)}`}
                style={{ width: `${Math.min((seoDescriptionLength / 160) * 100, 100)}%` }}
              />
            </div>
          </div>
        </div>

        {/* 3. Tabs */}
        <div className="border-b">
          <div className="flex gap-4">
            <button
              type="button"
              onClick={() => setActiveTab('general')}
              className={`pb-2 px-1 border-b-2 transition-colors ${
                activeTab === 'general'
                  ? 'border-primary text-primary font-medium'
                  : 'border-transparent text-gray-600 hover:text-gray-900'
              }`}
            >
              Tổng quan
            </button>
            <button
              type="button"
              onClick={() => setActiveTab('advanced')}
              className={`pb-2 px-1 border-b-2 transition-colors ${
                activeTab === 'advanced'
                  ? 'border-primary text-primary font-medium'
                  : 'border-transparent text-gray-600 hover:text-gray-900'
              }`}
            >
              Nâng cao
            </button>
            <button
              type="button"
              onClick={() => setActiveTab('social')}
              className={`pb-2 px-1 border-b-2 transition-colors ${
                activeTab === 'social'
                  ? 'border-primary text-primary font-medium'
                  : 'border-transparent text-gray-600 hover:text-gray-900'
              }`}
            >
              Mạng xã hội
            </button>
            <button
              type="button"
              onClick={() => setActiveTab('schema')}
              className={`pb-2 px-1 border-b-2 transition-colors ${
                activeTab === 'schema'
                  ? 'border-primary text-primary font-medium'
                  : 'border-transparent text-gray-600 hover:text-gray-900'
              }`}
            >
              Schema Markup
            </button>
          </div>
        </div>

        {/* Tab Content */}
        {activeTab === 'general' && (
          <div className="space-y-4">
            {/* Focus Keyword */}
            <div>
              <Label htmlFor="focusKeyword">Từ khóa chính (Focus Keyword)</Label>
              <Input
                id="focusKeyword"
                value={data.focusKeyword || ''}
                onChange={(e) => updateField('focusKeyword', e.target.value)}
                placeholder={suggestedKeyword || 'Nhập từ khóa SEO...'}
              />
              {suggestedKeyword && !data.focusKeyword && (
                <p className="text-xs text-gray-500 mt-1">
                  Gợi ý: <button
                    type="button"
                    onClick={() => updateField('focusKeyword', suggestedKeyword)}
                    className="text-blue-600 hover:underline"
                  >
                    {suggestedKeyword}
                  </button>
                </p>
              )}
            </div>

            {/* SEO Title */}
            <div>
              <Label htmlFor="seoTitle">Tiêu đề SEO (SEO Title)</Label>
              <div className="space-y-2">
                <Input
                  id="seoTitle"
                  value={data.seoTitle || ''}
                  onChange={(e) => updateField('seoTitle', e.target.value)}
                  placeholder="Tiêu đề SEO..."
                />
                <div>
                  <Label htmlFor="seoTitleTemplate" className="text-xs text-gray-600">
                    Template (sử dụng: %title%, %price%, %sku%, %category%, %brand%, %sitename%)
                  </Label>
                  <Input
                    id="seoTitleTemplate"
                    value={seoTitleTemplate}
                    onChange={(e) => {
                      setSeoTitleTemplate(e.target.value);
                      if (e.target.value) {
                        const generated = replaceTemplateVariables(e.target.value, {
                          data,
                          onChange,
                          productName,
                          productPrice,
                          productSalePrice,
                          productSku,
                          productCategory,
                          productBrand,
                          productShortDescription,
                          productDescription,
                          productImage,
                          productStockStatus,
                          productStockQuantity,
                          productRating,
                          productSlug,
                          siteName,
                        });
                        updateField('seoTitle', generated);
                      }
                    }}
                    placeholder="Mua %title% Mã %sku% Giá chỉ %price% - %sitename%"
                    className="text-sm"
                  />
                </div>
              </div>
            </div>

            {/* Slug */}
            <div>
              <Label htmlFor="slug">Đường dẫn tĩnh (Slug/URL)</Label>
              <Input
                id="slug"
                value={data.slug || productSlug || ''}
                onChange={(e) => updateField('slug', e.target.value)}
                placeholder="product-slug"
                className={slugValidation && !slugValidation.isValid ? 'border-red-500' : ''}
              />
              <div className="mt-1">
                <p className="text-xs text-gray-500">
                  URL: /products/{data.slug || productSlug || 'product-slug'}
                </p>
                {slugValidation && (
                  <p className={`text-xs mt-1 ${
                    slugValidation.isValid ? 'text-green-600' : 'text-red-600'
                  }`}>
                    {slugValidation.isValid ? '✓ Slug hợp lệ' : `⚠ ${slugValidation.message}`}
                  </p>
                )}
              </div>
            </div>

            {/* Meta Description */}
            <div>
              <Label htmlFor="seoDescription">Mô tả Meta (Meta Description)</Label>
              <Textarea
                id="seoDescription"
                value={data.seoDescription || ''}
                onChange={(e) => updateField('seoDescription', e.target.value)}
                rows={3}
                placeholder="Mô tả SEO (tối đa 160 ký tự)..."
                maxLength={160}
              />
              <p className="text-xs text-gray-500 mt-1">
                Tự động lấy từ &quot;Mô tả ngắn&quot; nếu để trống
              </p>
            </div>

            {/* SEO Analysis Checklist */}
            <div className="border-t pt-4">
              <h4 className="text-sm font-semibold mb-3">Phân tích SEO</h4>
              <div className="grid grid-cols-2 gap-3">
                {Object.entries(seoChecks).map(([key, check]) => {
                  const Icon = check.status === 'good' 
                    ? CheckCircle2 
                    : check.status === 'warning' 
                    ? AlertCircle 
                    : XCircle;
                  const color = check.status === 'good' 
                    ? 'text-green-600' 
                    : check.status === 'warning' 
                    ? 'text-orange-600' 
                    : 'text-red-600';
                  
                  return (
                    <div key={key} className="flex items-center gap-2 text-sm">
                      <Icon className={`w-4 h-4 ${color}`} />
                      <span className={color}>{check.label}:</span>
                      <span className="text-gray-600">{check.message}</span>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'advanced' && (
          <div className="space-y-4">
            {/* Canonical URL */}
            <div>
              <Label htmlFor="canonicalUrl">Canonical URL</Label>
              <Input
                id="canonicalUrl"
                type="url"
                value={data.canonicalUrl || ''}
                onChange={(e) => updateField('canonicalUrl', e.target.value)}
                placeholder={`https://example.com/products/${data.slug || productSlug || 'product-slug'}`}
              />
              <p className="text-xs text-gray-500 mt-1">
                Link gốc (dùng khi sản phẩm này là biến thể copy)
              </p>
            </div>

            {/* Meta Robots */}
            <div>
              <Label htmlFor="robotsMeta">Meta Robots</Label>
              <Select
                value={data.robotsMeta || (productStockQuantity === 0 ? 'noindex, follow' : 'index, follow')}
                onValueChange={(value) => updateField('robotsMeta', value)}
              >
                <SelectTrigger id="robotsMeta">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="index, follow">Index, Follow (Mặc định)</SelectItem>
                  <SelectItem value="index, nofollow">Index, NoFollow</SelectItem>
                  <SelectItem value="noindex, follow">NoIndex, Follow</SelectItem>
                  <SelectItem value="noindex, nofollow">NoIndex, NoFollow</SelectItem>
                </SelectContent>
              </Select>
              <p className="text-xs text-gray-500 mt-1">
                {productStockQuantity === 0 && (
                  <span className="text-orange-600">
                    Gợi ý: Tự động đặt NoIndex khi hết hàng để tránh trải nghiệm xấu
                  </span>
                )}
              </p>
            </div>
          </div>
        )}

        {activeTab === 'social' && (
          <div className="space-y-4">
            {/* OG Image */}
            <div>
              <Label>Ảnh chia sẻ (Open Graph Image)</Label>
              <div className="space-y-2">
                {data.ogImage ? (
                  <div className="relative w-full max-w-md h-48 rounded border overflow-hidden">
                    <Image
                      src={data.ogImage}
                      alt="OG Image"
                      fill
                      className="object-cover"
                      sizes="(max-width: 768px) 100vw, 512px"
                    />
                    <Button
                      type="button"
                      variant="destructive"
                      size="sm"
                      onClick={() => updateField('ogImage', undefined)}
                      className="absolute top-2 right-2"
                    >
                      Xóa
                    </Button>
                  </div>
                ) : (
                  <div className="border-2 border-dashed rounded p-8 text-center">
                    <ImageIcon className="w-12 h-12 mx-auto text-gray-400 mb-2" />
                    <p className="text-sm text-gray-600 mb-2">
                      {productImage ? 'Sử dụng ảnh đại diện sản phẩm' : 'Chưa có ảnh'}
                    </p>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => setShowMediaModal(true)}
                    >
                      Upload ảnh riêng
                    </Button>
                  </div>
                )}
                {productImage && !data.ogImage && (
                  <p className="text-xs text-gray-500">
                    Mặc định: Sử dụng ảnh đại diện sản phẩm
                  </p>
                )}
              </div>
            </div>

            {/* Social Description */}
            <div>
              <Label htmlFor="socialDescription">Mô tả chia sẻ (Social Description)</Label>
              <Textarea
                id="socialDescription"
                value={data.socialDescription || ''}
                onChange={(e) => updateField('socialDescription', e.target.value)}
                rows={3}
                placeholder={`Đang giảm giá chỉ còn ${priceFormatted}! ${productShortDescription || ''}`}
              />
              <p className="text-xs text-gray-500 mt-1">
                Tự động chèn giá vào mô tả khi chia sẻ
              </p>
            </div>
          </div>
        )}

        {activeTab === 'schema' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <h4 className="text-sm font-semibold mb-1">Schema Markup (JSON-LD)</h4>
                <p className="text-xs text-gray-500">
                  Schema này được tự động generate và lưu vào database khi bạn lưu sản phẩm.
                  Google sẽ sử dụng schema này để hiển thị Rich Results với giá và tình trạng kho.
                </p>
              </div>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleCopySchema}
                className="flex items-center gap-2"
              >
                <Copy className="w-4 h-4" />
                Sao chép
              </Button>
            </div>

            <div className="border rounded-lg bg-gray-50 p-4">
              <div className="bg-white rounded border p-4 overflow-x-auto">
                <pre className="text-xs font-mono text-gray-800 whitespace-pre-wrap break-words">
                  {schemaJson}
                </pre>
              </div>
            </div>

            <div className="border-t pt-4 space-y-2">
              <h5 className="text-sm font-semibold flex items-center gap-2">
                <Code className="w-4 h-4" />
                Mapping Dữ liệu
              </h5>
              <div className="text-xs text-gray-600 space-y-1">
                <p><strong>name:</strong> Tên sản phẩm</p>
                <p><strong>description:</strong> Meta Description / Mô tả ngắn</p>
                <p><strong>sku:</strong> Mã SKU từ tab Kiểm kê kho hàng</p>
                <p><strong>image:</strong> Ảnh đại diện sản phẩm</p>
                <p><strong>brand:</strong> Thương hiệu (mặc định: Shop Gấu Bông)</p>
                <p><strong>category:</strong> Danh mục sản phẩm</p>
                <p><strong>offers.price:</strong> Giá bán / Giá Sale từ tab Dữ liệu sản phẩm</p>
                <p><strong>offers.availability:</strong> Tình trạng kho (InStock/OutOfStock)</p>
                {(productSchema as any).additionalProperty && (
                  <p><strong>additionalProperty:</strong> Size từ biến thể (nếu có)</p>
                )}
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <p className="text-xs text-blue-800">
                <strong>Lưu ý:</strong> Schema này được tự động generate ở backend khi lưu sản phẩm.
                Bạn không cần chỉnh sửa thủ công. Schema sẽ được inject vào HTML của trang sản phẩm
                dưới dạng JSON-LD để Google có thể đọc và hiển thị Rich Results.
              </p>
            </div>
          </div>
        )}
      </CardContent>

      {/* Media Library Modal for OG Image */}
      <MediaLibraryModal
        isOpen={showMediaModal}
        onClose={() => setShowMediaModal(false)}
        onSelect={(items) => {
          const item = Array.isArray(items) ? items[0] : items;
          updateField('ogImage', item.thumbnail_url || item.url);
          updateField('ogImageId', item.id);
          setShowMediaModal(false);
        }}
        mode="single"
        buttonText="Chọn ảnh chia sẻ"
      />
    </Card>
  );
}
================================================================================FILE: components/admin/products/SEOSection.tsx================================================================================'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Plus, X } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';

interface SEOData {
  seoTitle?: string;
  seoDescription?: string;
  seoKeywords?: string[];
  ogImage?: string;
  canonicalUrl?: string;
  robotsMeta?: string;
}

interface SEOSectionProps {
  data: SEOData;
  onChange: (data: SEOData) => void;
  productName?: string; // Để suggest SEO title
  productSlug?: string; // Để suggest canonical URL
}

export function SEOSection({ data, onChange, productName, productSlug }: SEOSectionProps) {
  const { showToast } = useToastContext();
  const [keywordInput, setKeywordInput] = useState('');

  const updateField = (field: keyof SEOData, value: string | string[]) => {
    onChange({ ...data, [field]: value });
  };

  const addKeyword = () => {
    if (!keywordInput.trim()) {
      showToast('Vui lòng nhập keyword', 'error');
      return;
    }
    if (data.seoKeywords?.includes(keywordInput.trim())) {
      showToast('Keyword đã tồn tại', 'info');
      return;
    }
    updateField('seoKeywords', [...(data.seoKeywords || []), keywordInput.trim()]);
    showToast(`Đã thêm keyword "${keywordInput.trim()}"`, 'success');
    setKeywordInput('');
  };

  const removeKeyword = (keyword: string) => {
    updateField('seoKeywords', data.seoKeywords?.filter((k) => k !== keyword) || []);
    showToast(`Đã xóa keyword "${keyword}"`, 'success');
  };

  // Auto-suggest SEO title từ product name
  const suggestedTitle = productName 
    ? `${productName} | Shop Gấu Bông`
    : '';

  // Auto-suggest canonical URL từ slug
  const suggestedCanonical = productSlug
    ? `${typeof window !== 'undefined' ? window.location.origin : ''}/products/${productSlug}`
    : '';

  return (
    <Card>
      <CardHeader>
        <CardTitle>SEO & Meta Tags</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <Label htmlFor="seoTitle">SEO Title (Meta Title)</Label>
          <Input
            id="seoTitle"
            value={data.seoTitle || ''}
            onChange={(e) => updateField('seoTitle', e.target.value)}
            placeholder={suggestedTitle || 'Tiêu đề SEO (tối đa 60 ký tự)'}
            maxLength={60}
          />
          <p className="text-xs text-gray-500 mt-1">
            {data.seoTitle?.length || 0}/60 ký tự
            {suggestedTitle && !data.seoTitle && (
              <button
                type="button"
                onClick={() => updateField('seoTitle', suggestedTitle)}
                className="ml-2 text-blue-600 hover:underline"
              >
                Sử dụng gợi ý
              </button>
            )}
          </p>
        </div>

        <div>
          <Label htmlFor="seoDescription">SEO Description (Meta Description)</Label>
          <Textarea
            id="seoDescription"
            value={data.seoDescription || ''}
            onChange={(e) => updateField('seoDescription', e.target.value)}
            rows={3}
            placeholder="Mô tả SEO (tối đa 160 ký tự)"
            maxLength={160}
          />
          <p className="text-xs text-gray-500 mt-1">
            {data.seoDescription?.length || 0}/160 ký tự
          </p>
        </div>

        <div>
          <Label htmlFor="seoKeywords">SEO Keywords</Label>
          <div className="flex gap-2 mb-2">
            <Input
              id="seoKeywords"
              value={keywordInput}
              onChange={(e) => setKeywordInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addKeyword())}
              placeholder="Nhập keyword và nhấn Enter"
            />
            <Button type="button" onClick={addKeyword} variant="outline">
              <Plus className="w-4 h-4 mr-2" />
              Thêm
            </Button>
          </div>
          {data.seoKeywords && data.seoKeywords.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {data.seoKeywords.map((keyword) => (
                <span
                  key={keyword}
                  className="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-sm"
                >
                  {keyword}
                  <button
                    type="button"
                    onClick={() => removeKeyword(keyword)}
                    className="hover:text-red-600"
                  >
                    <X className="w-3 h-3" />
                  </button>
                </span>
              ))}
            </div>
          )}
        </div>

        <div>
          <Label htmlFor="ogImage">Open Graph Image</Label>
          <Input
            id="ogImage"
            type="url"
            value={data.ogImage || ''}
            onChange={(e) => updateField('ogImage', e.target.value)}
            placeholder="https://example.com/og-image.jpg"
          />
          <p className="text-xs text-gray-500 mt-1">
            Hình ảnh hiển thị khi chia sẻ lên Facebook, Zalo (khuyến nghị: 1200x630px)
          </p>
        </div>

        <div>
          <Label htmlFor="canonicalUrl">Canonical URL</Label>
          <Input
            id="canonicalUrl"
            type="url"
            value={data.canonicalUrl || ''}
            onChange={(e) => updateField('canonicalUrl', e.target.value)}
            placeholder={suggestedCanonical || 'https://example.com/products/product-slug'}
          />
          <p className="text-xs text-gray-500 mt-1">
            URL chính thức của trang (để tránh duplicate content)
            {suggestedCanonical && !data.canonicalUrl && (
              <button
                type="button"
                onClick={() => updateField('canonicalUrl', suggestedCanonical)}
                className="ml-2 text-blue-600 hover:underline"
              >
                Sử dụng gợi ý
              </button>
            )}
          </p>
        </div>

        <div>
          <Label htmlFor="robotsMeta">Robots Meta Tag</Label>
          <select
            id="robotsMeta"
            value={data.robotsMeta || 'index, follow'}
            onChange={(e) => updateField('robotsMeta', e.target.value)}
            className="w-full border rounded px-3 py-2"
          >
            <option value="index, follow">Index, Follow (Mặc định)</option>
            <option value="index, nofollow">Index, NoFollow</option>
            <option value="noindex, follow">NoIndex, Follow</option>
            <option value="noindex, nofollow">NoIndex, NoFollow</option>
          </select>
          <p className="text-xs text-gray-500 mt-1">
            Hướng dẫn công cụ tìm kiếm cách index trang này
          </p>
        </div>
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/ShortDescriptionEditor.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Link from '@tiptap/extension-link';
import Placeholder from '@tiptap/extension-placeholder';
import { Button } from '@/components/ui/button';
import {
  Bold,
  Italic,
  List,
  ListOrdered,
  Link as LinkIcon,
  Palette,
  Sparkles,
} from 'lucide-react';

interface ShortDescriptionEditorProps {
  value: string;
  onChange: (html: string) => void;
  placeholder?: string;
}

/**
 * Mini Editor for Product Short Description
 * Features:
 * - Minimal toolbar (Bulleted/Numbered List, Bold/Italic, Text Color, Link)
 * - Low height (150-200px)
 * - Template button for "Shop Gấu Bông" template
 */
export function ShortDescriptionEditor({
  value,
  onChange,
  placeholder = 'Mô tả ngắn gọn về sản phẩm (hiển thị trong danh sách sản phẩm)...',
}: ShortDescriptionEditorProps) {
  const [textContent, setTextContent] = useState(value);

  // Initialize Tiptap editor with minimal extensions
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        heading: false, // Disable headings
        blockquote: false, // Disable blockquote
      }),
      Link.configure({
        openOnClick: false,
        HTMLAttributes: {
          class: 'text-primary underline',
          target: '_blank',
          rel: 'noopener noreferrer',
        },
      }),
      Placeholder.configure({
        placeholder,
      }),
    ],
    content: value || '',
    immediatelyRender: false,
    onUpdate: ({ editor }) => {
      const html = editor.getHTML();
      if (html !== textContent) {
        setTextContent(html);
        onChange(html);
      }
    },
    editorProps: {
      attributes: {
        class: 'prose prose-sm max-w-none focus:outline-none min-h-[150px] max-h-[200px] p-3 border border-input rounded-b overflow-y-auto',
      },
    },
  });

  // Sync content when value prop changes
  useEffect(() => {
    if (!editor || value === undefined) return;
    const currentHtml = editor.getHTML();
    if (value !== currentHtml) {
      editor.commands.setContent(value || '');
      setTextContent(value || '');
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [value]);

  const addLink = () => {
    const url = prompt('Nhập URL:');
    if (!url) return;

    try {
      new URL(url);
    } catch {
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        const fullUrl = `http://${url}`;
        try {
          new URL(fullUrl);
        } catch {
          alert('URL không hợp lệ');
          return;
        }
      } else {
        alert('URL không hợp lệ');
        return;
      }
    }

    if (editor) {
      const selectedText = editor.state.doc.textBetween(
        editor.state.selection.from,
        editor.state.selection.to
      );
      if (selectedText) {
        editor.chain().focus().setLink({ href: url }).run();
      } else {
        editor.chain().focus().insertContent(`<a href="${url}">${url}</a>`).run();
      }
    }
  };

  const changeTextColor = () => {
    const color = prompt('Nhập mã màu (VD: #FF0000):');
    if (!color) return;

    const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
    if (!colorRegex.test(color) && !['red', 'blue', 'green', 'black', 'white'].includes(color.toLowerCase())) {
      alert('Mã màu không hợp lệ. Sử dụng format #RRGGBB hoặc tên màu.');
      return;
    }

    if (editor) {
      const { from, to } = editor.state.selection;
      const selectedText = editor.state.doc.textBetween(from, to);
      if (selectedText) {
        editor.chain().focus().deleteSelection().insertContent(`<span style="color: ${color};">${selectedText}</span>`).run();
      } else {
        editor.chain().focus().insertContent(`<span style="color: ${color};">text</span>`).run();
      }
    }
  };

  const insertTemplate = () => {
    const template = `<ul>
    <li>✅ <b>Chất liệu:</b> Bông PP 3D tinh khiết, đàn hồi đa chiều.</li>
    <li>✅ <b>Vỏ gấu:</b> Nhung mịn cao cấp, không rụng lông.</li>
    <li>🎁 <b>Tặng kèm:</b> Thiệp chúc mừng + Gói quà miễn phí.</li>
    <li>⚡ <b>Bảo hành:</b> Đường chỉ trọn đời.</li>
    <li>🚚 <b>Giao hàng:</b> Hỏa tốc 2H nội thành.</li>
</ul>`;

    if (editor) {
      editor.chain().focus().insertContent(template).run();
      const newHtml = editor.getHTML();
      setTextContent(newHtml);
      onChange(newHtml);
    }
  };

  if (!editor) {
    return (
      <div className="border border-input rounded-lg p-8 text-center">
        <div className="text-muted-foreground">Đang tải editor...</div>
      </div>
    );
  }

  return (
    <div className="border border-input rounded-lg overflow-hidden">
      {/* Minimal Toolbar */}
      <div className="bg-muted border-b border-input flex items-center gap-1 p-2">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => editor.chain().focus().toggleBold().run()}
          className={editor.isActive('bold') ? 'bg-background' : ''}
          title="In đậm (Ctrl+B)"
        >
          <Bold className="h-4 w-4" />
        </Button>
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => editor.chain().focus().toggleItalic().run()}
          className={editor.isActive('italic') ? 'bg-background' : ''}
          title="In nghiêng (Ctrl+I)"
        >
          <Italic className="h-4 w-4" />
        </Button>

        <div className="h-6 w-px bg-border mx-1" />

        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => editor.chain().focus().toggleBulletList().run()}
          className={editor.isActive('bulletList') ? 'bg-background' : ''}
          title="Danh sách không thứ tự"
        >
          <List className="h-4 w-4" />
        </Button>
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => editor.chain().focus().toggleOrderedList().run()}
          className={editor.isActive('orderedList') ? 'bg-background' : ''}
          title="Danh sách có thứ tự"
        >
          <ListOrdered className="h-4 w-4" />
        </Button>

        <div className="h-6 w-px bg-border mx-1" />

        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={changeTextColor}
          title="Màu chữ"
        >
          <Palette className="h-4 w-4" />
        </Button>

        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={addLink}
          title="Chèn/Sửa liên kết"
        >
          <LinkIcon className="h-4 w-4" />
        </Button>

        <div className="flex-1" />

        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={insertTemplate}
          className="flex items-center gap-1"
          title="Chèn mẫu Gấu Bông"
        >
          <Sparkles className="h-4 w-4" />
          Chèn mẫu Gấu Bông
        </Button>
      </div>

      {/* Editor Content */}
      <EditorContent editor={editor} />
    </div>
  );
}
================================================================================FILE: components/admin/products/sidebar/CategoriesBox.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { Search, Folder, Plus, X, Check, Star } from 'lucide-react';
import { useCategories } from '@/lib/hooks/useCategories';
import { useToastContext } from '@/components/providers/ToastProvider';
import { AddSubCategoryModal } from '@/components/admin/AddSubCategoryModal';
import { generateSlug } from '@/lib/utils/slug';
import type { MappedCategory } from '@/lib/utils/productMapper';

interface CategoriesBoxProps {
  categories?: MappedCategory[]; // Optional: if not provided, will fetch using useCategories
  selectedCategories: string[]; // Array of category IDs
  primaryCategory?: string; // Primary category ID
  onCategoriesChange: (categoryIds: string[]) => void;
  onPrimaryCategoryChange?: (categoryId: string | null) => void;
  onAddNew?: () => void; // Optional: Quick add category
}

/**
 * Categories Box - Sidebar component cho category selection
 * Features:
 * - Tabs: All Categories / Most Used
 * - Multi-select categories với hierarchy tree
 * - Primary Category selection
 * - Search/filter categories (debounced)
 * - Inline Add Category form
 */
export function CategoriesBox({
  categories: propCategories,
  selectedCategories,
  primaryCategory,
  onCategoriesChange,
  onPrimaryCategoryChange,
  onAddNew,
}: CategoriesBoxProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [debouncedSearch, setDebouncedSearch] = useState('');
  const [activeTab, setActiveTab] = useState<'all' | 'most-used'>('all');
  const [showAddForm, setShowAddForm] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategorySlug, setNewCategorySlug] = useState('');
  const [addingCategory, setAddingCategory] = useState(false);
  const [addSubCategoryModal, setAddSubCategoryModal] = useState<{
    isOpen: boolean;
    parentId: string;
    parentName: string;
  }>({ isOpen: false, parentId: '', parentName: '' });

  const { showToast } = useToastContext();
  
  // Fetch categories if not provided
  const { categories: fetchedCategories, isLoading } = useCategories({
    type: 'tree',
    status: 'active',
    enabled: !propCategories,
  });

  const categories = propCategories || fetchedCategories;

  // Debounce search query
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearch(searchQuery);
    }, 300);
    return () => clearTimeout(timer);
  }, [searchQuery]);

  // Get most used categories (sorted by count)
  const mostUsedCategories = useMemo(() => {
    return [...categories]
      .filter(cat => (cat.count || 0) > 0)
      .sort((a, b) => (b.count || 0) - (a.count || 0))
      .slice(0, 10); // Top 10
  }, [categories]);

  // Filter categories based on search
  const filteredCategories = useMemo(() => {
    const sourceCategories = activeTab === 'most-used' ? mostUsedCategories : categories;
    if (!debouncedSearch.trim()) {
      return sourceCategories;
    }
    const query = debouncedSearch.toLowerCase();
    return sourceCategories.filter(
      (cat) =>
        cat.name.toLowerCase().includes(query) ||
        cat.slug.toLowerCase().includes(query)
    );
  }, [categories, mostUsedCategories, debouncedSearch, activeTab]);

  // Categories are already in tree structure from API (type: 'tree')
  // If using flat list, we need to build tree structure
  // For now, we'll use the tree structure directly from API

  const toggleCategory = (categoryId: string) => {
    if (selectedCategories.includes(categoryId)) {
      onCategoriesChange(selectedCategories.filter((id) => id !== categoryId));
      if (onPrimaryCategoryChange && primaryCategory === categoryId) {
        onPrimaryCategoryChange(null);
      }
    } else {
      onCategoriesChange([...selectedCategories, categoryId]);
    }
  };

  const setPrimaryCategory = (categoryId: string) => {
    if (onPrimaryCategoryChange) {
      if (primaryCategory === categoryId) {
        onPrimaryCategoryChange(null);
      } else {
        onPrimaryCategoryChange(categoryId);
        // Auto-select if not already selected
        if (!selectedCategories.includes(categoryId)) {
          onCategoriesChange([...selectedCategories, categoryId]);
        }
      }
    }
  };

  const isSelected = (categoryId: string) => {
    return selectedCategories.includes(categoryId);
  };

  const isPrimary = (categoryId: string) => {
    return primaryCategory === categoryId;
  };

  const handleAddCategory = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newCategoryName.trim()) {
      showToast('Vui lòng nhập tên danh mục', 'error');
      return;
    }

    setAddingCategory(true);
    try {
      const response = await fetch('/api/admin/categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: newCategoryName.trim(),
          slug: newCategorySlug.trim() || generateSlug(newCategoryName),
          status: 'active',
          position: 0,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Có lỗi xảy ra');
      }

      const data = await response.json();
      const newCategory = data.category;

      // Auto-select new category
      onCategoriesChange([...selectedCategories, newCategory.id]);
      if (onPrimaryCategoryChange) {
        onPrimaryCategoryChange(newCategory.id);
      }

      // Reset form
      setNewCategoryName('');
      setNewCategorySlug('');
      setShowAddForm(false);
      showToast('Đã thêm danh mục mới', 'success');
    } catch (error) {
      console.error('Error adding category:', error);
      showToast(error instanceof Error ? error.message : 'Có lỗi xảy ra khi thêm danh mục', 'error');
    } finally {
      setAddingCategory(false);
    }
  };

  const handleNameChange = (value: string) => {
    setNewCategoryName(value);
    if (!newCategorySlug || newCategorySlug === generateSlug(newCategoryName)) {
      setNewCategorySlug(generateSlug(value));
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center gap-2">
          <Folder className="h-4 w-4" />
          Danh mục
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Tabs */}
        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'all' | 'most-used')}>
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="all">Tất cả</TabsTrigger>
            <TabsTrigger value="most-used">
              <Star className="w-3 h-3 mr-1" />
              Thường dùng
            </TabsTrigger>
          </TabsList>

          <TabsContent value={activeTab} className="mt-4">
            {/* Search Input */}
            <div className="relative mb-4">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                type="text"
                placeholder="Tìm kiếm danh mục..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9"
              />
            </div>

            {/* Categories List */}
            {isLoading ? (
              <p className="text-sm text-muted-foreground text-center py-4">Đang tải...</p>
            ) : filteredCategories.length === 0 ? (
              <p className="text-sm text-muted-foreground text-center py-4">
                {debouncedSearch ? 'Không tìm thấy danh mục' : 'Chưa có danh mục'}
              </p>
            ) : (
              <div className="space-y-2 max-h-[300px] overflow-y-auto">
                {filteredCategories.map((category) => (
                  <CategoryItem
                    key={category.id}
                    category={category}
                    isSelected={isSelected(category.id)}
                    isPrimary={isPrimary(category.id)}
                    onToggle={toggleCategory}
                    onSetPrimary={onPrimaryCategoryChange ? () => setPrimaryCategory(category.id) : undefined}
                    selectedCategories={selectedCategories}
                    onToggleCategory={toggleCategory}
                    onAddSubCategory={(parentId, parentName) => {
                      setAddSubCategoryModal({ isOpen: true, parentId, parentName });
                    }}
                  />
                ))}
              </div>
            )}
          </TabsContent>
        </Tabs>

        {/* Inline Add Category Form */}
        {showAddForm ? (
          <form onSubmit={handleAddCategory} className="space-y-2 p-3 border rounded-lg bg-muted/50">
            <Input
              placeholder="Tên danh mục *"
              value={newCategoryName}
              onChange={(e) => handleNameChange(e.target.value)}
              required
              autoFocus
            />
            <Input
              placeholder="Slug"
              value={newCategorySlug}
              onChange={(e) => setNewCategorySlug(e.target.value)}
            />
            <div className="flex gap-2">
              <Button
                type="submit"
                size="sm"
                disabled={addingCategory || !newCategoryName.trim()}
                className="flex-1"
              >
                {addingCategory ? 'Đang thêm...' : 'Thêm'}
              </Button>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => {
                  setShowAddForm(false);
                  setNewCategoryName('');
                  setNewCategorySlug('');
                }}
                disabled={addingCategory}
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          </form>
        ) : (
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setShowAddForm(true)}
            className="w-full"
          >
            <Plus className="h-4 w-4 mr-2" />
            Thêm danh mục mới
          </Button>
        )}

        {/* Selected Count & Primary */}
        {selectedCategories.length > 0 && (
          <div className="text-xs text-muted-foreground space-y-1">
            <p>Đã chọn: {selectedCategories.length} danh mục</p>
            {primaryCategory && (
              <p className="text-primary font-medium">
                Danh mục chính: {categories.find(c => c.id === primaryCategory)?.name || 'N/A'}
              </p>
            )}
          </div>
        )}

        {/* Add Sub-category Modal */}
        <AddSubCategoryModal
          isOpen={addSubCategoryModal.isOpen}
          onClose={() => setAddSubCategoryModal({ isOpen: false, parentId: '', parentName: '' })}
          parentId={addSubCategoryModal.parentId}
          parentName={addSubCategoryModal.parentName}
          onSuccess={() => {
            setAddSubCategoryModal({ isOpen: false, parentId: '', parentName: '' });
            showToast('Đã thêm danh mục con', 'success');
            // Refresh categories if using hook
            if (!propCategories) {
              // React Query will auto-refetch
            }
          }}
        />
      </CardContent>
    </Card>
  );
}

interface CategoryItemProps {
  category: MappedCategory;
  isSelected: boolean;
  isPrimary?: boolean;
  onToggle: (categoryId: string) => void;
  onSetPrimary?: () => void;
  children?: MappedCategory[];
  selectedCategories: string[];
  onToggleCategory: (categoryId: string) => void;
  onAddSubCategory?: (parentId: string, parentName: string) => void;
}

function CategoryItem({
  category,
  isSelected,
  isPrimary = false,
  onToggle,
  onSetPrimary,
  children = [],
  selectedCategories,
  onToggleCategory,
  onAddSubCategory,
}: CategoryItemProps) {
  const hasChildren = children && children.length > 0;
  const [isExpanded, setIsExpanded] = useState(true);

  // Build tree from flat list (if category has children property from tree API)
  const categoryChildren = (category as any).children || children;

  return (
    <div>
      <div className="flex items-center gap-2 py-1">
        {/* Expand/Collapse Button */}
        {categoryChildren.length > 0 && (
          <button
            type="button"
            onClick={() => setIsExpanded(!isExpanded)}
            className="p-0.5 hover:bg-muted rounded min-w-[20px]"
          >
            <span className="text-xs">{isExpanded ? '−' : '+'}</span>
          </button>
        )}
        {categoryChildren.length === 0 && <div className="w-5" />}

        {/* Checkbox */}
        <button
          type="button"
          onClick={() => onToggle(category.id)}
          className="flex items-center gap-2 flex-1 text-left hover:bg-muted rounded px-2 py-1.5 transition-colors min-h-[44px]"
        >
          <div
            className={`flex items-center justify-center w-4 h-4 border-2 rounded flex-shrink-0 ${
              isSelected
                ? 'bg-primary border-primary'
                : 'border-input hover:border-primary'
            }`}
          >
            {isSelected && <Check className="h-3 w-3 text-primary-foreground" />}
          </div>
          <span className={`text-sm flex-1 ${isPrimary ? 'font-semibold text-primary' : ''}`}>
            {category.name}
            {isPrimary && <Star className="w-3 h-3 inline ml-1 text-primary" />}
          </span>
          {category.count !== null && (
            <span className="text-xs text-muted-foreground">
              ({category.count})
            </span>
          )}
        </button>

        {/* Primary Category Button */}
        {onSetPrimary && (
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              onSetPrimary();
            }}
            className={`p-1 rounded hover:bg-muted ${isPrimary ? 'text-primary' : 'text-muted-foreground'}`}
            title={isPrimary ? 'Bỏ đánh dấu danh mục chính' : 'Đặt làm danh mục chính'}
          >
            <Star className={`w-4 h-4 ${isPrimary ? 'fill-current' : ''}`} />
          </button>
        )}

        {/* Add Sub-category Button */}
        {onAddSubCategory && (
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              onAddSubCategory(category.id, category.name);
            }}
            className="p-1 rounded hover:bg-muted text-muted-foreground"
            title="Thêm danh mục con"
          >
            <Plus className="w-4 h-4" />
          </button>
        )}
      </div>

      {/* Children Categories */}
      {categoryChildren.length > 0 && isExpanded && (
        <div className="ml-6 space-y-1">
          {categoryChildren.map((child: MappedCategory) => (
            <CategoryItem
              key={child.id}
              category={child}
              isSelected={selectedCategories.includes(child.id)}
              isPrimary={false}
              onToggle={onToggleCategory}
              onSetPrimary={onSetPrimary}
              selectedCategories={selectedCategories}
              onToggleCategory={onToggleCategory}
              onAddSubCategory={onAddSubCategory}
            />
          ))}
        </div>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/sidebar/FeaturedImageBox.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Image as ImageIcon } from 'lucide-react';
import { MediaPicker } from '@/components/admin/media/MediaPicker';
import type { MediaPickerValue } from '@/components/admin/media/MediaPicker';

interface FeaturedImageBoxProps {
  thumbnailId?: string; // Attachment ID
  thumbnailUrl?: string; // Thumbnail URL for display
  altText?: string; // Alt text for SEO
  onImageChange: (attachmentId: string, thumbnailUrl: string) => void;
  onImageRemove: () => void;
  onAltTextChange?: (altText: string) => void; // Callback for alt text changes
}

/**
 * Featured Image Box - Sidebar component cho featured image management
 * Features:
 * - 2 states: Empty / Has image
 * - Uses MediaPicker for media selection
 * - Save attachment_id to hidden input _thumbnail_id
 * - Remove button
 * - Thumbnail display (260px width)
 */
export function FeaturedImageBox({
  thumbnailId,
  thumbnailUrl,
  altText = '',
  onImageChange,
  onImageRemove,
  onAltTextChange,
}: FeaturedImageBoxProps) {
  const [mediaValue, setMediaValue] = useState<MediaPickerValue | undefined>();

  // Sync with props
  useEffect(() => {
    if (thumbnailId && thumbnailUrl) {
      setMediaValue({
        _id: thumbnailId,
        url: thumbnailUrl,
        name: 'Featured Image',
        type: 'image',
        thumbnail_url: thumbnailUrl,
      });
    } else {
      setMediaValue(undefined);
    }
  }, [thumbnailId, thumbnailUrl]);

  const handleChange = (value: MediaPickerValue | MediaPickerValue[] | undefined) => {
    if (!value) {
      setMediaValue(undefined);
      onImageRemove();
      return;
    }

    const selected = Array.isArray(value) ? value[0] : value;
    setMediaValue(selected);
    onImageChange(selected._id, selected.thumbnail_url || selected.url);
  };

  const hasImage = !!mediaValue;

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center gap-2">
          <ImageIcon className="h-4 w-4" />
          Hình ảnh đại diện
        </CardTitle>
      </CardHeader>
      <CardContent>
        {/* Hidden input for _thumbnail_id */}
        <input
          type="hidden"
          name="_thumbnail_id"
          value={thumbnailId || ''}
        />

        {/* MediaPicker */}
        <MediaPicker
          value={mediaValue}
          onChange={handleChange}
          multiple={false}
          type="image"
        />

        {/* Alt Text Input - Only show when image is selected */}
        {thumbnailId && (
          <div className="mt-4 space-y-2">
            <Label htmlFor="featured-image-alt" className="text-xs font-medium">
              Văn bản thay thế (Alt Text) cho SEO
            </Label>
            <Input
              id="featured-image-alt"
              type="text"
              placeholder="Mô tả hình ảnh cho SEO (ví dụ: Gấu bông Teddy màu nâu)"
              value={altText}
              onChange={(e) => onAltTextChange?.(e.target.value)}
              className="text-sm"
            />
            <p className="text-xs text-muted-foreground">
              Alt text giúp cải thiện SEO và khả năng tiếp cận cho người dùng khiếm thị
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
================================================================================FILE: components/admin/products/sidebar/ProductDataBox.tsx================================================================================'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Package, Box } from 'lucide-react';

interface ProductDataBoxProps {
  sku: string;
  stockStatus?: 'instock' | 'outofstock' | 'onbackorder';
  stockQuantity?: number;
  length?: number;
  width?: number;
  height?: number;
  weight?: number;
  onSkuChange: (sku: string) => void;
  onStockStatusChange?: (status: 'instock' | 'outofstock' | 'onbackorder') => void;
  onStockQuantityChange?: (quantity: number) => void;
  onLengthChange?: (length: number | undefined) => void;
  onWidthChange?: (width: number | undefined) => void;
  onHeightChange?: (height: number | undefined) => void;
  onWeightChange?: (weight: number | undefined) => void;
}

/**
 * Product Data Box - Sidebar component cho product data management
 * Features:
 * - SKU input
 * - Stock status selector
 * - Stock quantity input
 * - Dimensions (Length, Width, Height)
 * - Weight input
 */
export function ProductDataBox({
  sku,
  stockStatus = 'instock',
  stockQuantity,
  length,
  width,
  height,
  weight,
  onSkuChange,
  onStockStatusChange,
  onStockQuantityChange,
  onLengthChange,
  onWidthChange,
  onHeightChange,
  onWeightChange,
}: ProductDataBoxProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center gap-2">
          <Package className="h-4 w-4" />
          Dữ liệu sản phẩm
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* SKU */}
        <div className="space-y-2">
          <Label htmlFor="sidebar-sku">SKU</Label>
          <Input
            id="sidebar-sku"
            type="text"
            placeholder="VD: PROD-001"
            value={sku}
            onChange={(e) => onSkuChange(e.target.value)}
          />
        </div>

        {/* Stock Status */}
        {onStockStatusChange && (
          <div className="space-y-2">
            <Label htmlFor="sidebar-stock-status">Trạng thái tồn kho</Label>
            <Select
              value={stockStatus}
              onValueChange={(value) =>
                onStockStatusChange(
                  value as 'instock' | 'outofstock' | 'onbackorder'
                )
              }
            >
              <SelectTrigger id="sidebar-stock-status">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="instock">Còn hàng</SelectItem>
                <SelectItem value="outofstock">Hết hàng</SelectItem>
                <SelectItem value="onbackorder">Đặt hàng trước</SelectItem>
              </SelectContent>
            </Select>
          </div>
        )}

        {/* Stock Quantity */}
        {onStockQuantityChange && (
          <div className="space-y-2">
            <Label htmlFor="sidebar-stock-quantity">Số lượng tồn kho</Label>
            <Input
              id="sidebar-stock-quantity"
              type="number"
              min="0"
              placeholder="0"
              value={stockQuantity || ''}
              onChange={(e) =>
                onStockQuantityChange(parseInt(e.target.value) || 0)
              }
            />
          </div>
        )}

        {/* Dimensions */}
        {(onLengthChange || onWidthChange || onHeightChange) && (
          <div className="space-y-3 pt-2 border-t">
            <Label className="text-sm font-semibold flex items-center gap-2">
              <Box className="h-4 w-4" />
              Kích thước (cm)
            </Label>
            <div className="grid grid-cols-3 gap-2">
              {onLengthChange && (
                <div className="space-y-1">
                  <Label htmlFor="sidebar-length" className="text-xs">
                    Dài
                  </Label>
                  <Input
                    id="sidebar-length"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="0"
                    value={length || ''}
                    onChange={(e) =>
                      onLengthChange(
                        e.target.value ? parseFloat(e.target.value) : undefined
                      )
                    }
                  />
                </div>
              )}
              {onWidthChange && (
                <div className="space-y-1">
                  <Label htmlFor="sidebar-width" className="text-xs">
                    Rộng
                  </Label>
                  <Input
                    id="sidebar-width"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="0"
                    value={width || ''}
                    onChange={(e) =>
                      onWidthChange(
                        e.target.value ? parseFloat(e.target.value) : undefined
                      )
                    }
                  />
                </div>
              )}
              {onHeightChange && (
                <div className="space-y-1">
                  <Label htmlFor="sidebar-height" className="text-xs">
                    Cao
                  </Label>
                  <Input
                    id="sidebar-height"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="0"
                    value={height || ''}
                    onChange={(e) =>
                      onHeightChange(
                        e.target.value ? parseFloat(e.target.value) : undefined
                      )
                    }
                  />
                </div>
              )}
            </div>
          </div>
        )}

        {/* Weight */}
        {onWeightChange && (
          <div className="space-y-2">
            <Label htmlFor="sidebar-weight">Trọng lượng (kg)</Label>
            <Input
              id="sidebar-weight"
              type="number"
              min="0"
              step="0.1"
              placeholder="0"
              value={weight || ''}
              onChange={(e) =>
                onWeightChange(
                  e.target.value ? parseFloat(e.target.value) : undefined
                )
              }
            />
          </div>
        )}
      </CardContent>
    </Card>
  );
}
================================================================================FILE: components/admin/products/sidebar/ProductGalleryBox.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Image as ImageIcon, X, GripVertical } from 'lucide-react';
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { MediaLibraryModal, type MediaItem } from '../MediaLibraryModal';

interface GalleryImage {
  id: string; // Attachment ID
  thumbnail_url: string; // Thumbnail URL for display
  title?: string; // Image title for tooltip
  altText?: string; // Alt text for SEO
}

interface ProductGalleryBoxProps {
  galleryImages?: GalleryImage[]; // Array of {id, thumbnail_url, title, altText}
  onImagesChange: (images: GalleryImage[]) => void;
  onAltTextChange?: (imageId: string, altText: string) => void; // Callback for alt text changes
}

/**
 * Sortable Gallery Item Component
 */
function SortableGalleryItem({ 
  image, 
  onRemove 
}: { 
  image: GalleryImage; 
  onRemove: () => void;
}) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: image.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  return (
    <div
      ref={setNodeRef}
      style={{ ...style, width: '80px', height: '80px' }}
      className="relative group rounded-lg overflow-hidden border-2 border-muted cursor-move"
      title={image.title || `Image ${image.id}`}
    >
      <div className="relative w-full h-full">
        <Image
          src={image.thumbnail_url}
          alt={image.title || `Gallery ${image.id}`}
          fill
          className="object-cover"
          sizes="80px"
          onError={() => {
            console.error(`Failed to load gallery image: ${image.id}`);
          }}
        />
      </div>

      {/* Overlay on hover */}
      <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
        {/* Drag handle */}
        <div
          {...attributes}
          {...listeners}
          className="text-white cursor-grab active:cursor-grabbing"
        >
          <GripVertical className="h-5 w-5" />
        </div>

        {/* Quick Remove Button */}
        <Button
          type="button"
          variant="destructive"
          size="sm"
          onClick={(e) => {
            e.stopPropagation();
            onRemove();
          }}
          className="h-8"
        >
          <X className="h-3 w-3" />
        </Button>
      </div>
    </div>
  );
}

/**
 * Product Gallery Box - Sidebar component cho product gallery management
 * Features:
 * - Grid layout với thumbnails 80x80px
 * - Multi-select trong Media Modal
 * - Drag & Drop để sắp xếp
 * - Quick remove button (hover)
 * - Tooltip với tên file
 * - Hidden input _product_image_gallery (comma-separated IDs)
 * - Append mode (không ghi đè)
 * - Lazy loading (> 20 ảnh)
 */
export function ProductGalleryBox({
  galleryImages = [],
  onImagesChange,
  onAltTextChange,
}: ProductGalleryBoxProps) {
  const [showMediaModal, setShowMediaModal] = useState(false);
  const [images, setImages] = useState<GalleryImage[]>(galleryImages);

  // Sync with prop changes
  useEffect(() => {
    setImages(galleryImages);
  }, [galleryImages]);

  // Drag & Drop sensors
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      setImages((items) => {
        const oldIndex = items.findIndex((item) => item.id === active.id);
        const newIndex = items.findIndex((item) => item.id === over.id);
        const newItems = arrayMove(items, oldIndex, newIndex);
        onImagesChange(newItems);
        return newItems;
      });
    }
  };

  const handleMediaSelect = (items: MediaItem | MediaItem[]) => {
    // In multiple mode, onSelect returns an array
    const selectedItems = Array.isArray(items) ? items : [items];
    
    // Convert to GalleryImage format
    const newGalleryImages: GalleryImage[] = selectedItems.map((item) => ({
      id: item.id,
      thumbnail_url: item.thumbnail_url || item.url,
      title: item.title,
    }));

    // Append mode: add to existing images (don't overwrite)
    const updatedImages = [...images, ...newGalleryImages];
    setImages(updatedImages);
    onImagesChange(updatedImages);
    setShowMediaModal(false);
  };

  const handleRemove = (imageId: string) => {
    // Optimistic UI: remove immediately
    const newImages = images.filter((img) => img.id !== imageId);
    setImages(newImages);
    onImagesChange(newImages);
  };

  // Generate comma-separated IDs string for hidden input
  const galleryIdsString = images.map((img) => img.id).join(',');

  // Use lazy loading for thumbnails if > 20 images
  const useLazyLoading = images.length > 20;

  return (
    <>
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <ImageIcon className="h-4 w-4" />
            Thư viện hình ảnh
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Hidden input for _product_image_gallery */}
          <input
            type="hidden"
            name="_product_image_gallery"
            value={galleryIdsString}
          />

          {/* Gallery Grid */}
          {images.length > 0 ? (
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragEnd={handleDragEnd}
            >
              <SortableContext
                items={images.map((img) => img.id)}
              >
                <div className="grid grid-cols-3 gap-2" style={{ gridAutoRows: '80px' }}>
                  {images.map((image) => (
                    <SortableGalleryItem
                      key={image.id}
                      image={image}
                      onRemove={() => handleRemove(image.id)}
                    />
                  ))}
                </div>
              </SortableContext>
            </DndContext>
          ) : (
            <div 
              className="rounded-lg border-2 border-dashed border-muted flex items-center justify-center bg-muted/50"
              style={{ width: '80px', height: '80px' }}
            >
              <div className="text-center">
                <ImageIcon className="h-6 w-6 mx-auto text-muted-foreground mb-1" />
                <p className="text-xs text-muted-foreground">Chưa có</p>
              </div>
            </div>
          )}

          {/* Add Gallery Images Button */}
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setShowMediaModal(true)}
            className="w-full"
          >
            <ImageIcon className="h-4 w-4 mr-2" />
            Thêm ảnh thư viện sản phẩm
          </Button>

          {/* Info */}
          {images.length > 0 && (
            <p className="text-xs text-muted-foreground">
              {images.length} hình ảnh • Kéo thả để sắp xếp
            </p>
          )}

          {/* Alt Text Inputs for Gallery Images */}
          {images.length > 0 && (
            <div className="mt-4 space-y-3 pt-4 border-t">
              <Label className="text-xs font-medium">
                Văn bản thay thế (Alt Text) cho SEO
              </Label>
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {images.map((image) => (
                  <div key={image.id} className="flex gap-2 items-center">
                    <div className="w-12 h-12 flex-shrink-0 rounded overflow-hidden border">
                      <img
                        src={image.thumbnail_url}
                        alt={image.altText || `Gallery ${image.id}`}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <Input
                      type="text"
                      placeholder="Nhập alt text cho hình ảnh này"
                      value={image.altText || ''}
                      onChange={(e) => {
                        const updatedImages = images.map((img) =>
                          img.id === image.id
                            ? { ...img, altText: e.target.value }
                            : img
                        );
                        setImages(updatedImages);
                        onImagesChange(updatedImages);
                        onAltTextChange?.(image.id, e.target.value);
                      }}
                      className="text-xs flex-1"
                    />
                  </div>
                ))}
              </div>
              <p className="text-xs text-muted-foreground">
                Alt text giúp cải thiện SEO và khả năng tiếp cận
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Media Library Modal */}
      <MediaLibraryModal
        isOpen={showMediaModal}
        onClose={() => setShowMediaModal(false)}
        onSelect={handleMediaSelect}
        mode="multiple"
        selectedIds={images.map((img) => img.id)}
        buttonText="Thêm vào thư viện"
      />
    </>
  );
}
================================================================================FILE: components/admin/products/sidebar/ProductLinksBox.tsx================================================================================'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Link as LinkIcon, ExternalLink, Copy, Loader2 } from 'lucide-react';
import { useRouter } from 'next/navigation';

interface ProductLinksBoxProps {
  slug: string;
  productId?: string;
  status?: 'draft' | 'publish' | 'trash';
  onSlugChange: (slug: string) => void;
}

/**
 * Product Links Box - Sidebar component cho product links management
 * Features:
 * - Permalink editor (slug)
 * - View product link (if published)
 * - Duplicate product link
 */
export function ProductLinksBox({
  slug,
  productId,
  status,
  onSlugChange,
}: ProductLinksBoxProps) {
  const router = useRouter();
  const [slugInput, setSlugInput] = useState(slug);
  const [isDuplicating, setIsDuplicating] = useState(false);

  const handleSlugSubmit = () => {
    if (slugInput.trim()) {
      onSlugChange(slugInput.trim());
    } else {
      setSlugInput(slug);
    }
  };

  const handleDuplicate = async () => {
    if (!productId) {
      alert('Không thể duplicate sản phẩm mới. Vui lòng lưu sản phẩm trước.');
      return;
    }

    if (
      !confirm(
        'Bạn có chắc chắn muốn tạo bản sao của sản phẩm này? Sản phẩm mới sẽ được tạo với trạng thái "Bản nháp".'
      )
    ) {
      return;
    }

    setIsDuplicating(true);

    try {
      const response = await fetch(`/api/admin/products/${productId}/duplicate`, {
        method: 'POST',
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to duplicate product');
      }

      const result = await response.json();
      const newProductId = result.product?._id || result.product?.id;

      if (newProductId) {
        // Redirect to edit page of duplicated product
        router.push(`/admin/products/${newProductId}/edit`);
        router.refresh();
      } else {
        alert('Sản phẩm đã được duplicate thành công!');
      }
    } catch (error: any) {
      console.error('Error duplicating product:', error);
      alert(error.message || 'Có lỗi xảy ra khi duplicate sản phẩm');
    } finally {
      setIsDuplicating(false);
    }
  };

  const viewProductUrl = status === 'publish' && slug ? `/products/${slug}` : null;
  const editProductUrl = productId ? `/admin/products/${productId}/edit` : null;

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center gap-2">
          <LinkIcon className="h-4 w-4" />
          Liên kết
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Permalink Editor */}
        <div className="space-y-2">
          <Label htmlFor="sidebar-slug">Permalink (Slug)</Label>
          <div className="flex gap-2">
            <Input
              id="sidebar-slug"
              type="text"
              value={slugInput}
              onChange={(e) => setSlugInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSlugSubmit()}
              onBlur={handleSlugSubmit}
              placeholder="product-slug"
            />
          </div>
          <p className="text-xs text-muted-foreground">
            URL: /products/{slugInput || slug}
          </p>
        </div>

        {/* View Product Link */}
        {viewProductUrl && (
          <div className="space-y-2">
            <Label className="text-sm">Xem sản phẩm</Label>
            <Button
              type="button"
              variant="outline"
              size="sm"
              className="w-full"
              onClick={() => window.open(viewProductUrl, '_blank')}
            >
              <ExternalLink className="h-4 w-4 mr-2" />
              Mở trong tab mới
            </Button>
          </div>
        )}

        {/* Edit Product Link */}
        {editProductUrl && (
          <div className="space-y-2">
            <Label className="text-sm">Chỉnh sửa</Label>
            <Button
              type="button"
              variant="outline"
              size="sm"
              className="w-full"
              onClick={() => router.push(editProductUrl)}
            >
              <LinkIcon className="h-4 w-4 mr-2" />
              Đi tới trang chỉnh sửa
            </Button>
          </div>
        )}

        {/* Duplicate Product */}
        {productId && (
          <div className="space-y-2 pt-2 border-t">
            <Label className="text-sm">Thao tác</Label>
            <Button
              type="button"
              variant="outline"
              size="sm"
              className="w-full"
              onClick={handleDuplicate}
              disabled={isDuplicating}
            >
              {isDuplicating ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Đang tạo bản sao...
                </>
              ) : (
                <>
                  <Copy className="h-4 w-4 mr-2" />
                  Tạo bản sao
                </>
              )}
            </Button>
            <p className="text-xs text-muted-foreground">
              Tạo bản sao sản phẩm này với trạng thái &quot;Bản nháp&quot;
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
================================================================================FILE: components/admin/products/sidebar/PublishBox.tsx================================================================================'use client';

import { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Eye, Save, Send, Loader2, Lock, Globe, Key, Trash2, Edit2, Calendar, Clock } from 'lucide-react';
import { format } from 'date-fns';

interface PublishBoxProps {
  status: 'draft' | 'publish' | 'trash';
  isActive: boolean;
  visibility?: 'public' | 'private' | 'password';
  scheduledDate?: Date | string | null;
  password?: string;
  onStatusChange: (status: 'draft' | 'publish' | 'trash') => void;
  onIsActiveChange: (isActive: boolean) => void;
  onVisibilityChange?: (visibility: 'public' | 'private' | 'password') => void;
  onPasswordChange?: (password: string) => void;
  onScheduledDateChange?: (date: Date | null) => void;
  onPublish: () => void;
  onSaveDraft: () => void;
  onPreview?: () => void;
  onDelete?: () => void;
  loading?: boolean;
  productId?: string;
  productSlug?: string;
  hasUnsavedChanges?: boolean;
}

/**
 * Publish Box - Sidebar component cho publish/save actions
 * Theo spec publish_box.md:
 * - Top Actions (Lưu nháp, Xem thử)
 * - Status Info với icon màu và nút Chỉnh sửa
 * - Visibility (Công khai/Riêng tư/Mật khẩu)
 * - Schedule với Date & Time Picker
 * - Primary Action (Đăng/Cập nhật)
 * - Footer (Di chuyển vào thùng rác)
 * - Unsaved Changes Warning
 */
export function PublishBox({
  status,
  isActive,
  visibility = 'public',
  scheduledDate,
  password = '',
  onStatusChange,
  onIsActiveChange,
  onVisibilityChange,
  onPasswordChange,
  onScheduledDateChange,
  onPublish,
  onSaveDraft,
  onPreview,
  onDelete,
  loading = false,
  productId,
  productSlug,
  hasUnsavedChanges = false,
}: PublishBoxProps) {
  const [showStatusEdit, setShowStatusEdit] = useState(false);
  const [showSchedulePicker, setShowSchedulePicker] = useState(false);
  const [scheduleDateTime, setScheduleDateTime] = useState<string>('');
  const [showPasswordInput, setShowPasswordInput] = useState(visibility === 'password');
  const [passwordValue, setPasswordValue] = useState(password);

  // Status display với icon màu
  const getStatusDisplay = () => {
    switch (status) {
      case 'publish':
        return { text: 'Đã đăng', icon: '🟢', color: 'text-green-600' };
      case 'draft':
        return { text: 'Bản nháp', icon: '🟡', color: 'text-yellow-600' };
      case 'trash':
        return { text: 'Thùng rác', icon: '🔴', color: 'text-red-600' };
      default:
        return { text: 'Bản nháp', icon: '🟡', color: 'text-yellow-600' };
    }
  };

  const statusDisplay = getStatusDisplay();

  // Format scheduled date
  useEffect(() => {
    if (scheduledDate) {
      const date = scheduledDate instanceof Date ? scheduledDate : new Date(scheduledDate);
      // Format for datetime-local input: YYYY-MM-DDTHH:mm
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      setScheduleDateTime(`${year}-${month}-${day}T${hours}:${minutes}`);
    } else {
      setScheduleDateTime('');
    }
  }, [scheduledDate]);

  // Auto-save đã bị loại bỏ - chỉ lưu khi người dùng click button
  // useEffect cho autosave đã bị loại bỏ

  // Unsaved Changes Warning
  useEffect(() => {
    if (!hasUnsavedChanges) return;

    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      e.preventDefault();
      e.returnValue = 'Dữ liệu chưa được lưu sẽ bị mất. Bạn có chắc chắn muốn rời đi?';
      return e.returnValue;
    };

    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [hasUnsavedChanges]);

  const handlePreview = () => {
    if (onPreview) {
      onPreview();
    } else if (productSlug) {
      window.open(`/products/${productSlug}`, '_blank');
    } else {
      alert('Vui lòng nhập slug để xem trước sản phẩm');
    }
  };

  const handleScheduleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setScheduleDateTime(value);
    if (value && onScheduledDateChange) {
      const date = new Date(value);
      onScheduledDateChange(date);
    } else if (!value && onScheduledDateChange) {
      onScheduledDateChange(null);
    }
  };

  const handleVisibilityChange = (newVisibility: 'public' | 'private' | 'password') => {
    if (onVisibilityChange) {
      onVisibilityChange(newVisibility);
    }
    setShowPasswordInput(newVisibility === 'password');
    if (newVisibility !== 'password' && onPasswordChange) {
      onPasswordChange('');
      setPasswordValue('');
    }
  };

  const handlePasswordChange = (value: string) => {
    setPasswordValue(value);
    if (onPasswordChange) {
      onPasswordChange(value);
    }
  };

  const handleDelete = () => {
    if (confirm('Bạn có chắc chắn muốn di chuyển sản phẩm này vào thùng rác?')) {
      if (onDelete) {
        onDelete();
      } else {
        onStatusChange('trash');
      }
    }
  };

  return (
    <>
      <Card>
        {/* Header - Có thể ẩn (optional) */}
        {/* <CardHeader className="pb-3">
          <CardTitle className="text-base">Xuất bản</CardTitle>
        </CardHeader> */}

        <CardContent className="space-y-4">
          {/* Phần 1: Top Actions (Hành động phụ) */}
          <div className="space-y-2">
            <Button
              type="button"
              variant="ghost"
              onClick={onSaveDraft}
              disabled={loading}
              className="w-full justify-start"
            >
              <Save className="h-4 w-4 mr-2" />
              Lưu nháp
            </Button>
            <Button
              type="button"
              variant="outline"
              onClick={handlePreview}
              disabled={loading || !productSlug}
              className="w-full justify-start"
            >
              <Eye className="h-4 w-4 mr-2" />
              Xem thử
            </Button>
          </div>

          {/* Phần 2: Thông tin Trạng thái */}
          <div className="space-y-4 pt-2 border-t">
            {/* Status Display */}
            <div className="space-y-2">
              <Label>Trạng thái</Label>
              {!showStatusEdit ? (
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="text-lg">{statusDisplay.icon}</span>
                    <span className={`font-semibold ${statusDisplay.color}`}>
                      {statusDisplay.text}
                    </span>
                  </div>
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => setShowStatusEdit(true)}
                    className="h-7 text-xs"
                  >
                    <Edit2 className="h-3 w-3 mr-1" />
                    Chỉnh sửa
                  </Button>
                </div>
              ) : (
                <div className="space-y-2">
                  <select
                    value={status}
                    onChange={(e) => {
                      onStatusChange(e.target.value as 'draft' | 'publish' | 'trash');
                      setShowStatusEdit(false);
                    }}
                    className="w-full px-3 py-2 border rounded-md text-sm"
                    disabled={loading}
                  >
                    <option value="draft">🟡 Bản nháp</option>
                    <option value="publish">🟢 Đã đăng</option>
                    <option value="trash">🔴 Thùng rác</option>
                  </select>
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => setShowStatusEdit(false)}
                    className="w-full text-xs"
                  >
                    Hủy
                  </Button>
                </div>
              )}
            </div>

            {/* Visibility */}
            {onVisibilityChange && (
              <div className="space-y-2">
                <Label>Hiển thị</Label>
                <select
                  value={visibility}
                  onChange={(e) =>
                    handleVisibilityChange(e.target.value as 'public' | 'private' | 'password')
                  }
                  className="w-full px-3 py-2 border rounded-md text-sm"
                  disabled={loading}
                >
                  <option value="public">Công khai</option>
                  <option value="private">Riêng tư</option>
                  <option value="password">Mật khẩu</option>
                </select>
                {showPasswordInput && (
                  <div className="space-y-1">
                    <Label htmlFor="password" className="text-xs">
                      Mật khẩu
                    </Label>
                    <Input
                      id="password"
                      type="password"
                      value={passwordValue}
                      onChange={(e) => handlePasswordChange(e.target.value)}
                      placeholder="Nhập mật khẩu..."
                      className="text-sm"
                    />
                  </div>
                )}
                <p className="text-xs text-muted-foreground flex items-center gap-1">
                  {visibility === 'public' ? (
                    <>
                      <Globe className="h-3 w-3" />
                      Sản phẩm sẽ hiển thị công khai
                    </>
                  ) : visibility === 'private' ? (
                    <>
                      <Lock className="h-3 w-3" />
                      Sản phẩm chỉ hiển thị cho admin
                    </>
                  ) : (
                    <>
                      <Key className="h-3 w-3" />
                      Sản phẩm được bảo vệ bằng mật khẩu
                    </>
                  )}
                </p>
              </div>
            )}

            {/* Schedule */}
            {onScheduledDateChange && (
              <div className="space-y-2">
                <Label>Lịch đăng</Label>
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      id="schedule"
                      checked={showSchedulePicker}
                      onChange={(e) => {
                        setShowSchedulePicker(e.target.checked);
                        if (!e.target.checked && onScheduledDateChange) {
                          onScheduledDateChange(null);
                          setScheduleDateTime('');
                        }
                      }}
                      className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                    />
                    <Label htmlFor="schedule" className="text-sm font-normal cursor-pointer">
                      Lên lịch đăng
                    </Label>
                  </div>
                  {showSchedulePicker && (
                    <div className="space-y-2 pl-6">
                      <Input
                        type="datetime-local"
                        value={scheduleDateTime}
                        onChange={handleScheduleChange}
                        className="text-sm"
                        min={new Date().toISOString().slice(0, 16)}
                      />
                      {scheduleDateTime && (
                        <p className="text-xs text-muted-foreground">
                          Sẽ đăng vào:{' '}
                      {format(new Date(scheduleDateTime), "dd/MM/yyyy 'lúc' HH:mm")}
                        </p>
                      )}
                    </div>
                  )}
                  {!showSchedulePicker && (
                    <p className="text-xs text-muted-foreground flex items-center gap-1">
                      <Clock className="h-3 w-3" />
                      Đăng ngay lập tức
                    </p>
                  )}
                </div>
              </div>
            )}

            {/* Active Status */}
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="isActive"
                checked={isActive}
                onChange={(e) => onIsActiveChange(e.target.checked)}
                disabled={loading}
                className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
              />
              <Label htmlFor="isActive" className="text-sm font-normal cursor-pointer">
                Sản phẩm đang hoạt động
              </Label>
            </div>
          </div>

          {/* Phần 3: Primary Action */}
          <div className="pt-2 border-t">
            <Button
              type="button"
              onClick={onPublish}
              disabled={loading}
              className="w-full bg-primary hover:bg-primary/90"
              size="lg"
            >
              {loading ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Đang lưu...
                </>
              ) : (
                <>
                  <Send className="h-4 w-4 mr-2" />
                  {productId ? 'Cập nhật' : 'Đăng sản phẩm'}
                </>
              )}
            </Button>
          </div>

          {/* Footer: Di chuyển vào thùng rác */}
          {productId && (
            <div className="pt-2 border-t">
              <button
                type="button"
                onClick={handleDelete}
                disabled={loading}
                className="text-xs text-red-600 hover:text-red-700 hover:underline flex items-center gap-1"
              >
                <Trash2 className="h-3 w-3" />
                Di chuyển vào thùng rác
              </button>
            </div>
          )}

          {/* Info Message */}
          {!productSlug && (
            <p className="text-xs text-muted-foreground">
              Nhập slug để sử dụng tính năng xem trước
            </p>
          )}

        </CardContent>
      </Card>

    </>
  );
}
================================================================================FILE: components/admin/products/sidebar/TagsBox.tsx================================================================================'use client';

import { useState, useEffect, useRef, useMemo } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Tag, X, Plus, TrendingUp } from 'lucide-react';

interface TagsBoxProps {
  tags: string[];
  onTagsChange: (tags: string[]) => void;
  popularTags?: string[]; // Optional: Popular tags to suggest
  onFetchPopularTags?: () => Promise<string[]>; // Optional: Function to fetch popular tags
}

/**
 * Tags Box - Sidebar component cho tag management
 * Features:
 * - Tag input với autocomplete
 * - Popular tags suggestion
 * - Tag chips với remove button
 * - Enter to add tag
 */
export function TagsBox({
  tags,
  onTagsChange,
  popularTags = [],
  onFetchPopularTags,
}: TagsBoxProps) {
  const [tagInput, setTagInput] = useState('');
  const [suggestions, setSuggestions] = useState<string[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [popularTagsList, setPopularTagsList] = useState<string[]>(popularTags);
  const inputRef = useRef<HTMLInputElement>(null);
  const suggestionsRef = useRef<HTMLDivElement>(null);

  // Fetch popular tags on mount
  useEffect(() => {
    if (onFetchPopularTags && popularTagsList.length === 0) {
      onFetchPopularTags()
        .then((tags) => setPopularTagsList(tags))
        .catch((error) => console.error('Error fetching popular tags:', error));
    }
  }, [onFetchPopularTags, popularTagsList.length]);

  // Filter suggestions based on input
  const filteredSuggestions = useMemo(() => {
    if (!tagInput.trim() || tagInput.length < 2) {
      return [];
    }

    const query = tagInput.toLowerCase();
    const allSuggestions = [
      ...popularTagsList.filter((tag) => !tags.includes(tag)),
      ...tags.filter((tag) => tag.toLowerCase().includes(query) && tag !== tagInput),
    ];

    // Remove duplicates and filter
    const unique = Array.from(new Set(allSuggestions));
    return unique
      .filter((tag) => tag.toLowerCase().includes(query) && !tags.includes(tag))
      .slice(0, 5);
  }, [tagInput, popularTagsList, tags]);

  // Handle click outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        suggestionsRef.current &&
        !suggestionsRef.current.contains(event.target as Node) &&
        inputRef.current &&
        !inputRef.current.contains(event.target as Node)
      ) {
        setShowSuggestions(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const addTag = (tagToAdd?: string) => {
    const tag = (tagToAdd || tagInput).trim();
    if (tag && !tags.includes(tag)) {
      onTagsChange([...tags, tag]);
      setTagInput('');
      setShowSuggestions(false);
    }
  };

  const removeTag = (tagToRemove: string) => {
    onTagsChange(tags.filter((tag) => tag !== tagToRemove));
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setTagInput(value);
    setShowSuggestions(value.length >= 2 && filteredSuggestions.length > 0);
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (filteredSuggestions.length > 0 && showSuggestions) {
        // Add first suggestion
        addTag(filteredSuggestions[0]);
      } else {
        // Add typed tag
        addTag();
      }
    } else if (e.key === 'Escape') {
      setShowSuggestions(false);
    }
  };

  const handleSuggestionClick = (suggestion: string) => {
    addTag(suggestion);
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center gap-2">
          <Tag className="h-4 w-4" />
          Tags
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Tag Input */}
        <div className="relative">
          <Input
            ref={inputRef}
            type="text"
            placeholder="Nhập tag và nhấn Enter"
            value={tagInput}
            onChange={handleInputChange}
            onKeyDown={handleKeyDown}
            onFocus={() => {
              if (filteredSuggestions.length > 0) {
                setShowSuggestions(true);
              }
            }}
          />

          {/* Autocomplete Suggestions */}
          {showSuggestions && filteredSuggestions.length > 0 && (
            <div
              ref={suggestionsRef}
              className="absolute z-10 w-full mt-1 bg-background border rounded-md shadow-lg max-h-48 overflow-y-auto"
            >
              {filteredSuggestions.map((suggestion) => (
                <button
                  key={suggestion}
                  type="button"
                  onClick={() => handleSuggestionClick(suggestion)}
                  className="w-full text-left px-3 py-2 hover:bg-muted transition-colors text-sm"
                >
                  {suggestion}
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Selected Tags */}
        {tags.length > 0 && (
          <div className="flex flex-wrap gap-2">
            {tags.map((tag) => (
              <span
                key={tag}
                className="inline-flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-sm"
              >
                {tag}
                <button
                  type="button"
                  onClick={() => removeTag(tag)}
                  className="hover:text-primary/70 transition-colors"
                >
                  <X className="h-3 w-3" />
                </button>
              </span>
            ))}
          </div>
        )}

        {/* Popular Tags */}
        {popularTagsList.length > 0 && (
          <div className="space-y-2 pt-2 border-t">
            <Label className="text-xs text-muted-foreground flex items-center gap-1">
              <TrendingUp className="h-3 w-3" />
              Tags phổ biến
            </Label>
            <div className="flex flex-wrap gap-2">
              {popularTagsList
                .filter((tag) => !tags.includes(tag))
                .slice(0, 10)
                .map((tag) => (
                  <button
                    key={tag}
                    type="button"
                    onClick={() => addTag(tag)}
                    className="px-2 py-1 text-xs bg-muted hover:bg-muted/80 rounded-full transition-colors"
                  >
                    <Plus className="h-3 w-3 inline mr-1" />
                    {tag}
                  </button>
                ))}
            </div>
          </div>
        )}

        {/* Tag Count */}
        {tags.length > 0 && (
          <p className="text-xs text-muted-foreground">
            Đã thêm: {tags.length} tag{tags.length > 1 ? 's' : ''}
          </p>
        )}
      </CardContent>
    </Card>
  );
}
================================================================================FILE: components/admin/products/SkuAutoGenerateButton.tsx================================================================================/**
 * SKU Auto Generate Button
 * 
 * Button component for generating SKU automatically
 */

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Loader2, Zap } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';

interface SkuAutoGenerateButtonProps {
  productName: string;
  categoryId?: string;
  brandId?: string;
  onSkuGenerated: (sku: string) => void;
  excludeProductId?: string;
  disabled?: boolean;
}

export function SkuAutoGenerateButton({
  productName,
  categoryId,
  brandId,
  onSkuGenerated,
  excludeProductId,
  disabled,
}: SkuAutoGenerateButtonProps) {
  const { showToast } = useToastContext();
  const [loading, setLoading] = useState(false);

  const handleGenerate = async () => {
    if (!productName.trim()) {
      showToast('Vui lòng nhập tên sản phẩm trước', 'error');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch('/api/admin/sku/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          productName: productName.trim(),
          categoryId: categoryId || undefined,
          brandId: brandId || undefined,
          isVariant: false,
          previewMode: false,
          excludeProductId: excludeProductId || undefined,
        }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Failed to generate SKU');
      }

      if (data.data?.sku) {
        onSkuGenerated(data.data.sku);
        showToast('Đã sinh SKU tự động', 'success');
      } else {
        throw new Error('SKU không được trả về từ server');
      }
    } catch (error: any) {
      console.error('[SKU Auto Generate] Error:', error);
      showToast(error.message || 'Đã xảy ra lỗi khi sinh SKU', 'error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Button
      type="button"
      variant="outline"
      size="sm"
      onClick={handleGenerate}
      disabled={loading || disabled || !productName.trim()}
      className="gap-2"
    >
      {loading ? (
        <>
          <Loader2 className="h-4 w-4 animate-spin" />
          Đang sinh...
        </>
      ) : (
        <>
          <Zap className="h-4 w-4" />
          Auto Gen
        </>
      )}
    </Button>
  );
}

================================================================================FILE: components/admin/products/SKUCell.tsx================================================================================'use client';

import { useState } from 'react';
import { Copy, Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useToastContext } from '@/components/providers/ToastProvider';

interface SKUCellProps {
  sku: string | null | undefined;
}

export function SKUCell({ sku }: SKUCellProps) {
  const { showToast } = useToastContext();
  const [copied, setCopied] = useState(false);

  if (!sku || sku.trim() === '') {
    return <span className="text-sm text-gray-400">-</span>;
  }

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(sku);
      setCopied(true);
      showToast('Đã sao chép SKU', 'success');
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      showToast('Không thể sao chép SKU', 'error');
    }
  };

  return (
    <div className="flex items-center gap-2">
      <span className="text-sm font-mono text-gray-700">{sku}</span>
      <Button
        variant="ghost"
        size="sm"
        className="h-6 w-6 p-0"
        onClick={handleCopy}
        title="Sao chép SKU"
      >
        {copied ? (
          <Check className="w-3 h-3 text-green-600" />
        ) : (
          <Copy className="w-3 h-3 text-gray-400 hover:text-gray-600" />
        )}
      </Button>
    </div>
  );
}

================================================================================FILE: components/admin/products/SmartValueInput.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Check, ChevronDown, Plus, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { AttributeValueSelectionModal } from './AttributeValueSelectionModal';
import type { Term } from '@/app/admin/attributes/[id]/terms/page';

interface SmartValueInputProps {
  terms: Term[];
  selectedValues: string[];
  onValuesChange: (values: string[]) => void;
  attributeType: 'text' | 'color' | 'image' | 'button';
  loading?: boolean;
  onQuickAdd?: () => void;
  placeholder?: string;
  attributeName?: string; // For modal title
}

export function SmartValueInput({
  terms,
  selectedValues,
  onValuesChange,
  attributeType,
  loading = false,
  onQuickAdd,
  placeholder = 'Chọn giá trị...',
  attributeName = 'Giá trị',
}: SmartValueInputProps) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node)
      ) {
        setIsDropdownOpen(false);
        setSearchQuery('');
      }
    };

    if (isDropdownOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [isDropdownOpen]);

  // Handle input click - open modal instead of dropdown
  const handleInputClick = () => {
    setIsModalOpen(true);
    setIsDropdownOpen(false);
  };

  // Filter terms based on search
  const filteredTerms = terms.filter((term) =>
    term.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    term.slug.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const handleToggleValue = (value: string) => {
    if (selectedValues.includes(value)) {
      onValuesChange(selectedValues.filter((v) => v !== value));
    } else {
      onValuesChange([...selectedValues, value]);
    }
  };

  const handleSelectAll = () => {
    const allValues = filteredTerms.map((term) => term.name);
    const newValues = [...new Set([...selectedValues, ...allValues])];
    onValuesChange(newValues);
  };

  const handleDeselectAll = () => {
    const filteredValues = selectedValues.filter(
      (value) => !filteredTerms.some((term) => term.name === value)
    );
    onValuesChange(filteredValues);
  };

  const displayText =
    selectedValues.length > 0
      ? `${selectedValues.length} giá trị đã chọn`
      : placeholder;

  return (
    <>
      <div className="relative" ref={dropdownRef}>
        {/* Input Field - Opens Modal */}
        <div className="relative">
          <Input
            type="text"
            value={displayText}
            readOnly
            onClick={handleInputClick}
            className="cursor-pointer pr-10"
            placeholder={placeholder}
          />
          <ChevronDown
            className={cn(
              'absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground transition-transform',
              isModalOpen && 'rotate-180'
            )}
          />
        </div>

        {/* Legacy Dropdown (kept for fallback, but modal is primary) */}
        {isDropdownOpen && (
        <div className="absolute z-50 w-full mt-1 bg-white border border-input rounded-lg shadow-lg max-h-80 overflow-hidden flex flex-col">
          {/* Search */}
          <div className="p-2 border-b">
            <Input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Tìm kiếm giá trị..."
              className="h-9"
              autoFocus
            />
          </div>

          {/* Actions Bar */}
          <div className="px-2 py-1.5 border-b flex items-center justify-between gap-2">
            <div className="flex gap-1">
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={handleSelectAll}
                className="h-7 text-xs"
              >
                Chọn tất cả
              </Button>
              {selectedValues.length > 0 && (
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={handleDeselectAll}
                  className="h-7 text-xs"
                >
                  Bỏ chọn
                </Button>
              )}
            </div>
            {onQuickAdd && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={onQuickAdd}
                className="h-7 text-xs flex items-center gap-1"
              >
                <Plus className="w-3 h-3" />
                Tạo giá trị mới
              </Button>
            )}
          </div>

          {/* Terms List */}
          <div className="overflow-y-auto max-h-60">
            {loading ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="w-5 h-5 animate-spin text-muted-foreground" />
              </div>
            ) : filteredTerms.length === 0 ? (
              <div className="p-4 text-center text-sm text-muted-foreground">
                {searchQuery ? 'Không tìm thấy giá trị nào' : 'Chưa có giá trị nào'}
              </div>
            ) : (
              <div className="p-1">
                {filteredTerms.map((term) => {
                  const isSelected = selectedValues.includes(term.name);

                  return (
                    <div
                      key={term.id}
                      className={cn(
                        'flex items-center gap-2 p-2 rounded hover:bg-muted cursor-pointer transition-colors',
                        isSelected && 'bg-primary/10'
                      )}
                      onClick={() => handleToggleValue(term.name)}
                    >
                      {/* Visual Preview */}
                      <div className="flex-shrink-0">
                        {attributeType === 'color' && term.colorHex && (
                          <div
                            className="w-8 h-8 rounded-full border-2 border-gray-300"
                            style={{
                              background: term.colorHex2
                                ? `linear-gradient(135deg, ${term.colorHex} 0%, ${term.colorHex2} 100%)`
                                : term.colorHex,
                            }}
                            title={term.name}
                          />
                        )}
                        {(attributeType === 'image' || attributeType === 'button') &&
                          term.imageUrl && (
                            <div className="relative w-8 h-8 border rounded overflow-hidden">
                              <Image
                                src={term.imageUrl}
                                alt={term.name}
                                fill
                                className="object-cover"
                                sizes="32px"
                              />
                            </div>
                          )}
                        {attributeType === 'text' && (
                          <div className="w-8 h-8 rounded border-2 border-gray-200 flex items-center justify-center text-xs text-muted-foreground">
                            T
                          </div>
                        )}
                      </div>

                      {/* Name */}
                      <div className="flex-1 min-w-0">
                        <div className="font-medium text-sm truncate">{term.name}</div>
                        {term.description && (
                          <div className="text-xs text-muted-foreground truncate">
                            {term.description}
                          </div>
                        )}
                      </div>

                      {/* Checkbox */}
                      {isSelected && (
                        <Check className="w-4 h-4 text-primary flex-shrink-0" />
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
        )}
      </div>

      {/* Modal for Value Selection */}
      <AttributeValueSelectionModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onApply={(values) => {
          onValuesChange(values);
          setIsModalOpen(false);
        }}
        attributeName={attributeName}
        attributeType={attributeType}
        terms={terms}
        selectedValues={selectedValues}
        loading={loading}
        onQuickAdd={onQuickAdd}
      />
    </>
  );
}
================================================================================FILE: components/admin/products/StatusCell.tsx================================================================================'use client';

import { useState, useCallback } from 'react';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import type { MappedProduct } from '@/lib/utils/productMapper';

interface StatusCellProps {
  product: MappedProduct;
  onStatusChange?: (status: 'draft' | 'publish') => Promise<void>;
}

export function StatusCell({ product, onStatusChange }: StatusCellProps) {
  const [isUpdating, setIsUpdating] = useState(false);
  
  // Determine status from product
  // Priority: status field > stockStatus > isActive
  const status = (product as any).status || 
                 (product.stockStatus === 'instock' ? 'publish' : 'draft') ||
                 (product.isActive ? 'publish' : 'draft');
  
  const isPublished = status === 'publish';
  const isDraft = status === 'draft';
  const isTrash = status === 'trash';

  // Memoize handleToggle để tránh re-render loop
  // CRITICAL: Không include isUpdating trong dependencies để tránh loop
  // CRITICAL: onCheckedChange của Radix UI Switch truyền checked: boolean
  const handleToggle = useCallback(async (checked: boolean) => {
    if (!onStatusChange) return;
    
    setIsUpdating(true);
    try {
      const newStatus = checked ? 'publish' : 'draft';
      await onStatusChange(newStatus);
    } catch (error) {
      console.error('Error updating status:', error);
    } finally {
      setIsUpdating(false);
    }
  }, [onStatusChange]);

  // Status badge colors
  const getStatusBadge = () => {
    if (isTrash) {
      return 'bg-gray-100 text-gray-800';
    }
    if (isPublished) {
      return 'bg-green-100 text-green-800';
    }
    return 'bg-yellow-100 text-yellow-800';
  };

  const getStatusLabel = () => {
    if (isTrash) return 'Thùng rác';
    if (isPublished) return 'Đang bán';
    return 'Bản nháp';
  };

  return (
    <div className="flex items-center gap-3">
      <span className={`px-2 py-1 rounded text-xs font-medium ${getStatusBadge()}`}>
        {getStatusLabel()}
      </span>
      {!isTrash && onStatusChange && (
        <div className="flex items-center gap-2">
          <Switch
            id={`status-${product.id}`}
            checked={isPublished}
            onCheckedChange={handleToggle}
            disabled={isUpdating}
          />
          <Label htmlFor={`status-${product.id}`} className="text-xs text-gray-500">
            {isPublished ? 'Bật' : 'Tắt'}
          </Label>
        </div>
      )}
    </div>
  );
}

================================================================================FILE: components/admin/products/StockCell.tsx================================================================================'use client';

import { useState } from 'react';
import { Pencil } from 'lucide-react';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { InlineStockEditor } from './InlineStockEditor';

interface StockCellProps {
  product: MappedProduct;
  onUpdate?: (updatedProduct: MappedProduct) => void;
}

export function StockCell({ product, onUpdate }: StockCellProps) {
  const [isEditing, setIsEditing] = useState(false);
  
  // Calculate total stock for variable products
  const stockQuantity = product.stockQuantity ?? 0;
  
  // Color labels: Xanh (>10), Vàng (<10), Đỏ (0)
  const getStockColor = (stock: number): string => {
    if (stock === 0) return 'bg-red-100 text-red-800';
    if (stock < 10) return 'bg-yellow-100 text-yellow-800';
    return 'bg-green-100 text-green-800';
  };

  const stockColor = getStockColor(stockQuantity);

  const handleSave = (newStock: number) => {
    // Update product locally (optimistic update)
    const updatedProduct: MappedProduct = {
      ...product,
      stockQuantity: newStock,
      stockStatus: newStock > 0 ? 'instock' : 'outofstock',
    };
    onUpdate?.(updatedProduct);
    setIsEditing(false);
  };

  if (isEditing) {
    return (
      <InlineStockEditor
        productId={product.id}
        currentStock={product.stockQuantity}
        onSave={handleSave}
        onCancel={() => setIsEditing(false)}
      />
    );
  }

  return (
    <div className="flex items-center gap-2">
      <span className={`px-2 py-1 rounded text-xs font-medium ${stockColor}`}>
        {stockQuantity}
      </span>
      <button
        onClick={() => setIsEditing(true)}
        className="p-1 hover:bg-gray-100 rounded transition-colors"
        title="Sửa kho"
      >
        <Pencil className="w-3 h-3 text-gray-400 hover:text-gray-600" />
      </button>
    </div>
  );
}

================================================================================FILE: components/admin/products/TemplateSelector.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Save, FileText, X } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { useToastContext } from '@/components/providers/ToastProvider';

// Template data can be any product form data structure
type TemplateData = Record<string, unknown>;

interface ProductTemplate {
  _id: string;
  name: string;
  description?: string;
  category?: string;
  templateData: TemplateData;
  createdAt: string;
}

interface TemplateSelectorProps {
  onLoadTemplate: (templateData: TemplateData) => void;
  onSaveTemplate?: (name: string, description: string, category: string, templateData: TemplateData) => void;
  currentFormData?: TemplateData;
}

export function TemplateSelector({ onLoadTemplate, onSaveTemplate, currentFormData }: TemplateSelectorProps) {
  const { showToast } = useToastContext();
  const [templates, setTemplates] = useState<ProductTemplate[]>([]);
  const [loading, setLoading] = useState(false);
  const [showSaveDialog, setShowSaveDialog] = useState(false);
  const [templateName, setTemplateName] = useState('');
  const [templateDescription, setTemplateDescription] = useState('');
  const [templateCategory, setTemplateCategory] = useState('');

  useEffect(() => {
    fetchTemplates();
  }, []);

  const fetchTemplates = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/admin/products/templates');
      const data = await response.json();
      setTemplates(data.templates || []);
    } catch (error) {
      console.error('Error fetching templates:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleLoadTemplate = async (templateId: string) => {
    try {
      const response = await fetch(`/api/admin/products/templates/${templateId}`);
      const data = await response.json();
      if (data.template) {
        onLoadTemplate(data.template.templateData);
        showToast('Đã tải template thành công', 'success');
      } else {
        showToast('Không tìm thấy template', 'error');
      }
    } catch (error) {
      console.error('Error loading template:', error);
      showToast('Có lỗi xảy ra khi tải template', 'error');
    }
  };

  const handleSaveTemplate = async () => {
    if (!templateName.trim()) {
      showToast('Vui lòng nhập tên template', 'error');
      return;
    }

    if (!onSaveTemplate || !currentFormData) {
      showToast('Không thể lưu template', 'error');
      return;
    }

    try {
      onSaveTemplate(templateName, templateDescription, templateCategory, currentFormData);
      showToast('Đã lưu template thành công', 'success');
      setShowSaveDialog(false);
      setTemplateName('');
      setTemplateDescription('');
      setTemplateCategory('');
      fetchTemplates();
    } catch (error: unknown) {
      console.error('Error saving template:', error);
      const errorMessage = error instanceof Error ? error.message : 'Có lỗi xảy ra khi lưu template';
      showToast(errorMessage, 'error');
    }
  };

  const handleDeleteTemplate = async (templateId: string) => {
    if (!confirm('Bạn có chắc muốn xóa template này?')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/products/templates/${templateId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        showToast('Đã xóa template thành công', 'success');
        fetchTemplates();
      } else {
        const error = await response.json();
        showToast(error?.error || 'Có lỗi xảy ra khi xóa template', 'error');
      }
    } catch (error) {
      console.error('Error deleting template:', error);
      showToast('Có lỗi xảy ra khi xóa template', 'error');
    }
  };

  // Group templates by category
  const groupedTemplates = templates.reduce((acc, template) => {
    const category = template.category || 'Khác';
    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(template);
    return acc;
  }, {} as Record<string, ProductTemplate[]>);

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle className="flex items-center gap-2">
          <FileText className="w-5 h-5" />
          Product Templates
        </CardTitle>
        {onSaveTemplate && currentFormData && (
          <Button
            variant="outline"
            size="sm"
            onClick={() => setShowSaveDialog(true)}
          >
            <Save className="w-4 h-4 mr-2" />
            Lưu template
          </Button>
        )}
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Save Template Dialog */}
        {showSaveDialog && (
          <div className="p-4 border rounded-lg bg-gray-50 space-y-3">
            <div>
              <Label>Tên template *</Label>
              <Input
                value={templateName}
                onChange={(e) => setTemplateName(e.target.value)}
                placeholder="Ví dụ: Gấu bông cơ bản"
              />
            </div>
            <div>
              <Label>Mô tả</Label>
              <Textarea
                value={templateDescription}
                onChange={(e) => setTemplateDescription(e.target.value)}
                rows={2}
                placeholder="Mô tả template..."
              />
            </div>
            <div>
              <Label>Danh mục</Label>
              <Input
                value={templateCategory}
                onChange={(e) => setTemplateCategory(e.target.value)}
                placeholder="Ví dụ: Gấu bông, Đồ chơi"
              />
            </div>
            <div className="flex gap-2">
              <Button onClick={handleSaveTemplate} size="sm">
                Lưu
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  setShowSaveDialog(false);
                  setTemplateName('');
                  setTemplateDescription('');
                  setTemplateCategory('');
                }}
              >
                Hủy
              </Button>
            </div>
          </div>
        )}

        {/* Templates List */}
        {loading ? (
          <div className="text-center py-8 text-gray-500">Đang tải...</div>
        ) : templates.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            Chưa có template nào. Lưu template để sử dụng sau.
          </div>
        ) : (
          <div className="space-y-4">
            {Object.entries(groupedTemplates).map(([category, categoryTemplates]) => (
              <div key={category}>
                <h4 className="text-sm font-medium text-gray-700 mb-2">{category}</h4>
                <div className="space-y-2">
                  {categoryTemplates.map((template) => (
                    <div
                      key={template._id}
                      className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50"
                    >
                      <div className="flex-1">
                        <p className="text-sm font-medium">{template.name}</p>
                        {template.description && (
                          <p className="text-xs text-gray-500">{template.description}</p>
                        )}
                      </div>
                      <div className="flex gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleLoadTemplate(template._id)}
                        >
                          Sử dụng
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDeleteTemplate(template._id)}
                        >
                          <X className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/VariantFormEnhanced.tsx================================================================================'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Plus, Trash2, AlertTriangle } from 'lucide-react';

export interface EnhancedVariant {
  id: string;
  size: string;
  color?: string;
  colorCode?: string; // hex/rgb
  price: number;
  stock: number;
  image?: string; // Variant-specific image
  sku?: string;
  stockAlertThreshold?: number; // Cảnh báo khi stock < threshold
  pricingRule?: {
    type: 'fixed' | 'percentage' | 'formula';
    value: number;
  };
}

interface VariantFormEnhancedProps {
  variants: EnhancedVariant[];
  onChange: (variants: EnhancedVariant[]) => void;
  baseSku?: string; // Base SKU để auto-generate variant SKU
}

export function VariantFormEnhanced({ variants, onChange, baseSku }: VariantFormEnhancedProps) {
  const [selectedVariant, setSelectedVariant] = useState<string | null>(null);

  const addVariant = () => {
    const newVariant: EnhancedVariant = {
      id: `variant-${Date.now()}`,
      size: '',
      price: 0,
      stock: 0,
      stockAlertThreshold: 10, // Default threshold
    };
    onChange([...variants, newVariant]);
    setSelectedVariant(newVariant.id);
  };

  const removeVariant = (id: string) => {
    onChange(variants.filter((v) => v.id !== id));
    if (selectedVariant === id) {
      setSelectedVariant(null);
    }
  };

  const updateVariant = (id: string, field: keyof EnhancedVariant, value: any) => {
    const updated = variants.map((v) => {
      if (v.id === id) {
        const updatedVariant = { ...v, [field]: value };
        
        // Auto-generate SKU nếu có baseSku
        if (field === 'size' && baseSku && !updatedVariant.sku) {
          updatedVariant.sku = `${baseSku}-${value}`.toUpperCase().replace(/\s+/g, '-');
        }
        
        return updatedVariant;
      }
      return v;
    });
    onChange(updated);
  };

  const updatePricingRule = (id: string, type: 'fixed' | 'percentage' | 'formula', value: number) => {
    updateVariant(id, 'pricingRule', { type, value });
  };

  const getStockStatus = (stock: number, threshold?: number) => {
    if (stock === 0) return { text: 'Hết hàng', color: 'text-red-600' };
    if (threshold && stock < threshold) return { text: 'Sắp hết', color: 'text-yellow-600' };
    return { text: 'Còn hàng', color: 'text-green-600' };
  };

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle>Biến thể sản phẩm nâng cao</CardTitle>
        <Button type="button" onClick={addVariant} variant="outline" size="sm">
          <Plus className="w-4 h-4 mr-2" />
          Thêm biến thể
        </Button>
      </CardHeader>
      <CardContent className="space-y-4">
        {variants.length === 0 ? (
          <p className="text-sm text-gray-500 text-center py-8">
            Chưa có biến thể nào. Click &quot;Thêm biến thể&quot; để bắt đầu.
          </p>
        ) : (
          variants.map((variant) => {
            const stockStatus = getStockStatus(variant.stock, variant.stockAlertThreshold);
            const isLowStock = variant.stockAlertThreshold && variant.stock < variant.stockAlertThreshold;

            return (
              <div
                key={variant.id}
                className={`border rounded-lg p-4 space-y-3 ${
                  selectedVariant === variant.id ? 'border-blue-500 bg-blue-50' : ''
                }`}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-medium">
                      Biến thể {variant.size || 'Mới'}
                      {variant.color && ` - ${variant.color}`}
                    </h4>
                    {isLowStock && (
                      <div className="flex items-center gap-1 text-yellow-600 text-sm mt-1">
                        <AlertTriangle className="w-4 h-4" />
                        <span>Cảnh báo: Sắp hết hàng</span>
                      </div>
                    )}
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => removeVariant(variant.id)}
                  >
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <Label>Kích thước *</Label>
                    <Input
                      value={variant.size}
                      onChange={(e) => updateVariant(variant.id, 'size', e.target.value)}
                      required
                    />
                  </div>

                  <div>
                    <Label>Màu sắc</Label>
                    <Input
                      value={variant.color || ''}
                      onChange={(e) => updateVariant(variant.id, 'color', e.target.value)}
                      placeholder="Ví dụ: Hồng, Xanh"
                    />
                  </div>

                  <div>
                    <Label>Mã màu (Hex/RGB)</Label>
                    <div className="flex gap-2">
                      <Input
                        type="color"
                        value={variant.colorCode || '#000000'}
                        onChange={(e) => updateVariant(variant.id, 'colorCode', e.target.value)}
                        className="w-16 h-10 p-1"
                      />
                      <Input
                        value={variant.colorCode || ''}
                        onChange={(e) => updateVariant(variant.id, 'colorCode', e.target.value)}
                        placeholder="#FF5733"
                        pattern="^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$"
                      />
                    </div>
                  </div>

                  <div>
                    <Label>Giá *</Label>
                    <Input
                      type="number"
                      min="0"
                      value={variant.price}
                      onChange={(e) => updateVariant(variant.id, 'price', parseFloat(e.target.value) || 0)}
                      required
                    />
                  </div>

                  <div>
                    <Label>Số lượng *</Label>
                    <Input
                      type="number"
                      min="0"
                      value={variant.stock}
                      onChange={(e) => updateVariant(variant.id, 'stock', parseInt(e.target.value) || 0)}
                      required
                    />
                    <p className={`text-xs mt-1 ${stockStatus.color}`}>
                      {stockStatus.text}
                    </p>
                  </div>

                  <div>
                    <Label>Ngưỡng cảnh báo tồn kho</Label>
                    <Input
                      type="number"
                      min="0"
                      value={variant.stockAlertThreshold || 10}
                      onChange={(e) => updateVariant(variant.id, 'stockAlertThreshold', parseInt(e.target.value) || 10)}
                      placeholder="10"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Cảnh báo khi số lượng &lt; ngưỡng này
                    </p>
                  </div>

                  <div>
                    <Label>SKU</Label>
                    <Input
                      value={variant.sku || ''}
                      onChange={(e) => updateVariant(variant.id, 'sku', e.target.value)}
                      placeholder="Auto-generated từ base SKU"
                    />
                  </div>

                  <div>
                    <Label>URL ảnh biến thể</Label>
                    <Input
                      type="url"
                      value={variant.image || ''}
                      onChange={(e) => updateVariant(variant.id, 'image', e.target.value)}
                      placeholder="https://example.com/variant-image.jpg"
                    />
                  </div>
                </div>

                {/* Pricing Rule */}
                <div className="border-t pt-3">
                  <Label className="mb-2 block">Quy tắc giá (tùy chọn)</Label>
                  <div className="grid grid-cols-3 gap-2">
                    <select
                      value={variant.pricingRule?.type || 'fixed'}
                      onChange={(e) => {
                        const type = e.target.value as 'fixed' | 'percentage' | 'formula';
                        updatePricingRule(
                          variant.id,
                          type,
                          variant.pricingRule?.value || 0
                        );
                      }}
                      className="border rounded px-3 py-2"
                    >
                      <option value="fixed">Giá cố định</option>
                      <option value="percentage">Phần trăm</option>
                      <option value="formula">Công thức</option>
                    </select>
                    <Input
                      type="number"
                      value={variant.pricingRule?.value || 0}
                      onChange={(e) => {
                        const type = variant.pricingRule?.type || 'fixed';
                        updatePricingRule(
                          variant.id,
                          type,
                          parseFloat(e.target.value) || 0
                        );
                      }}
                      placeholder="Giá trị"
                    />
                    <p className="text-xs text-gray-500 flex items-center">
                      {variant.pricingRule?.type === 'percentage' && '%'}
                      {variant.pricingRule?.type === 'formula' && 'Công thức'}
                    </p>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </CardContent>
    </Card>
  );
}

================================================================================FILE: components/admin/products/VariantSkuGenerator.tsx================================================================================/**
 * Variant SKU Generator
 * 
 * Component for generating SKUs for variants with live preview
 */

'use client';

import { useState, useEffect } from 'react';
import { Checkbox } from '@/components/ui/checkbox';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Loader2, RefreshCw, Zap, Info } from 'lucide-react';
import { useToastContext } from '@/components/providers/ToastProvider';
// Tooltip component not found, using title attribute instead
import type { Variation } from './ProductDataMetaBox/VariationTable';

interface VariantSkuGeneratorProps {
  variations: Variation[];
  productName: string;
  categoryId?: string;
  onVariationsChange: (variations: Variation[]) => void;
  autoGenerateEnabled: boolean;
  onAutoGenerateChange: (enabled: boolean) => void;
  onPreviewSkusChange?: (previews: Record<string, string>) => void;
  onHasIncrementTokenChange?: (hasToken: boolean) => void;
}

/**
 * Generate SKU preview for a variant
 */
async function generateSkuPreview(
  productName: string,
  categoryId: string | undefined,
  attributes: Record<string, string>,
  previewMode: boolean = true
): Promise<string> {
  try {
    // Convert attributes to array format
    const attributePairs = Object.entries(attributes).map(([key, value]) => ({
      key,
      value,
    }));

    const response = await fetch('/api/admin/sku/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        productName,
        categoryId: categoryId || undefined,
        attributes: attributePairs,
        isVariant: true,
        previewMode,
      }),
    });

    const data = await response.json();
    if (!response.ok || !data.success) {
      throw new Error(data.message || 'Failed to generate SKU');
    }

    return data.data?.sku || '';
  } catch (error) {
    console.error('[Variant SKU Preview] Error:', error);
    return '';
  }
}

/**
 * Generate actual SKU for a variant (not preview)
 */
async function generateSku(
  productName: string,
  categoryId: string | undefined,
  attributes: Record<string, string>,
  excludeProductId?: string
): Promise<string> {
  try {
    const attributePairs = Object.entries(attributes).map(([key, value]) => ({
      key,
      value,
    }));

    const response = await fetch('/api/admin/sku/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        productName,
        categoryId: categoryId || undefined,
        attributes: attributePairs,
        isVariant: true,
        previewMode: false,
        excludeProductId,
      }),
    });

    const data = await response.json();
    if (!response.ok || !data.success) {
      throw new Error(data.message || 'Failed to generate SKU');
    }

    return data.data?.sku || '';
  } catch (error) {
    console.error('[Variant SKU Generate] Error:', error);
    throw error;
  }
}

export function VariantSkuGenerator({
  variations,
  productName,
  categoryId,
  onVariationsChange,
  autoGenerateEnabled,
  onAutoGenerateChange,
  onPreviewSkusChange,
  onHasIncrementTokenChange,
}: VariantSkuGeneratorProps) {
  const { showToast } = useToastContext();
  const [previewSkus, setPreviewSkus] = useState<Record<string, string>>({});
  const [isGenerating, setIsGenerating] = useState(false);
  const [hasIncrementToken, setHasIncrementToken] = useState(false);

  // Check if pattern has {INCREMENT} token
  useEffect(() => {
    async function checkPattern() {
      try {
        const response = await fetch(`/api/admin/sku/settings${categoryId ? `?categoryId=${categoryId}` : ''}`);
        const data = await response.json();
        if (data.success && data.data) {
          const pattern = (data.data.global || data.data)?.pattern || '';
          const hasToken = pattern.includes('{INCREMENT}');
          setHasIncrementToken(hasToken);
          onHasIncrementTokenChange?.(hasToken);
        }
      } catch (error) {
        console.error('[Check Pattern] Error:', error);
      }
    }
    checkPattern();
  }, [categoryId, onHasIncrementTokenChange]);

  // Generate preview SKUs when auto-generate is enabled
  useEffect(() => {
    if (!autoGenerateEnabled || !productName.trim()) {
      setPreviewSkus({});
      return;
    }

    const generatePreviews = async () => {
      const newPreviews: Record<string, string> = {};
      
      for (const variation of variations) {
        if (Object.keys(variation.attributes).length === 0) continue;
        
        try {
          const preview = await generateSkuPreview(
            productName,
            categoryId,
            variation.attributes,
            true // preview mode
          );
          if (preview) {
            newPreviews[variation.id] = preview;
          }
        } catch (error) {
          // Silently fail for preview
        }
      }
      
      setPreviewSkus(newPreviews);
      onPreviewSkusChange?.(newPreviews);
    };

    generatePreviews();
  }, [autoGenerateEnabled, productName, categoryId, variations, onPreviewSkusChange]);

  // Handle regenerate all SKUs
  const handleRegenerateAll = async () => {
    if (!productName.trim()) {
      showToast('Vui lòng nhập tên sản phẩm trước', 'error');
      return;
    }

    setIsGenerating(true);
    try {
      const updatedVariations = await Promise.all(
        variations.map(async (variation) => {
          if (Object.keys(variation.attributes).length === 0) {
            return variation;
          }

          try {
            const sku = await generateSku(
              productName,
              categoryId,
              variation.attributes
            );
            return { ...variation, sku };
          } catch (error: any) {
            console.error(`[Regenerate SKU] Error for variation ${variation.id}:`, error);
            return variation; // Keep existing SKU on error
          }
        })
      );

      onVariationsChange(updatedVariations);
      showToast('Đã tạo lại SKU cho tất cả biến thể', 'success');
    } catch (error: any) {
      showToast(error.message || 'Đã xảy ra lỗi khi tạo lại SKU', 'error');
    } finally {
      setIsGenerating(false);
    }
  };

  // Expose previewSkus and hasIncrementToken for parent component
  useEffect(() => {
    onPreviewSkusChange?.(previewSkus);
  }, [previewSkus, onPreviewSkusChange]);

  return (
    <div className="space-y-3 mb-4 p-4 bg-muted/30 rounded-lg border">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <Checkbox
            id="auto-generate-sku"
            checked={autoGenerateEnabled}
            onCheckedChange={(checked) => onAutoGenerateChange(checked === true)}
          />
          <Label
            htmlFor="auto-generate-sku"
            className="text-sm font-medium cursor-pointer"
          >
            Tự động sinh SKU cho tất cả biến thể
          </Label>
          {hasIncrementToken && (
            <span
              title="Pattern có chứa {INCREMENT}. Số thứ tự thực tế sẽ được gán khi lưu sản phẩm để đảm bảo không trùng lặp."
              className="cursor-help"
            >
              <Info className="h-4 w-4 text-muted-foreground" />
            </span>
          )}
        </div>
        {variations.length > 0 && (
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={handleRegenerateAll}
            disabled={isGenerating || !productName.trim()}
            className="gap-2"
          >
            {isGenerating ? (
              <>
                <Loader2 className="h-4 w-4 animate-spin" />
                Đang tạo...
              </>
            ) : (
              <>
                <RefreshCw className="h-4 w-4" />
                Tạo lại SKU
              </>
            )}
          </Button>
        )}
      </div>
      {autoGenerateEnabled && (
        <p className="text-xs text-muted-foreground ml-7">
          SKU sẽ được tự động sinh dựa trên pattern đã cấu hình. Bạn có thể chỉnh sửa thủ công nếu cần.
        </p>
      )}
    </div>
  );
}

// Note: useVariantSkuPreview hook removed - preview logic is handled directly in VariationTable

================================================================================FILE: components/product/AddToCartButton.tsx================================================================================'use client';

import { Button } from '@/components/ui/button';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { type CartItem } from '@/lib/store/cartStore';
import { useState } from 'react';
import { Loader2 } from 'lucide-react';
import { useQuickCheckoutStore } from '@/lib/store/useQuickCheckoutStore';

interface AddToCartButtonProps {
  product: Omit<CartItem, 'quantity'>;
  disabled?: boolean;
}

export function AddToCartButton({ product, disabled }: AddToCartButtonProps) {
  const { addToCart } = useCartSync();
  const [isAdding, setIsAdding] = useState(false);

  const handleAddToCart = async () => {
    if (disabled) return;

    setIsAdding(true);
    try {
      await addToCart(product);
      // Mở QuickCheckoutModal sau khi thêm vào giỏ
      useQuickCheckoutStore.getState().onOpen();
    } catch (error) {
      console.error('Error adding to cart:', error);
    } finally {
      // Show feedback
      setTimeout(() => {
        setIsAdding(false);
      }, 500);
    }
  };

  // Button text - Hiển thị loading state với spinner
  const getButtonContent = () => {
    if (isAdding) {
      return (
        <>
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          Đang thêm...
        </>
      );
    }
    if (disabled) {
      return 'Hết hàng';
    }
    return 'Thêm vào giỏ hàng';
  };

  return (
    <Button
      className="w-full relative"
      size="lg"
      disabled={disabled || isAdding}
      onClick={handleAddToCart}
    >
      {getButtonContent()}
    </Button>
  );
}

================================================================================FILE: components/product/AdvancedFilters.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Select } from '@/components/ui/select';
import { Slider } from '@/components/ui/slider';
import { useProductFilters, type ProductFilters as ProductFiltersType } from '@/lib/hooks/useProductFilters';
import { useCategoriesREST } from '@/lib/hooks/useCategoriesREST';
import { useProductAttributes } from '@/lib/hooks/useProductAttributes';
import { X } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { formatPrice } from '@/lib/utils/format';

interface AdvancedFiltersProps {
  className?: string;
}

export function AdvancedFilters({ className }: AdvancedFiltersProps) {
  const { filters, updateFilter, clearFilters } = useProductFilters();
  const { categories, loading: categoriesLoading } = useCategoriesREST();
  const { getSizeOptions, getMaterialOptions, isLoading: attributesLoading } = useProductAttributes();
  const [isOpen, setIsOpen] = useState(false);
  // Parse categories từ URL (comma-separated string)
  const [selectedCategories, setSelectedCategories] = useState<string[]>(
    filters.category ? filters.category.split(',').filter(Boolean) : []
  );

  // Sync selectedCategories với filters khi filters thay đổi từ bên ngoài
  useEffect(() => {
    if (filters.category) {
      const categoriesFromUrl = filters.category.split(',').filter(Boolean);
      setSelectedCategories(categoriesFromUrl);
    } else {
      setSelectedCategories([]);
    }
  }, [filters.category]);
  // Price range constants
  const MIN_PRICE = 0;
  const MAX_PRICE = 1000000;
  
  const minPrice = filters.minPrice ?? filters.priceMin ?? null;
  const maxPrice = filters.maxPrice ?? filters.priceMax ?? null;
  
  const [priceRange, setPriceRange] = useState<[number, number]>([
    minPrice || MIN_PRICE,
    maxPrice || MAX_PRICE,
  ]);

  // Sync priceRange với filters khi filters thay đổi từ bên ngoài (URL params)
  useEffect(() => {
    setPriceRange([
      minPrice || MIN_PRICE,
      maxPrice || MAX_PRICE,
    ]);
  }, [minPrice, maxPrice]);

  const hasActiveFilters = 
    (filters.category && filters.category.split(',').length > 0) ||
    minPrice || 
    maxPrice || 
    filters.material || 
    filters.size ||
    filters.sortBy;

  const handleCategoryToggle = (categorySlug: string) => {
    const newCategories = selectedCategories.includes(categorySlug)
      ? selectedCategories.filter((c) => c !== categorySlug)
      : [...selectedCategories, categorySlug];

    setSelectedCategories(newCategories);
    
    // Update filter với tất cả categories (comma-separated)
    updateFilter('category', newCategories.length > 0 ? newCategories.join(',') : null);
  };

  const handlePriceRangeChange = (values: number[]) => {
    const [min, max] = values;
    setPriceRange([min, max]);
    
    updateFilter('priceMin', min > MIN_PRICE ? min : null);
    updateFilter('priceMax', max < MAX_PRICE ? max : null);
    updateFilter('minPrice', min > MIN_PRICE ? min : null);
    updateFilter('maxPrice', max < MAX_PRICE ? max : null);
  };

  // Material và Size options được lấy động từ WooCommerce attributes
  const materialOptions = getMaterialOptions().map(material => ({
    value: material,
    label: material,
  }));

  const sizeOptions = getSizeOptions().map(size => ({
    value: size,
    label: size,
  }));

  // Active filters for display as badges
  const activeFilters = useMemo(() => {
    const active: Array<{ key: string; label: string; value: string }> = [];
    
    if (filters.category) {
      const categorySlugs = filters.category.split(',').filter(Boolean);
      const categoryNames = categorySlugs
        .map(slug => {
          const category = categories.find(c => 
            c.slug === slug || c.databaseId?.toString() === slug
          );
          return category?.name;
        })
        .filter(Boolean);
      
      if (categoryNames.length > 0) {
        active.push({ 
          key: 'category', 
          label: categoryNames.length === 1 ? 'Danh mục' : 'Danh mục', 
          value: categoryNames.join(', ') 
        });
      }
    }
    
    if (minPrice) {
      active.push({ 
        key: 'minPrice', 
        label: 'Giá từ', 
        value: formatPrice(minPrice) 
      });
    }
    
    if (maxPrice && maxPrice < MAX_PRICE) {
      active.push({ 
        key: 'maxPrice', 
        label: 'Giá đến', 
        value: formatPrice(maxPrice) 
      });
    }
    
    if (filters.material) {
      active.push({ key: 'material', label: 'Chất liệu', value: filters.material });
    }
    
    if (filters.size) {
      active.push({ key: 'size', label: 'Kích thước', value: filters.size });
    }
    
    if (filters.sortBy) {
      const sortLabels: Record<string, string> = {
        price_asc: 'Giá: Thấp đến cao',
        price_desc: 'Giá: Cao đến thấp',
        name_asc: 'Tên: A-Z',
        name_desc: 'Tên: Z-A',
        newest: 'Mới nhất',
      };
      active.push({ 
        key: 'sortBy', 
        label: 'Sắp xếp', 
        value: sortLabels[filters.sortBy] || filters.sortBy 
      });
    }
    
    return active;
  }, [filters, categories]);

  const handleClearAll = () => {
    setSelectedCategories([]);
    setPriceRange([MIN_PRICE, MAX_PRICE]);
    clearFilters();
  };

  const handleRemoveFilter = (key: string) => {
    switch (key) {
      case 'category':
        setSelectedCategories([]);
        updateFilter('category', null);
        break;
      case 'minPrice':
        updateFilter('priceMin', null);
        updateFilter('minPrice', null);
        setPriceRange([MIN_PRICE, priceRange[1]]);
        break;
      case 'maxPrice':
        updateFilter('priceMax', null);
        updateFilter('maxPrice', null);
        setPriceRange([priceRange[0], MAX_PRICE]);
        break;
      case 'material':
        updateFilter('material', null);
        break;
      case 'size':
        updateFilter('size', null);
        break;
      case 'sortBy':
        updateFilter('sortBy', null);
        break;
    }
  };

  return (
    <div className={`w-full ${className || ''}`}>
      {/* Mobile: Collapsible Filter Button */}
      <div className="md:hidden mb-4">
        <Button
          variant="outline"
          className="w-full"
          onClick={() => setIsOpen(!isOpen)}
        >
          {isOpen ? 'Đóng bộ lọc' : 'Bộ lọc nâng cao'}
          {hasActiveFilters && (
            <span className="ml-2 bg-primary text-primary-foreground rounded-full w-5 h-5 flex items-center justify-center text-xs">
              !
            </span>
          )}
        </Button>
      </div>

      {/* Filter Panel */}
      <div
        className={`${
          isOpen ? 'block' : 'hidden'
        } md:block space-y-4`}
      >
        <Card className="p-4 md:p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-heading text-lg font-semibold">
              Bộ lọc nâng cao
            </h3>
            {hasActiveFilters && (
              <Button
                variant="ghost"
                size="sm"
                onClick={handleClearAll}
                className="text-sm"
              >
                <X className="h-4 w-4 mr-1" />
                Xóa tất cả
              </Button>
            )}
          </div>

          <div className="space-y-6">
            {/* Active Filters - Badges */}
            {activeFilters.length > 0 && (
              <div>
                <label className="block text-sm font-medium text-text-main mb-2">
                  Bộ lọc đang áp dụng
                </label>
                <div className="flex flex-wrap gap-2">
                  {activeFilters.map((filter) => (
                    <div
                      key={filter.key}
                      className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-pink-50 border border-pink-200 rounded-full text-sm"
                    >
                      <span className="text-text-main">
                        <span className="font-medium">{filter.label}:</span>{' '}
                        {filter.value}
                      </span>
                      <button
                        onClick={() => handleRemoveFilter(filter.key)}
                        className="ml-1 hover:bg-pink-100 rounded-full p-0.5 transition-colors"
                        aria-label={`Xóa bộ lọc ${filter.label}`}
                      >
                        <X className="w-3.5 h-3.5 text-text-muted hover:text-destructive" />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Multiple Categories Filter */}
            <div>
              <label className="block text-sm font-medium text-text-main mb-3">
                Danh mục (có thể chọn nhiều)
              </label>
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {categoriesLoading ? (
                  <div className="text-sm text-text-muted">Đang tải...</div>
                ) : (
                  categories.map((category) => {
                    const isSelected = selectedCategories.includes(
                      category.slug || category.databaseId?.toString() || ''
                    );
                    return (
                      <label
                        key={category.id}
                        className="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-muted transition-colors"
                      >
                        <input
                          type="checkbox"
                          checked={isSelected}
                          onChange={() =>
                            handleCategoryToggle(
                              category.slug || category.databaseId?.toString() || ''
                            )
                          }
                          className="w-4 h-4 rounded border-text-muted"
                        />
                        <span className="text-sm flex-1">
                          {category.name}
                          {category.count !== undefined && (
                            <span className="text-text-muted ml-1">
                              ({category.count})
                            </span>
                          )}
                        </span>
                      </label>
                    );
                  })
                )}
              </div>
            </div>

            {/* Price Range Slider */}
            <div>
              <label className="block text-sm font-medium text-text-main mb-3">
                Khoảng giá
              </label>
              <div className="space-y-4">
                <Slider
                  value={priceRange}
                  onValueChange={handlePriceRangeChange}
                  min={MIN_PRICE}
                  max={MAX_PRICE}
                  step={10000}
                  className="w-full"
                />
                <div className="flex items-center justify-between text-sm">
                  <span className="text-text-muted">
                    {formatPrice(priceRange[0])}
                  </span>
                  <span className="font-medium text-primary px-3 py-1 bg-pink-50 rounded-full">
                    {priceRange[0] > MIN_PRICE || priceRange[1] < MAX_PRICE
                      ? `${formatPrice(priceRange[0])} - ${formatPrice(priceRange[1])}`
                      : 'Tất cả mức giá'}
                  </span>
                  <span className="text-text-muted">
                    {formatPrice(priceRange[1])}
                  </span>
                </div>
              </div>
            </div>

            {/* Material Filter - Button Chips */}
            <div>
              <label className="block text-sm font-medium text-text-main mb-3">
                Chất liệu
              </label>
              {attributesLoading ? (
                <div className="text-sm text-text-muted py-2">Đang tải...</div>
              ) : materialOptions.length === 0 ? (
                <div className="text-sm text-text-muted py-2">Không có tùy chọn</div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {materialOptions.map((option) => {
                  const isSelected = filters.material === option.value;
                  return (
                    <Button
                      key={option.value}
                      type="button"
                      variant={isSelected ? 'default' : 'outline'}
                      size="sm"
                      onClick={() =>
                        updateFilter('material', isSelected ? null : option.value)
                      }
                      className={cn(
                        'min-h-[44px]',
                        isSelected && 'bg-primary text-primary-foreground'
                      )}
                    >
                      {option.label}
                    </Button>
                  );
                  })}
                </div>
              )}
            </div>

            {/* Size Filter - Button Chips */}
            <div>
              <label className="block text-sm font-medium text-text-main mb-3">
                Kích thước
              </label>
              {attributesLoading ? (
                <div className="text-sm text-text-muted py-2">Đang tải...</div>
              ) : sizeOptions.length === 0 ? (
                <div className="text-sm text-text-muted py-2">Không có tùy chọn</div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {sizeOptions.map((option) => {
                  const isSelected = filters.size === option.value;
                  return (
                    <Button
                      key={option.value}
                      type="button"
                      variant={isSelected ? 'default' : 'outline'}
                      size="sm"
                      onClick={() =>
                        updateFilter('size', isSelected ? null : option.value)
                      }
                      className={cn(
                        'min-h-[44px]',
                        isSelected && 'bg-primary text-primary-foreground'
                      )}
                    >
                      {option.label}
                    </Button>
                  );
                  })}
                </div>
              )}
            </div>

            {/* Sort */}
            <div>
              <label className="block text-sm font-medium text-text-main mb-2">
                Sắp xếp
              </label>
              <select
                value={filters.sortBy || ''}
                onChange={(e) =>
                  updateFilter('sortBy', (e.target.value as ProductFiltersType['sortBy']) || null)
                }
                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
              >
                <option value="">Mặc định</option>
                <option value="price_asc">Giá: Thấp đến cao</option>
                <option value="price_desc">Giá: Cao đến thấp</option>
                <option value="name_asc">Tên: A-Z</option>
                <option value="name_desc">Tên: Z-A</option>
                <option value="newest">Mới nhất</option>
              </select>
            </div>
          </div>
        </Card>
      </div>
    </div>
  );
}

================================================================================FILE: components/product/FilterForm.tsx================================================================================'use client';

import { useState, useEffect, useRef, useImperativeHandle, forwardRef } from 'react';
// Using native HTML select for FilterForm
import { Input } from '@/components/ui/input';
import { useProductFilters, type ProductFilters as ProductFiltersType } from '@/lib/hooks/useProductFilters';
import { useCategoriesREST } from '@/lib/hooks/useCategoriesREST';
import { useProductAttributes } from '@/lib/hooks/useProductAttributes';
import { cn } from '@/lib/utils/cn';

interface FilterFormProps {
  className?: string;
  /**
   * Mode: 'auto' = apply ngay khi thay đổi (Desktop), 'manual' = chỉ apply khi nhấn nút (Mobile Sheet)
   */
  mode?: 'auto' | 'manual';
}

export interface FilterFormRef {
  getFilters: () => {
    category?: string;
    minPrice?: number;
    maxPrice?: number;
    material?: string;
    sortBy?: ProductFiltersType['sortBy'];
  };
}

/**
 * FilterForm - Sub-component chứa form lọc sản phẩm
 * Tái sử dụng cho cả Mobile (trong Sheet) và Desktop (trong Sidebar)
 */
export const FilterForm = forwardRef<FilterFormRef, FilterFormProps>(
  ({ className, mode = 'auto' }, ref) => {
  const { filters, updateFilter } = useProductFilters();
  const { categories, loading: categoriesLoading } = useCategoriesREST();
  const { getMaterialOptions, isLoading: attributesLoading } = useProductAttributes();
  
  // Local state cho tất cả filters (dùng khi mode='manual')
  const [localCategory, setLocalCategory] = useState<string>(filters.category || '');
  const [localMinPrice, setLocalMinPrice] = useState<string>(filters.minPrice?.toString() || '');
  const [localMaxPrice, setLocalMaxPrice] = useState<string>(filters.maxPrice?.toString() || '');
  const [localMaterial, setLocalMaterial] = useState<string>(filters.material || '');
  const [localSortBy, setLocalSortBy] = useState<string>(filters.sortBy || '');
  
  // Validation state cho price range
  const [priceError, setPriceError] = useState<string>('');

  // Lấy material options động từ WooCommerce
  const materialOptions = getMaterialOptions();

  // Sync local state với filters từ URL khi filters thay đổi (từ bên ngoài)
  useEffect(() => {
    setLocalCategory(filters.category || '');
    setLocalMinPrice(filters.minPrice?.toString() || '');
    setLocalMaxPrice(filters.maxPrice?.toString() || '');
    setLocalMaterial(filters.material || '');
    setLocalSortBy(filters.sortBy || '');
  }, [filters.category, filters.minPrice, filters.maxPrice, filters.material, filters.sortBy]);

  // Expose getFilters function qua ref để parent component có thể lấy current filter values
  useImperativeHandle(ref, () => ({
    getFilters: () => {
      // Validate price range trước khi return
      const min = localMinPrice ? Number(localMinPrice) : undefined;
      const max = localMaxPrice ? Number(localMaxPrice) : undefined;
      
      if (min !== undefined && max !== undefined && min > max) {
        // Return với error flag để parent component có thể xử lý
        throw new Error('Giá tối thiểu không được lớn hơn giá tối đa');
      }
      
      return {
        category: localCategory || undefined,
        minPrice: min,
        maxPrice: max,
        material: localMaterial || undefined,
        sortBy: (localSortBy as ProductFiltersType['sortBy']) || undefined,
      };
    },
  }), [localCategory, localMinPrice, localMaxPrice, localMaterial, localSortBy]);

  return (
    <div className={`space-y-4 ${className || ''}`}>
      {/* Category Filter */}
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          Danh mục
        </label>
        <select
          value={mode === 'manual' ? localCategory : (filters.category || '')}
          onChange={(e) => {
            if (mode === 'auto') {
              updateFilter('category', e.target.value || null);
            } else {
              setLocalCategory(e.target.value);
            }
          }}
          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
        >
          <option value="">Tất cả danh mục</option>
          {categoriesLoading ? (
            <option disabled>Đang tải...</option>
          ) : (
            categories.map((category) => (
              <option key={category.id} value={category.slug || category.databaseId?.toString()}>
                {category.name} ({category.count || 0})
              </option>
            ))
          )}
        </select>
      </div>

      {/* Price Range */}
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          Khoảng giá
        </label>
        <div className="flex gap-2">
          <Input
            type="number"
            placeholder="Từ"
            value={localMinPrice}
            onChange={(e) => {
              setLocalMinPrice(e.target.value);
              // Validate khi nhập
              const min = e.target.value ? Number(e.target.value) : undefined;
              const max = localMaxPrice ? Number(localMaxPrice) : undefined;
              if (min !== undefined && max !== undefined && min > max) {
                setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
              } else {
                setPriceError('');
              }
            }}
            onBlur={(e) => {
              // Validate trước khi apply
              const min = e.target.value ? Number(e.target.value) : undefined;
              const max = localMaxPrice ? Number(localMaxPrice) : undefined;
              
              if (min !== undefined && max !== undefined && min > max) {
                setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
                return; // Không apply nếu validation fail
              }
              
              setPriceError('');
              // Chỉ update URL khi blur nếu mode='auto' và validation pass
              if (mode === 'auto') {
                updateFilter('priceMin', min ?? null);
                updateFilter('minPrice', min ?? null);
              }
            }}
            className={cn("flex-1", priceError && "border-destructive")}
          />
          <Input
            type="number"
            placeholder="Đến"
            value={localMaxPrice}
            onChange={(e) => {
              setLocalMaxPrice(e.target.value);
              // Validate khi nhập
              const min = localMinPrice ? Number(localMinPrice) : undefined;
              const max = e.target.value ? Number(e.target.value) : undefined;
              if (min !== undefined && max !== undefined && min > max) {
                setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
              } else {
                setPriceError('');
              }
            }}
            onBlur={(e) => {
              // Validate trước khi apply
              const min = localMinPrice ? Number(localMinPrice) : undefined;
              const max = e.target.value ? Number(e.target.value) : undefined;
              
              if (min !== undefined && max !== undefined && min > max) {
                setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
                return; // Không apply nếu validation fail
              }
              
              setPriceError('');
              // Chỉ update URL khi blur nếu mode='auto' và validation pass
              if (mode === 'auto') {
                updateFilter('priceMax', max ?? null);
                updateFilter('maxPrice', max ?? null);
              }
            }}
            className={cn("flex-1", priceError && "border-destructive")}
          />
        </div>
        {priceError && (
          <p className="text-xs text-destructive mt-1">{priceError}</p>
        )}
      </div>

      {/* Material Filter */}
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          Chất liệu
        </label>
        <select
          value={mode === 'manual' ? localMaterial : (filters.material || '')}
          onChange={(e) => {
            if (mode === 'auto') {
              updateFilter('material', e.target.value || null);
            } else {
              setLocalMaterial(e.target.value);
            }
          }}
          disabled={attributesLoading}
          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <option value="">Tất cả</option>
          {attributesLoading ? (
            <option disabled>Đang tải...</option>
          ) : (
            materialOptions.map((material) => (
              <option key={material} value={material}>
                {material}
              </option>
            ))
          )}
        </select>
      </div>

      {/* Sort */}
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          Sắp xếp
        </label>
        <select
          value={mode === 'manual' ? localSortBy : (filters.sortBy || '')}
          onChange={(e) => {
            if (mode === 'auto') {
              updateFilter('sortBy', (e.target.value as ProductFiltersType['sortBy']) || null);
            } else {
              setLocalSortBy(e.target.value);
            }
          }}
          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
        >
          <option value="">Mặc định</option>
          <option value="price_asc">Giá: Thấp đến cao</option>
          <option value="price_desc">Giá: Cao đến thấp</option>
          <option value="name_asc">Tên: A-Z</option>
          <option value="name_desc">Tên: Z-A</option>
          <option value="newest">Mới nhất</option>
        </select>
      </div>
    </div>
  );
  }
);

FilterForm.displayName = 'FilterForm';

================================================================================FILE: components/product/ProductBadges.tsx================================================================================'use client';

interface ProductBadgesProps {
  onSale?: boolean | null;
  featured?: boolean | null;
  isNew?: boolean | null;
}

export function ProductBadges({ onSale, featured, isNew }: ProductBadgesProps) {
  const badges = [];

  if (onSale) {
    badges.push(
      <span
        key="sale"
        className="bg-accent text-accent-foreground text-xs font-semibold px-2 py-1 rounded-full"
      >
        Giảm giá
      </span>
    );
  }

  if (featured) {
    badges.push(
      <span
        key="featured"
        className="bg-primary text-primary-foreground text-xs font-semibold px-2 py-1 rounded-full"
      >
        Nổi bật
      </span>
    );
  }

  if (isNew) {
    badges.push(
      <span
        key="new"
        className="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-full"
      >
        Mới
      </span>
    );
  }

  if (badges.length === 0) {
    return null;
  }

  return (
    <div className="absolute top-2 left-2 flex flex-wrap gap-2 z-10">
      {badges}
    </div>
  );
}

================================================================================FILE: components/product/ProductCard.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Card } from '@/components/ui/card';
import { formatPrice } from '@/lib/utils/format';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { useProductVariations } from '@/lib/hooks/useProductVariations';
import { useVariationMatcher, useSmallestSizeByPrice } from '@/lib/hooks/useVariationMatcher';
import { useProductPrice } from '@/lib/hooks/useProductPrice';
import { isAttributeSize, isAttributeColor } from '@/lib/constants/attributes';
import { cn } from '@/lib/utils/cn';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { ShoppingCart, Check, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { getColorHex } from '@/lib/utils/colorMapping';
import { generateSlug } from '@/lib/utils/slug';
import { useQuickCheckoutStore } from '@/lib/store/useQuickCheckoutStore';

interface ProductCardProps {
  product: MappedProduct;
}

export function ProductCard({ product }: ProductCardProps) {
  const router = useRouter();
  const { addToCart } = useCartSync();
  // State cho việc chọn Size/Màu
  const [selectedSize, setSelectedSize] = useState<string | null>(null);
  const [selectedColor, setSelectedColor] = useState<string | null>(null);
  // State cho loading feedback
  const [isAddingToCart, setIsAddingToCart] = useState(false);
  
  // ============================================
  // LAZY LOADING: Chỉ fetch variations khi cần
  // ============================================
  // Performance Optimization: Thay vì fetch variations cho tất cả products ngay khi page load
  // (có thể gây 40+ API calls đồng thời), chúng ta chỉ fetch khi:
  // 1. User hover vào card → Prefetch để sẵn sàng khi user click size
  // 2. User đã chọn size → Cần để hiển thị giá động
  // 3. Product không có giá bán thường → Cần lấy giá thấp nhất từ variations
  // 
  // Kết quả: Giảm initial API calls từ 40 xuống 0, cải thiện Time to Interactive ~80%
  const [isHovered, setIsHovered] = useState(false);
  
  // Kiểm tra xem product có giá bán thường không
  const hasRegularPrice = useMemo(() => {
    if (!product) return false;
    const price = parseFloat(product.price || '0');
    const regularPrice = parseFloat(product.regularPrice || '0');
    return (price > 0) || (regularPrice > 0);
  }, [product]);
  
  // Fetch variations nếu:
  // 1. User hover vào card (prefetch)
  // 2. User đã chọn size
  // 3. Product không có giá bán thường (cần lấy giá từ variations)
  const shouldFetchVariations = isHovered || selectedSize !== null || !hasRegularPrice;
  
  // Fetch variations nếu product là variable type
  const { variations, isLoading: isLoadingVariations, refetch: refetchVariations } = useProductVariations(
    product?.databaseId,
    { 
      enabled: !!product && product.type === 'variable' && 
               (product.variations?.length || 0) > 0 &&
               shouldFetchVariations
    }
  );
  
  // FIX: Khi user chọn size, đảm bảo variations được fetch ngay nếu chưa có
  useEffect(() => {
    if (selectedSize && product?.type === 'variable' && variations.length === 0 && !isLoadingVariations) {
      refetchVariations();
    }
  }, [selectedSize, product?.type, variations.length, isLoadingVariations, refetchVariations]);
  
  // Auto-select smallest size (lowest price) when variations load
  const smallestSize = useSmallestSizeByPrice(variations);
  
  // Auto-select smallest size when variations load and no size is selected
  useEffect(() => {
    if (product?.type === 'variable' && smallestSize && !selectedSize && !isLoadingVariations && variations.length > 0) {
      setSelectedSize(smallestSize);
    }
  }, [product?.type, smallestSize, selectedSize, isLoadingVariations, variations.length]);
  
  // Use custom hook to find matching variation (replaces duplicate logic)
  const selectedVariation = useVariationMatcher(variations, selectedSize, selectedColor);
  
  // Lấy ảnh hiển thị: ưu tiên ảnh biến thể nếu có, nếu không thì dùng ảnh chính
  const imageUrl = useMemo(() => {
    // Nếu có selectedVariation và variation có ảnh, dùng ảnh variation
    if (selectedVariation?.image) {
      return selectedVariation.image;
    }
    // Fallback về ảnh chính của sản phẩm
    return product?.image?.sourceUrl || '/images/teddy-placeholder.png';
  }, [selectedVariation, product?.image?.sourceUrl]);
  
  // Use custom hook for pricing logic (replaces ~60 lines of duplicate code)
  const { displayPrice, displayRegularPrice, isOnSale, priceRange } = useProductPrice(product, selectedVariation);
  
  // Calculate price range for variable products
  const variablePriceRange = useMemo(() => {
    if (product?.type === 'variable' && variations.length > 0 && !selectedVariation) {
      const prices = variations
        .map((v: { price?: number }) => v.price || 0)
        .filter((p: number) => p > 0);
      
      if (prices.length > 0) {
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        return { min: minPrice, max: maxPrice };
      }
    }
    return null;
  }, [product, variations, selectedVariation]);
  
  // Fallback logic for products without regular price (keep existing behavior)
  const finalDisplayPrice = useMemo(() => {
    // For variable products without selected variation, show price range
    if (product?.type === 'variable' && !selectedVariation && variablePriceRange) {
      if (variablePriceRange.min === variablePriceRange.max) {
        return String(variablePriceRange.min);
      }
      // Will show "Từ X đ" format in UI
      return String(variablePriceRange.min);
    }
    
    const numDisplayPrice = parseFloat(displayPrice || '0');
    
    // If displayPrice is 0 and we have variations, try to get min price
    if (numDisplayPrice <= 0 && variations.length > 0) {
      const prices = variations
        .map((v: { price?: number }) => v.price || 0)
        .filter((p: number) => p > 0);
      
      if (prices.length > 0) {
        return String(Math.min(...prices));
      }
    }
    
    // If still 0 and product has minPrice, use it
    if (numDisplayPrice <= 0 && product?.minPrice && product.minPrice > 0) {
      return String(product.minPrice);
    }
    
    return displayPrice;
  }, [displayPrice, variations, product, selectedVariation, variablePriceRange]);
  
  const finalRegularPrice = displayRegularPrice;
  
  // Extract Size and Color attributes from product using centralized constants
  // This replaces hardcoded string matching with reusable helper functions
  const sizeAttribute = product?.attributes?.find((attr) => isAttributeSize(attr.name));
  const colorAttribute = product?.attributes?.find((attr) => isAttributeColor(attr.name));
  
  // Use real attributes from CMS only (no fallback mock data)
  // If product doesn't have these attributes in CMS, don't show them
  const availableSizes = sizeAttribute?.options || [];
  const availableColors = colorAttribute?.options || [];
  
  // Limit display to 4 sizes and 4 colors (Cập nhật hiển thị tối đa 4)
  const displaySizes = availableSizes.slice(0, 4);
  const displayColors = availableColors.slice(0, 4);
  const remainingColors = availableColors.length - displayColors.length;

  // Build product URL với query params cho selected attributes
  // Format: /products/slug?attribute_pa_size=60cm&attribute_pa_color=do
  const productUrl = useMemo(() => {
    if (!product) return '';
    
    const baseUrl = `/products/${product.slug || product.databaseId}`;
    const params = new URLSearchParams();
    
    // Helper function để tạo slug từ attribute name
    const createAttributeSlug = (name: string): string => {
      return generateSlug(name);
    };
    
    // Thêm size attribute nếu có
    if (selectedSize && sizeAttribute) {
      // WooCommerce format: attribute_pa_{slug}
      // Ví dụ: attribute_pa_size hoặc attribute_pa_kich-thuoc
      const sizeAttrSlug = createAttributeSlug(sizeAttribute.name);
      const attrKey = `attribute_pa_${sizeAttrSlug}`;
      // Encode giá trị size (có thể chứa ký tự đặc biệt)
      params.append(attrKey, selectedSize);
    }
    
    // Thêm color attribute nếu có
    if (selectedColor && colorAttribute) {
      const colorAttrSlug = createAttributeSlug(colorAttribute.name);
      const attrKey = `attribute_pa_${colorAttrSlug}`;
      // Normalize tên màu thành slug (ví dụ: "Đỏ" -> "do", "Hồng" -> "hong")
      const colorValue = createAttributeSlug(selectedColor);
      params.append(attrKey, colorValue);
    }
    
    const queryString = params.toString();
    return queryString ? `${baseUrl}?${queryString}` : baseUrl;
  }, [product, selectedSize, selectedColor, sizeAttribute, colorAttribute]);
  
  // Early return sau khi đã gọi tất cả hooks
  if (!product || !product.name) return null;
  
  const isOutOfStock = product.stockStatus === 'outofstock';

  const handleQuickAdd = async (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    // FIX: Prevent quick add for variable products without variations data
    // This prevents wrong pricing when variations haven't loaded yet (race condition)
    if (product.type === 'variable') {
      // Check if variations are still loading or not available
      if (isLoadingVariations || variations.length === 0) {
        // Redirect to product detail page to select variation properly
        router.push(productUrl);
        return;
      }
      
      // If variations loaded but no variation is selected, redirect to detail page
      if (!selectedVariation) {
        router.push(productUrl);
        return;
      }
    }
    
    // Set loading state
    setIsAddingToCart(true);
    
    try {
    // Sử dụng giá của variation nếu có, nếu không thì dùng giá product
    // MongoVariant structure: { id, size, color, price (number), stock, ... }
    let priceToUse: string;
    if (selectedVariation) {
      // MongoVariant chỉ có price (number), không có on_sale/sale_price/regular_price
      priceToUse = String(selectedVariation.price || 0);
    } else {
        // Use product price (string) for simple products
      priceToUse = product.onSale ? product.salePrice : product.price;
    }
    
    await addToCart({
      productId: typeof product.databaseId === 'string' ? parseInt(product.databaseId, 10) : product.databaseId,
      productName: `${product.name} ${selectedSize ? `(${selectedSize})` : ''}`,
      price: priceToUse || '0',
      image: product.image?.sourceUrl,
      quantity: 1,
      variationId: selectedVariation?.id ? (typeof selectedVariation.id === 'number' ? selectedVariation.id : parseInt(selectedVariation.id, 10) || undefined) : undefined,
      length: product.length || undefined,
      width: product.width || undefined,
      height: product.height || undefined,
      weight: product.weight ? parseFloat(product.weight) : undefined,
      volumetricWeight: product.volumetricWeight || undefined,
    });

    // Mở QuickCheckoutModal sau khi thêm vào giỏ
    try {
      useQuickCheckoutStore.getState().onOpen();
      } catch (error) {
        console.error('[ProductCard] Error opening QuickCheckoutModal:', error);
      }
    } catch (error) {
      console.error('[ProductCard] Error adding to cart:', error);
    } finally {
      // Reset loading state after a short delay for better UX
      setTimeout(() => {
        setIsAddingToCart(false);
      }, 500);
    }
  };

  return (
    <div 
      className="group relative flex flex-col gap-2 bg-white rounded-2xl p-2 md:p-3 hover:shadow-lg transition-all duration-300 border border-transparent hover:border-pink-100"
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      {/* 1. Product Image Area */}
      <Link href={productUrl} className="relative aspect-square w-full overflow-hidden rounded-xl bg-gray-50">
        <Image
          src={imageUrl}
          alt={product.image?.altText || product.name}
          fill
          className="object-cover transition-transform duration-500 group-hover:scale-110"
          sizes="(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
        />
        
        {/* Badges */}
        <div className="absolute top-2 left-2 flex flex-col gap-1">
          {isOnSale && (
            <span className="bg-red-500 text-white text-[10px] md:text-xs font-bold px-2 py-1 rounded-full shadow-sm">
              Sale
            </span>
          )}
          {/* Logo Brand nhỏ (như ảnh mẫu GOMI) */}
          <div className="bg-white/90 p-1 rounded-full shadow-sm w-6 h-6 flex items-center justify-center">
            <span className="text-[8px] font-extrabold text-pink-500">GB</span>
          </div>
        </div>

        {/* Quick Add Button (Hiện khi hover - Desktop) */}
        {/* Sử dụng Button component với variant default để có gradient effect đồng bộ */}
        <Button
          onClick={handleQuickAdd}
          size="icon"
          disabled={isAddingToCart || isOutOfStock}
          className={cn(
            "absolute bottom-2 right-2 h-10 w-10 md:h-12 md:w-12 rounded-full shadow-md translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300",
            isAddingToCart && "cursor-not-allowed opacity-50"
          )}
          title={isAddingToCart ? "Đang thêm..." : "Thêm nhanh vào giỏ"}
          aria-label={isAddingToCart ? "Đang thêm vào giỏ" : "Thêm nhanh vào giỏ"}
        >
          {isAddingToCart ? (
            <Loader2 className="w-4 h-4 md:w-5 md:h-5 animate-spin" />
          ) : (
          <ShoppingCart className="w-4 h-4 md:w-5 md:h-5" />
          )}
        </Button>
      </Link>

      {/* 2. Content Area */}
      <div className="flex flex-col gap-1">
        {/* Tên sản phẩm */}
        <Link href={productUrl}>
          <h3 className="font-heading text-sm md:text-base font-bold text-gray-700 line-clamp-2 min-h-[2.5rem] group-hover:text-pink-600 transition-colors">
            {product.name}
          </h3>
        </Link>

        {/* Giá tiền - Style giống ảnh mẫu (Màu hồng đậm/đỏ) với Skeleton Loading */}
        <div className="flex items-center gap-2 min-h-[28px]">
            {isLoadingVariations ? (
            // Skeleton loading: animate pulse effect cho vùng giá
            <div className="flex items-center gap-2 animate-pulse">
              <div className="h-5 md:h-6 bg-gray-200 rounded w-20"></div>
              <div className="h-4 bg-gray-200 rounded w-16"></div>
            </div>
          ) : (
            <>
              {product?.type === 'variable' && !selectedVariation && variablePriceRange && variablePriceRange.min !== variablePriceRange.max ? (
                // Show price range for variable products without selection
                <span className="text-base md:text-lg font-extrabold text-[#D6336C]">
                  Từ {formatPrice(String(variablePriceRange.min))}
                </span>
              ) : (
                <>
                  <span className="text-base md:text-lg font-extrabold text-[#D6336C]">
                    {formatPrice(finalDisplayPrice)}
                  </span>
                  {isOnSale && finalRegularPrice && finalRegularPrice !== finalDisplayPrice && (
                    <span className="text-xs text-gray-400 line-through">
                      {formatPrice(finalRegularPrice)}
                    </span>
                  )}
                </>
              )}
            </>
          )}
        </div>

        {/* 3. Variants Selection (Size Tabs) - Style GOMI Compact với kích thước vừa phải */}
        {displaySizes.length > 0 && (
          <div className="flex flex-wrap gap-1.5 mt-2">
            {displaySizes.map((size, idx) => (
              <button
                key={idx}
                onClick={(e) => {
                  e.preventDefault();
                  setSelectedSize(size);
                }}
                className={cn(
                  // STYLE CHUẨN GOMI với kích thước vừa phải:
                  // 1. Text size nhỏ vừa (10px), font medium
                  // 2. Padding vừa phải (px-2 py-0.75)
                  // 3. Border mỏng, bo góc nhẹ (rounded-sm)
                  // 4. Min height vừa phải để đảm bảo touch target
                  "text-[10px] md:text-xs font-medium px-2 py-0.75 rounded-sm border transition-all",
                  "min-h-[32px] touch-manipulation",
                  "flex items-center justify-center",
                  
                  // Trạng thái Active (Đã chọn)
                  selectedSize === size
                    ? "border-[#D6336C] bg-pink-50 text-[#D6336C]" // Viền hồng đậm, nền hồng nhạt, chữ hồng
                    : "border-gray-200 bg-white text-gray-500 hover:border-pink-300 hover:text-pink-500" // Mặc định xám nhạt
                )}
              >
                {size}
              </button>
            ))}
          </div>
        )}

        {/* 4. Color Selection (Dots) - Cập nhật logic hiển thị */}
        {displayColors.length > 0 && (
          <div className="flex gap-1.5 mt-1 items-center">
            {displayColors.map((colorName, idx) => {
              // Chuẩn hóa tên màu để tìm trong Map (chuyển về chữ thường, bỏ khoảng trắng thừa)
              const lookupKey = colorName.toLowerCase().trim();
              
              // Lấy mã Hex từ Map, nếu không thấy thì thử dùng chính nó (nếu là mã Hex), hoặc fallback về xám
              const bgColor = getColorHex(colorName) || (colorName.startsWith('#') ? colorName : '#E5E7EB');
              const isSelected = selectedColor === colorName;
              
              return (
                <button
                  key={idx}
                  className={cn(
                    "relative w-6 h-6 rounded-full border-2 shadow-sm hover:scale-110 transition-transform",
                    // Thêm viền xám cho tất cả màu để dễ nhìn hơn
                    ['#FFFFFF', '#FDFBF7', 'trang', 'kem'].includes(lookupKey) || lookupKey === 'trắng' || lookupKey === 'kem'
                      ? "border-gray-400" 
                      : "border-gray-300"
                  )}
                  style={{ backgroundColor: bgColor }}
                  title={`Màu: ${colorName}`}
                  onClick={(e) => {
                    e.preventDefault();
                    setSelectedColor(colorName);
                  }}
                >
                  {/* Dấu tích màu hồng với viền trắng mỏng khi được chọn */}
                  {isSelected && (
                    <div className="absolute inset-0 flex items-center justify-center">
                      <div className="w-4 h-4 rounded-full bg-pink-500 flex items-center justify-center border border-white">
                        <Check className="w-2.5 h-2.5 text-white" strokeWidth={3} />
                      </div>
                    </div>
                  )}
                </button>
              );
            })}
            {/* Hiển thị số lượng màu còn lại nếu có */}
            {remainingColors > 0 && (
              <span className="text-[10px] text-gray-400">+{remainingColors}</span>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
================================================================================FILE: components/product/ProductDescription.tsx================================================================================'use client';

import { useState, useRef, useEffect } from 'react';
import { cn } from '@/lib/utils/cn';
import { Button } from '@/components/ui/button';
import { ChevronDown, ChevronUp } from 'lucide-react';
import { sanitizeHtml } from '@/lib/utils/sanitizeHtml';

interface ProductDescriptionProps {
  content: string;
  className?: string;
  maxHeight?: number; // Max height in pixels when collapsed (default: 300)
}

export function ProductDescription({ 
  content, 
  className,
  maxHeight = 300 
}: ProductDescriptionProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [needsExpandButton, setNeedsExpandButton] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);

  // Check if content exceeds maxHeight
  useEffect(() => {
    if (contentRef.current && !isExpanded) {
      const height = contentRef.current.scrollHeight;
      setNeedsExpandButton(height > maxHeight);
    }
  }, [content, maxHeight, isExpanded]);

  if (!content || !content.trim()) {
    return null;
  }

  return (
    <div className={cn('bg-white rounded-2xl p-4 md:p-6', className)}>
      <h3 className="font-heading text-lg font-semibold mb-4 text-text-main">
        Mô tả sản phẩm
      </h3>
      
      <div className="relative">
        {/* Content Container */}
        <div
          ref={contentRef}
          className={cn(
            'overflow-hidden transition-all duration-300 ease-in-out',
            !isExpanded && needsExpandButton ? `max-h-[${maxHeight}px]` : 'max-h-none'
          )}
          style={{
            maxHeight: !isExpanded && needsExpandButton ? `${maxHeight}px` : 'none',
          }}
        >
          {/* HTML Content with Typography Plugin */}
          {/* Sanitized to prevent XSS attacks */}
          <div
            className="prose prose-sm md:prose-base max-w-none prose-headings:font-heading prose-headings:text-text-main prose-p:text-text-main prose-p:leading-relaxed prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-strong:text-text-main prose-strong:font-semibold prose-ul:text-text-main prose-ol:text-text-main prose-li:text-text-main prose-img:rounded-lg prose-img:max-w-full prose-img:h-auto prose-img:my-4 prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg"
            dangerouslySetInnerHTML={{ __html: sanitizeHtml(content) }}
          />
        </div>

        {/* Gradient Fade Effect (only when collapsed and needs expand) */}
        {!isExpanded && needsExpandButton && (
          <div 
            className="absolute bottom-0 left-0 right-0 h-20 pointer-events-none"
            style={{
              background: 'linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1))',
            }}
          />
        )}
      </div>

      {/* Expand/Collapse Button */}
      {needsExpandButton && (
        <div className="flex justify-center mt-4">
          <Button
            variant="outline"
            onClick={() => setIsExpanded(!isExpanded)}
            className="border-pink-200 text-primary hover:bg-pink-50 hover:border-pink-300 min-h-[44px] px-6"
            aria-expanded={isExpanded}
            aria-label={isExpanded ? 'Thu gọn mô tả' : 'Xem thêm mô tả'}
          >
            {isExpanded ? (
              <>
                <ChevronUp className="w-4 h-4 mr-2" />
                Thu gọn
              </>
            ) : (
              <>
                <ChevronDown className="w-4 h-4 mr-2" />
                Xem thêm
              </>
            )}
          </Button>
        </div>
      )}
    </div>
  );
}

================================================================================FILE: components/product/ProductFilters.tsx================================================================================'use client';

import { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
  SheetFooter,
} from '@/components/ui/sheet';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Input } from '@/components/ui/input';
import { useProductFilters } from '@/lib/hooks/useProductFilters';
import { useProductAttributes } from '@/lib/hooks/useProductAttributes';
import { FilterForm, type FilterFormRef } from './FilterForm';
import {
  Filter,
  ChevronDown,
  Sparkles,
  ArrowDownWideNarrow,
  ArrowUpNarrowWide,
  Crown,
  Percent,
  DollarSign,
  Ruler,
  Palette,
  X,
  Check,
} from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { formatPrice } from '@/lib/utils/format';
import { getColorHex } from '@/lib/utils/colorMapping';

export function ProductFilters() {
  const { filters, updateFilter, clearFilters } = useProductFilters();
  const { getSizeOptions, getColorOptions, isLoading: attributesLoading } = useProductAttributes();
  const [isSheetOpen, setIsSheetOpen] = useState(false);
  
  // --- STATE CHO DESKTOP ---
  const [pricePopoverOpen, setPricePopoverOpen] = useState(false);
  const [sizePopoverOpen, setSizePopoverOpen] = useState(false);
  const [colorPopoverOpen, setColorPopoverOpen] = useState(false);
  
  // --- STATE RIÊNG CHO MOBILE ---
  const [mobilePriceOpen, setMobilePriceOpen] = useState(false);
  const [mobileSizeOpen, setMobileSizeOpen] = useState(false);
  const [mobileColorOpen, setMobileColorOpen] = useState(false);

  
  // Local state cho giá trong Popover để tránh spam URL khi gõ
  const [localMinPrice, setLocalMinPrice] = useState<string>(filters.minPrice?.toString() || '');
  const [localMaxPrice, setLocalMaxPrice] = useState<string>(filters.maxPrice?.toString() || '');
  const [priceError, setPriceError] = useState<string>('');

  // Sync local state với filters từ URL khi filters thay đổi (từ bên ngoài)
  useEffect(() => {
    setLocalMinPrice(filters.minPrice?.toString() || '');
    setLocalMaxPrice(filters.maxPrice?.toString() || '');
    setPriceError(''); // Clear error khi sync từ URL
  }, [filters.minPrice, filters.maxPrice]);

  // Lấy size và color options động từ WooCommerce
  const sizeOptions = getSizeOptions();
  const colorOptions = getColorOptions();

  const hasActiveFilters = 
    filters.category || 
    filters.minPrice || 
    filters.maxPrice || 
    filters.material ||
    filters.size ||
    filters.color ||
    filters.sortBy;

  // Đếm số lượng filter đang active
  const activeFiltersCount = [
    filters.category,
    filters.minPrice,
    filters.maxPrice,
    filters.material,
    filters.size,
    filters.color,
    filters.sortBy,
  ].filter(Boolean).length;

  // Active filters for display as badges (excluding sortBy)
  const activeFilters = (() => {
    const active: Array<{ key: string; label: string; value: string; onRemove: () => void }> = [];
    
    if (filters.color) {
      active.push({
        key: 'color',
        label: 'Màu',
        value: filters.color,
        onRemove: () => updateFilter('color', null),
      });
    }
    
    if (filters.size) {
      active.push({
        key: 'size',
        label: 'Kích thước',
        value: filters.size,
        onRemove: () => updateFilter('size', null),
      });
    }
    
    if (filters.minPrice || filters.maxPrice) {
      const priceLabel = filters.minPrice && filters.maxPrice
        ? `${formatPrice(filters.minPrice)} - ${formatPrice(filters.maxPrice)}`
        : filters.minPrice
        ? `Từ ${formatPrice(filters.minPrice)}`
        : `Đến ${formatPrice(filters.maxPrice!)}`;
      active.push({
        key: 'price',
        label: 'Giá',
        value: priceLabel,
        onRemove: () => {
          // Clear tất cả price filters
          // Gọi updateFilter cho priceMin sẽ trigger clear cả minPrice, priceMax, maxPrice trong logic
          updateFilter('priceMin', null);
          updateFilter('priceMax', null);
          setLocalMinPrice('');
          setLocalMaxPrice('');
        },
      });
    }
    
    if (filters.material) {
      active.push({
        key: 'material',
        label: 'Chất liệu',
        value: filters.material,
        onRemove: () => updateFilter('material', null),
      });
    }
    
    if (filters.category) {
      active.push({
        key: 'category',
        label: 'Danh mục',
        value: filters.category.includes(',') && filters.category.split(',').length > 1 
          ? `${filters.category.split(',').length} danh mục`
          : filters.category,
        onRemove: () => {
          updateFilter('category', null);
        },
      });
    }
    
    return active;
  })();

  // Sort options
  const sortOptions = [
    { value: 'newest', label: 'Mới nhất', icon: Sparkles },
    { value: 'price_desc', label: 'Giá cao - thấp', icon: ArrowDownWideNarrow },
    { value: 'price_asc', label: 'Giá thấp - cao', icon: ArrowUpNarrowWide },
    { value: 'hot', label: 'Khuyến mãi hot', icon: Percent },
    { value: 'bestseller', label: 'Bán chạy nhất', icon: Crown },
  ];

  // Size và Color options được lấy động từ WooCommerce attributes
  // Format: { value: string, label: string } để tương thích với code hiện tại
  const sizeOptionsFormatted = sizeOptions.map(size => ({
    value: size,
    label: size,
  }));

  const colorOptionsFormatted = colorOptions.map(color => ({
    value: color,
    label: color,
  }));

  const handlePriceApply = () => {
    // Validate trước khi apply
    const min = localMinPrice ? Number(localMinPrice) : undefined;
    const max = localMaxPrice ? Number(localMaxPrice) : undefined;
    
    if (min !== undefined && max !== undefined && min > max) {
      setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
      return; // Không apply nếu validation fail
    }
    
    setPriceError('');
    // Update URL khi nhấn "Áp dụng"
    updateFilter('priceMin', min ?? null);
    updateFilter('minPrice', min ?? null);
    updateFilter('priceMax', max ?? null);
    updateFilter('maxPrice', max ?? null);
    // Đóng cả 2 Popover (Desktop và Mobile)
    setPricePopoverOpen(false);
    setMobilePriceOpen(false);
  };

  const handleSizeSelect = (size: string) => {
    updateFilter('size', filters.size === size ? null : size);
    // Đóng cả 2 Popover (Desktop và Mobile)
    setSizePopoverOpen(false);
    setMobileSizeOpen(false);
  };

  const handleColorSelect = (color: string) => {
    updateFilter('color', filters.color === color ? null : color);
    // Đóng cả 2 Popover (Desktop và Mobile)
    setColorPopoverOpen(false);
    setMobileColorOpen(false);
  };

  // Ref để lấy current filter values từ FilterForm (khi mode='manual')
  const filterFormRef = useRef<FilterFormRef>(null);

  const handleApplyFilters = () => {
    if (filterFormRef.current) {
      const filtersToApply = filterFormRef.current.getFilters();
      Object.entries(filtersToApply).forEach(([key, value]) => {
        updateFilter(key as keyof typeof filters, value);
      });
      setIsSheetOpen(false);
    }
  };

  return (
    <>
      {/* Mobile: Horizontal Scrolling Bar (1 dòng duy nhất) - CHỈ hiển thị trên mobile */}
      <div className="lg:hidden sticky top-[64px] z-40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80 border-b border-border/40">
        <div 
          className="flex flex-row items-center gap-2 overflow-x-auto scrollbar-hide py-2 flex-nowrap -mx-4 px-4 overflow-y-visible" 
          style={{ isolation: 'isolate' }}
          onTouchStart={(e) => {
            // Prevent scroll when clicking on buttons
            const target = e.target as HTMLElement;
            if (target.closest('button')) {
              e.stopPropagation();
            }
          }}
        >
          {/* Nút Lọc cố định bên trái */}
          <div className="flex-shrink-0">
            <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
              <SheetTrigger asChild>
                <Button
                  variant="outline"
                  className="rounded-full gap-1.5 h-8 px-3 border-border/60 hover:border-primary/50 text-xs"
                >
                  <Filter className="w-3.5 h-3.5" />
                  <span>Lọc</span>
                  {hasActiveFilters && (
                    <span className="ml-0.5 bg-primary text-primary-foreground rounded-full min-w-[16px] h-4 px-1 flex items-center justify-center text-[10px] font-semibold">
                      {activeFiltersCount}
                    </span>
                  )}
                </Button>
              </SheetTrigger>
              <SheetContent side="left" className="w-[85vw] sm:max-w-sm overflow-y-auto">
                <SheetHeader>
                  <SheetTitle className="text-left font-heading">
                    Bộ lọc sản phẩm
                  </SheetTitle>
                </SheetHeader>

                <div className="mt-6">
                  <FilterForm 
                    ref={filterFormRef}
                    mode="manual"
                  />
                </div>

                <SheetFooter className="flex-col gap-2 sm:flex-row mt-8 pb-4 border-t pt-4">
                  {hasActiveFilters && (
                    <Button
                      variant="outline"
                      className="w-full sm:w-auto"
                      onClick={() => {
                        clearFilters();
                        setIsSheetOpen(false);
                      }}
                    >
                      <X className="w-4 h-4 mr-2" />
                      Xóa bộ lọc
                    </Button>
                  )}
                  <Button
                    className="w-full sm:w-auto"
                    onClick={handleApplyFilters}
                  >
                    Áp dụng
                  </Button>
                </SheetFooter>
              </SheetContent>
            </Sheet>
          </div>
          
          {/* Divider */}
          <div className="flex-shrink-0 w-px h-6 bg-border/60" />
          
          {/* Các nút scrollable */}
          <div className="flex flex-row items-center gap-2 flex-nowrap">

            {/* Nút Giá bán - Popover - MOBILE */}
            <Popover 
              open={mobilePriceOpen} 
              onOpenChange={setMobilePriceOpen}
              modal={false}
            >
              <PopoverTrigger asChild>
                <button
                  type="button"
                  className={cn(
                    "inline-flex items-center justify-center gap-1.5 h-8 px-3 rounded-full border text-xs flex-shrink-0 touch-manipulation transition-colors",
                    "border-border/60 hover:border-primary/50 bg-background hover:bg-accent",
                    (filters.minPrice || filters.maxPrice) && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <DollarSign className="w-3.5 h-3.5" />
                  <span>Giá</span>
                  {(filters.minPrice || filters.maxPrice) && (
                    <span className="text-[10px]">•</span>
                  )}
                  <ChevronDown className="w-3 h-3" />
                </button>
              </PopoverTrigger>
              <PopoverContent 
                className="w-80 z-[100]" 
                align="start" 
                side="bottom"
                sideOffset={8}
                onOpenAutoFocus={(e) => {
                  // Prevent auto focus from closing popover
                  e.preventDefault();
                }}
                onPointerDownOutside={(e) => {
                  const target = e.target as HTMLElement;
                  // Don't close if clicking inside PopoverContent or on trigger
                  if (target.closest('button[data-radix-popover-trigger]') || 
                      target.closest('[data-radix-popover-content]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
                onInteractOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  
                  // Check if click is inside PopoverContent itself
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  
                  // Don't close if clicking on trigger button
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
              >
                <div className="space-y-3">
                  {/* Header với nút đóng - MOBILE */}
                  <div className="flex items-center justify-between">
                    <h5 className="font-semibold text-sm text-text-main">Khoảng giá</h5>
                    <button
                      type="button"
                      onClick={() => setMobilePriceOpen(false)}
                      className="ml-auto p-1.5 rounded-full hover:bg-muted transition-colors touch-manipulation"
                      aria-label="Đóng"
                    >
                      <X className="w-4 h-4 text-text-muted" />
                    </button>
                  </div>
                
                {/* Price Presets */}
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => {
                      setLocalMinPrice('');
                      setLocalMaxPrice('200000');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMaxPrice === '200000' && !localMinPrice
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    Dưới 200k
                  </button>
                  <button
                    onClick={() => {
                      setLocalMinPrice('200000');
                      setLocalMaxPrice('500000');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMinPrice === '200000' && localMaxPrice === '500000'
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    200k - 500k
                  </button>
                  <button
                    onClick={() => {
                      setLocalMinPrice('500000');
                      setLocalMaxPrice('1000000');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMinPrice === '500000' && localMaxPrice === '1000000'
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    500k - 1tr
                  </button>
                  <button
                    onClick={() => {
                      setLocalMinPrice('1000000');
                      setLocalMaxPrice('');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMinPrice === '1000000' && !localMaxPrice
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    Trên 1tr
                  </button>
                </div>
                
                <div className="flex gap-2">
                  <Input
                    type="number"
                    placeholder="Từ"
                    value={localMinPrice}
                    onChange={(e) => {
                      setLocalMinPrice(e.target.value);
                      // Validate khi nhập
                      const min = e.target.value ? Number(e.target.value) : undefined;
                      const max = localMaxPrice ? Number(localMaxPrice) : undefined;
                      if (min !== undefined && max !== undefined && min > max) {
                        setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
                      } else {
                        setPriceError('');
                      }
                    }}
                    className={cn("flex-1", priceError && "border-destructive")}
                  />
                  <Input
                    type="number"
                    placeholder="Đến"
                    value={localMaxPrice}
                    onChange={(e) => {
                      setLocalMaxPrice(e.target.value);
                      // Validate khi nhập
                      const min = localMinPrice ? Number(localMinPrice) : undefined;
                      const max = e.target.value ? Number(e.target.value) : undefined;
                      if (min !== undefined && max !== undefined && min > max) {
                        setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
                      } else {
                        setPriceError('');
                      }
                    }}
                    className={cn("flex-1", priceError && "border-destructive")}
                  />
                </div>
                {priceError && (
                  <p className="text-xs text-destructive">{priceError}</p>
                )}
                {(localMinPrice || localMaxPrice) && !priceError && (
                  <div className="text-xs text-text-muted">
                    {localMinPrice && localMaxPrice
                      ? `${formatPrice(Number(localMinPrice))} - ${formatPrice(Number(localMaxPrice))}`
                      : localMinPrice
                      ? `Từ ${formatPrice(Number(localMinPrice))}`
                      : `Đến ${formatPrice(Number(localMaxPrice))}`}
                  </div>
                )}
                <div className="flex gap-2 pt-2">
                  <Button
                    variant="outline"
                    size="sm"
                    className="flex-1"
                    onClick={() => {
                      setLocalMinPrice('');
                      setLocalMaxPrice('');
                      setPriceError('');
                      updateFilter('priceMin', null);
          updateFilter('minPrice', null);
          updateFilter('priceMax', null);
          updateFilter('maxPrice', null);
                      // Đóng cả 2 Popover (Desktop và Mobile)
                      setPricePopoverOpen(false);
                      setMobilePriceOpen(false);
                    }}
                  >
                    Xóa
                  </Button>
                  <Button
                    size="sm"
                    className="flex-1"
                    onClick={() => {
                      handlePriceApply();
                      setMobilePriceOpen(false); // Đóng mobile popover
                    }}
                    disabled={!!priceError}
                  >
                    Áp dụng
                  </Button>
                </div>
              </div>
              </PopoverContent>
            </Popover>

            {/* Nút Kích thước - Popover - MOBILE */}
            <Popover 
              open={mobileSizeOpen} 
              onOpenChange={setMobileSizeOpen}
              modal={false}
            >
              <PopoverTrigger asChild>
                <button
                  type="button"
                  className={cn(
                    "inline-flex items-center justify-center gap-1.5 h-8 px-3 rounded-full border text-xs flex-shrink-0 touch-manipulation transition-colors",
                    "border-border/60 hover:border-primary/50 bg-background hover:bg-accent",
                    filters.size && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Ruler className="w-3.5 h-3.5" />
                  <span>Size</span>
                  {filters.size && (
                    <span className="text-[10px]">•</span>
                  )}
                  <ChevronDown className="w-3 h-3" />
                </button>
              </PopoverTrigger>
              <PopoverContent 
                className="w-64 z-[100]" 
                align="start" 
                side="bottom"
                sideOffset={8}
                onOpenAutoFocus={(e) => {
                  e.preventDefault();
                }}
                onPointerDownOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // Don't close if clicking inside PopoverContent or on trigger
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
                onInteractOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // CRITICAL: Check if click is inside PopoverContent itself
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  // Don't close if clicking on trigger button
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
              >
                <div className="space-y-3">
                  {/* Header với nút đóng - MOBILE */}
                  <div className="flex items-center justify-between">
                    <h5 className="font-semibold text-sm text-text-main">Chọn kích thước</h5>
                    <button
                      type="button"
                      onClick={() => setMobileSizeOpen(false)}
                      className="ml-auto p-1.5 rounded-full hover:bg-muted transition-colors touch-manipulation"
                      aria-label="Đóng"
                    >
                      <X className="w-4 h-4 text-text-muted" />
                    </button>
                  </div>
                {attributesLoading ? (
                  <div className="text-sm text-text-muted py-4 text-center">Đang tải...</div>
                ) : sizeOptionsFormatted.length === 0 ? (
                  <div className="text-sm text-text-muted py-4 text-center">Không có tùy chọn</div>
                ) : (
                  <div className="grid grid-cols-2 gap-2">
                    {sizeOptionsFormatted.map((option) => {
                      const isSelected = filters.size === option.value;
                      // Map size labels to cm ranges
                      const sizeCmMap: Record<string, string> = {
                        'Nhỏ': '< 30cm',
                        'Vừa': '30-50cm',
                        'Lớn': '50-80cm',
                        'Rất lớn': '> 80cm',
                      };
                      const sizeCm = sizeCmMap[option.label] || '';
                      return (
                        <button
                          key={option.value}
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            handleSizeSelect(option.value);
                            setMobileSizeOpen(false); // Đóng mobile popover
                          }}
                          className={cn(
                            "text-left px-3 py-2 rounded-sm border transition-colors",
                            isSelected
                              ? "border-primary bg-pink-50 text-primary font-medium"
                              : "border-border hover:border-primary/50 hover:bg-muted/50"
                          )}
                        >
                          <div className="font-medium">{option.label}</div>
                          {sizeCm && (
                            <div className="text-xs text-text-muted mt-0.5">{sizeCm}</div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
                {filters.size && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={() => {
                      updateFilter('size', null);
                      // Đóng cả 2 Popover (Desktop và Mobile)
                      setSizePopoverOpen(false);
                      setMobileSizeOpen(false);
                    }}
                  >
                    Xóa lọc
                  </Button>
                )}
              </div>
              </PopoverContent>
            </Popover>

            {/* Nút Màu sắc - Popover - MOBILE */}
            <Popover 
              open={mobileColorOpen} 
              onOpenChange={setMobileColorOpen}
              modal={false}
            >
              <PopoverTrigger asChild>
                <button
                  type="button"
                  className={cn(
                    "inline-flex items-center justify-center gap-1.5 h-8 px-3 rounded-full border text-xs flex-shrink-0 touch-manipulation transition-colors",
                    "border-border/60 hover:border-primary/50 bg-background hover:bg-accent",
                    filters.color && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Palette className="w-3.5 h-3.5" />
                  <span>Màu</span>
                  {filters.color && (
                    <span className="text-[10px]">•</span>
                  )}
                  <ChevronDown className="w-3 h-3" />
                </button>
              </PopoverTrigger>
              <PopoverContent 
                className="w-72 z-[100]" 
                align="start" 
                side="bottom"
                sideOffset={8}
                onOpenAutoFocus={(e) => {
                  e.preventDefault();
                }}
                onPointerDownOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // Don't close if clicking inside PopoverContent or on trigger
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
                onInteractOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // CRITICAL: Check if click is inside PopoverContent itself
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  // Don't close if clicking on trigger button
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
              >
                <div className="space-y-3">
                  {/* Header với nút đóng - MOBILE */}
                  <div className="flex items-center justify-between">
                    <h5 className="font-semibold text-sm text-text-main">Chọn màu sắc</h5>
                    <button
                      type="button"
                      onClick={() => setMobileColorOpen(false)}
                      className="ml-auto p-1.5 rounded-full hover:bg-muted transition-colors touch-manipulation"
                      aria-label="Đóng"
                    >
                      <X className="w-4 h-4 text-text-muted" />
                    </button>
                  </div>
                {attributesLoading ? (
                  <div className="text-sm text-text-muted py-4 text-center">Đang tải...</div>
                ) : colorOptionsFormatted.length === 0 ? (
                  <div className="text-sm text-text-muted py-4 text-center">Không có tùy chọn</div>
                ) : (
                  <div className="grid grid-cols-6 gap-3">
                    {colorOptionsFormatted.map((option) => {
                      const isSelected = filters.color === option.value;
                      const colorHex = getColorHex(option.value) || '#E5E7EB'; // Fallback to gray
                      return (
                        <button
                          key={option.value}
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            handleColorSelect(option.value);
                            setMobileColorOpen(false); // Đóng mobile popover
                          }}
                          className={cn(
                            "relative w-8 h-8 rounded-full transition-all",
                            "border-2 border-transparent",
                            isSelected
                              ? "ring-2 ring-offset-2 ring-primary ring-offset-white"
                              : "hover:ring-2 hover:ring-offset-2 hover:ring-primary/30 hover:ring-offset-white"
                          )}
                          style={{ backgroundColor: colorHex }}
                          title={option.label}
                          aria-label={option.label}
                        >
                          {isSelected && (
                            <div className="absolute inset-0 flex items-center justify-center">
                              <Check className="w-4 h-4 text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.5)]" />
                            </div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
                {filters.color && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={() => {
                      updateFilter('color', null);
                      // Đóng cả 2 Popover (Desktop và Mobile)
                      setColorPopoverOpen(false);
                      setMobileColorOpen(false);
                    }}
                  >
                    Xóa lọc
                  </Button>
                )}
              </div>
              </PopoverContent>
            </Popover>
            
            {/* Sort Options - Mobile */}
            {sortOptions.map((option) => {
              const Icon = option.icon;
              const isSelected = filters.sortBy === option.value || 
                (!filters.sortBy && option.value === 'newest');
              const actualSelected = filters.sortBy === option.value;
              
              return (
                <button
                  key={option.value}
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (actualSelected) {
                      updateFilter('sortBy', null);
                    } else {
                      let sortValue: 'price_asc' | 'price_desc' | 'name_asc' | 'name_desc' | 'newest' | undefined;
                      if (option.value === 'hot' || option.value === 'bestseller') {
                        sortValue = 'newest';
                      } else {
                        sortValue = option.value as typeof sortValue;
                      }
                      updateFilter('sortBy', sortValue);
                    }
                  }}
                  className={cn(
                    "flex items-center gap-1 px-2.5 h-8 rounded-full border whitespace-nowrap transition-all flex-shrink-0 text-xs touch-manipulation",
                    isSelected
                      ? "border-primary bg-pink-50 text-primary font-medium"
                      : "border-border/60 bg-white text-text-muted hover:border-primary/50 hover:text-text-main"
                  )}
                >
                  <Icon className="w-3.5 h-3.5 flex-shrink-0" />
                  <span>{option.label}</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* Desktop: Layout cũ (giữ nguyên) - CHỈ hiển thị trên desktop */}
      <div className="hidden lg:block w-full space-y-4 mb-4">
        {/* Dòng 1: Chọn theo tiêu chí (Filter Group) */}
        <div className="space-y-2">
          <h4 className="text-sm font-semibold text-text-main">Chọn theo tiêu chí</h4>
          <div className="flex flex-row flex-wrap gap-2">
            {/* Nút Giá bán - Popover */}
            <Popover open={pricePopoverOpen} onOpenChange={setPricePopoverOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "rounded-md gap-2 h-9 border-border/60 hover:border-primary/50",
                    (filters.minPrice || filters.maxPrice) && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <DollarSign className="w-4 h-4" />
                  <span>Giá bán</span>
                  {(filters.minPrice || filters.maxPrice) && (
                    <span className="text-xs">•</span>
                  )}
                  <ChevronDown className="w-3.5 h-3.5" />
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-80" align="start">
                <div className="space-y-3">
                  <h5 className="font-semibold text-sm text-text-main">Khoảng giá</h5>
                  
                  {/* Price Presets */}
                  <div className="flex flex-wrap gap-2">
                    <button
                      onClick={() => {
                        setLocalMinPrice('');
                        setLocalMaxPrice('200000');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMaxPrice === '200000' && !localMinPrice
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      Dưới 200k
                    </button>
                    <button
                      onClick={() => {
                        setLocalMinPrice('200000');
                        setLocalMaxPrice('500000');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMinPrice === '200000' && localMaxPrice === '500000'
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      200k - 500k
                    </button>
                    <button
                      onClick={() => {
                        setLocalMinPrice('500000');
                        setLocalMaxPrice('1000000');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMinPrice === '500000' && localMaxPrice === '1000000'
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      500k - 1tr
                    </button>
                    <button
                      onClick={() => {
                        setLocalMinPrice('1000000');
                        setLocalMaxPrice('');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMinPrice === '1000000' && !localMaxPrice
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      Trên 1tr
                    </button>
                  </div>
                  
                  <div className="flex gap-2">
                    <Input
                      type="number"
                      placeholder="Từ"
                      value={localMinPrice}
                      onChange={(e) => {
                        setLocalMinPrice(e.target.value);
                        const min = e.target.value ? Number(e.target.value) : undefined;
                        const max = localMaxPrice ? Number(localMaxPrice) : undefined;
                        if (min !== undefined && max !== undefined && min > max) {
                          setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
                        } else {
                          setPriceError('');
                        }
                      }}
                      className={cn("flex-1", priceError && "border-destructive")}
                    />
                    <Input
                      type="number"
                      placeholder="Đến"
                      value={localMaxPrice}
                      onChange={(e) => {
                        setLocalMaxPrice(e.target.value);
                        const min = localMinPrice ? Number(localMinPrice) : undefined;
                        const max = e.target.value ? Number(e.target.value) : undefined;
                        if (min !== undefined && max !== undefined && min > max) {
                          setPriceError('Giá tối thiểu không được lớn hơn giá tối đa');
                        } else {
                          setPriceError('');
                        }
                      }}
                      className={cn("flex-1", priceError && "border-destructive")}
                    />
                  </div>
                  {priceError && (
                    <p className="text-xs text-destructive">{priceError}</p>
                  )}
                  {(localMinPrice || localMaxPrice) && !priceError && (
                    <div className="text-xs text-text-muted">
                      {localMinPrice && localMaxPrice
                        ? `${formatPrice(Number(localMinPrice))} - ${formatPrice(Number(localMaxPrice))}`
                        : localMinPrice
                        ? `Từ ${formatPrice(Number(localMinPrice))}`
                        : `Đến ${formatPrice(Number(localMaxPrice))}`}
                    </div>
                  )}
                  <div className="flex gap-2 pt-2">
                    <Button
                      variant="outline"
                      size="sm"
                      className="flex-1"
                      onClick={() => {
                        setLocalMinPrice('');
                        setLocalMaxPrice('');
                        setPriceError('');
                        updateFilter('priceMin', null);
          updateFilter('minPrice', null);
          updateFilter('priceMax', null);
          updateFilter('maxPrice', null);
                        setPricePopoverOpen(false);
                      }}
                    >
                      Xóa
                    </Button>
                    <Button
                      size="sm"
                      className="flex-1"
                      onClick={handlePriceApply}
                      disabled={!!priceError}
                    >
                      Áp dụng
                    </Button>
                  </div>
                </div>
              </PopoverContent>
            </Popover>

            {/* Nút Kích thước - Popover */}
            <Popover open={sizePopoverOpen} onOpenChange={setSizePopoverOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "rounded-md gap-2 h-9 border-border/60 hover:border-primary/50",
                    filters.size && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Ruler className="w-4 h-4" />
                  <span>Kích thước</span>
                  {filters.size && (
                    <span className="text-xs">•</span>
                  )}
                  <ChevronDown className="w-3.5 h-3.5" />
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-64" align="start">
                <div className="space-y-3">
                  <h5 className="font-semibold text-sm text-text-main">Chọn kích thước</h5>
                  {attributesLoading ? (
                    <div className="text-sm text-text-muted py-4 text-center">Đang tải...</div>
                  ) : sizeOptionsFormatted.length === 0 ? (
                    <div className="text-sm text-text-muted py-4 text-center">Không có tùy chọn</div>
                  ) : (
                    <div className="grid grid-cols-2 gap-2">
                      {sizeOptionsFormatted.map((option) => {
                        const isSelected = filters.size === option.value;
                        const sizeCmMap: Record<string, string> = {
                          'Nhỏ': '< 30cm',
                          'Vừa': '30-50cm',
                          'Lớn': '50-80cm',
                          'Rất lớn': '> 80cm',
                        };
                        const sizeCm = sizeCmMap[option.label] || '';
                        return (
                        <button
                          key={option.value}
                          onClick={() => {
                            handleSizeSelect(option.value);
                            setMobileSizeOpen(false); // Đóng mobile popover
                          }}
                          className={cn(
                            "text-left px-3 py-2 rounded-sm border transition-colors",
                            isSelected
                              ? "border-primary bg-pink-50 text-primary font-medium"
                              : "border-border hover:border-primary/50 hover:bg-muted/50"
                          )}
                        >
                          <div className="font-medium">{option.label}</div>
                          {sizeCm && (
                            <div className="text-xs text-text-muted mt-0.5">{sizeCm}</div>
                          )}
                        </button>
                        );
                      })}
                    </div>
                  )}
                  {filters.size && (
                    <Button
                      variant="outline"
                      size="sm"
                      className="w-full"
                      onClick={() => {
                        updateFilter('size', null);
                        setSizePopoverOpen(false);
                      }}
                    >
                      Xóa lọc
                    </Button>
                  )}
                </div>
              </PopoverContent>
            </Popover>

            {/* Nút Màu sắc - Popover */}
            <Popover open={colorPopoverOpen} onOpenChange={setColorPopoverOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "rounded-md gap-2 h-9 border-border/60 hover:border-primary/50",
                    filters.color && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Palette className="w-4 h-4" />
                  <span>Màu sắc</span>
                  {filters.color && (
                    <span className="text-xs">•</span>
                  )}
                  <ChevronDown className="w-3.5 h-3.5" />
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-72" align="start">
                <div className="space-y-3">
                  <h5 className="font-semibold text-sm text-text-main">Chọn màu sắc</h5>
                  {attributesLoading ? (
                    <div className="text-sm text-text-muted py-4 text-center">Đang tải...</div>
                  ) : colorOptionsFormatted.length === 0 ? (
                    <div className="text-sm text-text-muted py-4 text-center">Không có tùy chọn</div>
                  ) : (
                    <div className="grid grid-cols-6 gap-3">
                      {colorOptionsFormatted.map((option) => {
                        const isSelected = filters.color === option.value;
                        const colorHex = getColorHex(option.value) || '#E5E7EB';
                        return (
                          <button
                            key={option.value}
                            type="button"
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              handleColorSelect(option.value);
                            }}
                            className={cn(
                              "relative w-8 h-8 rounded-full transition-all",
                              "border-2 border-transparent",
                              isSelected
                                ? "ring-2 ring-offset-2 ring-primary ring-offset-white"
                                : "hover:ring-2 hover:ring-offset-2 hover:ring-primary/30 hover:ring-offset-white"
                            )}
                            style={{ backgroundColor: colorHex }}
                            title={option.label}
                            aria-label={option.label}
                          >
                            {isSelected && (
                              <div className="absolute inset-0 flex items-center justify-center">
                                <Check className="w-4 h-4 text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.5)]" />
                              </div>
                            )}
                          </button>
                        );
                      })}
                    </div>
                  )}
                  {filters.color && (
                    <Button
                      variant="outline"
                      size="sm"
                      className="w-full"
                      onClick={() => {
                        updateFilter('color', null);
                        setColorPopoverOpen(false);
                      }}
                    >
                      Xóa lọc
                    </Button>
                  )}
                </div>
              </PopoverContent>
            </Popover>
          </div>
        </div>

        {/* Dòng 2: Sắp xếp theo (Sort Group) - Desktop */}
        <div className="space-y-2">
          <h4 className="text-sm font-semibold text-text-main">Sắp xếp theo</h4>
          <div className="flex gap-2 flex-wrap">
            {sortOptions.map((option) => {
              const Icon = option.icon;
              const isSelected = filters.sortBy === option.value || 
                (!filters.sortBy && option.value === 'newest');
              const actualSelected = filters.sortBy === option.value;
              
              return (
                <button
                  key={option.value}
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (actualSelected) {
                      updateFilter('sortBy', null);
                    } else {
                      let sortValue: 'price_asc' | 'price_desc' | 'name_asc' | 'name_desc' | 'newest' | undefined;
                      if (option.value === 'hot' || option.value === 'bestseller') {
                        sortValue = 'newest';
                      } else {
                        sortValue = option.value as typeof sortValue;
                      }
                      updateFilter('sortBy', sortValue);
                    }
                  }}
                  className={cn(
                    "flex items-center gap-1.5 px-3 py-1.5 rounded-full border whitespace-nowrap transition-all",
                    "min-h-[36px] touch-manipulation",
                    isSelected
                      ? "border-primary bg-pink-50 text-primary font-medium shadow-sm"
                      : "border-border/60 bg-white text-text-muted hover:border-primary/50 hover:text-text-main hover:bg-muted/30"
                  )}
                >
                  <Icon className="w-4 h-4 flex-shrink-0" />
                  <span className="text-sm">{option.label}</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* Active Filters Section - Hiển thị cho cả Mobile và Desktop */}
      {activeFilters.length > 0 && (
        <div className="w-full space-y-2 mt-4 md:mt-0">
          <h4 className="text-sm font-semibold text-text-main hidden md:block">Bộ lọc đang áp dụng</h4>
          <div className="flex flex-wrap gap-2">
            {activeFilters.map((filter) => (
              <div
                key={filter.key}
                className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-pink-50 border border-primary/20 text-sm"
              >
                <span className="text-text-main">
                  <span className="font-medium">{filter.label}:</span>{' '}
                  <span className="text-text-muted">{filter.value}</span>
                </span>
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    filter.onRemove();
                  }}
                  className="ml-1 hover:bg-primary/10 rounded-full p-0.5 transition-colors"
                  aria-label={`Xóa bộ lọc ${filter.label}`}
                >
                  <X className="w-3.5 h-3.5 text-text-muted hover:text-primary" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </>
  );
}
================================================================================FILE: components/product/ProductGallery.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import Image from 'next/image';
import { cn } from '@/lib/utils/cn';
import { ChevronLeft, ChevronRight } from 'lucide-react';

interface ProductGalleryProps {
  images: Array<{
    sourceUrl: string;
    altText?: string;
  }>;
  productName?: string;
  selectedVariationImage?: string; // Ảnh từ variation được chọn (màu sắc)
}

export function ProductGallery({ images, productName, selectedVariationImage }: ProductGalleryProps) {
  const [selectedImageIndex, setSelectedImageIndex] = useState(0);

  // Fallback to placeholder if no images
  const baseImages = images.length > 0 
    ? images 
    : [{ sourceUrl: '/images/teddy-placeholder.png', altText: productName || 'Sản phẩm' }];

  // Nếu có selectedVariationImage, đặt nó làm ảnh đầu tiên
  const allImages = useMemo(() => {
    if (selectedVariationImage) {
      // Tìm xem variation image đã có trong images chưa
      const existingIndex = baseImages.findIndex(img => img.sourceUrl === selectedVariationImage);
      if (existingIndex >= 0) {
        // Nếu đã có, di chuyển nó lên đầu
        const reordered = [
          baseImages[existingIndex],
          ...baseImages.filter((_, idx) => idx !== existingIndex)
        ];
        return reordered;
      } else {
        // Nếu chưa có, thêm vào đầu
        return [
          { sourceUrl: selectedVariationImage, altText: productName || 'Sản phẩm' },
          ...baseImages
        ];
      }
    }
    return baseImages;
  }, [baseImages, selectedVariationImage, productName]);

  // Reset selectedImageIndex về 0 khi selectedVariationImage thay đổi
  useEffect(() => {
    if (selectedVariationImage) {
      setSelectedImageIndex(0);
    }
  }, [selectedVariationImage]);

  const mainImage = allImages[selectedImageIndex] || allImages[0];
  const thumbnails = allImages.slice(0, 5); // Limit to 5 thumbnails

  // Circular navigation handlers
  const handlePrevious = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();
    setSelectedImageIndex((prev) => {
      if (prev === 0) {
        return allImages.length - 1; // Loop to last image
      }
      return prev - 1;
    });
  };

  const handleNext = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();
    setSelectedImageIndex((prev) => {
      if (prev === allImages.length - 1) {
        return 0; // Loop to first image
      }
      return prev + 1;
    });
  };

  return (
    <div className="space-y-4">
      {/* Main Image */}
      <div className="relative aspect-square w-full overflow-hidden rounded-2xl bg-gray-50">
        <Image
          src={mainImage.sourceUrl}
          alt={mainImage.altText || productName || 'Sản phẩm'}
          fill
          className="object-cover"
          priority
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 40vw"
        />
        
        {/* Badge Logo "GB" */}
        <div className="absolute top-4 left-4 bg-white/90 p-1 rounded-full shadow-sm w-6 h-6 flex items-center justify-center z-10">
          <span className="text-[8px] font-extrabold text-pink-500">GB</span>
        </div>

        {/* Navigation Arrows - Only show if more than 1 image */}
        {allImages.length > 1 && (
          <>
            {/* Previous Button */}
            <button
              onClick={handlePrevious}
              className="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md transition-all z-10 w-10 h-10 flex items-center justify-center"
              aria-label="Hình trước"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>

            {/* Next Button */}
            <button
              onClick={handleNext}
              className="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md transition-all z-10 w-10 h-10 flex items-center justify-center"
              aria-label="Hình tiếp theo"
            >
              <ChevronRight className="w-5 h-5" />
            </button>
          </>
        )}
      </div>

      {/* Thumbnails */}
      {thumbnails.length > 1 && (
        <div className="flex md:grid md:grid-cols-5 gap-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory md:overflow-x-visible md:snap-none">
          {thumbnails.map((img, index) => (
            <button
              key={index}
              onClick={() => setSelectedImageIndex(index)}
              className={cn(
                "relative aspect-square overflow-hidden rounded-xl transition-all flex-shrink-0 snap-center",
                "border-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                "w-20 h-20 md:w-auto md:h-auto", // Fixed size on mobile for consistent scrolling
                selectedImageIndex === index
                  ? "border-primary scale-105"
                  : "border-transparent hover:border-pink-300"
              )}
              aria-label={`Xem hình ${index + 1} của sản phẩm`}
              aria-pressed={selectedImageIndex === index}
            >
              <Image
                src={img.sourceUrl}
                alt={img.altText || `Hình ${index + 1}`}
                fill
                className="object-cover"
                sizes="(max-width: 768px) 80px, 12.5vw"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

================================================================================FILE: components/product/ProductHighlights.tsx================================================================================'use client';

import { formatPrice } from '@/lib/utils/format';
import type { WooCommerceVariation } from '@/types/woocommerce';
import type { MongoVariant } from '@/types/mongodb';

/**
 * Variation type that supports both WooCommerce and MongoDB formats
 */
type Variation = WooCommerceVariation | MongoVariant | {
  size?: string;
  color?: string;
  price: string | number;
  regular_price?: string | number;
  sale_price?: string | number;
  on_sale?: boolean;
  attributes?: Array<{
    name: string;
    option: string;
  }>;
};

interface ProductHighlightsProps {
  description?: string;
  attributes?: Array<{
    name: string;
    options: string[];
  }>;
  material?: string;
  origin?: string;
  variations?: Variation[];
}

export function ProductHighlights({
  description,
  attributes,
  material,
  origin,
  variations,
}: ProductHighlightsProps) {

  // Extract highlights from description or attributes
  const highlights: string[] = [];
  
  if (description && typeof window !== 'undefined') {
    // Simple extraction: Look for list items or bullet points (client-side only)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = description;
    const listItems = tempDiv.querySelectorAll('li, ul li');
    listItems.forEach((li) => {
      const text = li.textContent?.trim();
      if (text && text.length > 0) {
        highlights.push(text);
      }
    });
  } else if (description) {
    // Fallback: Simple text extraction (server-side)
    const lines = description.split(/<[^>]+>/).filter(line => line.trim().length > 0);
    highlights.push(...lines.slice(0, 5)); // Limit to 5 highlights
  }

  // Add material and origin if available
  if (material) highlights.push(`Chất liệu: ${material}`);
  if (origin) highlights.push(`Xuất xứ: ${origin}`);

  // Price Table from variations
  // Support both WooCommerce format (with attributes) and MongoDB format (direct size/color fields)
  const priceTable = variations
    ?.filter((v) => {
      const price = typeof v.price === 'number' ? v.price : parseFloat(String(v.price || '0'));
      const regularPrice = typeof (v as any).regular_price === 'number' 
        ? (v as any).regular_price 
        : parseFloat(String((v as any).regular_price || '0'));
      return price > 0 || regularPrice > 0;
    })
    .map((v) => {
      // Try MongoDB format first (direct size field)
      let size = 'N/A';
      if ('size' in v && v.size) {
        size = String(v.size);
      } else if ('attributes' in v && Array.isArray(v.attributes)) {
        // Fallback to WooCommerce format (attributes array)
        const sizeAttr = v.attributes.find((attr: any) =>
          attr.name?.toLowerCase().includes('size') ||
          attr.name?.toLowerCase().includes('kích thước') ||
          attr.name?.toLowerCase().includes('kich thuoc')
      );
        size = sizeAttr?.option || 'N/A';
      }
      
      // Get price (support both formats)
      // MongoDB variants don't have on_sale, only price
      const hasOnSale = 'on_sale' in v && (v as any).on_sale;
      const salePrice = (v as any).sale_price;
      const price = (hasOnSale && salePrice) 
        ? salePrice 
        : (v.price || (v as any).regular_price || '0');
      
      return {
        size,
        price: typeof price === 'number' ? price.toString() : String(price),
      };
    })
    .sort((a, b) => {
      // Sort by size (try to parse as number)
      const aNum = parseFloat(a.size.replace(/[^\d.]/g, ''));
      const bNum = parseFloat(b.size.replace(/[^\d.]/g, ''));
      if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
      return a.size.localeCompare(b.size);
    });

  return (
    <div className="space-y-6">
      {/* Highlights List */}
      {highlights.length > 0 && (
        <div>
          <h3 className="font-heading text-lg font-semibold mb-4">
            Đặc điểm nổi bật
          </h3>
          <ul className="list-disc list-inside space-y-2 marker:text-primary text-text-main">
            {highlights.map((highlight, index) => (
              <li key={index} className="text-sm">
                {highlight}
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Price Table */}
      {priceTable && priceTable.length > 0 && (
        <div className="bg-pink-50 border border-pink-200 rounded-xl p-4">
          <h3 className="font-heading text-lg font-semibold mb-3">
            Kích thước & Giá
          </h3>
          <div className="space-y-2">
            {priceTable.map((item, index) => (
              <div
                key={index}
                className="flex justify-between items-center py-2 border-b border-pink-200 last:border-0"
              >
                <span className="text-sm font-medium text-text-main">
                  Size {index + 1}: {item.size}
                </span>
                <span className="text-sm font-bold text-primary">
                  {formatPrice(item.price)}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Note */}
      <p className="text-xs text-text-muted italic">
        Tất cả hình ảnh SP đều là Hình Thật Shop tự chụp.
      </p>
    </div>
  );
}

================================================================================FILE: components/product/ProductInfo.tsx================================================================================'use client';

import { useState, useMemo, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { formatPrice } from '@/lib/utils/format';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { useProductVariations } from '@/lib/hooks/useProductVariations';
import { useVariationMatcher, useSmallestSizeByPrice } from '@/lib/hooks/useVariationMatcher';
import { useProductPrice } from '@/lib/hooks/useProductPrice';
import { useMultipleGlobalAttributeTerms } from '@/lib/hooks/useGlobalAttributes';
import { isAttributeSize, isAttributeColor } from '@/lib/constants/attributes';
import { QuantitySelector } from '@/components/product/QuantitySelector';
import { VisualAttributeSelector } from '@/components/product/VisualAttributeSelector';
import { getColorHex } from '@/lib/utils/colorMapping';
import { generateSlug } from '@/lib/utils/slug';
import { cn } from '@/lib/utils/cn';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { Gift, ShoppingCart, Check, Loader2 } from 'lucide-react';
import { useQuickCheckoutStore } from '@/lib/store/useQuickCheckoutStore';

interface ProductInfoProps {
  product: MappedProduct;
  onAddToCart?: (variationId?: number, isGift?: boolean) => void;
  onGiftOrder?: () => void;
  onVariationChange?: (variationImage?: string) => void; // Callback khi variation thay đổi
}

export function ProductInfo({ product, onAddToCart, onGiftOrder, onVariationChange }: ProductInfoProps) {
  const { addToCart } = useCartSync();
  const searchParams = useSearchParams();
  const [selectedSize, setSelectedSize] = useState<string | null>(null);
  const [selectedColor, setSelectedColor] = useState<string | null>(null);
  const [quantity, setQuantity] = useState(1);
  const [isAdding, setIsAdding] = useState(false);
  const [addingType, setAddingType] = useState<'gift' | 'buy' | 'quick' | null>(null);

  // Fetch variations if product is variable type
  // Always call useProductVariations with consistent signature to avoid hooks violation
  const productId = product?.databaseId ?? null;
  const shouldFetchVariations = product?.type === 'variable' && (product?.variations?.length || 0) > 0;
  const { variations, isLoading: isLoadingVariations, refetch: refetchVariations } = useProductVariations(
    productId,
    { enabled: shouldFetchVariations && !!productId }
  );
  
  // FIX: Khi user chọn size, đảm bảo variations được fetch ngay nếu chưa có
  useEffect(() => {
    if (selectedSize && product?.type === 'variable' && variations.length === 0 && !isLoadingVariations) {
      refetchVariations();
    }
  }, [selectedSize, product?.type, variations.length, isLoadingVariations, refetchVariations]);

  // Extract Size and Color attributes using centralized constants
  // This replaces hardcoded string matching with reusable helper functions
  const sizeAttribute = product?.attributes?.find((attr) => isAttributeSize(attr.name));
  const colorAttribute = product?.attributes?.find((attr) => isAttributeColor(attr.name));

  // Auto-select smallest size (lowest price) when variations load
  const smallestSize = useSmallestSizeByPrice(variations);
  
  // Use custom hook to find matching variation (replaces ~25 lines of duplicate logic)
  const selectedVariation = useVariationMatcher(variations, selectedSize, selectedColor);

  // Notify parent component when variation image changes
  useEffect(() => {
    if (onVariationChange) {
      onVariationChange(selectedVariation?.image);
    }
  }, [selectedVariation?.image, onVariationChange]);

  // Use custom hook for pricing logic (replaces ~35 lines of duplicate code)
  const { displayPrice, displayRegularPrice, isOnSale } = useProductPrice(product, selectedVariation);

  const availableSizes = sizeAttribute?.options || [];
  const availableColors = colorAttribute?.options || [];

  const displaySizes = availableSizes.slice(0, 4);
  const displayColors = availableColors.slice(0, 4);

  // Fetch global attribute terms if globalAttributeId is available
  // Note: This requires product.attributes to include globalAttributeId (to be added in mapMongoProduct)
  const globalAttributeIds = useMemo(() => {
    const ids: string[] = [];
    product?.attributes?.forEach((attr: any) => {
      if (attr.globalAttributeId) {
        ids.push(attr.globalAttributeId);
      }
    });
    return ids;
  }, [product?.attributes]);

  const { 
    data: globalAttributeTermsData, 
    isLoading: isLoadingGlobalTerms,
    error: globalTermsError 
  } = useMultipleGlobalAttributeTerms(globalAttributeIds);

  // Handle error gracefully - log but don't crash
  useEffect(() => {
    if (globalTermsError) {
      console.error('[ProductInfo] Error loading global attribute terms:', globalTermsError);
      // Fallback to old color mapping will be used automatically
    }
  }, [globalTermsError]);

  // Create a map of globalAttributeId -> terms
  const globalTermsMap = useMemo(() => {
    // If there's an error, return empty map (fallback to old behavior)
    if (globalTermsError || !globalAttributeTermsData || globalAttributeTermsData.length === 0) {
      return new Map<string, any>();
    }
    
    const map = new Map<string, any>();
    globalAttributeTermsData.forEach((data) => {
      if (data?.attribute?.id) {
        map.set(data.attribute.id, data);
      }
    });
    return map;
  }, [globalAttributeTermsData, globalTermsError]);

  // Get global attribute type for an attribute
  const getGlobalAttributeType = (attr: any): 'text' | 'color' | 'image' | 'button' | null => {
    if (!attr.globalAttributeId) return null;
    const termsData = globalTermsMap.get(attr.globalAttributeId);
    return termsData?.attribute.type || null;
  };

  // Get global terms for an attribute
  const getGlobalTerms = (attr: any) => {
    if (!attr.globalAttributeId) return [];
    const termsData = globalTermsMap.get(attr.globalAttributeId);
    return termsData?.terms || [];
  };

  // Đọc query params từ URL và tự động chọn size/color
  // Priority: URL params > Auto-select smallest size
  useEffect(() => {
    if (!product || !product.attributes) return;

    // Helper function để tạo slug từ attribute name
    const createAttributeSlug = (name: string): string => {
      return generateSlug(name);
    };

    let sizeFromUrl: string | null = null;
    
    // Tìm size attribute và đọc từ URL
    if (sizeAttribute) {
      const sizeAttrSlug = createAttributeSlug(sizeAttribute.name);
      const attrKey = `attribute_pa_${sizeAttrSlug}`;
      sizeFromUrl = searchParams.get(attrKey);
      
      if (sizeFromUrl && availableSizes.includes(sizeFromUrl)) {
        setSelectedSize(sizeFromUrl);
        return; // URL param takes priority, don't auto-select
      }
    }
    
    // If no size from URL and variations loaded, auto-select smallest size
    if (!sizeFromUrl && product.type === 'variable' && smallestSize && !selectedSize && !isLoadingVariations && variations.length > 0) {
      setSelectedSize(smallestSize);
    }

    // Tìm color attribute và đọc từ URL
    if (colorAttribute) {
      const colorAttrSlug = createAttributeSlug(colorAttribute.name);
      const attrKey = `attribute_pa_${colorAttrSlug}`;
      const colorFromUrl = searchParams.get(attrKey);
      
      if (colorFromUrl) {
        // Tìm màu khớp (có thể là slug hoặc tên đầy đủ)
        const matchedColor = availableColors.find((color) => {
          const colorSlug = createAttributeSlug(color);
          return colorSlug === colorFromUrl || color.toLowerCase() === colorFromUrl.toLowerCase();
        });
        
        if (matchedColor) {
          setSelectedColor(matchedColor);
        }
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams, product, sizeAttribute, colorAttribute]);

  // Early return with null/undefined safety check
  // Per .cursorrules: Always handle missing product data gracefully
  if (!product || !product.name) {
    console.warn('[ProductInfo] Product or product.name is missing');
    return null;
  }

  const isOutOfStock = product.stockStatus === 'outofstock';

  const handleAddToCartClick = async (isGift: boolean = false, isQuickCheckout: boolean = false) => {
    // FIX: Use local variables to avoid async state update issues
    // If product has variations but no size selected, auto-select first size
    let sizeToUse = selectedSize;
    let colorToUse = selectedColor;
    
    if (product.type === 'variable' && availableSizes.length > 0 && !selectedSize) {
      sizeToUse = availableSizes[0];
      // Update UI state (async) but use local variable for immediate logic
      setSelectedSize(sizeToUse);
    }

    setIsAdding(true);
    setAddingType(isGift ? 'gift' : isQuickCheckout ? 'quick' : 'buy');

    try {
      // Find variation using local variables (not state) to ensure accuracy
      // MongoVariant structure: { id, size, color, price, stock, ... }
      const variationToUse = variations.find((variation) => {
        if (variation.size && variation.size === sizeToUse) {
          if (colorToUse) {
            return !variation.color || variation.color === colorToUse;
          }
          return true;
        }
        return false;
      });

      // Calculate price using the found variation
      // MongoVariant chỉ có price field, không có on_sale, sale_price, regular_price
      const priceToUse = variationToUse 
        ? String(variationToUse.price || 0)
        : (product.onSale ? product.salePrice : product.price);

      for (let i = 0; i < quantity; i++) {
        await addToCart({
          productId: typeof product.databaseId === 'string' ? parseInt(product.databaseId, 10) : product.databaseId,
          productName: `${product.name} ${sizeToUse ? `(${sizeToUse})` : ''}`,
          price: priceToUse || '0',
          image: product.image?.sourceUrl,
          quantity: 1,
          variationId: variationToUse?.id ? (typeof variationToUse.id === 'number' ? variationToUse.id : parseInt(variationToUse.id, 10) || undefined) : undefined,
          isGift: isGift,
          length: product.length || undefined,
          width: product.width || undefined,
          height: product.height || undefined,
          weight: product.weight ? parseFloat(product.weight) : undefined,
          volumetricWeight: product.volumetricWeight || undefined,
        });
      }

      if (onAddToCart) {
        onAddToCart(variationToUse?.id ? (typeof variationToUse.id === 'number' ? variationToUse.id : parseInt(variationToUse.id, 10) || undefined) : undefined, isGift);
      }

      // Mở QuickCheckoutModal sau khi thêm vào giỏ
      try {
        useQuickCheckoutStore.getState().onOpen();
      } catch (error) {
        console.error('[ProductInfo] Error opening QuickCheckoutModal:', error);
      }
    } catch (error) {
      console.error('Error adding to cart:', error);
    } finally {
      // Reset loading state after a short delay for better UX
      setTimeout(() => {
        setIsAdding(false);
        setAddingType(null);
      }, 500);
    }
  };

  return (
    <div className="space-y-6">
      {/* Product Name */}
      <div>
        <h1 className="font-heading text-2xl md:text-3xl font-bold mb-2">
          {product.name}
        </h1>
        {product.sku && (
          <p className="text-sm text-text-muted">
            SKU: {product.sku}
          </p>
        )}
      </div>

      {/* Price */}
      <div className="flex items-center gap-4">
        <p className="text-3xl font-bold text-primary">
          {isLoadingVariations ? (
            <span className="text-gray-400">Đang tải...</span>
          ) : (
            formatPrice(displayPrice)
          )}
        </p>
        {isOnSale && displayRegularPrice && displayRegularPrice !== displayPrice && (
          <p className="text-lg text-text-muted line-through">
            {formatPrice(displayRegularPrice)}
          </p>
        )}
      </div>

      {/* Size Selector - Use VisualAttributeSelector if global attribute, otherwise fallback */}
      {displaySizes.length > 0 && sizeAttribute && (
        (() => {
          const globalType = getGlobalAttributeType(sizeAttribute as any);
          const globalTerms = getGlobalTerms(sizeAttribute as any);
          
          // Use VisualAttributeSelector if it's a global attribute with type
          if (globalType) {
            return (
              <VisualAttributeSelector
                label="Kích thước"
                type={globalType}
                options={displaySizes}
                terms={globalTerms}
                selectedValue={selectedSize}
                onSelect={setSelectedSize}
              />
            );
          }
          
          // Fallback to button style for non-global or text attributes
          return (
            <VisualAttributeSelector
              label="Kích thước"
              type="button"
              options={displaySizes}
              selectedValue={selectedSize}
              onSelect={setSelectedSize}
            />
          );
        })()
      )}

      {/* Color Selector - Use VisualAttributeSelector if global attribute, otherwise fallback */}
      {displayColors.length > 0 && colorAttribute && (
        (() => {
          const globalType = getGlobalAttributeType(colorAttribute as any);
          const globalTerms = getGlobalTerms(colorAttribute as any);
          
          // Use VisualAttributeSelector if it's a global attribute with type
          if (globalType) {
            return (
              <VisualAttributeSelector
                label="Màu sắc"
                type={globalType}
                options={displayColors}
                terms={globalTerms}
                selectedValue={selectedColor}
                onSelect={setSelectedColor}
              />
            );
          }
          
          // Fallback to color swatches using getColorHex (backward compatibility)
          return (
            <div>
              <label className="block text-sm font-medium text-text-main mb-2">
                Màu sắc{selectedColor ? `: ${selectedColor}` : ''}
              </label>
              <div className="flex gap-3 items-center">
                {displayColors.map((colorName, idx) => {
                  const bgColor = getColorHex(colorName) || (colorName.startsWith('#') ? colorName : '#E5E7EB');
                  const isSelected = selectedColor === colorName;
                  
                  const lightColors = ['#FFFFFF', '#FDFBF7', '#F5F5DC', '#E5E7EB', '#FFF9FA', '#FEF3C7'];
                  const bgColorUpper = bgColor.toUpperCase();
                  const isLightColor = lightColors.includes(bgColorUpper) || 
                                       colorName.toLowerCase().includes('trắng') || 
                                       colorName.toLowerCase().includes('kem') ||
                                       colorName.toLowerCase().includes('trang');
                  
                  return (
                    <button
                      key={idx}
                      onClick={() => setSelectedColor(colorName)}
                      className={cn(
                        "w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all duration-200",
                        "border-2",
                        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                        isSelected 
                          ? "border-pink-600 ring-2 ring-pink-500 ring-offset-2 scale-110" 
                          : isLightColor
                            ? "border-gray-400 hover:scale-105 hover:border-pink-300"
                            : "border-gray-300 hover:scale-105 hover:border-pink-300"
                      )}
                      style={{ backgroundColor: bgColor }}
                      title={`Màu: ${colorName}`}
                      aria-label={`Chọn màu ${colorName}`}
                      aria-pressed={isSelected}
                    >
                      {isSelected && (
                        <Check 
                          className={cn(
                            "w-4 h-4 md:w-5 md:h-5", 
                            isLightColor ? "text-gray-900" : "text-white"
                          )} 
                          strokeWidth={3}
                        />
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          );
        })()
      )}

      {/* Actions (Horizontal Layout) */}
      <div className="space-y-4">
        {/* Row of Actions - Responsive flex with shrink */}
        <div className="flex items-center gap-2 sm:gap-3 flex-nowrap overflow-hidden">
          {/* 1. Quantity Capsule - Fixed width, no shrink */}
          <div className="flex-shrink-0">
            <QuantitySelector 
              value={quantity} 
              onChange={setQuantity} 
              min={1}
              max={product.stockQuantity || 99}
              disabled={isOutOfStock}
            />
          </div>

          {/* 2. Add to Cart Button - Flexible, can shrink */}
          <Button 
            className="rounded-full bg-blue-500 hover:bg-blue-600 text-white border-none px-2 sm:px-4 md:px-6 h-8 md:h-9 min-h-[44px] text-xs sm:text-sm gap-1 sm:gap-2 shadow-sm shadow-blue-200 font-bold !flex items-center justify-center flex-1 min-w-0"
            disabled={isOutOfStock || isAdding}
            onClick={() => handleAddToCartClick(false)}
            aria-label="Thêm vào giỏ hàng"
          >
            {isAdding && addingType === 'buy' ? (
              <>
                <Loader2 className="w-3.5 h-3.5 animate-spin flex-shrink-0" />
                <span className="truncate">Đang thêm...</span>
              </>
            ) : (
              <>
                <ShoppingCart className="w-3.5 h-3.5 md:w-4 md:h-4 flex-shrink-0" />
                <span className="truncate">Thêm giỏ hàng</span>
              </>
            )}
          </Button>

          {/* 3. Gift Button - Flexible, can shrink */}
          <Button 
            className="rounded-full bg-pink-400 hover:bg-pink-500 text-white border-none px-2 sm:px-4 md:px-6 h-8 md:h-9 min-h-[44px] text-xs sm:text-sm gap-1 sm:gap-2 shadow-sm shadow-pink-200 font-bold !flex items-center justify-center flex-1 min-w-0"
            disabled={isOutOfStock || isAdding}
            onClick={() => handleAddToCartClick(true)}
            aria-label="Gửi tặng sản phẩm"
          >
            {isAdding && addingType === 'gift' ? (
              <>
                <Loader2 className="w-3.5 h-3.5 animate-spin flex-shrink-0" />
                <span className="truncate">Đang thêm...</span>
              </>
            ) : (
              <>
                <Gift className="w-3.5 h-3.5 md:w-4 md:h-4 flex-shrink-0" />
                <span className="truncate">GỬI TẶNG</span>
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
}

================================================================================FILE: components/product/ProductList.tsx================================================================================'use client';

import { useState } from 'react';
import Image from 'next/image';
import { useProductsREST } from '@/lib/hooks/useProductsREST';
import { ProductCard } from './ProductCard';
import { ViewToggle } from './ViewToggle';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { formatPrice } from '@/lib/utils/format';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { ProductListSkeleton } from '@/components/ui/skeleton';
import { NoProductsFoundState } from '@/components/ui/empty-state';
import { ErrorState } from '@/components/ui/error-state';

interface ProductListProps {
  initialCount?: number;
}

export function ProductList({ initialCount = 12 }: ProductListProps) {
  const { products, loading, error, hasNextPage, loadMore, totalCount } = useProductsREST(initialCount);
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const { addToCart } = useCartSync();

  // Hiển thị skeleton khi đang loading (cả lần đầu và khi filter thay đổi)
  if (loading && products.length === 0) {
    return (
      <div className="w-full">
        <ProductListSkeleton count={8} />
      </div>
    );
  }

  if (error) {
    return (
      <div className="w-full">
        <ErrorState
          title="Không thể tải sản phẩm"
          message={error.message || 'Có lỗi xảy ra khi tải sản phẩm. Vui lòng thử lại sau.'}
          action={{
            label: 'Thử lại',
            onClick: () => window.location.reload(),
          }}
        />
      </div>
    );
  }

  if (products.length === 0 && !loading) {
    return (
      <div className="w-full">
        <NoProductsFoundState />
      </div>
    );
  }

  return (
    <div className="w-full relative">
      {/* Loading overlay khi đang filter (có products nhưng đang loading) */}
      {loading && products.length > 0 && (
        <div className="absolute inset-0 bg-white/60 backdrop-blur-sm z-10 flex items-center justify-center rounded-lg">
          <div className="flex flex-col items-center gap-2">
            <div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin" />
            <p className="text-sm text-text-muted">Đang tải...</p>
          </div>
        </div>
      )}

      <div className="flex items-center justify-between mb-6">
        {totalCount > 0 && (
          <p className="text-sm text-text-muted">
            Tìm thấy {totalCount} sản phẩm
          </p>
        )}
        <ViewToggle view={viewMode} onViewChange={setViewMode} />
      </div>

      {viewMode === 'grid' ? (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-4 lg:gap-6">
          {products.map((product) => {
            if (!product || !product.name) {
              return null;
            }
            return <ProductCard key={product.id || product.databaseId} product={product} />;
          })}
        </div>
      ) : (
        <div className="space-y-4">
          {products.map((product) => {
            if (!product || !product.name) {
              return null;
            }
            const isOutOfStock = product.stockStatus === 'outofstock' || product.stockStatus === 'OUT_OF_STOCK';
            return (
              <Card key={product.id || product.databaseId} className="p-4">
                <div className="flex gap-4">
                  <div className="relative w-24 h-24 md:w-32 md:h-32 flex-shrink-0 rounded-xl overflow-hidden bg-gray-50">
                    <Image
                      src={product.image?.sourceUrl || '/images/teddy-placeholder.png'}
                      alt={product.image?.altText || product.name || 'Gấu bông'}
                      fill
                      className="object-cover"
                      sizes="(max-width: 768px) 96px, 128px"
                    />
                  </div>
                  <div className="flex-1 min-w-0">
                    <h3 className="font-heading text-lg font-semibold text-text-main mb-2">
                      {product.name}
                    </h3>
                    <p className="text-primary font-bold text-xl mb-2">
                      {formatPrice(product.price)}
                    </p>
                    <Button
                      className="w-full md:w-auto"
                      disabled={isOutOfStock}
                      onClick={async () => {
                        if (!isOutOfStock) {
                          await addToCart({
                            productId: typeof product.databaseId === 'string' ? parseInt(product.databaseId, 10) : product.databaseId,
                            productName: product.name,
                            price: product.price || '0',
                            image: product.image?.sourceUrl,
                            length: product.length || undefined,
                            width: product.width || undefined,
                            height: product.height || undefined,
                            weight: product.weight ? parseFloat(product.weight) : undefined,
                            volumetricWeight: product.volumetricWeight || undefined,
                          });
                        }
                      }}
                    >
                      {isOutOfStock ? 'Hết hàng' : 'Thêm vào giỏ'}
                    </Button>
                  </div>
                </div>
              </Card>
            );
          })}
        </div>
      )}

      {hasNextPage && (
        <div className="mt-8 text-center">
          <Button onClick={loadMore} variant="outline">
            Xem thêm sản phẩm
          </Button>
        </div>
      )}
    </div>
  );
}

================================================================================FILE: components/product/ProductPromotions.tsx================================================================================'use client';

import { Gift, Package, Truck, Shield, Star } from 'lucide-react';

interface ProductPromotionsProps {
  promotions?: {
    freeGift?: boolean;
    freeCard?: boolean;
    freeShip?: boolean;
    warranty?: boolean;
    rewardPoints?: boolean;
  };
}

export function ProductPromotions({ promotions }: ProductPromotionsProps) {
  // Default promotions (hardcoded - có thể lấy từ ACF fields sau)
  const defaultPromotions = {
    freeGift: true,
    freeCard: true,
    freeShip: true,
    warranty: true,
    rewardPoints: true,
  };

  const activePromotions = promotions || defaultPromotions;

  // Check if any promotion is active
  const hasActivePromotions =
    activePromotions.freeGift ||
    activePromotions.freeCard ||
    activePromotions.freeShip ||
    activePromotions.warranty ||
    activePromotions.rewardPoints;

  if (!hasActivePromotions) return null;

  return (
    <div className="bg-pink-50 border border-pink-200 rounded-xl p-4">
      <h3 className="font-heading text-lg font-semibold mb-3">
        Ưu đãi đặc biệt
      </h3>
      <ul className="space-y-2">
        {activePromotions.freeGift && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Gift className="w-4 h-4 text-primary" />
            <span>Miễn phí Gói Quà (Túi trong suốt + Nơ)</span>
          </li>
        )}
        {activePromotions.freeCard && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Package className="w-4 h-4 text-primary" />
            <span>Miễn phí Tặng kèm thiệp ý nghĩa (Sinh nhật, Tình yêu, Cảm ơn, Lễ tết)</span>
          </li>
        )}
        {activePromotions.freeShip && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Truck className="w-4 h-4 text-primary" />
            <span>Hỏa Tốc: Giao hàng trong 45-60 phút tại HCM</span>
          </li>
        )}
        {activePromotions.warranty && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Shield className="w-4 h-4 text-primary" />
            <span>Bảo Hành: Bảo hành trọn đời đường may tại cửa hàng</span>
          </li>
        )}
        {activePromotions.rewardPoints && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Star className="w-4 h-4 text-primary" />
            <span>Tích Điểm: Tích 3% giá trị đơn hàng</span>
          </li>
        )}
      </ul>
    </div>
  );
}

================================================================================FILE: components/product/QuantitySelector.tsx================================================================================'use client';

import { useState, useEffect } from 'react';
import { cn } from '@/lib/utils/cn';

interface QuantitySelectorProps {
  value: number;
  onChange: (value: number) => void;
  min?: number;
  max?: number;
  disabled?: boolean;
}

export function QuantitySelector({
  value,
  onChange,
  min = 1,
  max = 99,
  disabled = false,
}: QuantitySelectorProps) {
  // Local state để cho phép input trống tạm thời khi người dùng đang nhập
  const [inputValue, setInputValue] = useState<string>(value.toString());
  const [isFocused, setIsFocused] = useState(false);

  // Sync local state với prop value khi không focus
  useEffect(() => {
    if (!isFocused) {
      setInputValue(value.toString());
    }
  }, [value, isFocused]);

  const handleDecrease = () => {
    if (value > min && !disabled) {
      onChange(value - 1);
    }
  };

  const handleIncrease = () => {
    if (value < max && !disabled) {
      onChange(value + 1);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const rawValue = e.target.value;
    
    // Cho phép input trống tạm thời (để người dùng có thể xóa và nhập lại)
    if (rawValue === '') {
      setInputValue('');
      return;
    }

    // Chỉ parse và validate khi có giá trị
    const numValue = parseInt(rawValue, 10);
    
    // Nếu không phải số hợp lệ, giữ nguyên giá trị hiện tại
    if (isNaN(numValue)) {
      return;
    }

    // Cập nhật local state để hiển thị
    setInputValue(rawValue);

    // Validate và update parent chỉ khi giá trị hợp lệ
    if (numValue >= min && numValue <= max) {
      onChange(numValue);
    }
    // Nếu vượt quá max, vẫn cho phép hiển thị nhưng không update parent
    // (sẽ được validate lại khi blur)
  };

  const handleBlur = () => {
    setIsFocused(false);
    const numValue = parseInt(inputValue, 10);
    
    // Nếu input trống hoặc không hợp lệ, set về giá trị hiện tại
    if (isNaN(numValue) || inputValue === '') {
      setInputValue(value.toString());
      return;
    }

    // Validate và clamp giá trị
    let finalValue = numValue;
    if (numValue < min) {
      finalValue = min;
    } else if (numValue > max) {
      finalValue = max;
    }

    // Update parent và local state
    onChange(finalValue);
    setInputValue(finalValue.toString());
  };

  const handleFocus = () => {
    setIsFocused(true);
  };

  const isDecreaseDisabled = disabled || value <= min;
  const isIncreaseDisabled = disabled || value >= max;

  return (
    <div className="flex items-center justify-between w-[110px] md:w-[120px] h-8 md:h-9 min-h-[44px] border-2 border-pink-300 rounded-full bg-white px-1 box-border">
      {/* Decrease Button */}
      <button
        type="button"
        onClick={handleDecrease}
        disabled={isDecreaseDisabled}
        className={cn(
          "flex items-center justify-center w-6 h-6 rounded-full",
          "text-pink-500 font-bold text-lg transition-colors",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-500 focus-visible:ring-offset-2",
          "hover:bg-pink-50 active:bg-pink-100",
          "disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent",
          "pb-0.5" // Căn chỉnh dấu - cho cân giữa
        )}
        aria-label="Giảm số lượng"
        aria-disabled={isDecreaseDisabled}
      >
        −
      </button>

      {/* Input */}
      <input
        type="text"
        inputMode="numeric"
        pattern="[0-9]*"
        value={inputValue}
        onChange={handleInputChange}
        onFocus={handleFocus}
        onBlur={handleBlur}
        disabled={disabled}
        role="spinbutton"
        className={cn(
          "w-10 md:w-12 h-full border-none bg-transparent text-center",
          "text-sm md:text-base font-bold text-gray-800",
          "focus-visible:outline-none",
          "disabled:cursor-not-allowed disabled:opacity-50",
          "[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
        )}
        aria-label="Số lượng"
        aria-valuemin={min}
        aria-valuemax={max}
        aria-valuenow={value}
      />

      {/* Increase Button */}
      <button
        type="button"
        onClick={handleIncrease}
        disabled={isIncreaseDisabled}
        className={cn(
          "flex items-center justify-center w-6 h-6 rounded-full",
          "text-pink-500 font-bold text-lg transition-colors",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-500 focus-visible:ring-offset-2",
          "hover:bg-pink-50 active:bg-pink-100",
          "disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent",
          "pb-0.5" // Căn chỉnh dấu + cho cân giữa
        )}
        aria-label="Tăng số lượng"
        aria-disabled={isIncreaseDisabled}
      >
        +
      </button>
    </div>
  );
}

================================================================================FILE: components/product/QuickOrderBox.tsx================================================================================'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2, Send, Zap } from 'lucide-react';

interface QuickOrderBoxProps {
  productId?: number;
  productName?: string;
  quantity?: number;
  variationId?: number;
  onQuickOrder?: (phone: string) => Promise<void>;
}

export function QuickOrderBox({ 
  productId, 
  productName, 
  quantity = 1,
  variationId,
  onQuickOrder 
}: QuickOrderBoxProps) {
  const [phone, setPhone] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const validatePhone = (phoneNumber: string): boolean => {
    // Vietnamese phone: 10-11 digits, may start with 0 or +84
    const cleaned = phoneNumber.replace(/[\s-]/g, '');
    const regex = /^(\+84|0)?[1-9][0-9]{8,9}$/;
    return regex.test(cleaned);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setSuccess(false);

    if (!phone.trim()) {
      setError('Vui lòng nhập số điện thoại');
      return;
    }

    if (!validatePhone(phone)) {
      setError('Số điện thoại không hợp lệ. Vui lòng nhập 10-11 chữ số');
      return;
    }

    setIsSubmitting(true);

    try {
      if (onQuickOrder) {
        await onQuickOrder(phone);
      } else {
        // Default: Zalo Notification (Option 1)
        const adminPhone = '0924923399'; // TODO: Move to env variable
        const message = encodeURIComponent(
          `Đặt hàng nhanh\n` +
          `SĐT: ${phone}\n` +
          `Sản phẩm: ${productName || 'N/A'}\n` +
          `Số lượng: ${quantity}`
        );
        const zaloLink = `https://zalo.me/${adminPhone}?text=${message}`;
        window.open(zaloLink, '_blank');
      }

      setSuccess(true);
      setPhone(''); // Clear input after success
      
      // Reset success message after 3 seconds
      setTimeout(() => setSuccess(false), 3000);
    } catch (err) {
      setError('Có lỗi xảy ra. Vui lòng thử lại sau.');
      console.error('Quick order error:', err);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
      {/* Title with Icon */}
      <div className="flex items-center gap-1.5 mb-2">
        <Zap className="w-4 h-4 text-orange-500 fill-orange-500" />
        <h3 className="font-bold text-text-main text-sm">
          Đặt hàng nhanh
        </h3>
      </div>
      
      {/* Horizontal Inline Form - Responsive flex with no wrap */}
      <form onSubmit={handleSubmit} className="flex items-start gap-2 flex-nowrap overflow-hidden">
        <div className="flex-1 min-w-0">
          <Input
            type="tel"
            placeholder="Nhập SĐT..."
            value={phone}
            onChange={(e) => {
              setPhone(e.target.value);
              setError(null);
            }}
            className="h-9 text-sm border-2 border-pink-200 focus:border-pink-400 rounded-lg w-full"
            disabled={isSubmitting}
            aria-label="Số điện thoại đặt hàng nhanh"
            aria-required="true"
            aria-invalid={error ? 'true' : 'false'}
            aria-describedby={error ? 'phone-error' : undefined}
          />
        </div>

        <Button
          type="submit"
          className="h-9 w-auto min-w-[44px] px-2 sm:px-3 bg-[#D6336C] hover:bg-[#BE185D] text-white flex-shrink-0"
          disabled={isSubmitting || !phone.trim()}
          aria-label="Gửi yêu cầu đặt hàng nhanh"
        >
          {isSubmitting ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <Send className="w-4 h-4" />
          )}
        </Button>
      </form>

      {/* Error and Success Messages */}
      {error && (
        <p id="phone-error" className="text-xs text-destructive mt-1.5" role="alert">
          {error}
        </p>
      )}
      {success && (
        <p className="text-xs text-green-600 mt-1.5" role="status">
          ✓ Đã gửi thông tin. Chúng tôi sẽ liên hệ với bạn sớm nhất!
        </p>
      )}
    </div>
  );
}

================================================================================FILE: components/product/RelatedProducts.tsx================================================================================'use client';

import { useProductsREST } from '@/lib/hooks/useProductsREST';
import { ProductCard } from './ProductCard';

interface RelatedProductsProps {
  productId: number;
  excludeId?: number;
}

export function RelatedProducts({
  productId,
  excludeId,
}: RelatedProductsProps) {
  // Get related products (simply get latest products, exclude current)
  const { products, loading } = useProductsREST(8);

  // Filter out current product
  const filteredProducts = products?.filter(
    (product) => Number(product.id) !== (excludeId || productId)
  ).slice(0, 4) || [];

  if (loading) {
    return (
      <div className="container-mobile py-8">
        <h2 className="font-heading text-2xl font-semibold mb-6">
          Sản phẩm liên quan
        </h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="animate-pulse">
              <div className="aspect-square bg-muted rounded-2xl mb-4" />
              <div className="h-4 bg-muted rounded mb-2" />
              <div className="h-6 bg-muted rounded w-2/3" />
            </div>
          ))}
        </div>
      </div>
    );
  }

  if (filteredProducts.length === 0) {
    return null;
  }

  return (
    <div className="container-mobile py-8">
      <h2 className="font-heading text-2xl font-semibold mb-6">
        Sản phẩm liên quan
      </h2>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {filteredProducts.map((product) => (
          <ProductCard
            key={product.id}
            product={product}
          />
        ))}
      </div>
    </div>
  );
}
================================================================================FILE: components/product/TrustBadges.tsx================================================================================'use client';

import { RefreshCcw, Truck, Phone, MapPin } from 'lucide-react';
import Link from 'next/link';

interface TrustBadgesProps {
  className?: string;
}

export function TrustBadges({ className }: TrustBadgesProps) {
  const badges = [
    {
      icon: RefreshCcw,
      title: 'Đổi hàng trong 3 ngày',
      description: 'Qua số điện thoại',
      color: 'text-pink-500',
      href: '/policies/return',
    },
    {
      icon: Truck,
      title: 'HCM Hỏa Tốc 60p',
      description: 'Ship Tỉnh 2-4 ngày',
      color: 'text-orange-500',
      href: '/policies/shipping',
    },
    {
      icon: Phone,
      title: 'Zalo/Hotline',
      description: '092 492 3399 (8h30 - 23h)',
      color: 'text-blue-500',
      href: 'https://zalo.me/0924923399',
      external: true,
    },
    {
      icon: MapPin,
      title: 'Cửa Hàng',
      description: '340 Phan Đình Phùng, P.1, Q.Phú Nhuận',
      color: 'text-red-500',
      href: '/contact',
    },
  ];

  return (
    <div className={className}>
      <div className="grid grid-cols-2 gap-3 md:gap-4">
        {badges.map((badge, index) => {
          const Icon = badge.icon;
          const content = (
            <div className="flex flex-col items-center gap-2 p-3 rounded-lg hover:bg-pink-50 transition-colors cursor-pointer">
              <Icon className={`w-6 h-6 ${badge.color}`} />
              <div className="text-center">
                <p className="text-xs font-medium text-text-main">{badge.title}</p>
                <p className="text-[10px] text-text-muted mt-0.5">{badge.description}</p>
              </div>
            </div>
          );

          if (badge.external) {
            return (
              <a
                key={index}
                href={badge.href}
                target="_blank"
                rel="noopener noreferrer"
                className="block"
              >
                {content}
              </a>
            );
          }

          return (
            <Link key={index} href={badge.href} className="block">
              {content}
            </Link>
          );
        })}
      </div>
    </div>
  );
}

================================================================================FILE: components/product/ViewToggle.tsx================================================================================'use client';

import { Button } from '@/components/ui/button';

type ViewMode = 'grid' | 'list';

interface ViewToggleProps {
  view: ViewMode;
  onViewChange: (view: ViewMode) => void;
}

export function ViewToggle({ view, onViewChange }: ViewToggleProps) {
  return (
    <div className="flex items-center gap-2 border rounded-full p-1">
      <Button
        type="button"
        variant={view === 'grid' ? 'default' : 'ghost'}
        size="sm"
        onClick={() => onViewChange('grid')}
        className="h-8 w-8 p-0"
        aria-label="Grid view"
      >
        ⊞
      </Button>
      <Button
        type="button"
        variant={view === 'list' ? 'default' : 'ghost'}
        size="sm"
        onClick={() => onViewChange('list')}
        className="h-8 w-8 p-0"
        aria-label="List view"
      >
        ☰
      </Button>
    </div>
  );
}

================================================================================FILE: components/product/VisualAttributeSelector.tsx================================================================================'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Check, Image as ImageIcon } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import Image from 'next/image';
import type { GlobalTerm } from '@/lib/hooks/useGlobalAttributes';

interface VisualAttributeSelectorProps {
  label: string;
  type: 'text' | 'color' | 'image' | 'button';
  options: string[]; // Option names (from product.attributes[].options)
  terms?: GlobalTerm[]; // Global terms with visual data
  selectedValue: string | null;
  onSelect: (value: string) => void;
  sizeGuideImage?: string; // Optional size guide image URL
}

/**
 * Visual Attribute Selector Component
 * 
 * Displays attributes with visual previews based on type:
 * - Color: Color swatches with hex codes
 * - Image: Image thumbnails
 * - Button/Text: Button-style selectors
 */
export function VisualAttributeSelector({
  label,
  type,
  options,
  terms = [],
  selectedValue,
  onSelect,
  sizeGuideImage,
}: VisualAttributeSelectorProps) {
  // Create a map of option name -> term for quick lookup
  const termMap = new Map<string, GlobalTerm>();
  terms.forEach((term) => {
    termMap.set(term.name, term);
  });

  // Get term for an option name
  const getTerm = (optionName: string): GlobalTerm | undefined => {
    return termMap.get(optionName);
  };

  // Render based on attribute type
  if (type === 'color') {
    return (
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          {label}
        </label>
        <div className="flex gap-3 items-center flex-wrap">
          {options.map((optionName, idx) => {
            const term = getTerm(optionName);
            const bgColor = term?.colorHex || term?.colorHex2 || '#E5E7EB';
            const isSelected = selectedValue === optionName;
            
            // Determine if color is light (for checkmark contrast)
            const lightColors = ['#FFFFFF', '#FDFBF7', '#F5F5DC', '#E5E7EB', '#FFF9FA', '#FEF3C7'];
            const bgColorUpper = bgColor.toUpperCase();
            const isLightColor = lightColors.includes(bgColorUpper) || 
                               optionName.toLowerCase().includes('trắng') || 
                               optionName.toLowerCase().includes('kem') ||
                               optionName.toLowerCase().includes('trang');
            
            return (
              <button
                key={idx}
                onClick={() => onSelect(optionName)}
                className={cn(
                  "w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all duration-200",
                  "border-2",
                  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                  isSelected 
                    ? "border-pink-600 ring-2 ring-pink-500 ring-offset-2 scale-110" 
                    : isLightColor
                      ? "border-gray-400 hover:scale-105 hover:border-pink-300"
                      : "border-gray-300 hover:scale-105 hover:border-pink-300"
                )}
                style={{ backgroundColor: bgColor }}
                title={`${label}: ${optionName}`}
                aria-label={`Chọn ${label.toLowerCase()} ${optionName}`}
                aria-pressed={isSelected}
              >
                {isSelected && (
                  <Check 
                    className={cn(
                      "w-4 h-4 md:w-5 md:h-5", 
                      isLightColor ? "text-gray-900" : "text-white"
                    )} 
                    strokeWidth={3}
                  />
                )}
              </button>
            );
          })}
        </div>
      </div>
    );
  }

  if (type === 'image') {
    return (
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          {label}
        </label>
        <div className="flex gap-3 items-center flex-wrap">
          {options.map((optionName, idx) => {
            const term = getTerm(optionName);
            const imageUrl = term?.imageUrl;
            const isSelected = selectedValue === optionName;
            
            return (
              <button
                key={idx}
                onClick={() => onSelect(optionName)}
                className={cn(
                  "relative w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 transition-all",
                  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                  isSelected
                    ? "border-pink-600 ring-2 ring-pink-500 ring-offset-2 scale-105"
                    : "border-gray-200 hover:border-pink-300 hover:scale-105"
                )}
                title={`${label}: ${optionName}`}
                aria-label={`Chọn ${label.toLowerCase()} ${optionName}`}
                aria-pressed={isSelected}
              >
                {imageUrl ? (
                  <Image
                    src={imageUrl}
                    alt={optionName}
                    fill
                    className="object-cover"
                    sizes="(max-width: 768px) 64px, 80px"
                  />
                ) : (
                  <div className="w-full h-full bg-gray-100 flex items-center justify-center">
                    <ImageIcon className="w-6 h-6 text-gray-400" />
                  </div>
                )}
                {isSelected && (
                  <div className="absolute inset-0 bg-pink-500/20 flex items-center justify-center">
                    <Check className="w-5 h-5 text-pink-600" strokeWidth={3} />
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </div>
    );
  }

  // Default: Button/Text style (for Size, Material, etc.)
  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <label className="block text-sm font-medium text-text-main">
          {label}
        </label>
        {sizeGuideImage && (
          <button
            type="button"
            onClick={() => {
              // Open size guide in new window or modal
              window.open(sizeGuideImage, '_blank');
            }}
            className="text-xs text-pink-600 hover:text-pink-700 underline"
            aria-label="Xem hướng dẫn kích thước"
          >
            Hướng dẫn kích thước
          </button>
        )}
      </div>
      <div className="flex gap-2 flex-nowrap overflow-x-auto scrollbar-hide">
        {options.map((optionName, idx) => {
          const isSelected = selectedValue === optionName;
          
          return (
            <button
              key={idx}
              onClick={() => onSelect(optionName)}
              className={cn(
                "text-xs sm:text-sm font-medium px-3 sm:px-4 py-2 rounded-md border-2 transition-all min-h-[44px]",
                "flex-shrink-0 whitespace-nowrap",
                "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                isSelected
                  ? "border-[#D6336C] bg-pink-50 text-[#D6336C]"
                  : "border-gray-200 bg-white text-gray-500 hover:border-pink-300 hover:text-pink-500"
              )}
              aria-label={`Chọn ${label.toLowerCase()} ${optionName}`}
              aria-pressed={isSelected}
            >
              {optionName}
            </button>
          );
        })}
      </div>
    </div>
  );
}
================================================================================FILE: components/product/VoucherSection.tsx================================================================================'use client';

import { useState } from 'react';
import { Copy, Check } from 'lucide-react';
import { cn } from '@/lib/utils/cn';

interface Voucher {
  code: string;
  discount: string;
  minOrder?: string; // e.g., "500K", "1tr", "2tr"
  description?: string;
}

interface VoucherSectionProps {
  vouchers?: Voucher[];
  className?: string;
}

// Default vouchers (hardcoded - có thể fetch từ API sau)
const defaultVouchers: Voucher[] = [
  {
    code: 'GIAM10K',
    discount: '10.000₫',
    minOrder: 'Đơn > 500K',
  },
  {
    code: 'GIAM20K',
    discount: '20.000₫',
    minOrder: 'Đơn > 1tr',
  },
  {
    code: 'GIAM40K',
    discount: '40.000₫',
    minOrder: 'Đơn > 2tr',
  },
];

export function VoucherSection({ vouchers = defaultVouchers, className }: VoucherSectionProps) {
  const [copiedCode, setCopiedCode] = useState<string | null>(null);

  const handleCopyCode = async (code: string) => {
    try {
      await navigator.clipboard.writeText(code);
      setCopiedCode(code);
      
      // Reset after 2 seconds
      setTimeout(() => setCopiedCode(null), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  return (
    <div className={cn('space-y-4', className)}>
      <div>
        <h3 className="font-bold text-sm text-text-main mb-3">
          VOUCHER KHUYẾN MÃI:
        </h3>
        
        {/* Vouchers List */}
        <div className="flex flex-wrap gap-3">
          {vouchers.map((voucher, index) => (
            <button
              key={index}
              onClick={() => handleCopyCode(voucher.code)}
              className={cn(
                'relative bg-pink-500 text-white px-4 py-2 rounded-lg',
                'hover:bg-pink-600 transition-colors',
                'flex flex-col items-center gap-1',
                'min-w-[120px]',
                'border-2 border-white shadow-sm'
              )}
            >
              <span className="font-bold text-sm">{voucher.code}</span>
              {voucher.minOrder && (
                <span className="text-xs opacity-90">{voucher.minOrder}</span>
              )}
              
              {/* Copy Icon */}
              <div className="absolute top-1 right-1">
                {copiedCode === voucher.code ? (
                  <Check className="w-3 h-3 text-white" />
                ) : (
                  <Copy className="w-3 h-3 text-white opacity-70" />
                )}
              </div>
            </button>
          ))}
        </div>
        
        {copiedCode && (
          <p className="text-xs text-green-600 mt-2">
            ✓ Đã copy mã: {copiedCode}
          </p>
        )}
      </div>
    </div>
  );
}

================================================================================END OF PRODUCT COMPONENTS EXPORT================================================================================