# PRODUCT FRONTEND SOURCE CODE (ProductCard & Public Pages)

Generated: 2025-12-14 15:41:09

Scope: Frontend product display components (not admin)


================================================================================




--- FILE: components/product/ProductCard.tsx ---


'use client';

import { useState, useMemo } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { Card } from '@/components/ui/card';
import { formatPrice } from '@/lib/utils/format';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { useProductVariations } from '@/lib/hooks/useProductVariations';
import { cn } from '@/lib/utils/cn';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { ShoppingCart, Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { getColorHex } from '@/lib/utils/colorMapping';
import { generateSlug } from '@/lib/utils/slug';
import { useQuickCheckoutStore } from '@/lib/store/useQuickCheckoutStore';

interface ProductCardProps {
  product: MappedProduct;
}

export function ProductCard({ product }: ProductCardProps) {
  const { addToCart } = useCartSync();
  // State cho viá»‡c chá»n Size/MÃ u
  const [selectedSize, setSelectedSize] = useState<string | null>(null);
  const [selectedColor, setSelectedColor] = useState<string | null>(null);
  
  // ============================================
  // LAZY LOADING: Chá»‰ fetch variations khi cáº§n
  // ============================================
  // Performance Optimization: Thay vÃ¬ fetch variations cho táº¥t cáº£ products ngay khi page load
  // (cÃ³ thá»ƒ gÃ¢y 40+ API calls Ä‘á»“ng thá»i), chÃºng ta chá»‰ fetch khi:
  // 1. User hover vÃ o card â†’ Prefetch Ä‘á»ƒ sáºµn sÃ ng khi user click size
  // 2. User Ä‘Ã£ chá»n size â†’ Cáº§n Ä‘á»ƒ hiá»ƒn thá»‹ giÃ¡ Ä‘á»™ng
  // 3. Product khÃ´ng cÃ³ giÃ¡ bÃ¡n thÆ°á»ng â†’ Cáº§n láº¥y giÃ¡ tháº¥p nháº¥t tá»« variations
  // 
  // Káº¿t quáº£: Giáº£m initial API calls tá»« 40 xuá»‘ng 0, cáº£i thiá»‡n Time to Interactive ~80%
  const [isHovered, setIsHovered] = useState(false);
  
  // Kiá»ƒm tra xem product cÃ³ giÃ¡ bÃ¡n thÆ°á»ng khÃ´ng
  const hasRegularPrice = useMemo(() => {
    if (!product) return false;
    const price = parseFloat(product.price || '0');
    const regularPrice = parseFloat(product.regularPrice || '0');
    return (price > 0) || (regularPrice > 0);
  }, [product]);
  
  // Fetch variations náº¿u:
  // 1. User hover vÃ o card (prefetch)
  // 2. User Ä‘Ã£ chá»n size
  // 3. Product khÃ´ng cÃ³ giÃ¡ bÃ¡n thÆ°á»ng (cáº§n láº¥y giÃ¡ tá»« variations)
  const shouldFetchVariations = isHovered || selectedSize !== null || !hasRegularPrice;
  
  // Fetch variations náº¿u product lÃ  variable type
  const { variations, isLoading: isLoadingVariations } = useProductVariations(
    product?.databaseId,
    { 
      enabled: !!product && product.type === 'variable' && 
               (product.variations?.length || 0) > 0 &&
               shouldFetchVariations
    }
  );
  
  // Láº¥y áº£nh hiá»ƒn thá»‹ (Æ°u tiÃªn áº£nh biáº¿n thá»ƒ náº¿u cÃ³ logic chá»n mÃ u, hiá»‡n táº¡i dÃ¹ng áº£nh chÃ­nh)
  const imageUrl = product?.image?.sourceUrl || '/images/teddy-placeholder.png';
  
  // TÃ¬m variation tÆ°Æ¡ng á»©ng vá»›i selectedSize
  const selectedVariation = useMemo(() => {
    if (!product) return null;
    if (!selectedSize || variations.length === 0) return null;
    
    // MongoVariant structure: { id, size, color, price, stock, ... }
    // Match variation by size directly (not through attributes array)
    const matchedVariation = variations.find((variation) => {
      // Check if variation.size matches selectedSize
      if (variation.size && variation.size === selectedSize) {
        // If color is also selected, check if it matches
        // But if variation doesn't have color (null/undefined), still match by size
        if (selectedColor) {
          // Only require color match if variation has a color value
          // If variation.color is null/undefined, it means this variation doesn't have color attribute
          // So we should still match it by size only
          return !variation.color || variation.color === selectedColor;
        }
        return true;
      }
      return false;
    });
    
    return matchedVariation || null;
  }, [selectedSize, selectedColor, variations, product]);
  
  // Logic hiá»ƒn thá»‹ giÃ¡: Æ¯u tiÃªn variation price, sau Ä‘Ã³ má»›i Ä‘áº¿n product price
  // Náº¿u khÃ´ng cÃ³ giÃ¡ bÃ¡n thÆ°á»ng, láº¥y giÃ¡ tháº¥p nháº¥t tá»« variations
  // MongoVariant structure: { id, size, color, price, stock, ... }
  const displayPrice = useMemo(() => {
    if (!product) return '0';
    
    // Náº¿u cÃ³ variation Ä‘Æ°á»£c chá»n, dÃ¹ng giÃ¡ cá»§a variation
    if (selectedVariation) {
      const price = String(selectedVariation.price || 0);
      return price;
    }
    
    // Fallback vá» giÃ¡ product gá»‘c
    const fallbackPrice = product.onSale ? product.salePrice : product.price;
    const numFallbackPrice = parseFloat(fallbackPrice || '0');
    
    // Náº¿u product khÃ´ng cÃ³ giÃ¡ bÃ¡n thÆ°á»ng (hoáº·c giÃ¡ = 0), nhÆ°ng cÃ³ variations
    // â†’ Láº¥y giÃ¡ tháº¥p nháº¥t tá»« variations
    if (numFallbackPrice <= 0 && variations.length > 0) {
      const prices = variations
        .map(v => v.price || 0)
        .filter(p => p > 0);
      
      if (prices.length > 0) {
        const minPrice = Math.min(...prices);
        return String(minPrice);
      }
    }
    
    // Náº¿u cÃ³ minPrice tá»« product (Ä‘Ã£ Ä‘Æ°á»£c map tá»« MongoDB)
    if (numFallbackPrice <= 0 && product.minPrice && product.minPrice > 0) {
      return String(product.minPrice);
    }
    
    return fallbackPrice;
  }, [selectedVariation, product, variations]);
  
  // Regular price Ä‘á»ƒ hiá»ƒn thá»‹ line-through khi cÃ³ sale
  const displayRegularPrice = useMemo(() => {
    if (!product) return null;
    if (selectedVariation) {
      // MongoVariant khÃ´ng cÃ³ regular_price, chá»‰ cÃ³ price
      // Return null Ä‘á»ƒ khÃ´ng hiá»ƒn thá»‹ line-through
      return null;
    }
    return product.regularPrice;
  }, [selectedVariation, product]);
  
  // Kiá»ƒm tra cÃ³ Ä‘ang sale khÃ´ng
  const isOnSale = useMemo(() => {
    if (!product) return false;
    if (selectedVariation) {
      // MongoVariant khÃ´ng cÃ³ on_sale field
      // Check if variation price is different from product regular price
      const variationPrice = selectedVariation.price || 0;
      const productRegularPrice = parseFloat(product.regularPrice) || 0;
      return variationPrice < productRegularPrice && variationPrice > 0;
    }
    return product.onSale || false;
  }, [selectedVariation, product]);
  
  // Extract Size and Color attributes from product (trÆ°á»›c early return Ä‘á»ƒ dÃ¹ng trong useMemo)
  // Fallback to mock data if attributes not available
  const sizeAttribute = product?.attributes?.find(
    (attr) => attr.name.toLowerCase().includes('size') || 
               attr.name.toLowerCase().includes('kÃ­ch thÆ°á»›c') ||
               attr.name.toLowerCase().includes('kich thuoc') ||
               attr.name === 'pa_size'
  );
  const colorAttribute = product?.attributes?.find(
    (attr) => attr.name.toLowerCase().includes('color') || 
               attr.name.toLowerCase().includes('mÃ u') ||
               attr.name.toLowerCase().includes('mau') ||
               attr.name === 'pa_color'
  );
  
  // Use real attributes if available, otherwise fallback to mock data
  const availableSizes = sizeAttribute?.options || ['60cm', '80cm', '1m', '1m2'];
  const availableColors = colorAttribute?.options || ['#EF4444', '#3B82F6', '#FFFFFF', '#FCD34D'];
  
  // Limit display to 4 sizes and 4 colors (Cáº­p nháº­t hiá»ƒn thá»‹ tá»‘i Ä‘a 4)
  const displaySizes = availableSizes.slice(0, 4);
  const displayColors = availableColors.slice(0, 4);
  const remainingColors = availableColors.length - displayColors.length;

  // Build product URL vá»›i query params cho selected attributes
  // Format: /products/slug?attribute_pa_size=60cm&attribute_pa_color=do
  const productUrl = useMemo(() => {
    if (!product) return '';
    
    const baseUrl = `/products/${product.slug || product.databaseId}`;
    const params = new URLSearchParams();
    
    // Helper function Ä‘á»ƒ táº¡o slug tá»« attribute name
    const createAttributeSlug = (name: string): string => {
      return generateSlug(name);
    };
    
    // ThÃªm size attribute náº¿u cÃ³
    if (selectedSize && sizeAttribute) {
      // WooCommerce format: attribute_pa_{slug}
      // VÃ­ dá»¥: attribute_pa_size hoáº·c attribute_pa_kich-thuoc
      const sizeAttrSlug = createAttributeSlug(sizeAttribute.name);
      const attrKey = `attribute_pa_${sizeAttrSlug}`;
      // Encode giÃ¡ trá»‹ size (cÃ³ thá»ƒ chá»©a kÃ½ tá»± Ä‘áº·c biá»‡t)
      params.append(attrKey, selectedSize);
    }
    
    // ThÃªm color attribute náº¿u cÃ³
    if (selectedColor && colorAttribute) {
      const colorAttrSlug = createAttributeSlug(colorAttribute.name);
      const attrKey = `attribute_pa_${colorAttrSlug}`;
      // Normalize tÃªn mÃ u thÃ nh slug (vÃ­ dá»¥: "Äá»" -> "do", "Há»“ng" -> "hong")
      const colorValue = createAttributeSlug(selectedColor);
      params.append(attrKey, colorValue);
    }
    
    const queryString = params.toString();
    return queryString ? `${baseUrl}?${queryString}` : baseUrl;
  }, [product, selectedSize, selectedColor, sizeAttribute, colorAttribute]);
  
  // Early return sau khi Ä‘Ã£ gá»i táº¥t cáº£ hooks
  if (!product || !product.name) return null;
  
  const isOutOfStock = product.stockStatus === 'outofstock';

  const handleQuickAdd = async (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    // Sá»­ dá»¥ng giÃ¡ cá»§a variation náº¿u cÃ³, náº¿u khÃ´ng thÃ¬ dÃ¹ng giÃ¡ product
    // MongoVariant structure: { id, size, color, price (number), stock, ... }
    let priceToUse: string;
    if (selectedVariation) {
      // MongoVariant chá»‰ cÃ³ price (number), khÃ´ng cÃ³ on_sale/sale_price/regular_price
      priceToUse = String(selectedVariation.price || 0);
    } else {
      // Use product price (string)
      priceToUse = product.onSale ? product.salePrice : product.price;
    }
    
    await addToCart({
      productId: product.databaseId,
      productName: `${product.name} ${selectedSize ? `(${selectedSize})` : ''}`,
      price: priceToUse || '0',
      image: product.image?.sourceUrl,
      quantity: 1,
      variationId: selectedVariation?.id ? (typeof selectedVariation.id === 'number' ? selectedVariation.id : parseInt(selectedVariation.id, 10) || undefined) : undefined,
      length: product.length || undefined,
      width: product.width || undefined,
      height: product.height || undefined,
      weight: product.weight ? parseFloat(product.weight) : undefined,
      volumetricWeight: product.volumetricWeight || undefined,
    });

    // Má»Ÿ QuickCheckoutModal sau khi thÃªm vÃ o giá»
    try {
      useQuickCheckoutStore.getState().onOpen();
      console.log('[ProductCard] QuickCheckoutModal opened');
    } catch (error) {
      console.error('[ProductCard] Error opening QuickCheckoutModal:', error);
    }
  };

  return (
    <div 
      className="group relative flex flex-col gap-2 bg-white rounded-2xl p-2 md:p-3 hover:shadow-lg transition-all duration-300 border border-transparent hover:border-pink-100"
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      {/* 1. Product Image Area */}
      <Link href={productUrl} className="relative aspect-square w-full overflow-hidden rounded-xl bg-gray-50">
        <Image
          src={imageUrl}
          alt={product.image?.altText || product.name}
          fill
          className="object-cover transition-transform duration-500 group-hover:scale-110"
          sizes="(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
        />
        
        {/* Badges */}
        <div className="absolute top-2 left-2 flex flex-col gap-1">
          {isOnSale && (
            <span className="bg-red-500 text-white text-[10px] md:text-xs font-bold px-2 py-1 rounded-full shadow-sm">
              Sale
            </span>
          )}
          {/* Logo Brand nhá» (nhÆ° áº£nh máº«u GOMI) */}
          <div className="bg-white/90 p-1 rounded-full shadow-sm w-6 h-6 flex items-center justify-center">
            <span className="text-[8px] font-extrabold text-pink-500">GB</span>
          </div>
        </div>

        {/* Quick Add Button (Hiá»‡n khi hover - Desktop) */}
        {/* Sá»­ dá»¥ng Button component vá»›i variant default Ä‘á»ƒ cÃ³ gradient effect Ä‘á»“ng bá»™ */}
        <Button
          onClick={handleQuickAdd}
          size="icon"
          className="absolute bottom-2 right-2 h-10 w-10 md:h-12 md:w-12 rounded-full shadow-md translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300"
          title="ThÃªm nhanh vÃ o giá»"
          aria-label="ThÃªm nhanh vÃ o giá»"
        >
          <ShoppingCart className="w-4 h-4 md:w-5 md:h-5" />
        </Button>
      </Link>

      {/* 2. Content Area */}
      <div className="flex flex-col gap-1">
        {/* TÃªn sáº£n pháº©m */}
        <Link href={productUrl}>
          <h3 className="font-heading text-sm md:text-base font-bold text-gray-700 line-clamp-2 min-h-[2.5rem] group-hover:text-pink-600 transition-colors">
            {product.name}
          </h3>
        </Link>

        {/* GiÃ¡ tiá»n - Style giá»‘ng áº£nh máº«u (MÃ u há»“ng Ä‘áº­m/Ä‘á») */}
        <div className="flex items-center gap-2">
          <span className="text-base md:text-lg font-extrabold text-[#D6336C]">
            {isLoadingVariations ? (
              <span className="text-gray-400">Äang táº£i...</span>
            ) : (
              formatPrice(displayPrice)
            )}
          </span>
          {isOnSale && displayRegularPrice && displayRegularPrice !== displayPrice && (
            <span className="text-xs text-gray-400 line-through">
              {formatPrice(displayRegularPrice)}
            </span>
          )}
        </div>

        {/* 3. Variants Selection (Size Tabs) - Style GOMI Compact vá»›i kÃ­ch thÆ°á»›c vá»«a pháº£i */}
        {displaySizes.length > 0 && (
          <div className="flex flex-wrap gap-1.5 mt-2">
            {displaySizes.map((size, idx) => (
              <button
                key={idx}
                onClick={(e) => {
                  e.preventDefault();
                  setSelectedSize(size);
                }}
                className={cn(
                  // STYLE CHUáº¨N GOMI vá»›i kÃ­ch thÆ°á»›c vá»«a pháº£i:
                  // 1. Text size nhá» vá»«a (10px), font medium
                  // 2. Padding vá»«a pháº£i (px-2 py-0.75)
                  // 3. Border má»ng, bo gÃ³c nháº¹ (rounded-sm)
                  // 4. Min height vá»«a pháº£i Ä‘á»ƒ Ä‘áº£m báº£o touch target
                  "text-[10px] md:text-xs font-medium px-2 py-0.75 rounded-sm border transition-all",
                  "min-h-[32px] touch-manipulation",
                  "flex items-center justify-center",
                  
                  // Tráº¡ng thÃ¡i Active (ÄÃ£ chá»n)
                  selectedSize === size
                    ? "border-[#D6336C] bg-pink-50 text-[#D6336C]" // Viá»n há»“ng Ä‘áº­m, ná»n há»“ng nháº¡t, chá»¯ há»“ng
                    : "border-gray-200 bg-white text-gray-500 hover:border-pink-300 hover:text-pink-500" // Máº·c Ä‘á»‹nh xÃ¡m nháº¡t
                )}
              >
                {size}
              </button>
            ))}
          </div>
        )}

        {/* 4. Color Selection (Dots) - Cáº­p nháº­t logic hiá»ƒn thá»‹ */}
        {displayColors.length > 0 && (
          <div className="flex gap-1.5 mt-1 items-center">
            {displayColors.map((colorName, idx) => {
              // Chuáº©n hÃ³a tÃªn mÃ u Ä‘á»ƒ tÃ¬m trong Map (chuyá»ƒn vá» chá»¯ thÆ°á»ng, bá» khoáº£ng tráº¯ng thá»«a)
              const lookupKey = colorName.toLowerCase().trim();
              
              // Láº¥y mÃ£ Hex tá»« Map, náº¿u khÃ´ng tháº¥y thÃ¬ thá»­ dÃ¹ng chÃ­nh nÃ³ (náº¿u lÃ  mÃ£ Hex), hoáº·c fallback vá» xÃ¡m
              const bgColor = getColorHex(colorName) || (colorName.startsWith('#') ? colorName : '#E5E7EB');
              const isSelected = selectedColor === colorName;
              
              return (
                <button
                  key={idx}
                  className={cn(
                    "relative w-6 h-6 rounded-full border-2 shadow-sm hover:scale-110 transition-transform",
                    // ThÃªm viá»n xÃ¡m cho táº¥t cáº£ mÃ u Ä‘á»ƒ dá»… nhÃ¬n hÆ¡n
                    ['#FFFFFF', '#FDFBF7', 'trang', 'kem'].includes(lookupKey) || lookupKey === 'tráº¯ng' || lookupKey === 'kem'
                      ? "border-gray-400" 
                      : "border-gray-300"
                  )}
                  style={{ backgroundColor: bgColor }}
                  title={`MÃ u: ${colorName}`}
                  onClick={(e) => {
                    e.preventDefault();
                    setSelectedColor(colorName);
                  }}
                >
                  {/* Dáº¥u tÃ­ch mÃ u há»“ng vá»›i viá»n tráº¯ng má»ng khi Ä‘Æ°á»£c chá»n */}
                  {isSelected && (
                    <div className="absolute inset-0 flex items-center justify-center">
                      <div className="w-4 h-4 rounded-full bg-pink-500 flex items-center justify-center border border-white">
                        <Check className="w-2.5 h-2.5 text-white" strokeWidth={3} />
                      </div>
                    </div>
                  )}
                </button>
              );
            })}
            {/* Hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng mÃ u cÃ²n láº¡i náº¿u cÃ³ */}
            {remainingColors > 0 && (
              <span className="text-[10px] text-gray-400">+{remainingColors}</span>
            )}
          </div>
        )}
      </div>
    </div>
  );
}



--- FILE: components/product/ProductInfo.tsx ---


'use client';

import { useState, useMemo, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { formatPrice } from '@/lib/utils/format';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { useProductVariations } from '@/lib/hooks/useProductVariations';
import { useMultipleGlobalAttributeTerms } from '@/lib/hooks/useGlobalAttributes';
import { QuantitySelector } from '@/components/product/QuantitySelector';
import { VisualAttributeSelector } from '@/components/product/VisualAttributeSelector';
import { getColorHex } from '@/lib/utils/colorMapping';
import { generateSlug } from '@/lib/utils/slug';
import { cn } from '@/lib/utils/cn';
import type { MappedProduct } from '@/lib/utils/productMapper';
import { Gift, ShoppingCart, Check, Loader2 } from 'lucide-react';
import { useQuickCheckoutStore } from '@/lib/store/useQuickCheckoutStore';

interface ProductInfoProps {
  product: MappedProduct;
  onAddToCart?: (variationId?: number, isGift?: boolean) => void;
  onGiftOrder?: () => void;
}

export function ProductInfo({ product, onAddToCart, onGiftOrder }: ProductInfoProps) {
  const { addToCart } = useCartSync();
  const searchParams = useSearchParams();
  const [selectedSize, setSelectedSize] = useState<string | null>(null);
  const [selectedColor, setSelectedColor] = useState<string | null>(null);
  const [quantity, setQuantity] = useState(1);
  const [isAdding, setIsAdding] = useState(false);
  const [addingType, setAddingType] = useState<'gift' | 'buy' | 'quick' | null>(null);

  // Fetch variations if product is variable type
  // Always call useProductVariations with consistent signature to avoid hooks violation
  const productId = product?.databaseId ?? null;
  const shouldFetchVariations = product?.type === 'variable' && (product?.variations?.length || 0) > 0;
  const { variations, isLoading: isLoadingVariations } = useProductVariations(
    productId,
    { enabled: shouldFetchVariations && !!productId }
  );

  // Find selected variation based on selectedSize
  // MongoVariant structure: { id, size, color, price, stock, ... }
  // Match variation by size directly (not through attributes array)
  const selectedVariation = useMemo(() => {
    if (!product || !selectedSize || variations.length === 0) return null;
    
    // Match variation by size directly (MongoDB variant structure)
    const matchedVariation = variations.find((variation) => {
      // Check if variation.size matches selectedSize
      if (variation.size && variation.size === selectedSize) {
        // If color is also selected, check if it matches
        // But if variation doesn't have color (null/undefined), still match by size
        if (selectedColor) {
          // Only require color match if variation has a color value
          // If variation.color is null/undefined, it means this variation doesn't have color attribute
          // So we should still match it by size only
          return !variation.color || variation.color === selectedColor;
        }
        return true;
      }
      return false;
    });
    
    return matchedVariation || null;
  }, [selectedSize, selectedColor, variations, product]);

  // Dynamic pricing
  // MongoVariant structure: { id, size, color, price, stock, ... }
  // MongoVariant khÃ´ng cÃ³ on_sale, sale_price, regular_price fields
  const displayPrice = useMemo(() => {
    if (!product) return '0';
    if (selectedVariation) {
      // MongoVariant chá»‰ cÃ³ price field
      const price = String(selectedVariation.price || 0);
      return price;
    }
    return product.onSale ? product.salePrice : product.price;
  }, [selectedVariation, product]);

  const displayRegularPrice = useMemo(() => {
    if (!product) return null;
    if (selectedVariation) {
      // MongoVariant khÃ´ng cÃ³ regular_price field
      // Return null Ä‘á»ƒ khÃ´ng hiá»ƒn thá»‹ line-through
      return null;
    }
    return product.regularPrice;
  }, [selectedVariation, product]);

  const isOnSale = useMemo(() => {
    if (!product) return false;
    if (selectedVariation) {
      // MongoVariant khÃ´ng cÃ³ on_sale field
      // Check if variation price is different from product regular price
      const variationPrice = selectedVariation.price || 0;
      const productRegularPrice = parseFloat(product.regularPrice) || 0;
      return variationPrice < productRegularPrice && variationPrice > 0;
    }
    return product.onSale || false;
  }, [selectedVariation, product]);

  // Extract Size and Color attributes (trÆ°á»›c early return Ä‘á»ƒ dÃ¹ng trong useEffect)
  const sizeAttribute = product?.attributes?.find(
    (attr) => attr.name.toLowerCase().includes('size') || 
               attr.name.toLowerCase().includes('kÃ­ch thÆ°á»›c') ||
               attr.name.toLowerCase().includes('kich thuoc')
  );
  const colorAttribute = product?.attributes?.find(
    (attr) => attr.name.toLowerCase().includes('color') || 
               attr.name.toLowerCase().includes('mÃ u') ||
               attr.name.toLowerCase().includes('mau')
  );

  const availableSizes = sizeAttribute?.options || [];
  const availableColors = colorAttribute?.options || [];

  const displaySizes = availableSizes.slice(0, 4);
  const displayColors = availableColors.slice(0, 4);

  // Fetch global attribute terms if globalAttributeId is available
  // Note: This requires product.attributes to include globalAttributeId (to be added in mapMongoProduct)
  const globalAttributeIds = useMemo(() => {
    const ids: string[] = [];
    product?.attributes?.forEach((attr: any) => {
      if (attr.globalAttributeId) {
        ids.push(attr.globalAttributeId);
      }
    });
    return ids;
  }, [product?.attributes]);

  const { 
    data: globalAttributeTermsData, 
    isLoading: isLoadingGlobalTerms,
    error: globalTermsError 
  } = useMultipleGlobalAttributeTerms(globalAttributeIds);

  // Handle error gracefully - log but don't crash
  useEffect(() => {
    if (globalTermsError) {
      console.error('[ProductInfo] Error loading global attribute terms:', globalTermsError);
      // Fallback to old color mapping will be used automatically
    }
  }, [globalTermsError]);

  // Create a map of globalAttributeId -> terms
  const globalTermsMap = useMemo(() => {
    // If there's an error, return empty map (fallback to old behavior)
    if (globalTermsError || !globalAttributeTermsData || globalAttributeTermsData.length === 0) {
      return new Map<string, any>();
    }
    
    const map = new Map<string, any>();
    globalAttributeTermsData.forEach((data) => {
      if (data?.attribute?.id) {
        map.set(data.attribute.id, data);
      }
    });
    return map;
  }, [globalAttributeTermsData, globalTermsError]);

  // Get global attribute type for an attribute
  const getGlobalAttributeType = (attr: any): 'text' | 'color' | 'image' | 'button' | null => {
    if (!attr.globalAttributeId) return null;
    const termsData = globalTermsMap.get(attr.globalAttributeId);
    return termsData?.attribute.type || null;
  };

  // Get global terms for an attribute
  const getGlobalTerms = (attr: any) => {
    if (!attr.globalAttributeId) return [];
    const termsData = globalTermsMap.get(attr.globalAttributeId);
    return termsData?.terms || [];
  };

  // Äá»c query params tá»« URL vÃ  tá»± Ä‘á»™ng chá»n size/color
  useEffect(() => {
    if (!product || !product.attributes) return;

    // Helper function Ä‘á»ƒ táº¡o slug tá»« attribute name
    const createAttributeSlug = (name: string): string => {
      return generateSlug(name);
    };

    // TÃ¬m size attribute vÃ  Ä‘á»c tá»« URL
    if (sizeAttribute) {
      const sizeAttrSlug = createAttributeSlug(sizeAttribute.name);
      const attrKey = `attribute_pa_${sizeAttrSlug}`;
      const sizeFromUrl = searchParams.get(attrKey);
      
      if (sizeFromUrl && availableSizes.includes(sizeFromUrl)) {
        setSelectedSize(sizeFromUrl);
      }
    }

    // TÃ¬m color attribute vÃ  Ä‘á»c tá»« URL
    if (colorAttribute) {
      const colorAttrSlug = createAttributeSlug(colorAttribute.name);
      const attrKey = `attribute_pa_${colorAttrSlug}`;
      const colorFromUrl = searchParams.get(attrKey);
      
      if (colorFromUrl) {
        // TÃ¬m mÃ u khá»›p (cÃ³ thá»ƒ lÃ  slug hoáº·c tÃªn Ä‘áº§y Ä‘á»§)
        const matchedColor = availableColors.find((color) => {
          const colorSlug = createAttributeSlug(color);
          return colorSlug === colorFromUrl || color.toLowerCase() === colorFromUrl.toLowerCase();
        });
        
        if (matchedColor) {
          setSelectedColor(matchedColor);
        }
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams, product, sizeAttribute, colorAttribute]);

  if (!product || !product.name) return null;

  const isOutOfStock = product.stockStatus === 'outofstock';

  const handleAddToCartClick = async (isGift: boolean = false, isQuickCheckout: boolean = false) => {
    // Validation: Náº¿u product cÃ³ variations nhÆ°ng chÆ°a chá»n size
    // Tá»± Ä‘á»™ng chá»n size Ä‘áº§u tiÃªn vÃ  tiáº¿p tá»¥c thÃªm vÃ o giá» (khÃ´ng return)
    if (product.type === 'variable' && availableSizes.length > 0 && !selectedSize) {
      if (availableSizes.length > 0) {
        setSelectedSize(availableSizes[0]);
        // KHÃ”NG return - Ä‘á»ƒ code tiáº¿p tá»¥c cháº¡y vÃ  thÃªm vÃ o giá» ngay trong láº§n báº¥m Ä‘áº§u tiÃªn
      }
    }

    setIsAdding(true);
    setAddingType(isGift ? 'gift' : isQuickCheckout ? 'quick' : 'buy');

    try {
      // MongoVariant structure: { id, size, color, price, stock, ... }
      // MongoVariant chá»‰ cÃ³ price field, khÃ´ng cÃ³ on_sale, sale_price, regular_price
      const priceToUse = selectedVariation 
        ? String(selectedVariation.price || 0)
        : (product.onSale ? product.salePrice : product.price);

      for (let i = 0; i < quantity; i++) {
        await addToCart({
          productId: product.databaseId,
          productName: `${product.name} ${selectedSize ? `(${selectedSize})` : ''}`,
          price: priceToUse || '0',
          image: product.image?.sourceUrl,
          quantity: 1,
          variationId: selectedVariation?.id ? (typeof selectedVariation.id === 'number' ? selectedVariation.id : parseInt(selectedVariation.id, 10) || undefined) : undefined,
          isGift: isGift,
          length: product.length || undefined,
          width: product.width || undefined,
          height: product.height || undefined,
          weight: product.weight ? parseFloat(product.weight) : undefined,
          volumetricWeight: product.volumetricWeight || undefined,
        });
      }

      if (onAddToCart) {
        onAddToCart(selectedVariation?.id ? (typeof selectedVariation.id === 'number' ? selectedVariation.id : parseInt(selectedVariation.id, 10) || undefined) : undefined, isGift);
      }

      // Má»Ÿ QuickCheckoutModal sau khi thÃªm vÃ o giá» (cho cáº£ "ThÃªm giá» hÃ ng" vÃ  "Mua ngay")
      try {
        useQuickCheckoutStore.getState().onOpen();
        console.log('[ProductInfo] QuickCheckoutModal opened');
      } catch (error) {
        console.error('[ProductInfo] Error opening QuickCheckoutModal:', error);
      }
    } catch (error) {
      console.error('Error adding to cart:', error);
    } finally {
      // Reset loading state after a short delay for better UX
      setTimeout(() => {
        setIsAdding(false);
        setAddingType(null);
      }, 500);
    }
  };

  return (
    <div className="space-y-6">
      {/* Product Name */}
      <div>
        <h1 className="font-heading text-2xl md:text-3xl font-bold mb-2">
          {product.name}
        </h1>
        {product.sku && (
          <p className="text-sm text-text-muted">
            SKU: {product.sku}
          </p>
        )}
      </div>

      {/* Price */}
      <div className="flex items-center gap-4">
        <p className="text-3xl font-bold text-primary">
          {isLoadingVariations ? (
            <span className="text-gray-400">Äang táº£i...</span>
          ) : (
            formatPrice(displayPrice)
          )}
        </p>
        {isOnSale && displayRegularPrice && displayRegularPrice !== displayPrice && (
          <p className="text-lg text-text-muted line-through">
            {formatPrice(displayRegularPrice)}
          </p>
        )}
      </div>

      {/* Size Selector - Use VisualAttributeSelector if global attribute, otherwise fallback */}
      {displaySizes.length > 0 && sizeAttribute && (
        (() => {
          const globalType = getGlobalAttributeType(sizeAttribute as any);
          const globalTerms = getGlobalTerms(sizeAttribute as any);
          
          // Use VisualAttributeSelector if it's a global attribute with type
          if (globalType) {
            return (
              <VisualAttributeSelector
                label="KÃ­ch thÆ°á»›c"
                type={globalType}
                options={displaySizes}
                terms={globalTerms}
                selectedValue={selectedSize}
                onSelect={setSelectedSize}
              />
            );
          }
          
          // Fallback to button style for non-global or text attributes
          return (
            <VisualAttributeSelector
              label="KÃ­ch thÆ°á»›c"
              type="button"
              options={displaySizes}
              selectedValue={selectedSize}
              onSelect={setSelectedSize}
            />
          );
        })()
      )}

      {/* Color Selector - Use VisualAttributeSelector if global attribute, otherwise fallback */}
      {displayColors.length > 0 && colorAttribute && (
        (() => {
          const globalType = getGlobalAttributeType(colorAttribute as any);
          const globalTerms = getGlobalTerms(colorAttribute as any);
          
          // Use VisualAttributeSelector if it's a global attribute with type
          if (globalType) {
            return (
              <VisualAttributeSelector
                label="MÃ u sáº¯c"
                type={globalType}
                options={displayColors}
                terms={globalTerms}
                selectedValue={selectedColor}
                onSelect={setSelectedColor}
              />
            );
          }
          
          // Fallback to color swatches using getColorHex (backward compatibility)
          return (
            <div>
              <label className="block text-sm font-medium text-text-main mb-2">
                MÃ u sáº¯c{selectedColor ? `: ${selectedColor}` : ''}
              </label>
              <div className="flex gap-3 items-center">
                {displayColors.map((colorName, idx) => {
                  const bgColor = getColorHex(colorName) || (colorName.startsWith('#') ? colorName : '#E5E7EB');
                  const isSelected = selectedColor === colorName;
                  
                  const lightColors = ['#FFFFFF', '#FDFBF7', '#F5F5DC', '#E5E7EB', '#FFF9FA', '#FEF3C7'];
                  const bgColorUpper = bgColor.toUpperCase();
                  const isLightColor = lightColors.includes(bgColorUpper) || 
                                       colorName.toLowerCase().includes('tráº¯ng') || 
                                       colorName.toLowerCase().includes('kem') ||
                                       colorName.toLowerCase().includes('trang');
                  
                  return (
                    <button
                      key={idx}
                      onClick={() => setSelectedColor(colorName)}
                      className={cn(
                        "w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all duration-200",
                        "border-2",
                        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                        isSelected 
                          ? "border-pink-600 ring-2 ring-pink-500 ring-offset-2 scale-110" 
                          : isLightColor
                            ? "border-gray-400 hover:scale-105 hover:border-pink-300"
                            : "border-gray-300 hover:scale-105 hover:border-pink-300"
                      )}
                      style={{ backgroundColor: bgColor }}
                      title={`MÃ u: ${colorName}`}
                      aria-label={`Chá»n mÃ u ${colorName}`}
                      aria-pressed={isSelected}
                    >
                      {isSelected && (
                        <Check 
                          className={cn(
                            "w-4 h-4 md:w-5 md:h-5", 
                            isLightColor ? "text-gray-900" : "text-white"
                          )} 
                          strokeWidth={3}
                        />
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          );
        })()
      )}

      {/* Actions (Horizontal Layout) */}
      <div className="space-y-4">
        {/* Row of Actions */}
        <div className="flex flex-wrap items-center gap-3">
          {/* 1. Quantity Capsule */}
          <QuantitySelector 
            value={quantity} 
            onChange={setQuantity} 
            min={1}
            max={product.stockQuantity || 99}
            disabled={isOutOfStock}
          />

          {/* 2. Add to Cart Button */}
          <Button 
            className="rounded-full bg-blue-500 hover:bg-blue-600 text-white border-none px-4 md:px-6 h-8 md:h-9 min-h-[44px] text-sm gap-2 shadow-sm shadow-blue-200 font-bold !flex items-center justify-center"
            disabled={isOutOfStock || isAdding}
            onClick={() => handleAddToCartClick(false)}
            aria-label="ThÃªm vÃ o giá» hÃ ng"
          >
            {isAdding && addingType === 'buy' ? (
              <>
                <Loader2 className="w-3.5 h-3.5 animate-spin" />
                <span>Äang thÃªm...</span>
              </>
            ) : (
              <>
                <ShoppingCart className="w-3.5 h-3.5 md:w-4 md:h-4 flex-shrink-0" />
                <span className="whitespace-nowrap">ThÃªm giá» hÃ ng</span>
              </>
            )}
          </Button>

          {/* 3. Gift Button */}
          <Button 
            className="rounded-full bg-pink-400 hover:bg-pink-500 text-white border-none px-4 md:px-6 h-8 md:h-9 min-h-[44px] text-sm gap-2 shadow-sm shadow-pink-200 font-bold !flex items-center justify-center"
            disabled={isOutOfStock || isAdding}
            onClick={() => handleAddToCartClick(true)}
            aria-label="Gá»­i táº·ng sáº£n pháº©m"
          >
            {isAdding && addingType === 'gift' ? (
              <>
                <Loader2 className="w-3.5 h-3.5 animate-spin flex-shrink-0" />
                <span className="whitespace-nowrap">Äang thÃªm...</span>
              </>
            ) : (
              <>
                <Gift className="w-3.5 h-3.5 md:w-4 md:h-4 flex-shrink-0" />
                <span className="whitespace-nowrap">Gá»¬I Táº¶NG</span>
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
}




--- FILE: components/product/ProductFilters.tsx ---


'use client';

import { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
  SheetFooter,
} from '@/components/ui/sheet';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Input } from '@/components/ui/input';
import { useProductFilters } from '@/lib/hooks/useProductFilters';
import { useProductAttributes } from '@/lib/hooks/useProductAttributes';
import { FilterForm, type FilterFormRef } from './FilterForm';
import {
  Filter,
  ChevronDown,
  Sparkles,
  ArrowDownWideNarrow,
  ArrowUpNarrowWide,
  Crown,
  Percent,
  DollarSign,
  Ruler,
  Palette,
  X,
  Check,
} from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { formatPrice } from '@/lib/utils/format';
import { getColorHex } from '@/lib/utils/colorMapping';

export function ProductFilters() {
  const { filters, updateFilter, clearFilters } = useProductFilters();
  const { getSizeOptions, getColorOptions, isLoading: attributesLoading } = useProductAttributes();
  const [isSheetOpen, setIsSheetOpen] = useState(false);
  
  // --- STATE CHO DESKTOP ---
  const [pricePopoverOpen, setPricePopoverOpen] = useState(false);
  const [sizePopoverOpen, setSizePopoverOpen] = useState(false);
  const [colorPopoverOpen, setColorPopoverOpen] = useState(false);
  
  // --- STATE RIÃŠNG CHO MOBILE ---
  const [mobilePriceOpen, setMobilePriceOpen] = useState(false);
  const [mobileSizeOpen, setMobileSizeOpen] = useState(false);
  const [mobileColorOpen, setMobileColorOpen] = useState(false);

  
  // Local state cho giÃ¡ trong Popover Ä‘á»ƒ trÃ¡nh spam URL khi gÃµ
  const [localMinPrice, setLocalMinPrice] = useState<string>(filters.minPrice?.toString() || '');
  const [localMaxPrice, setLocalMaxPrice] = useState<string>(filters.maxPrice?.toString() || '');
  const [priceError, setPriceError] = useState<string>('');

  // Sync local state vá»›i filters tá»« URL khi filters thay Ä‘á»•i (tá»« bÃªn ngoÃ i)
  useEffect(() => {
    setLocalMinPrice(filters.minPrice?.toString() || '');
    setLocalMaxPrice(filters.maxPrice?.toString() || '');
    setPriceError(''); // Clear error khi sync tá»« URL
  }, [filters.minPrice, filters.maxPrice]);

  // Láº¥y size vÃ  color options Ä‘á»™ng tá»« WooCommerce
  const sizeOptions = getSizeOptions();
  const colorOptions = getColorOptions();

  const hasActiveFilters = 
    filters.category || 
    filters.minPrice || 
    filters.maxPrice || 
    filters.material ||
    filters.size ||
    filters.color ||
    filters.sortBy;

  // Äáº¿m sá»‘ lÆ°á»£ng filter Ä‘ang active
  const activeFiltersCount = [
    filters.category,
    filters.minPrice,
    filters.maxPrice,
    filters.material,
    filters.size,
    filters.color,
    filters.sortBy,
  ].filter(Boolean).length;

  // Active filters for display as badges (excluding sortBy)
  const activeFilters = (() => {
    const active: Array<{ key: string; label: string; value: string; onRemove: () => void }> = [];
    
    if (filters.color) {
      active.push({
        key: 'color',
        label: 'MÃ u',
        value: filters.color,
        onRemove: () => updateFilter('color', null),
      });
    }
    
    if (filters.size) {
      active.push({
        key: 'size',
        label: 'KÃ­ch thÆ°á»›c',
        value: filters.size,
        onRemove: () => updateFilter('size', null),
      });
    }
    
    if (filters.minPrice || filters.maxPrice) {
      const priceLabel = filters.minPrice && filters.maxPrice
        ? `${formatPrice(filters.minPrice)} - ${formatPrice(filters.maxPrice)}`
        : filters.minPrice
        ? `Tá»« ${formatPrice(filters.minPrice)}`
        : `Äáº¿n ${formatPrice(filters.maxPrice!)}`;
      active.push({
        key: 'price',
        label: 'GiÃ¡',
        value: priceLabel,
        onRemove: () => {
          updateFilter('priceMin', null);
          updateFilter('minPrice', null);
          updateFilter('priceMax', null);
          updateFilter('maxPrice', null);
          setLocalMinPrice('');
          setLocalMaxPrice('');
        },
      });
    }
    
    if (filters.material) {
      active.push({
        key: 'material',
        label: 'Cháº¥t liá»‡u',
        value: filters.material,
        onRemove: () => updateFilter('material', null),
      });
    }
    
    if (filters.category) {
      active.push({
        key: 'category',
        label: 'Danh má»¥c',
        value: filters.category.split(',').length > 1 
          ? `${filters.category.split(',').length} danh má»¥c`
          : filters.category,
        onRemove: () => updateFilter('category', null),
      });
    }
    
    return active;
  })();

  // Sort options
  const sortOptions = [
    { value: 'newest', label: 'Má»›i nháº¥t', icon: Sparkles },
    { value: 'price_desc', label: 'GiÃ¡ cao - tháº¥p', icon: ArrowDownWideNarrow },
    { value: 'price_asc', label: 'GiÃ¡ tháº¥p - cao', icon: ArrowUpNarrowWide },
    { value: 'hot', label: 'Khuyáº¿n mÃ£i hot', icon: Percent },
    { value: 'bestseller', label: 'BÃ¡n cháº¡y nháº¥t', icon: Crown },
  ];

  // Size vÃ  Color options Ä‘Æ°á»£c láº¥y Ä‘á»™ng tá»« WooCommerce attributes
  // Format: { value: string, label: string } Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch vá»›i code hiá»‡n táº¡i
  const sizeOptionsFormatted = sizeOptions.map(size => ({
    value: size,
    label: size,
  }));

  const colorOptionsFormatted = colorOptions.map(color => ({
    value: color,
    label: color,
  }));

  const handlePriceApply = () => {
    // Validate trÆ°á»›c khi apply
    const min = localMinPrice ? Number(localMinPrice) : undefined;
    const max = localMaxPrice ? Number(localMaxPrice) : undefined;
    
    if (min !== undefined && max !== undefined && min > max) {
      setPriceError('GiÃ¡ tá»‘i thiá»ƒu khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n giÃ¡ tá»‘i Ä‘a');
      return; // KhÃ´ng apply náº¿u validation fail
    }
    
    setPriceError('');
    // Update URL khi nháº¥n "Ãp dá»¥ng"
    updateFilter('priceMin', min ?? null);
    updateFilter('minPrice', min ?? null);
    updateFilter('priceMax', max ?? null);
    updateFilter('maxPrice', max ?? null);
    // ÄÃ³ng cáº£ 2 Popover (Desktop vÃ  Mobile)
    setPricePopoverOpen(false);
    setMobilePriceOpen(false);
  };

  const handleSizeSelect = (size: string) => {
    updateFilter('size', filters.size === size ? null : size);
    // ÄÃ³ng cáº£ 2 Popover (Desktop vÃ  Mobile)
    setSizePopoverOpen(false);
    setMobileSizeOpen(false);
  };

  const handleColorSelect = (color: string) => {
    updateFilter('color', filters.color === color ? null : color);
    // ÄÃ³ng cáº£ 2 Popover (Desktop vÃ  Mobile)
    setColorPopoverOpen(false);
    setMobileColorOpen(false);
  };

  // Ref Ä‘á»ƒ láº¥y current filter values tá»« FilterForm (khi mode='manual')
  const filterFormRef = useRef<FilterFormRef>(null);

  const handleApplyFilters = () => {
    if (filterFormRef.current) {
      const filtersToApply = filterFormRef.current.getFilters();
      Object.entries(filtersToApply).forEach(([key, value]) => {
        updateFilter(key as keyof typeof filters, value);
      });
      setIsSheetOpen(false);
    }
  };

  return (
    <>
      {/* Mobile: Horizontal Scrolling Bar (1 dÃ²ng duy nháº¥t) - CHá»ˆ hiá»ƒn thá»‹ trÃªn mobile */}
      <div className="lg:hidden sticky top-[64px] z-40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80 border-b border-border/40">
        <div 
          className="flex flex-row items-center gap-2 overflow-x-auto scrollbar-hide py-2 flex-nowrap -mx-4 px-4 overflow-y-visible" 
          style={{ isolation: 'isolate' }}
          onTouchStart={(e) => {
            // Prevent scroll when clicking on buttons
            const target = e.target as HTMLElement;
            if (target.closest('button')) {
              e.stopPropagation();
            }
          }}
        >
          {/* NÃºt Lá»c cá»‘ Ä‘á»‹nh bÃªn trÃ¡i */}
          <div className="flex-shrink-0">
            <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
              <SheetTrigger asChild>
                <Button
                  variant="outline"
                  className="rounded-full gap-1.5 h-8 px-3 border-border/60 hover:border-primary/50 text-xs"
                >
                  <Filter className="w-3.5 h-3.5" />
                  <span>Lá»c</span>
                  {hasActiveFilters && (
                    <span className="ml-0.5 bg-primary text-primary-foreground rounded-full min-w-[16px] h-4 px-1 flex items-center justify-center text-[10px] font-semibold">
                      {activeFiltersCount}
                    </span>
                  )}
                </Button>
              </SheetTrigger>
              <SheetContent side="left" className="w-[85vw] sm:max-w-sm overflow-y-auto">
                <SheetHeader>
                  <SheetTitle className="text-left font-heading">
                    Bá»™ lá»c sáº£n pháº©m
                  </SheetTitle>
                </SheetHeader>

                <div className="mt-6">
                  <FilterForm 
                    ref={filterFormRef}
                    mode="manual"
                  />
                </div>

                <SheetFooter className="flex-col gap-2 sm:flex-row mt-8 pb-4 border-t pt-4">
                  {hasActiveFilters && (
                    <Button
                      variant="outline"
                      className="w-full sm:w-auto"
                      onClick={() => {
                        clearFilters();
                        setIsSheetOpen(false);
                      }}
                    >
                      <X className="w-4 h-4 mr-2" />
                      XÃ³a bá»™ lá»c
                    </Button>
                  )}
                  <Button
                    className="w-full sm:w-auto"
                    onClick={handleApplyFilters}
                  >
                    Ãp dá»¥ng
                  </Button>
                </SheetFooter>
              </SheetContent>
            </Sheet>
          </div>
          
          {/* Divider */}
          <div className="flex-shrink-0 w-px h-6 bg-border/60" />
          
          {/* CÃ¡c nÃºt scrollable */}
          <div className="flex flex-row items-center gap-2 flex-nowrap">

            {/* NÃºt GiÃ¡ bÃ¡n - Popover - MOBILE */}
            <Popover 
              open={mobilePriceOpen} 
              onOpenChange={setMobilePriceOpen}
              modal={false}
            >
              <PopoverTrigger asChild>
                <button
                  type="button"
                  className={cn(
                    "inline-flex items-center justify-center gap-1.5 h-8 px-3 rounded-full border text-xs flex-shrink-0 touch-manipulation transition-colors",
                    "border-border/60 hover:border-primary/50 bg-background hover:bg-accent",
                    (filters.minPrice || filters.maxPrice) && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <DollarSign className="w-3.5 h-3.5" />
                  <span>GiÃ¡</span>
                  {(filters.minPrice || filters.maxPrice) && (
                    <span className="text-[10px]">â€¢</span>
                  )}
                  <ChevronDown className="w-3 h-3" />
                </button>
              </PopoverTrigger>
              <PopoverContent 
                className="w-80 z-[100]" 
                align="start" 
                side="bottom"
                sideOffset={8}
                onOpenAutoFocus={(e) => {
                  // Prevent auto focus from closing popover
                  e.preventDefault();
                }}
                onPointerDownOutside={(e) => {
                  const target = e.target as HTMLElement;
                  // Don't close if clicking inside PopoverContent or on trigger
                  if (target.closest('button[data-radix-popover-trigger]') || 
                      target.closest('[data-radix-popover-content]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
                onInteractOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  
                  // Check if click is inside PopoverContent itself
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  
                  // Don't close if clicking on trigger button
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
              >
                <div className="space-y-3">
                  {/* Header vá»›i nÃºt Ä‘Ã³ng - MOBILE */}
                  <div className="flex items-center justify-between">
                    <h5 className="font-semibold text-sm text-text-main">Khoáº£ng giÃ¡</h5>
                    <button
                      type="button"
                      onClick={() => setMobilePriceOpen(false)}
                      className="ml-auto p-1.5 rounded-full hover:bg-muted transition-colors touch-manipulation"
                      aria-label="ÄÃ³ng"
                    >
                      <X className="w-4 h-4 text-text-muted" />
                    </button>
                  </div>
                
                {/* Price Presets */}
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => {
                      setLocalMinPrice('');
                      setLocalMaxPrice('200000');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMaxPrice === '200000' && !localMinPrice
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    DÆ°á»›i 200k
                  </button>
                  <button
                    onClick={() => {
                      setLocalMinPrice('200000');
                      setLocalMaxPrice('500000');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMinPrice === '200000' && localMaxPrice === '500000'
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    200k - 500k
                  </button>
                  <button
                    onClick={() => {
                      setLocalMinPrice('500000');
                      setLocalMaxPrice('1000000');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMinPrice === '500000' && localMaxPrice === '1000000'
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    500k - 1tr
                  </button>
                  <button
                    onClick={() => {
                      setLocalMinPrice('1000000');
                      setLocalMaxPrice('');
                      setPriceError('');
                    }}
                    className={cn(
                      "px-3 py-1.5 text-xs rounded-md border transition-colors",
                      localMinPrice === '1000000' && !localMaxPrice
                        ? "border-primary bg-pink-50 text-primary font-medium"
                        : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                    )}
                  >
                    TrÃªn 1tr
                  </button>
                </div>
                
                <div className="flex gap-2">
                  <Input
                    type="number"
                    placeholder="Tá»«"
                    value={localMinPrice}
                    onChange={(e) => {
                      setLocalMinPrice(e.target.value);
                      // Validate khi nháº­p
                      const min = e.target.value ? Number(e.target.value) : undefined;
                      const max = localMaxPrice ? Number(localMaxPrice) : undefined;
                      if (min !== undefined && max !== undefined && min > max) {
                        setPriceError('GiÃ¡ tá»‘i thiá»ƒu khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n giÃ¡ tá»‘i Ä‘a');
                      } else {
                        setPriceError('');
                      }
                    }}
                    className={cn("flex-1", priceError && "border-destructive")}
                  />
                  <Input
                    type="number"
                    placeholder="Äáº¿n"
                    value={localMaxPrice}
                    onChange={(e) => {
                      setLocalMaxPrice(e.target.value);
                      // Validate khi nháº­p
                      const min = localMinPrice ? Number(localMinPrice) : undefined;
                      const max = e.target.value ? Number(e.target.value) : undefined;
                      if (min !== undefined && max !== undefined && min > max) {
                        setPriceError('GiÃ¡ tá»‘i thiá»ƒu khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n giÃ¡ tá»‘i Ä‘a');
                      } else {
                        setPriceError('');
                      }
                    }}
                    className={cn("flex-1", priceError && "border-destructive")}
                  />
                </div>
                {priceError && (
                  <p className="text-xs text-destructive">{priceError}</p>
                )}
                {(localMinPrice || localMaxPrice) && !priceError && (
                  <div className="text-xs text-text-muted">
                    {localMinPrice && localMaxPrice
                      ? `${formatPrice(Number(localMinPrice))} - ${formatPrice(Number(localMaxPrice))}`
                      : localMinPrice
                      ? `Tá»« ${formatPrice(Number(localMinPrice))}`
                      : `Äáº¿n ${formatPrice(Number(localMaxPrice))}`}
                  </div>
                )}
                <div className="flex gap-2 pt-2">
                  <Button
                    variant="outline"
                    size="sm"
                    className="flex-1"
                    onClick={() => {
                      setLocalMinPrice('');
                      setLocalMaxPrice('');
                      setPriceError('');
                      updateFilter('priceMin', null);
          updateFilter('minPrice', null);
          updateFilter('priceMax', null);
          updateFilter('maxPrice', null);
                      // ÄÃ³ng cáº£ 2 Popover (Desktop vÃ  Mobile)
                      setPricePopoverOpen(false);
                      setMobilePriceOpen(false);
                    }}
                  >
                    XÃ³a
                  </Button>
                  <Button
                    size="sm"
                    className="flex-1"
                    onClick={() => {
                      handlePriceApply();
                      setMobilePriceOpen(false); // ÄÃ³ng mobile popover
                    }}
                    disabled={!!priceError}
                  >
                    Ãp dá»¥ng
                  </Button>
                </div>
              </div>
              </PopoverContent>
            </Popover>

            {/* NÃºt KÃ­ch thÆ°á»›c - Popover - MOBILE */}
            <Popover 
              open={mobileSizeOpen} 
              onOpenChange={setMobileSizeOpen}
              modal={false}
            >
              <PopoverTrigger asChild>
                <button
                  type="button"
                  className={cn(
                    "inline-flex items-center justify-center gap-1.5 h-8 px-3 rounded-full border text-xs flex-shrink-0 touch-manipulation transition-colors",
                    "border-border/60 hover:border-primary/50 bg-background hover:bg-accent",
                    filters.size && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Ruler className="w-3.5 h-3.5" />
                  <span>Size</span>
                  {filters.size && (
                    <span className="text-[10px]">â€¢</span>
                  )}
                  <ChevronDown className="w-3 h-3" />
                </button>
              </PopoverTrigger>
              <PopoverContent 
                className="w-64 z-[100]" 
                align="start" 
                side="bottom"
                sideOffset={8}
                onOpenAutoFocus={(e) => {
                  e.preventDefault();
                }}
                onPointerDownOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // Don't close if clicking inside PopoverContent or on trigger
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
                onInteractOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // CRITICAL: Check if click is inside PopoverContent itself
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  // Don't close if clicking on trigger button
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
              >
                <div className="space-y-3">
                  {/* Header vá»›i nÃºt Ä‘Ã³ng - MOBILE */}
                  <div className="flex items-center justify-between">
                    <h5 className="font-semibold text-sm text-text-main">Chá»n kÃ­ch thÆ°á»›c</h5>
                    <button
                      type="button"
                      onClick={() => setMobileSizeOpen(false)}
                      className="ml-auto p-1.5 rounded-full hover:bg-muted transition-colors touch-manipulation"
                      aria-label="ÄÃ³ng"
                    >
                      <X className="w-4 h-4 text-text-muted" />
                    </button>
                  </div>
                {attributesLoading ? (
                  <div className="text-sm text-text-muted py-4 text-center">Äang táº£i...</div>
                ) : sizeOptionsFormatted.length === 0 ? (
                  <div className="text-sm text-text-muted py-4 text-center">KhÃ´ng cÃ³ tÃ¹y chá»n</div>
                ) : (
                  <div className="grid grid-cols-2 gap-2">
                    {sizeOptionsFormatted.map((option) => {
                      const isSelected = filters.size === option.value;
                      // Map size labels to cm ranges
                      const sizeCmMap: Record<string, string> = {
                        'Nhá»': '< 30cm',
                        'Vá»«a': '30-50cm',
                        'Lá»›n': '50-80cm',
                        'Ráº¥t lá»›n': '> 80cm',
                      };
                      const sizeCm = sizeCmMap[option.label] || '';
                      return (
                        <button
                          key={option.value}
                          onClick={() => {
                            handleSizeSelect(option.value);
                            setMobileSizeOpen(false); // ÄÃ³ng mobile popover
                          }}
                          className={cn(
                            "text-left px-3 py-2 rounded-sm border transition-colors",
                            isSelected
                              ? "border-primary bg-pink-50 text-primary font-medium"
                              : "border-border hover:border-primary/50 hover:bg-muted/50"
                          )}
                        >
                          <div className="font-medium">{option.label}</div>
                          {sizeCm && (
                            <div className="text-xs text-text-muted mt-0.5">{sizeCm}</div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
                {filters.size && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={() => {
                      updateFilter('size', null);
                      // ÄÃ³ng cáº£ 2 Popover (Desktop vÃ  Mobile)
                      setSizePopoverOpen(false);
                      setMobileSizeOpen(false);
                    }}
                  >
                    XÃ³a lá»c
                  </Button>
                )}
              </div>
              </PopoverContent>
            </Popover>

            {/* NÃºt MÃ u sáº¯c - Popover - MOBILE */}
            <Popover 
              open={mobileColorOpen} 
              onOpenChange={setMobileColorOpen}
              modal={false}
            >
              <PopoverTrigger asChild>
                <button
                  type="button"
                  className={cn(
                    "inline-flex items-center justify-center gap-1.5 h-8 px-3 rounded-full border text-xs flex-shrink-0 touch-manipulation transition-colors",
                    "border-border/60 hover:border-primary/50 bg-background hover:bg-accent",
                    filters.color && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Palette className="w-3.5 h-3.5" />
                  <span>MÃ u</span>
                  {filters.color && (
                    <span className="text-[10px]">â€¢</span>
                  )}
                  <ChevronDown className="w-3 h-3" />
                </button>
              </PopoverTrigger>
              <PopoverContent 
                className="w-72 z-[100]" 
                align="start" 
                side="bottom"
                sideOffset={8}
                onOpenAutoFocus={(e) => {
                  e.preventDefault();
                }}
                onPointerDownOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // Don't close if clicking inside PopoverContent or on trigger
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
                onInteractOutside={(e) => {
                  const target = e.target as HTMLElement;
                  const popoverContent = e.currentTarget as HTMLElement;
                  // CRITICAL: Check if click is inside PopoverContent itself
                  if (popoverContent && popoverContent.contains(target)) {
                    e.preventDefault();
                    return;
                  }
                  // Don't close if clicking on trigger button
                  if (target.closest('button[data-radix-popover-trigger]')) {
                    e.preventDefault();
                    return;
                  }
                  // Allow close when clicking outside (better UX on mobile)
                }}
              >
                <div className="space-y-3">
                  {/* Header vá»›i nÃºt Ä‘Ã³ng - MOBILE */}
                  <div className="flex items-center justify-between">
                    <h5 className="font-semibold text-sm text-text-main">Chá»n mÃ u sáº¯c</h5>
                    <button
                      type="button"
                      onClick={() => setMobileColorOpen(false)}
                      className="ml-auto p-1.5 rounded-full hover:bg-muted transition-colors touch-manipulation"
                      aria-label="ÄÃ³ng"
                    >
                      <X className="w-4 h-4 text-text-muted" />
                    </button>
                  </div>
                {attributesLoading ? (
                  <div className="text-sm text-text-muted py-4 text-center">Äang táº£i...</div>
                ) : colorOptionsFormatted.length === 0 ? (
                  <div className="text-sm text-text-muted py-4 text-center">KhÃ´ng cÃ³ tÃ¹y chá»n</div>
                ) : (
                  <div className="grid grid-cols-6 gap-3">
                    {colorOptionsFormatted.map((option) => {
                      const isSelected = filters.color === option.value;
                      const colorHex = getColorHex(option.value) || '#E5E7EB'; // Fallback to gray
                      return (
                        <button
                          key={option.value}
                          onClick={() => {
                            handleColorSelect(option.value);
                            setMobileColorOpen(false); // ÄÃ³ng mobile popover
                          }}
                          className={cn(
                            "relative w-8 h-8 rounded-full transition-all",
                            "border-2 border-transparent",
                            isSelected
                              ? "ring-2 ring-offset-2 ring-primary ring-offset-white"
                              : "hover:ring-2 hover:ring-offset-2 hover:ring-primary/30 hover:ring-offset-white"
                          )}
                          style={{ backgroundColor: colorHex }}
                          title={option.label}
                          aria-label={option.label}
                        >
                          {isSelected && (
                            <div className="absolute inset-0 flex items-center justify-center">
                              <Check className="w-4 h-4 text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.5)]" />
                            </div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
                {filters.color && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={() => {
                      updateFilter('color', null);
                      // ÄÃ³ng cáº£ 2 Popover (Desktop vÃ  Mobile)
                      setColorPopoverOpen(false);
                      setMobileColorOpen(false);
                    }}
                  >
                    XÃ³a lá»c
                  </Button>
                )}
              </div>
              </PopoverContent>
            </Popover>
            
            {/* Sort Options - Mobile */}
            {sortOptions.map((option) => {
              const Icon = option.icon;
              const isSelected = filters.sortBy === option.value || 
                (!filters.sortBy && option.value === 'newest');
              const actualSelected = filters.sortBy === option.value;
              
              return (
                <button
                  key={option.value}
                  onClick={() => {
                    if (actualSelected) {
                      updateFilter('sortBy', null);
                    } else {
                      let sortValue: 'price_asc' | 'price_desc' | 'name_asc' | 'name_desc' | 'newest' | undefined;
                      if (option.value === 'hot' || option.value === 'bestseller') {
                        sortValue = 'newest';
                      } else {
                        sortValue = option.value as typeof sortValue;
                      }
                      updateFilter('sortBy', sortValue);
                    }
                  }}
                  type="button"
                  className={cn(
                    "flex items-center gap-1 px-2.5 h-8 rounded-full border whitespace-nowrap transition-all flex-shrink-0 text-xs touch-manipulation",
                    isSelected
                      ? "border-primary bg-pink-50 text-primary font-medium"
                      : "border-border/60 bg-white text-text-muted hover:border-primary/50 hover:text-text-main"
                  )}
                >
                  <Icon className="w-3.5 h-3.5 flex-shrink-0" />
                  <span>{option.label}</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* Desktop: Layout cÅ© (giá»¯ nguyÃªn) - CHá»ˆ hiá»ƒn thá»‹ trÃªn desktop */}
      <div className="hidden lg:block w-full space-y-4 mb-4">
        {/* DÃ²ng 1: Chá»n theo tiÃªu chÃ­ (Filter Group) */}
        <div className="space-y-2">
          <h4 className="text-sm font-semibold text-text-main">Chá»n theo tiÃªu chÃ­</h4>
          <div className="flex flex-row flex-wrap gap-2">
            {/* NÃºt GiÃ¡ bÃ¡n - Popover */}
            <Popover open={pricePopoverOpen} onOpenChange={setPricePopoverOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "rounded-md gap-2 h-9 border-border/60 hover:border-primary/50",
                    (filters.minPrice || filters.maxPrice) && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <DollarSign className="w-4 h-4" />
                  <span>GiÃ¡ bÃ¡n</span>
                  {(filters.minPrice || filters.maxPrice) && (
                    <span className="text-xs">â€¢</span>
                  )}
                  <ChevronDown className="w-3.5 h-3.5" />
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-80" align="start">
                <div className="space-y-3">
                  <h5 className="font-semibold text-sm text-text-main">Khoáº£ng giÃ¡</h5>
                  
                  {/* Price Presets */}
                  <div className="flex flex-wrap gap-2">
                    <button
                      onClick={() => {
                        setLocalMinPrice('');
                        setLocalMaxPrice('200000');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMaxPrice === '200000' && !localMinPrice
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      DÆ°á»›i 200k
                    </button>
                    <button
                      onClick={() => {
                        setLocalMinPrice('200000');
                        setLocalMaxPrice('500000');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMinPrice === '200000' && localMaxPrice === '500000'
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      200k - 500k
                    </button>
                    <button
                      onClick={() => {
                        setLocalMinPrice('500000');
                        setLocalMaxPrice('1000000');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMinPrice === '500000' && localMaxPrice === '1000000'
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      500k - 1tr
                    </button>
                    <button
                      onClick={() => {
                        setLocalMinPrice('1000000');
                        setLocalMaxPrice('');
                        setPriceError('');
                      }}
                      className={cn(
                        "px-3 py-1.5 text-xs rounded-md border transition-colors",
                        localMinPrice === '1000000' && !localMaxPrice
                          ? "border-primary bg-pink-50 text-primary font-medium"
                          : "border-border/60 hover:border-primary/50 hover:bg-muted/30"
                      )}
                    >
                      TrÃªn 1tr
                    </button>
                  </div>
                  
                  <div className="flex gap-2">
                    <Input
                      type="number"
                      placeholder="Tá»«"
                      value={localMinPrice}
                      onChange={(e) => {
                        setLocalMinPrice(e.target.value);
                        const min = e.target.value ? Number(e.target.value) : undefined;
                        const max = localMaxPrice ? Number(localMaxPrice) : undefined;
                        if (min !== undefined && max !== undefined && min > max) {
                          setPriceError('GiÃ¡ tá»‘i thiá»ƒu khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n giÃ¡ tá»‘i Ä‘a');
                        } else {
                          setPriceError('');
                        }
                      }}
                      className={cn("flex-1", priceError && "border-destructive")}
                    />
                    <Input
                      type="number"
                      placeholder="Äáº¿n"
                      value={localMaxPrice}
                      onChange={(e) => {
                        setLocalMaxPrice(e.target.value);
                        const min = localMinPrice ? Number(localMinPrice) : undefined;
                        const max = e.target.value ? Number(e.target.value) : undefined;
                        if (min !== undefined && max !== undefined && min > max) {
                          setPriceError('GiÃ¡ tá»‘i thiá»ƒu khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n giÃ¡ tá»‘i Ä‘a');
                        } else {
                          setPriceError('');
                        }
                      }}
                      className={cn("flex-1", priceError && "border-destructive")}
                    />
                  </div>
                  {priceError && (
                    <p className="text-xs text-destructive">{priceError}</p>
                  )}
                  {(localMinPrice || localMaxPrice) && !priceError && (
                    <div className="text-xs text-text-muted">
                      {localMinPrice && localMaxPrice
                        ? `${formatPrice(Number(localMinPrice))} - ${formatPrice(Number(localMaxPrice))}`
                        : localMinPrice
                        ? `Tá»« ${formatPrice(Number(localMinPrice))}`
                        : `Äáº¿n ${formatPrice(Number(localMaxPrice))}`}
                    </div>
                  )}
                  <div className="flex gap-2 pt-2">
                    <Button
                      variant="outline"
                      size="sm"
                      className="flex-1"
                      onClick={() => {
                        setLocalMinPrice('');
                        setLocalMaxPrice('');
                        setPriceError('');
                        updateFilter('priceMin', null);
          updateFilter('minPrice', null);
          updateFilter('priceMax', null);
          updateFilter('maxPrice', null);
                        setPricePopoverOpen(false);
                      }}
                    >
                      XÃ³a
                    </Button>
                    <Button
                      size="sm"
                      className="flex-1"
                      onClick={handlePriceApply}
                      disabled={!!priceError}
                    >
                      Ãp dá»¥ng
                    </Button>
                  </div>
                </div>
              </PopoverContent>
            </Popover>

            {/* NÃºt KÃ­ch thÆ°á»›c - Popover */}
            <Popover open={sizePopoverOpen} onOpenChange={setSizePopoverOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "rounded-md gap-2 h-9 border-border/60 hover:border-primary/50",
                    filters.size && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Ruler className="w-4 h-4" />
                  <span>KÃ­ch thÆ°á»›c</span>
                  {filters.size && (
                    <span className="text-xs">â€¢</span>
                  )}
                  <ChevronDown className="w-3.5 h-3.5" />
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-64" align="start">
                <div className="space-y-3">
                  <h5 className="font-semibold text-sm text-text-main">Chá»n kÃ­ch thÆ°á»›c</h5>
                  {attributesLoading ? (
                    <div className="text-sm text-text-muted py-4 text-center">Äang táº£i...</div>
                  ) : sizeOptionsFormatted.length === 0 ? (
                    <div className="text-sm text-text-muted py-4 text-center">KhÃ´ng cÃ³ tÃ¹y chá»n</div>
                  ) : (
                    <div className="grid grid-cols-2 gap-2">
                      {sizeOptionsFormatted.map((option) => {
                        const isSelected = filters.size === option.value;
                        const sizeCmMap: Record<string, string> = {
                          'Nhá»': '< 30cm',
                          'Vá»«a': '30-50cm',
                          'Lá»›n': '50-80cm',
                          'Ráº¥t lá»›n': '> 80cm',
                        };
                        const sizeCm = sizeCmMap[option.label] || '';
                        return (
                        <button
                          key={option.value}
                          onClick={() => {
                            handleSizeSelect(option.value);
                            setMobileSizeOpen(false); // ÄÃ³ng mobile popover
                          }}
                          className={cn(
                            "text-left px-3 py-2 rounded-sm border transition-colors",
                            isSelected
                              ? "border-primary bg-pink-50 text-primary font-medium"
                              : "border-border hover:border-primary/50 hover:bg-muted/50"
                          )}
                        >
                          <div className="font-medium">{option.label}</div>
                          {sizeCm && (
                            <div className="text-xs text-text-muted mt-0.5">{sizeCm}</div>
                          )}
                        </button>
                        );
                      })}
                    </div>
                  )}
                  {filters.size && (
                    <Button
                      variant="outline"
                      size="sm"
                      className="w-full"
                      onClick={() => {
                        updateFilter('size', null);
                        setSizePopoverOpen(false);
                      }}
                    >
                      XÃ³a lá»c
                    </Button>
                  )}
                </div>
              </PopoverContent>
            </Popover>

            {/* NÃºt MÃ u sáº¯c - Popover */}
            <Popover open={colorPopoverOpen} onOpenChange={setColorPopoverOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "rounded-md gap-2 h-9 border-border/60 hover:border-primary/50",
                    filters.color && "border-primary text-primary bg-pink-50"
                  )}
                >
                  <Palette className="w-4 h-4" />
                  <span>MÃ u sáº¯c</span>
                  {filters.color && (
                    <span className="text-xs">â€¢</span>
                  )}
                  <ChevronDown className="w-3.5 h-3.5" />
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-72" align="start">
                <div className="space-y-3">
                  <h5 className="font-semibold text-sm text-text-main">Chá»n mÃ u sáº¯c</h5>
                  {attributesLoading ? (
                    <div className="text-sm text-text-muted py-4 text-center">Äang táº£i...</div>
                  ) : colorOptionsFormatted.length === 0 ? (
                    <div className="text-sm text-text-muted py-4 text-center">KhÃ´ng cÃ³ tÃ¹y chá»n</div>
                  ) : (
                    <div className="grid grid-cols-6 gap-3">
                      {colorOptionsFormatted.map((option) => {
                        const isSelected = filters.color === option.value;
                        const colorHex = getColorHex(option.value) || '#E5E7EB';
                        return (
                          <button
                            key={option.value}
                            onClick={() => handleColorSelect(option.value)}
                            className={cn(
                              "relative w-8 h-8 rounded-full transition-all",
                              "border-2 border-transparent",
                              isSelected
                                ? "ring-2 ring-offset-2 ring-primary ring-offset-white"
                                : "hover:ring-2 hover:ring-offset-2 hover:ring-primary/30 hover:ring-offset-white"
                            )}
                            style={{ backgroundColor: colorHex }}
                            title={option.label}
                            aria-label={option.label}
                          >
                            {isSelected && (
                              <div className="absolute inset-0 flex items-center justify-center">
                                <Check className="w-4 h-4 text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.5)]" />
                              </div>
                            )}
                          </button>
                        );
                      })}
                    </div>
                  )}
                  {filters.color && (
                    <Button
                      variant="outline"
                      size="sm"
                      className="w-full"
                      onClick={() => {
                        updateFilter('color', null);
                        setColorPopoverOpen(false);
                      }}
                    >
                      XÃ³a lá»c
                    </Button>
                  )}
                </div>
              </PopoverContent>
            </Popover>
          </div>
        </div>

        {/* DÃ²ng 2: Sáº¯p xáº¿p theo (Sort Group) - Desktop */}
        <div className="space-y-2">
          <h4 className="text-sm font-semibold text-text-main">Sáº¯p xáº¿p theo</h4>
          <div className="flex gap-2 flex-wrap">
            {sortOptions.map((option) => {
              const Icon = option.icon;
              const isSelected = filters.sortBy === option.value || 
                (!filters.sortBy && option.value === 'newest');
              const actualSelected = filters.sortBy === option.value;
              
              return (
                <button
                  key={option.value}
                  onClick={() => {
                    if (actualSelected) {
                      updateFilter('sortBy', null);
                    } else {
                      let sortValue: 'price_asc' | 'price_desc' | 'name_asc' | 'name_desc' | 'newest' | undefined;
                      if (option.value === 'hot' || option.value === 'bestseller') {
                        sortValue = 'newest';
                      } else {
                        sortValue = option.value as typeof sortValue;
                      }
                      updateFilter('sortBy', sortValue);
                    }
                  }}
                  className={cn(
                    "flex items-center gap-1.5 px-3 py-1.5 rounded-full border whitespace-nowrap transition-all",
                    "min-h-[36px] touch-manipulation",
                    isSelected
                      ? "border-primary bg-pink-50 text-primary font-medium shadow-sm"
                      : "border-border/60 bg-white text-text-muted hover:border-primary/50 hover:text-text-main hover:bg-muted/30"
                  )}
                >
                  <Icon className="w-4 h-4 flex-shrink-0" />
                  <span className="text-sm">{option.label}</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* Active Filters Section - Hiá»ƒn thá»‹ cho cáº£ Mobile vÃ  Desktop */}
      {activeFilters.length > 0 && (
        <div className="w-full space-y-2 mt-4 md:mt-0">
          <h4 className="text-sm font-semibold text-text-main hidden md:block">Bá»™ lá»c Ä‘ang Ã¡p dá»¥ng</h4>
          <div className="flex flex-wrap gap-2">
            {activeFilters.map((filter) => (
              <div
                key={filter.key}
                className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-pink-50 border border-primary/20 text-sm"
              >
                <span className="text-text-main">
                  <span className="font-medium">{filter.label}:</span>{' '}
                  <span className="text-text-muted">{filter.value}</span>
                </span>
                <button
                  onClick={filter.onRemove}
                  className="ml-1 hover:bg-primary/10 rounded-full p-0.5 transition-colors"
                  aria-label={`XÃ³a bá»™ lá»c ${filter.label}`}
                >
                  <X className="w-3.5 h-3.5 text-text-muted hover:text-primary" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </>
  );
}



--- FILE: components/product/ProductDescription.tsx ---


'use client';

import { useState, useRef, useEffect } from 'react';
import { cn } from '@/lib/utils/cn';
import { Button } from '@/components/ui/button';
import { ChevronDown, ChevronUp } from 'lucide-react';
import { sanitizeHtml } from '@/lib/utils/sanitizeHtml';

interface ProductDescriptionProps {
  content: string;
  className?: string;
  maxHeight?: number; // Max height in pixels when collapsed (default: 300)
}

export function ProductDescription({ 
  content, 
  className,
  maxHeight = 300 
}: ProductDescriptionProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [needsExpandButton, setNeedsExpandButton] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);

  // Check if content exceeds maxHeight
  useEffect(() => {
    if (contentRef.current && !isExpanded) {
      const height = contentRef.current.scrollHeight;
      setNeedsExpandButton(height > maxHeight);
    }
  }, [content, maxHeight, isExpanded]);

  if (!content || !content.trim()) {
    return null;
  }

  return (
    <div className={cn('bg-white rounded-2xl p-4 md:p-6', className)}>
      <h3 className="font-heading text-lg font-semibold mb-4 text-text-main">
        MÃ´ táº£ sáº£n pháº©m
      </h3>
      
      <div className="relative">
        {/* Content Container */}
        <div
          ref={contentRef}
          className={cn(
            'overflow-hidden transition-all duration-300 ease-in-out',
            !isExpanded && needsExpandButton ? `max-h-[${maxHeight}px]` : 'max-h-none'
          )}
          style={{
            maxHeight: !isExpanded && needsExpandButton ? `${maxHeight}px` : 'none',
          }}
        >
          {/* HTML Content with Typography Plugin */}
          {/* Sanitized to prevent XSS attacks */}
          <div
            className="prose prose-sm md:prose-base max-w-none prose-headings:font-heading prose-headings:text-text-main prose-p:text-text-main prose-p:leading-relaxed prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-strong:text-text-main prose-strong:font-semibold prose-ul:text-text-main prose-ol:text-text-main prose-li:text-text-main prose-img:rounded-lg prose-img:max-w-full prose-img:h-auto prose-img:my-4 prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg"
            dangerouslySetInnerHTML={{ __html: sanitizeHtml(content) }}
          />
        </div>

        {/* Gradient Fade Effect (only when collapsed and needs expand) */}
        {!isExpanded && needsExpandButton && (
          <div 
            className="absolute bottom-0 left-0 right-0 h-20 pointer-events-none"
            style={{
              background: 'linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1))',
            }}
          />
        )}
      </div>

      {/* Expand/Collapse Button */}
      {needsExpandButton && (
        <div className="flex justify-center mt-4">
          <Button
            variant="outline"
            onClick={() => setIsExpanded(!isExpanded)}
            className="border-pink-200 text-primary hover:bg-pink-50 hover:border-pink-300 min-h-[44px] px-6"
            aria-expanded={isExpanded}
            aria-label={isExpanded ? 'Thu gá»n mÃ´ táº£' : 'Xem thÃªm mÃ´ táº£'}
          >
            {isExpanded ? (
              <>
                <ChevronUp className="w-4 h-4 mr-2" />
                Thu gá»n
              </>
            ) : (
              <>
                <ChevronDown className="w-4 h-4 mr-2" />
                Xem thÃªm
              </>
            )}
          </Button>
        </div>
      )}
    </div>
  );
}




--- FILE: components/product/ProductGallery.tsx ---


'use client';

import { useState } from 'react';
import Image from 'next/image';
import { cn } from '@/lib/utils/cn';
import { ChevronLeft, ChevronRight } from 'lucide-react';

interface ProductGalleryProps {
  images: Array<{
    sourceUrl: string;
    altText?: string;
  }>;
  productName?: string;
}

export function ProductGallery({ images, productName }: ProductGalleryProps) {
  const [selectedImageIndex, setSelectedImageIndex] = useState(0);

  // Fallback to placeholder if no images
  const allImages = images.length > 0 
    ? images 
    : [{ sourceUrl: '/images/teddy-placeholder.png', altText: productName || 'Sáº£n pháº©m' }];

  const mainImage = allImages[selectedImageIndex] || allImages[0];
  const thumbnails = allImages.slice(0, 5); // Limit to 5 thumbnails

  // Circular navigation handlers
  const handlePrevious = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();
    setSelectedImageIndex((prev) => {
      if (prev === 0) {
        return allImages.length - 1; // Loop to last image
      }
      return prev - 1;
    });
  };

  const handleNext = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();
    setSelectedImageIndex((prev) => {
      if (prev === allImages.length - 1) {
        return 0; // Loop to first image
      }
      return prev + 1;
    });
  };

  return (
    <div className="space-y-4">
      {/* Main Image */}
      <div className="relative aspect-square w-full overflow-hidden rounded-2xl bg-gray-50">
        <Image
          src={mainImage.sourceUrl}
          alt={mainImage.altText || productName || 'Sáº£n pháº©m'}
          fill
          className="object-cover"
          priority
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 40vw"
        />
        
        {/* Badge Logo "GB" */}
        <div className="absolute top-4 left-4 bg-white/90 p-1 rounded-full shadow-sm w-6 h-6 flex items-center justify-center z-10">
          <span className="text-[8px] font-extrabold text-pink-500">GB</span>
        </div>

        {/* Navigation Arrows - Only show if more than 1 image */}
        {allImages.length > 1 && (
          <>
            {/* Previous Button */}
            <button
              onClick={handlePrevious}
              className="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md transition-all z-10 w-10 h-10 flex items-center justify-center"
              aria-label="HÃ¬nh trÆ°á»›c"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>

            {/* Next Button */}
            <button
              onClick={handleNext}
              className="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md transition-all z-10 w-10 h-10 flex items-center justify-center"
              aria-label="HÃ¬nh tiáº¿p theo"
            >
              <ChevronRight className="w-5 h-5" />
            </button>
          </>
        )}
      </div>

      {/* Thumbnails */}
      {thumbnails.length > 1 && (
        <div className="flex md:grid md:grid-cols-5 gap-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory md:overflow-x-visible md:snap-none">
          {thumbnails.map((img, index) => (
            <button
              key={index}
              onClick={() => setSelectedImageIndex(index)}
              className={cn(
                "relative aspect-square overflow-hidden rounded-xl transition-all flex-shrink-0 snap-center",
                "border-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                "w-20 h-20 md:w-auto md:h-auto", // Fixed size on mobile for consistent scrolling
                selectedImageIndex === index
                  ? "border-primary scale-105"
                  : "border-transparent hover:border-pink-300"
              )}
              aria-label={`Xem hÃ¬nh ${index + 1} cá»§a sáº£n pháº©m`}
              aria-pressed={selectedImageIndex === index}
            >
              <Image
                src={img.sourceUrl}
                alt={img.altText || `HÃ¬nh ${index + 1}`}
                fill
                className="object-cover"
                sizes="(max-width: 768px) 80px, 12.5vw"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}




--- FILE: components/product/VisualAttributeSelector.tsx ---


'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Check, Image as ImageIcon } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import Image from 'next/image';
import type { GlobalTerm } from '@/lib/hooks/useGlobalAttributes';

interface VisualAttributeSelectorProps {
  label: string;
  type: 'text' | 'color' | 'image' | 'button';
  options: string[]; // Option names (from product.attributes[].options)
  terms?: GlobalTerm[]; // Global terms with visual data
  selectedValue: string | null;
  onSelect: (value: string) => void;
  sizeGuideImage?: string; // Optional size guide image URL
}

/**
 * Visual Attribute Selector Component
 * 
 * Displays attributes with visual previews based on type:
 * - Color: Color swatches with hex codes
 * - Image: Image thumbnails
 * - Button/Text: Button-style selectors
 */
export function VisualAttributeSelector({
  label,
  type,
  options,
  terms = [],
  selectedValue,
  onSelect,
  sizeGuideImage,
}: VisualAttributeSelectorProps) {
  // Create a map of option name -> term for quick lookup
  const termMap = new Map<string, GlobalTerm>();
  terms.forEach((term) => {
    termMap.set(term.name, term);
  });

  // Get term for an option name
  const getTerm = (optionName: string): GlobalTerm | undefined => {
    return termMap.get(optionName);
  };

  // Render based on attribute type
  if (type === 'color') {
    return (
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          {label}
        </label>
        <div className="flex gap-3 items-center flex-wrap">
          {options.map((optionName, idx) => {
            const term = getTerm(optionName);
            const bgColor = term?.colorHex || term?.colorHex2 || '#E5E7EB';
            const isSelected = selectedValue === optionName;
            
            // Determine if color is light (for checkmark contrast)
            const lightColors = ['#FFFFFF', '#FDFBF7', '#F5F5DC', '#E5E7EB', '#FFF9FA', '#FEF3C7'];
            const bgColorUpper = bgColor.toUpperCase();
            const isLightColor = lightColors.includes(bgColorUpper) || 
                               optionName.toLowerCase().includes('tráº¯ng') || 
                               optionName.toLowerCase().includes('kem') ||
                               optionName.toLowerCase().includes('trang');
            
            return (
              <button
                key={idx}
                onClick={() => onSelect(optionName)}
                className={cn(
                  "w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all duration-200",
                  "border-2",
                  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                  isSelected 
                    ? "border-pink-600 ring-2 ring-pink-500 ring-offset-2 scale-110" 
                    : isLightColor
                      ? "border-gray-400 hover:scale-105 hover:border-pink-300"
                      : "border-gray-300 hover:scale-105 hover:border-pink-300"
                )}
                style={{ backgroundColor: bgColor }}
                title={`${label}: ${optionName}`}
                aria-label={`Chá»n ${label.toLowerCase()} ${optionName}`}
                aria-pressed={isSelected}
              >
                {isSelected && (
                  <Check 
                    className={cn(
                      "w-4 h-4 md:w-5 md:h-5", 
                      isLightColor ? "text-gray-900" : "text-white"
                    )} 
                    strokeWidth={3}
                  />
                )}
              </button>
            );
          })}
        </div>
      </div>
    );
  }

  if (type === 'image') {
    return (
      <div>
        <label className="block text-sm font-medium text-text-main mb-2">
          {label}
        </label>
        <div className="flex gap-3 items-center flex-wrap">
          {options.map((optionName, idx) => {
            const term = getTerm(optionName);
            const imageUrl = term?.imageUrl;
            const isSelected = selectedValue === optionName;
            
            return (
              <button
                key={idx}
                onClick={() => onSelect(optionName)}
                className={cn(
                  "relative w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 transition-all",
                  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                  isSelected
                    ? "border-pink-600 ring-2 ring-pink-500 ring-offset-2 scale-105"
                    : "border-gray-200 hover:border-pink-300 hover:scale-105"
                )}
                title={`${label}: ${optionName}`}
                aria-label={`Chá»n ${label.toLowerCase()} ${optionName}`}
                aria-pressed={isSelected}
              >
                {imageUrl ? (
                  <Image
                    src={imageUrl}
                    alt={optionName}
                    fill
                    className="object-cover"
                    sizes="(max-width: 768px) 64px, 80px"
                  />
                ) : (
                  <div className="w-full h-full bg-gray-100 flex items-center justify-center">
                    <ImageIcon className="w-6 h-6 text-gray-400" />
                  </div>
                )}
                {isSelected && (
                  <div className="absolute inset-0 bg-pink-500/20 flex items-center justify-center">
                    <Check className="w-5 h-5 text-pink-600" strokeWidth={3} />
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </div>
    );
  }

  // Default: Button/Text style (for Size, Material, etc.)
  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <label className="block text-sm font-medium text-text-main">
          {label}
        </label>
        {sizeGuideImage && (
          <button
            type="button"
            onClick={() => {
              // Open size guide in new window or modal
              window.open(sizeGuideImage, '_blank');
            }}
            className="text-xs text-pink-600 hover:text-pink-700 underline"
            aria-label="Xem hÆ°á»›ng dáº«n kÃ­ch thÆ°á»›c"
          >
            HÆ°á»›ng dáº«n kÃ­ch thÆ°á»›c
          </button>
        )}
      </div>
      <div className="flex flex-wrap gap-2">
        {options.map((optionName, idx) => {
          const isSelected = selectedValue === optionName;
          
          return (
            <button
              key={idx}
              onClick={() => onSelect(optionName)}
              className={cn(
                "text-sm font-medium px-4 py-2 rounded-md border-2 transition-all min-h-[44px]",
                "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
                isSelected
                  ? "border-[#D6336C] bg-pink-50 text-[#D6336C]"
                  : "border-gray-200 bg-white text-gray-500 hover:border-pink-300 hover:text-pink-500"
              )}
              aria-label={`Chá»n ${label.toLowerCase()} ${optionName}`}
              aria-pressed={isSelected}
            >
              {optionName}
            </button>
          );
        })}
      </div>
    </div>
  );
}



--- FILE: components/product/ProductList.tsx ---


'use client';

import { useState } from 'react';
import Image from 'next/image';
import { useProductsREST } from '@/lib/hooks/useProductsREST';
import { ProductCard } from './ProductCard';
import { ViewToggle } from './ViewToggle';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { formatPrice } from '@/lib/utils/format';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { ProductListSkeleton } from '@/components/ui/skeleton';
import { NoProductsFoundState } from '@/components/ui/empty-state';
import { ErrorState } from '@/components/ui/error-state';

interface ProductListProps {
  initialCount?: number;
}

export function ProductList({ initialCount = 12 }: ProductListProps) {
  const { products, loading, error, hasNextPage, loadMore, totalCount } = useProductsREST(initialCount);
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const { addToCart } = useCartSync();

  // Hiá»ƒn thá»‹ skeleton khi Ä‘ang loading (cáº£ láº§n Ä‘áº§u vÃ  khi filter thay Ä‘á»•i)
  if (loading && products.length === 0) {
    return (
      <div className="w-full">
        <ProductListSkeleton count={8} />
      </div>
    );
  }

  if (error) {
    return (
      <div className="w-full">
        <ErrorState
          title="KhÃ´ng thá»ƒ táº£i sáº£n pháº©m"
          message={error.message || 'CÃ³ lá»—i xáº£y ra khi táº£i sáº£n pháº©m. Vui lÃ²ng thá»­ láº¡i sau.'}
          action={{
            label: 'Thá»­ láº¡i',
            onClick: () => window.location.reload(),
          }}
        />
      </div>
    );
  }

  if (products.length === 0 && !loading) {
    return (
      <div className="w-full">
        <NoProductsFoundState />
      </div>
    );
  }

  return (
    <div className="w-full relative">
      {/* Loading overlay khi Ä‘ang filter (cÃ³ products nhÆ°ng Ä‘ang loading) */}
      {loading && products.length > 0 && (
        <div className="absolute inset-0 bg-white/60 backdrop-blur-sm z-10 flex items-center justify-center rounded-lg">
          <div className="flex flex-col items-center gap-2">
            <div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin" />
            <p className="text-sm text-text-muted">Äang táº£i...</p>
          </div>
        </div>
      )}

      <div className="flex items-center justify-between mb-6">
        {totalCount > 0 && (
          <p className="text-sm text-text-muted">
            TÃ¬m tháº¥y {totalCount} sáº£n pháº©m
          </p>
        )}
        <ViewToggle view={viewMode} onViewChange={setViewMode} />
      </div>

      {viewMode === 'grid' ? (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-4 lg:gap-6">
          {products.map((product) => {
            if (!product || !product.name) {
              return null;
            }
            return <ProductCard key={product.id || product.databaseId} product={product} />;
          })}
        </div>
      ) : (
        <div className="space-y-4">
          {products.map((product) => {
            if (!product || !product.name) {
              return null;
            }
            const isOutOfStock = product.stockStatus === 'outofstock' || product.stockStatus === 'OUT_OF_STOCK';
            return (
              <Card key={product.id || product.databaseId} className="p-4">
                <div className="flex gap-4">
                  <div className="relative w-24 h-24 md:w-32 md:h-32 flex-shrink-0 rounded-xl overflow-hidden bg-gray-50">
                    <Image
                      src={product.image?.sourceUrl || '/images/teddy-placeholder.png'}
                      alt={product.image?.altText || product.name || 'Gáº¥u bÃ´ng'}
                      fill
                      className="object-cover"
                      sizes="(max-width: 768px) 96px, 128px"
                    />
                  </div>
                  <div className="flex-1 min-w-0">
                    <h3 className="font-heading text-lg font-semibold text-text-main mb-2">
                      {product.name}
                    </h3>
                    <p className="text-primary font-bold text-xl mb-2">
                      {formatPrice(product.price)}
                    </p>
                    <Button
                      className="w-full md:w-auto"
                      disabled={isOutOfStock}
                      onClick={async () => {
                        if (!isOutOfStock) {
                          await addToCart({
                            productId: product.databaseId,
                            productName: product.name,
                            price: product.price || '0',
                            image: product.image?.sourceUrl,
                            length: product.length || undefined,
                            width: product.width || undefined,
                            height: product.height || undefined,
                            weight: product.weight ? parseFloat(product.weight) : undefined,
                            volumetricWeight: product.volumetricWeight || undefined,
                          });
                        }
                      }}
                    >
                      {isOutOfStock ? 'Háº¿t hÃ ng' : 'ThÃªm vÃ o giá»'}
                    </Button>
                  </div>
                </div>
              </Card>
            );
          })}
        </div>
      )}

      {hasNextPage && (
        <div className="mt-8 text-center">
          <Button onClick={loadMore} variant="outline">
            Xem thÃªm sáº£n pháº©m
          </Button>
        </div>
      )}
    </div>
  );
}




--- FILE: components/product/AddToCartButton.tsx ---


'use client';

import { Button } from '@/components/ui/button';
import { useCartSync } from '@/lib/hooks/useCartSync';
import { type CartItem } from '@/lib/store/cartStore';
import { useState } from 'react';
import { Loader2 } from 'lucide-react';
import { useQuickCheckoutStore } from '@/lib/store/useQuickCheckoutStore';

interface AddToCartButtonProps {
  product: Omit<CartItem, 'quantity'>;
  disabled?: boolean;
}

export function AddToCartButton({ product, disabled }: AddToCartButtonProps) {
  const { addToCart } = useCartSync();
  const [isAdding, setIsAdding] = useState(false);

  const handleAddToCart = async () => {
    if (disabled) return;

    setIsAdding(true);
    try {
      await addToCart(product);
      // Má»Ÿ QuickCheckoutModal sau khi thÃªm vÃ o giá»
      useQuickCheckoutStore.getState().onOpen();
    } catch (error) {
      console.error('Error adding to cart:', error);
    } finally {
      // Show feedback
      setTimeout(() => {
        setIsAdding(false);
      }, 500);
    }
  };

  // Button text - Hiá»ƒn thá»‹ loading state vá»›i spinner
  const getButtonContent = () => {
    if (isAdding) {
      return (
        <>
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          Äang thÃªm...
        </>
      );
    }
    if (disabled) {
      return 'Háº¿t hÃ ng';
    }
    return 'ThÃªm vÃ o giá» hÃ ng';
  };

  return (
    <Button
      className="w-full relative"
      size="lg"
      disabled={disabled || isAdding}
      onClick={handleAddToCart}
    >
      {getButtonContent()}
    </Button>
  );
}




--- FILE: components/product/QuantitySelector.tsx ---


'use client';

import { useState, useEffect } from 'react';
import { cn } from '@/lib/utils/cn';

interface QuantitySelectorProps {
  value: number;
  onChange: (value: number) => void;
  min?: number;
  max?: number;
  disabled?: boolean;
}

export function QuantitySelector({
  value,
  onChange,
  min = 1,
  max = 99,
  disabled = false,
}: QuantitySelectorProps) {
  // Local state Ä‘á»ƒ cho phÃ©p input trá»‘ng táº¡m thá»i khi ngÆ°á»i dÃ¹ng Ä‘ang nháº­p
  const [inputValue, setInputValue] = useState<string>(value.toString());
  const [isFocused, setIsFocused] = useState(false);

  // Sync local state vá»›i prop value khi khÃ´ng focus
  useEffect(() => {
    if (!isFocused) {
      setInputValue(value.toString());
    }
  }, [value, isFocused]);

  const handleDecrease = () => {
    if (value > min && !disabled) {
      onChange(value - 1);
    }
  };

  const handleIncrease = () => {
    if (value < max && !disabled) {
      onChange(value + 1);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const rawValue = e.target.value;
    
    // Cho phÃ©p input trá»‘ng táº¡m thá»i (Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ xÃ³a vÃ  nháº­p láº¡i)
    if (rawValue === '') {
      setInputValue('');
      return;
    }

    // Chá»‰ parse vÃ  validate khi cÃ³ giÃ¡ trá»‹
    const numValue = parseInt(rawValue, 10);
    
    // Náº¿u khÃ´ng pháº£i sá»‘ há»£p lá»‡, giá»¯ nguyÃªn giÃ¡ trá»‹ hiá»‡n táº¡i
    if (isNaN(numValue)) {
      return;
    }

    // Cáº­p nháº­t local state Ä‘á»ƒ hiá»ƒn thá»‹
    setInputValue(rawValue);

    // Validate vÃ  update parent chá»‰ khi giÃ¡ trá»‹ há»£p lá»‡
    if (numValue >= min && numValue <= max) {
      onChange(numValue);
    }
    // Náº¿u vÆ°á»£t quÃ¡ max, váº«n cho phÃ©p hiá»ƒn thá»‹ nhÆ°ng khÃ´ng update parent
    // (sáº½ Ä‘Æ°á»£c validate láº¡i khi blur)
  };

  const handleBlur = () => {
    setIsFocused(false);
    const numValue = parseInt(inputValue, 10);
    
    // Náº¿u input trá»‘ng hoáº·c khÃ´ng há»£p lá»‡, set vá» giÃ¡ trá»‹ hiá»‡n táº¡i
    if (isNaN(numValue) || inputValue === '') {
      setInputValue(value.toString());
      return;
    }

    // Validate vÃ  clamp giÃ¡ trá»‹
    let finalValue = numValue;
    if (numValue < min) {
      finalValue = min;
    } else if (numValue > max) {
      finalValue = max;
    }

    // Update parent vÃ  local state
    onChange(finalValue);
    setInputValue(finalValue.toString());
  };

  const handleFocus = () => {
    setIsFocused(true);
  };

  const isDecreaseDisabled = disabled || value <= min;
  const isIncreaseDisabled = disabled || value >= max;

  return (
    <div className="flex items-center justify-between w-[110px] md:w-[120px] h-8 md:h-9 min-h-[44px] border-2 border-pink-300 rounded-full bg-white px-1 box-border">
      {/* Decrease Button */}
      <button
        type="button"
        onClick={handleDecrease}
        disabled={isDecreaseDisabled}
        className={cn(
          "flex items-center justify-center w-6 h-6 rounded-full",
          "text-pink-500 font-bold text-lg transition-colors",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-500 focus-visible:ring-offset-2",
          "hover:bg-pink-50 active:bg-pink-100",
          "disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent",
          "pb-0.5" // CÄƒn chá»‰nh dáº¥u - cho cÃ¢n giá»¯a
        )}
        aria-label="Giáº£m sá»‘ lÆ°á»£ng"
        aria-disabled={isDecreaseDisabled}
      >
        âˆ’
      </button>

      {/* Input */}
      <input
        type="text"
        inputMode="numeric"
        pattern="[0-9]*"
        value={inputValue}
        onChange={handleInputChange}
        onFocus={handleFocus}
        onBlur={handleBlur}
        disabled={disabled}
        role="spinbutton"
        className={cn(
          "w-10 md:w-12 h-full border-none bg-transparent text-center",
          "text-sm md:text-base font-bold text-gray-800",
          "focus-visible:outline-none",
          "disabled:cursor-not-allowed disabled:opacity-50",
          "[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
        )}
        aria-label="Sá»‘ lÆ°á»£ng"
        aria-valuemin={min}
        aria-valuemax={max}
        aria-valuenow={value}
      />

      {/* Increase Button */}
      <button
        type="button"
        onClick={handleIncrease}
        disabled={isIncreaseDisabled}
        className={cn(
          "flex items-center justify-center w-6 h-6 rounded-full",
          "text-pink-500 font-bold text-lg transition-colors",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-500 focus-visible:ring-offset-2",
          "hover:bg-pink-50 active:bg-pink-100",
          "disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent",
          "pb-0.5" // CÄƒn chá»‰nh dáº¥u + cho cÃ¢n giá»¯a
        )}
        aria-label="TÄƒng sá»‘ lÆ°á»£ng"
        aria-disabled={isIncreaseDisabled}
      >
        +
      </button>
    </div>
  );
}




--- FILE: components/product/ProductBadges.tsx ---


'use client';

interface ProductBadgesProps {
  onSale?: boolean | null;
  featured?: boolean | null;
  isNew?: boolean | null;
}

export function ProductBadges({ onSale, featured, isNew }: ProductBadgesProps) {
  const badges = [];

  if (onSale) {
    badges.push(
      <span
        key="sale"
        className="bg-accent text-accent-foreground text-xs font-semibold px-2 py-1 rounded-full"
      >
        Giáº£m giÃ¡
      </span>
    );
  }

  if (featured) {
    badges.push(
      <span
        key="featured"
        className="bg-primary text-primary-foreground text-xs font-semibold px-2 py-1 rounded-full"
      >
        Ná»•i báº­t
      </span>
    );
  }

  if (isNew) {
    badges.push(
      <span
        key="new"
        className="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-full"
      >
        Má»›i
      </span>
    );
  }

  if (badges.length === 0) {
    return null;
  }

  return (
    <div className="absolute top-2 left-2 flex flex-wrap gap-2 z-10">
      {badges}
    </div>
  );
}




--- FILE: components/product/ProductPromotions.tsx ---


'use client';

import { Gift, Package, Truck, Shield, Star } from 'lucide-react';

interface ProductPromotionsProps {
  promotions?: {
    freeGift?: boolean;
    freeCard?: boolean;
    freeShip?: boolean;
    warranty?: boolean;
    rewardPoints?: boolean;
  };
}

export function ProductPromotions({ promotions }: ProductPromotionsProps) {
  // Default promotions (hardcoded - cÃ³ thá»ƒ láº¥y tá»« ACF fields sau)
  const defaultPromotions = {
    freeGift: true,
    freeCard: true,
    freeShip: true,
    warranty: true,
    rewardPoints: true,
  };

  const activePromotions = promotions || defaultPromotions;

  // Check if any promotion is active
  const hasActivePromotions =
    activePromotions.freeGift ||
    activePromotions.freeCard ||
    activePromotions.freeShip ||
    activePromotions.warranty ||
    activePromotions.rewardPoints;

  if (!hasActivePromotions) return null;

  return (
    <div className="bg-pink-50 border border-pink-200 rounded-xl p-4">
      <h3 className="font-heading text-lg font-semibold mb-3">
        Æ¯u Ä‘Ã£i Ä‘áº·c biá»‡t
      </h3>
      <ul className="space-y-2">
        {activePromotions.freeGift && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Gift className="w-4 h-4 text-primary" />
            <span>Miá»…n phÃ­ GÃ³i QuÃ  (TÃºi trong suá»‘t + NÆ¡)</span>
          </li>
        )}
        {activePromotions.freeCard && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Package className="w-4 h-4 text-primary" />
            <span>Miá»…n phÃ­ Táº·ng kÃ¨m thiá»‡p Ã½ nghÄ©a (Sinh nháº­t, TÃ¬nh yÃªu, Cáº£m Æ¡n, Lá»… táº¿t)</span>
          </li>
        )}
        {activePromotions.freeShip && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Truck className="w-4 h-4 text-primary" />
            <span>Há»a Tá»‘c: Giao hÃ ng trong 45-60 phÃºt táº¡i HCM</span>
          </li>
        )}
        {activePromotions.warranty && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Shield className="w-4 h-4 text-primary" />
            <span>Báº£o HÃ nh: Báº£o hÃ nh trá»n Ä‘á»i Ä‘Æ°á»ng may táº¡i cá»­a hÃ ng</span>
          </li>
        )}
        {activePromotions.rewardPoints && (
          <li className="flex items-center gap-2 text-sm text-text-main">
            <Star className="w-4 h-4 text-primary" />
            <span>TÃ­ch Äiá»ƒm: TÃ­ch 3% giÃ¡ trá»‹ Ä‘Æ¡n hÃ ng</span>
          </li>
        )}
      </ul>
    </div>
  );
}




--- FILE: components/product/QuickOrderBox.tsx ---


'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2, Send, Zap } from 'lucide-react';

interface QuickOrderBoxProps {
  productId?: number;
  productName?: string;
  quantity?: number;
  variationId?: number;
  onQuickOrder?: (phone: string) => Promise<void>;
}

export function QuickOrderBox({ 
  productId, 
  productName, 
  quantity = 1,
  variationId,
  onQuickOrder 
}: QuickOrderBoxProps) {
  const [phone, setPhone] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const validatePhone = (phoneNumber: string): boolean => {
    // Vietnamese phone: 10-11 digits, may start with 0 or +84
    const cleaned = phoneNumber.replace(/[\s-]/g, '');
    const regex = /^(\+84|0)?[1-9][0-9]{8,9}$/;
    return regex.test(cleaned);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setSuccess(false);

    if (!phone.trim()) {
      setError('Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i');
      return;
    }

    if (!validatePhone(phone)) {
      setError('Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p 10-11 chá»¯ sá»‘');
      return;
    }

    setIsSubmitting(true);

    try {
      if (onQuickOrder) {
        await onQuickOrder(phone);
      } else {
        // Default: Zalo Notification (Option 1)
        const adminPhone = '0924923399'; // TODO: Move to env variable
        const message = encodeURIComponent(
          `Äáº·t hÃ ng nhanh\n` +
          `SÄT: ${phone}\n` +
          `Sáº£n pháº©m: ${productName || 'N/A'}\n` +
          `Sá»‘ lÆ°á»£ng: ${quantity}`
        );
        const zaloLink = `https://zalo.me/${adminPhone}?text=${message}`;
        window.open(zaloLink, '_blank');
      }

      setSuccess(true);
      setPhone(''); // Clear input after success
      
      // Reset success message after 3 seconds
      setTimeout(() => setSuccess(false), 3000);
    } catch (err) {
      setError('CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i sau.');
      console.error('Quick order error:', err);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
      {/* Title with Icon */}
      <div className="flex items-center gap-1.5 mb-2">
        <Zap className="w-4 h-4 text-orange-500 fill-orange-500" />
        <h3 className="font-bold text-text-main text-sm">
          Äáº·t hÃ ng nhanh
        </h3>
      </div>
      
      {/* Horizontal Inline Form */}
      <form onSubmit={handleSubmit} className="flex items-start gap-2">
        <div className="flex-1">
          <Input
            type="tel"
            placeholder="Nháº­p SÄT..."
            value={phone}
            onChange={(e) => {
              setPhone(e.target.value);
              setError(null);
            }}
            className="h-9 text-sm border-2 border-pink-200 focus:border-pink-400 rounded-lg"
            disabled={isSubmitting}
            aria-label="Sá»‘ Ä‘iá»‡n thoáº¡i Ä‘áº·t hÃ ng nhanh"
            aria-required="true"
            aria-invalid={error ? 'true' : 'false'}
            aria-describedby={error ? 'phone-error' : undefined}
          />
        </div>

        <Button
          type="submit"
          className="h-9 w-auto px-3 bg-[#D6336C] hover:bg-[#BE185D] text-white flex-shrink-0"
          disabled={isSubmitting || !phone.trim()}
          aria-label="Gá»­i yÃªu cáº§u Ä‘áº·t hÃ ng nhanh"
        >
          {isSubmitting ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <Send className="w-4 h-4" />
          )}
        </Button>
      </form>

      {/* Error and Success Messages */}
      {error && (
        <p id="phone-error" className="text-xs text-destructive mt-1.5" role="alert">
          {error}
        </p>
      )}
      {success && (
        <p className="text-xs text-green-600 mt-1.5" role="status">
          âœ“ ÄÃ£ gá»­i thÃ´ng tin. ChÃºng tÃ´i sáº½ liÃªn há»‡ vá»›i báº¡n sá»›m nháº¥t!
        </p>
      )}
    </div>
  );
}




--- FILE: components/product/RelatedProducts.tsx ---


'use client';

import { useProductsREST } from '@/lib/hooks/useProductsREST';
import { ProductCard } from './ProductCard';

interface RelatedProductsProps {
  productId: number;
  excludeId?: number;
}

export function RelatedProducts({
  productId,
  excludeId,
}: RelatedProductsProps) {
  // Get related products (simply get latest products, exclude current)
  const { products, loading } = useProductsREST(8);

  // Filter out current product
  const filteredProducts = products?.filter(
    (product) => Number(product.id) !== (excludeId || productId)
  ).slice(0, 4) || [];

  if (loading) {
    return (
      <div className="container-mobile py-8">
        <h2 className="font-heading text-2xl font-semibold mb-6">
          Sáº£n pháº©m liÃªn quan
        </h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="animate-pulse">
              <div className="aspect-square bg-muted rounded-2xl mb-4" />
              <div className="h-4 bg-muted rounded mb-2" />
              <div className="h-6 bg-muted rounded w-2/3" />
            </div>
          ))}
        </div>
      </div>
    );
  }

  if (filteredProducts.length === 0) {
    return null;
  }

  return (
    <div className="container-mobile py-8">
      <h2 className="font-heading text-2xl font-semibold mb-6">
        Sáº£n pháº©m liÃªn quan
      </h2>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {filteredProducts.map((product) => (
          <ProductCard
            key={product.id}
            product={product}
          />
        ))}
      </div>
    </div>
  );
}



--- FILE: app/(shop)/products/page.tsx ---


'use client';

import { Suspense } from 'react';
import { ProductList } from '@/components/product/ProductList';
import { ProductFilters } from '@/components/product/ProductFilters';

function ProductsContent() {
  return (
    <div className="min-h-screen">
      {/* Content Section - Vertical Stack */}
      <div className="container-mobile py-6 md:py-8">
        {/* Product Filters - Full Width, Horizontal Layout */}
        <div className="mb-6 md:mb-8">
          <ProductFilters />
        </div>

        {/* Product List */}
        <ProductList />
      </div>
    </div>
  );
}

export default function ProductsPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen">
        <div className="container-mobile py-6 md:py-8">
          <div className="animate-pulse">
            <div className="h-8 bg-muted rounded w-64 mb-4" />
            <div className="h-4 bg-muted rounded w-96" />
          </div>
        </div>
      </div>
    }>
      <ProductsContent />
    </Suspense>
  );
}




--- FILE: lib/hooks/useProductVariations.ts ---


'use client';

import { useQuery } from '@tanstack/react-query';

/**
 * MongoDB Variant format (from CMS API)
 */
export interface MongoVariant {
  id: string;
  size: string;
  color?: string;
  colorCode?: string;
  price: number;
  stock: number;
  image?: string;
  sku?: string;
}

interface UseProductVariationsOptions {
  enabled?: boolean; // Chá»‰ fetch khi enabled = true
}

interface UseProductVariationsResult {
  variations: MongoVariant[];
  isLoading: boolean;
  error: Error | null;
  refetch: () => void;
}

/**
 * Fetch function cho React Query
 * 
 * @param productId - Product ID (MongoDB ObjectId string) or slug
 * @returns Promise vá»›i array of variations
 */
async function fetchProductVariations(productId: string | number): Promise<MongoVariant[]> {
  const response = await fetch(`/api/cms/products/${encodeURIComponent(String(productId))}/variations`);
  
  if (!response.ok) {
    throw new Error(`Failed to fetch variations: ${response.statusText}`);
  }

  const data = await response.json();
  // CMS API returns { variations: [...] }
  return Array.isArray(data.variations) ? data.variations : [];
}

/**
 * Hook Ä‘á»ƒ fetch product variations tá»« CMS API vá»›i React Query
 * 
 * **TÃ­nh nÄƒng:**
 * - âœ… Tá»± Ä‘á»™ng cache: Data Ä‘Æ°á»£c cache 5 phÃºt
 * - âœ… Deduplication: Náº¿u nhiá»u components cÃ¹ng fetch cÃ¹ng productId, chá»‰ 1 request Ä‘Æ°á»£c gá»­i
 * - âœ… Background refetch: Tá»± Ä‘á»™ng refetch khi data stale
 * - âœ… Error handling: Tá»± Ä‘á»™ng retry 1 láº§n náº¿u fail
 * 
 * @param productId - Product ID
 * @param options - Options (enabled: chá»‰ fetch khi true)
 * @returns Object vá»›i variations, loading state, error, vÃ  refetch function
 * 
 * @example
 * ```tsx
 * const { variations, isLoading, error } = useProductVariations(productId, { 
 *   enabled: product.type === 'variable' && isHovered 
 * });
 * ```
 */
export function useProductVariations(
  productId: string | number | null | undefined,
  options: UseProductVariationsOptions = {}
): UseProductVariationsResult {
  const { enabled = true } = options;
  
  const {
    data: variations = [],
    isLoading,
    error,
    refetch,
  } = useQuery({
    queryKey: ['product-variations', productId],
    queryFn: () => fetchProductVariations(productId!),
    enabled: !!productId && enabled,
    staleTime: 5 * 60 * 1000, // Cache 5 phÃºt - Data Ä‘Æ°á»£c coi lÃ  "fresh" trong 5 phÃºt
    gcTime: 10 * 60 * 1000, // Giá»¯ trong cache 10 phÃºt sau khi khÃ´ng cÃ²n component nÃ o sá»­ dá»¥ng
    retry: 1, // Tá»± Ä‘á»™ng retry 1 láº§n náº¿u fail
    refetchOnWindowFocus: false, // KhÃ´ng refetch khi user quay láº¡i tab
    refetchOnMount: false, // KhÃ´ng refetch khi component mount náº¿u data Ä‘Ã£ cÃ³ trong cache
  });

  return {
    variations,
    isLoading,
    error: error instanceof Error ? error : error ? new Error(String(error)) : null,
    refetch: () => {
      refetch();
    },
  };
}




--- FILE: lib/utils/productMapper.ts ---


/**
 * Product Mapper Utility
 * 
 * Map WooCommerce REST API product format sang frontend format
 * Ä‘á»ƒ Ä‘áº£m báº£o tÆ°Æ¡ng thÃ­ch vá»›i components hiá»‡n táº¡i
 * 
 * Note: This file still supports mapping from WooCommerce format for backward compatibility
 * during migration. New code should use mapMongoProduct() instead.
 */

import type { WooCommerceProduct } from '@/types/woocommerce';

/**
 * Helper function Ä‘á»ƒ extract ACF field value tá»« meta_data array
 * (Extracted from lib/api/woocommerce.ts for independence)
 * 
 * @param metaData - Array of meta_data objects
 * @param key - Key to extract
 * @returns Value hoáº·c undefined
 */
function getMetaValue(metaData: Array<{ key: string; value: any }>, key: string): any {
  const meta = metaData?.find(m => m.key === key);
  return meta?.value;
}

/**
 * Mapped Product Type - Format cho frontend components
 * TÆ°Æ¡ng thÃ­ch vá»›i GraphQL product format hiá»‡n táº¡i
 */
export interface MappedProduct {
  id: string; // GraphQL ID format (hoáº·c databaseId)
  databaseId: number;
  name: string;
  slug: string;
  price: string;
  regularPrice: string;
  salePrice: string;
  onSale: boolean;
  minPrice?: number; // Minimum price (for variable products)
  maxPrice?: number; // Maximum price (for variable products)
  image: {
    id?: string; // Attachment ID (new structure)
    sourceUrl: string;
    altText: string;
  } | null;
  galleryImages: Array<{
    id?: string; // Attachment ID (new structure)
    sourceUrl: string;
    altText: string;
  }>;
  description: string;
  shortDescription: string;
  sku: string;
  stockStatus: string;
  stockQuantity: number | null;
  weight: string | null;
  length: number | null;
  width: number | null;
  height: number | null;
  volumetricWeight: number | null;
  material: string | null;
  origin: string | null;
  categories: Array<{
    id: number;
    name: string;
    slug: string;
  }>;
  tags: Array<{
    id: number;
    name: string;
    slug: string;
  }>;
  // Product attributes for variants (Size, Color, etc.)
  attributes?: Array<{
    id: number;
    name: string;
    options: string[];
    position: number;
    visible: boolean;
    variation: boolean;
    globalAttributeId?: string; // Reference to global attribute ID (for Phase 6)
  }>;
  // Product type: simple, variable, grouped, external
  type?: 'simple' | 'variable' | 'grouped' | 'external';
  // Variation IDs (for variable products)
  variations?: number[];
  // Status field (draft, publish, trash)
  status?: 'draft' | 'publish' | 'trash';
  // isActive field (for backward compatibility)
  isActive?: boolean;
}

/**
 * Map WooCommerce REST API product to frontend format
 * 
 * @param wcProduct - WooCommerce product tá»« REST API
 * @returns Mapped product cho frontend
 */
export function mapWooCommerceProduct(wcProduct: WooCommerceProduct): MappedProduct {
  // Extract ACF fields tá»« meta_data
  const length = getMetaValue(wcProduct.meta_data, 'length') as number | undefined;
  const width = getMetaValue(wcProduct.meta_data, 'width') as number | undefined;
  const height = getMetaValue(wcProduct.meta_data, 'height') as number | undefined;
  const volumetricWeight = getMetaValue(wcProduct.meta_data, 'volumetric_weight') as number | undefined;
  const material = getMetaValue(wcProduct.meta_data, 'material') as string | undefined;
  const origin = getMetaValue(wcProduct.meta_data, 'origin') as string | undefined;

  // Map dimensions tá»« WooCommerce dimensions object (náº¿u cÃ³)
  // Æ¯u tiÃªn ACF fields, fallback vá» WooCommerce dimensions
  const finalLength = length || (wcProduct.dimensions?.length ? parseFloat(wcProduct.dimensions.length) : null);
  const finalWidth = width || (wcProduct.dimensions?.width ? parseFloat(wcProduct.dimensions.width) : null);
  const finalHeight = height || (wcProduct.dimensions?.height ? parseFloat(wcProduct.dimensions.height) : null);

  return {
    id: `gid://shop-gau-bong/Product/${wcProduct.id}`, // GraphQL ID format (tÆ°Æ¡ng thÃ­ch)
    databaseId: wcProduct.id,
    name: wcProduct.name,
    slug: wcProduct.slug,
    price: wcProduct.price || '0',
    regularPrice: wcProduct.regular_price || wcProduct.price || '0',
    salePrice: wcProduct.sale_price || '',
    onSale: wcProduct.on_sale || false,
    image: wcProduct.images?.[0] ? {
      sourceUrl: wcProduct.images[0].src,
      altText: wcProduct.images[0].alt || wcProduct.name,
    } : null,
    galleryImages: wcProduct.images?.slice(1).map(img => ({
      sourceUrl: img.src,
      altText: img.alt || wcProduct.name,
    })) || [],
    description: wcProduct.description || '',
    shortDescription: wcProduct.short_description || '',
    sku: wcProduct.sku || '',
    stockStatus: wcProduct.stock_status || 'instock',
    stockQuantity: wcProduct.stock_quantity,
    weight: wcProduct.weight || null,
    length: finalLength,
    width: finalWidth,
    height: finalHeight,
    volumetricWeight: volumetricWeight || null,
    material: material || null,
    origin: origin || null,
    categories: wcProduct.categories || [],
    tags: wcProduct.tags || [],
    // Map attributes for variant selection
    attributes: wcProduct.attributes || [],
    // Product type
    type: wcProduct.type || 'simple',
    // Variation IDs (for variable products)
    variations: wcProduct.variations || [],
  };
}

/**
 * Map array of WooCommerce products
 * 
 * @param wcProducts - Array of WooCommerce products
 * @returns Array of mapped products
 */
export function mapWooCommerceProducts(wcProducts: WooCommerceProduct[]): MappedProduct[] {
  return wcProducts.map(mapWooCommerceProduct);
}

/**
 * Map WooCommerce category to frontend format
 */
export interface MappedCategory {
  id: string; // MongoDB ObjectId as string
  databaseId: number | string; // For backward compatibility (can be ObjectId string or number)
  name: string;
  slug: string;
  count: number | null;
  parentId: string | null; // Parent category ID as string (ObjectId string), null = top-level
  image: {
    sourceUrl: string;
    altText: string;
  } | null;
  status?: 'active' | 'inactive'; // NEW
  metaTitle?: string; // NEW
  metaDesc?: string; // NEW
  deletedAt?: Date | null; // NEW
  position?: number; // NEW - for sorting
  children?: MappedCategory[]; // NEW - for tree structure
  level?: number; // NEW - for tree indentation
}

/**
 * Map WooCommerce category
 * 
 * @param wcCategory - WooCommerce category tá»« REST API
 * @returns Mapped category cho frontend
 */
export function mapWooCommerceCategory(wcCategory: {
  id: number;
  name: string;
  slug: string;
  count: number;
  parent?: number; // Parent category ID (0 = top-level, undefined = not provided)
  image: {
    src: string;
    alt: string;
  } | null;
}): MappedCategory {
  return {
    id: `gid://shop-gau-bong/ProductCategory/${wcCategory.id}`, // GraphQL ID format
    databaseId: wcCategory.id,
    name: wcCategory.name,
    slug: wcCategory.slug,
    count: wcCategory.count || null,
    parentId: wcCategory.parent !== undefined && wcCategory.parent !== 0 ? String(wcCategory.parent) : null, // 0 = top-level, null = not provided
    image: wcCategory.image ? {
      sourceUrl: wcCategory.image.src,
      altText: wcCategory.image.alt || wcCategory.name,
    } : null,
  };
}

/**
 * Map array of WooCommerce categories
 * 
 * @param wcCategories - Array of WooCommerce categories
 * @returns Array of mapped categories
 */
export function mapWooCommerceCategories(
  wcCategories: Array<{
    id: number;
    name: string;
    slug: string;
    count: number;
    parent?: number; // Parent category ID
    image: {
      src: string;
      alt: string;
    } | null;
  }>
): MappedCategory[] {
  return wcCategories.map(mapWooCommerceCategory);
}

/**
 * MongoDB Product Type (from database)
 */
export interface MongoProduct {
  _id: any; // ObjectId
  id?: string;
  name: string;
  slug: string;
  description?: string;
  shortDescription?: string;
  sku?: string;
  minPrice: number;
  maxPrice?: number;
  // Image fields (new structure)
  _thumbnail_id?: string; // Attachment ID for featured image
  _product_image_gallery?: string; // Comma-separated attachment IDs for gallery
  images?: string[]; // Array of image URLs (backward compatibility)
  category?: string; // Category ID or slug
  tags?: string[];
  variants?: Array<{
    id: string;
    size: string;
    color?: string;
    colorCode?: string;
    price: number;
    stock: number;
    image?: string;
    sku?: string;
  }>;
  isHot?: boolean;
  isActive: boolean;
  status: 'draft' | 'publish';
  length?: number;
  width?: number;
  height?: number;
  weight?: number;
  volumetricWeight?: number;
  material?: string;
  origin?: string;
  createdAt: Date;
  updatedAt: Date;
}

/**
 * MongoDB Document type (with _id)
 */
type MongoDocument = MongoProduct & { _id: any };

/**
 * Map MongoDB product to frontend format
 * 
 * @param mongoProduct - MongoDB product document
 * @returns Mapped product cho frontend
 */
export function mapMongoProduct(mongoProduct: MongoProduct | MongoDocument | any): MappedProduct {
  const productId = mongoProduct._id.toString();
  
  // Priority 1: Use productDataMetaBox prices if available
  // Priority 2: Calculate from variants
  // Priority 3: Use minPrice/maxPrice
  const regularPrice = mongoProduct.productDataMetaBox?.regularPrice !== undefined
    ? String(mongoProduct.productDataMetaBox.regularPrice)
    : mongoProduct.variants && mongoProduct.variants.length > 0
    ? String(Math.max(...mongoProduct.variants.map((v: any) => v.price || v.regularPrice || 0)))
    : String(mongoProduct.maxPrice || mongoProduct.minPrice || 0);
  
  const salePrice = mongoProduct.productDataMetaBox?.salePrice !== undefined
    ? String(mongoProduct.productDataMetaBox.salePrice)
    : '';
  
  const onSale = Boolean(salePrice && parseFloat(salePrice) > 0 && parseFloat(salePrice) < parseFloat(regularPrice));
  
  // Use salePrice if on sale, otherwise use regularPrice
  // If price is 0 or invalid, it will be handled by formatPrice to show "LiÃªn há»‡"
  const price = onSale ? salePrice : regularPrice;
  
  // Extract attributes from variants (priority: variants > productDataMetaBox.variations)
  // Priority 1: Use variants array (converted from productDataMetaBox.variations)
  // Priority 2: Extract from productDataMetaBox.variations if variants not available (backward compatibility)
  let sizeOptions: string[] = [];
  let colorOptions: string[] = [];
  
  if (mongoProduct.variants && mongoProduct.variants.length > 0) {
    // Use variants array (new format)
    // Filter out empty/null/undefined values
    sizeOptions = [...new Set(mongoProduct.variants
      .map((v: any) => v.size)
      .filter((size: any) => size && String(size).trim().length > 0)
      .map((size: any) => String(size).trim()))] as string[];
    colorOptions = [...new Set(mongoProduct.variants
      .map((v: any) => v.color)
      .filter((color: any) => color && String(color).trim().length > 0)
      .map((color: any) => String(color).trim()))] as string[];
  } else if (mongoProduct.productDataMetaBox?.variations && mongoProduct.productDataMetaBox.variations.length > 0) {
    // Fallback: Extract from productDataMetaBox.variations (backward compatibility)
    mongoProduct.productDataMetaBox.variations.forEach((variation: any) => {
      if (variation.attributes) {
        Object.entries(variation.attributes).forEach(([attrName, value]) => {
          const attrNameLower = attrName.toLowerCase();
          if (attrNameLower.includes('size') || attrNameLower === 'pa_size' || attrNameLower === 'kÃ­ch thÆ°á»›c') {
            const size = String(value).trim();
            if (size && size.length > 0 && !sizeOptions.includes(size)) {
              sizeOptions.push(size);
            }
          } else if (attrNameLower.includes('color') || attrNameLower === 'pa_color' || attrNameLower === 'mÃ u') {
            const color = String(value).trim();
            if (color && color.length > 0 && !colorOptions.includes(color)) {
              colorOptions.push(color);
            }
          }
        });
      }
    });
  }
  
  // Build attributes array
  // Priority: Use productDataMetaBox.attributes if available (includes globalAttributeId)
  // Fallback: Build from variants/extracted options
  const attributes: Array<{
    id: number;
    name: string;
    options: string[];
    position: number;
    visible: boolean;
    variation: boolean;
    globalAttributeId?: string;
  }> = [];
  
  // Check if productDataMetaBox.attributes exists (new format with globalAttributeId)
  if (mongoProduct.productDataMetaBox?.attributes && mongoProduct.productDataMetaBox.attributes.length > 0) {
    // Map from productDataMetaBox.attributes (includes globalAttributeId)
    mongoProduct.productDataMetaBox.attributes.forEach((attr: any, index: number) => {
      if (attr.values && attr.values.length > 0) {
        attributes.push({
          id: index + 1,
          name: attr.name,
          options: attr.values,
          position: index,
          visible: true,
          variation: attr.usedForVariations || false,
          globalAttributeId: attr.globalAttributeId, // Include globalAttributeId
        });
      }
    });
  } else {
    // Fallback: Build from extracted options (backward compatibility)
    if (sizeOptions.length > 0) {
      attributes.push({
        id: 1,
        name: 'pa_size',
        options: sizeOptions,
        position: 0,
        visible: true,
        variation: true,
      });
    }
    
    if (colorOptions.length > 0) {
      attributes.push({
        id: 2,
        name: 'pa_color',
        options: colorOptions,
        position: 1,
        visible: true,
        variation: true,
      });
    }
  }
  
  // Determine product type
  const hasVariants = (mongoProduct.variants && mongoProduct.variants.length > 0) ||
                      (mongoProduct.productDataMetaBox?.variations && mongoProduct.productDataMetaBox.variations.length > 0);
  const type: 'simple' | 'variable' = hasVariants ? 'variable' : 'simple';
  
  // Stock calculation logic:
  // For variable products: Always calculate from variants (ignore productDataMetaBox.stockQuantity)
  // For simple products: Use productDataMetaBox.stockQuantity if available
  let stockQuantity: number | null = null;
  let stockStatus: string = 'instock';
  
  if (hasVariants) {
    // Variable product: Calculate sum from variants
    // Priority 1: Sum from variants array (new format)
    if (mongoProduct.variants && mongoProduct.variants.length > 0) {
      stockQuantity = mongoProduct.variants.reduce((sum: number, v: any) => {
        // Support both 'stock' and 'stockQuantity' fields in variants
        const variantStock = v.stockQuantity !== undefined ? v.stockQuantity : (v.stock || 0);
        return sum + (variantStock || 0);
      }, 0);
      
      // Check if any variant has stock for stockStatus
      const hasStock = mongoProduct.variants.some((v: any) => {
        const variantStock = v.stockQuantity !== undefined ? v.stockQuantity : (v.stock || 0);
        return (variantStock || 0) > 0;
      });
      stockStatus = hasStock ? 'instock' : 'outofstock';
    } else if (mongoProduct.productDataMetaBox?.variations && mongoProduct.productDataMetaBox.variations.length > 0) {
      // Priority 2: Sum from productDataMetaBox.variations (backward compatibility)
      stockQuantity = mongoProduct.productDataMetaBox.variations.reduce((sum: number, v: any) => {
        const variantStock = v.stockQuantity !== undefined ? v.stockQuantity : 0;
        return sum + (variantStock || 0);
      }, 0);
      
      // Check if any variation has stock
      const hasStock = mongoProduct.productDataMetaBox.variations.some((v: any) => (v.stockQuantity || 0) > 0);
      stockStatus = hasStock ? 'instock' : 'outofstock';
    } else {
      // No variants found, use productDataMetaBox values or default
      stockQuantity = mongoProduct.productDataMetaBox?.stockQuantity !== undefined
        ? mongoProduct.productDataMetaBox.stockQuantity
        : null;
      stockStatus = mongoProduct.productDataMetaBox?.stockStatus || 'instock';
    }
    // If sum is 0, set to null
    if (stockQuantity === 0) {
      stockQuantity = null;
    }
  } else {
    // Simple product: Use productDataMetaBox.stockQuantity if available
    stockQuantity = mongoProduct.productDataMetaBox?.stockQuantity !== undefined
      ? mongoProduct.productDataMetaBox.stockQuantity
      : null;
    // Stock status: Use productDataMetaBox.stockStatus or calculate from stockQuantity
    stockStatus = mongoProduct.productDataMetaBox?.stockStatus !== undefined
      ? mongoProduct.productDataMetaBox.stockStatus
      : (stockQuantity !== null && stockQuantity > 0) ? 'instock' : 'outofstock';
  }
  
  const mappedResult = {
    id: productId, // Use MongoDB ObjectId directly (not GraphQL format)
    databaseId: productId, // Use ObjectId string as databaseId for compatibility
    name: mongoProduct.name,
    slug: mongoProduct.slug,
    price,
    regularPrice,
    salePrice,
    onSale,
    minPrice: mongoProduct.minPrice,
    maxPrice: mongoProduct.maxPrice,
    // Map images - try new structure first, fallback to old structure
    image: (() => {
      // Priority 1: Use images array if available (these are already URLs from payload)
      if (mongoProduct.images && Array.isArray(mongoProduct.images) && mongoProduct.images.length > 0) {
        const firstImageUrl = mongoProduct.images[0];
        if (firstImageUrl && typeof firstImageUrl === 'string' && firstImageUrl.length > 0) {
          return {
            id: mongoProduct._thumbnail_id || firstImageUrl,
            sourceUrl: firstImageUrl,
            altText: mongoProduct.name,
          } as any;
        }
      }
      
      // Priority 2: Use _thumbnail_id (can be URL or pathname)
      if (mongoProduct._thumbnail_id) {
        // Check if _thumbnail_id is already a full URL
        if (mongoProduct._thumbnail_id.startsWith('http://') || mongoProduct._thumbnail_id.startsWith('https://')) {
          return {
            id: mongoProduct._thumbnail_id,
            sourceUrl: mongoProduct._thumbnail_id,
            altText: mongoProduct.name,
          } as any;
        }
        // If _thumbnail_id is pathname and images array is empty, we can't resolve it
        // This should not happen if POST handler populates images array correctly
      }
      
      // No image available
      return null;
    })(),
    galleryImages: (() => {
      // Priority 1: Use _product_image_gallery (comma-separated IDs)
      if (mongoProduct._product_image_gallery) {
        const galleryIds = mongoProduct._product_image_gallery.split(',').filter(Boolean);
        const imageUrls = mongoProduct.images || [];
        
        // Map gallery IDs to image URLs
        // Try to match IDs with URLs in images array, or use images array as fallback
        return galleryIds.map((id: string, idx: number) => {
          const trimmedId = id.trim();
          let imageUrl = '';
          
          // Check if ID is already a full URL
          if (trimmedId.startsWith('http://') || trimmedId.startsWith('https://')) {
            imageUrl = trimmedId;
          } else if (imageUrls.length > idx + 1) {
            // Use corresponding image from array (skip first image which is featured)
            imageUrl = imageUrls[idx + 1];
          } else if (imageUrls.length > 0) {
            // Fallback: use any available image
            imageUrl = imageUrls[idx % imageUrls.length];
          }
          
          return {
            id: trimmedId,
            sourceUrl: imageUrl,
            altText: mongoProduct.name,
          };
        }).filter((img: { sourceUrl: string }) => img.sourceUrl) as any; // Filter out images without URL
      }
      
      // Priority 2: Use images array (old structure) - skip first image (featured)
      if (mongoProduct.images && mongoProduct.images.length > 1) {
        return mongoProduct.images.slice(1).map((img: any) => ({
          sourceUrl: img,
          altText: mongoProduct.name,
        })) as any;
      }
      
      // No gallery images
      return [];
    })(),
    description: mongoProduct.description || '',
    shortDescription: mongoProduct.shortDescription || '',
    sku: mongoProduct.productDataMetaBox?.sku || mongoProduct.sku || '',
    // Use calculated stockQuantity and stockStatus
    stockStatus,
    stockQuantity,
    weight: mongoProduct.weight ? String(mongoProduct.weight) : null,
    length: mongoProduct.length || null,
    width: mongoProduct.width || null,
    height: mongoProduct.height || null,
    volumetricWeight: mongoProduct.volumetricWeight || null,
    material: mongoProduct.material || null,
    origin: mongoProduct.origin || null,
    categories: [], // TODO: Populate from category reference
    tags: (mongoProduct.tags || []).map((tag: any, idx: number) => ({
      id: idx + 1,
      name: tag,
      slug: tag.toLowerCase().replace(/\s+/g, '-'),
    })),
    attributes: attributes.length > 0 ? attributes : undefined,
    type,
    variations: (mongoProduct.variants?.map((_: any, idx: number) => idx + 1) || 
                 mongoProduct.productDataMetaBox?.variations?.map((_: any, idx: number) => idx + 1) || []),
    status: mongoProduct.status || 'draft',
    isActive: mongoProduct.isActive !== undefined ? mongoProduct.isActive : (mongoProduct.status === 'publish'),
  };
  
  return mappedResult;
}

/**
 * Map array of MongoDB products
 * 
 * @param mongoProducts - Array of MongoDB products
 * @returns Array of mapped products
 */
export function mapMongoProducts(mongoProducts: MongoProduct[]): MappedProduct[] {
  return mongoProducts.map(mapMongoProduct);
}

/**
 * MongoDB Category Type (from database)
 */
export interface MongoCategory {
  _id: any; // ObjectId
  name: string;
  slug: string;
  description?: string;
  parentId?: string | null; // ObjectId as string or null
  imageUrl?: string;
  position?: number;
  count?: number;
  status?: 'active' | 'inactive'; // NEW: Default 'active'
  metaTitle?: string; // NEW: SEO title
  metaDesc?: string; // NEW: SEO description (max 500 chars)
  deletedAt?: Date | null; // NEW: Soft delete (null = not deleted)
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Map MongoDB category to frontend format
 * 
 * @param mongoCategory - MongoDB category document
 * @returns Mapped category cho frontend
 */
export function mapMongoCategory(mongoCategory: MongoCategory | any): MappedCategory {
  const categoryId = mongoCategory._id.toString();
  
  // Convert parentId from ObjectId string to string (keep as string for compatibility)
  let parentId: string | null = null;
  if (mongoCategory.parentId) {
    parentId = typeof mongoCategory.parentId === 'string' 
      ? mongoCategory.parentId 
      : mongoCategory.parentId.toString();
  }
  
  return {
    id: categoryId, // Use MongoDB ObjectId directly as string
    databaseId: parseInt(categoryId, 16) || 0, // Fallback ID for backward compatibility
    name: mongoCategory.name,
    slug: mongoCategory.slug,
    count: mongoCategory.count || null,
    parentId: parentId, // Keep as string (ObjectId string)
    image: mongoCategory.imageUrl ? {
      sourceUrl: mongoCategory.imageUrl,
      altText: mongoCategory.name,
    } : null,
    status: mongoCategory.status || 'active', // Default to 'active'
    metaTitle: mongoCategory.metaTitle,
    metaDesc: mongoCategory.metaDesc,
    deletedAt: mongoCategory.deletedAt || null,
  };
}

/**
 * Map array of MongoDB categories
 * 
 * @param mongoCategories - Array of MongoDB categories
 * @returns Array of mapped categories
 */
export function mapMongoCategories(mongoCategories: MongoCategory[]): MappedCategory[] {
  return mongoCategories.map(mapMongoCategory);
}


